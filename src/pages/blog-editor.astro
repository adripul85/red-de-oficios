---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
---

<Layout title="Editor de Blog SEO - DeOficios Admin">
    <Header />

    <main class="editor-container">
        <div class="editor-header">
            <h1>‚úçÔ∏è Editor de Contenidos SEO</h1>
            <p>Redacta con Markdown y define tus palabras clave.</p>
        </div>

        <div id="loading-state" class="loading-box">
            <div class="spinner"></div>
            <p>Verificando permisos...</p>
        </div>

        <div id="editor-content" class="grid-editor hidden">
            <section class="form-section">
                <form id="blog-form">
                    <div class="form-group">
                        <label>T√≠tulo del Art√≠culo (H1)</label>
                        <input
                            type="text"
                            id="titulo"
                            placeholder="Ej: Cu√°nto cuesta un plomero en 2026"
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label>URL Amigable (Slug)</label>
                        <input
                            type="text"
                            id="slug"
                            class="input-slug"
                            readonly
                            placeholder="se-genera-automaticamente"
                        />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Categor√≠a</label>
                            <select id="categoria">
                                <option value="Consejos">üí° Consejos</option>
                                <option value="Noticias">üì∞ Noticias</option>
                                <option value="Precios"
                                    >üí∞ Gu√≠a de Precios</option
                                >
                                <option value="Tutoriales">üõ†Ô∏è Tutoriales</option
                                >
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Autor</label>
                            <input
                                type="text"
                                id="autor"
                                value="Equipo DeOficios"
                            />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Imagen Principal (URL)</label>
                        <input
                            type="text"
                            id="imagen"
                            placeholder="https://..."
                        />
                    </div>

                    <div class="form-group">
                        <label>üîë Keywords / Palabras Clave (SEO)</label>
                        <small
                            >Escribe y presiona ENTER. Ej: "plomero precios",
                            "tarifario 2026".</small
                        >
                        <div class="tags-input-wrapper">
                            <input
                                type="text"
                                id="keyword-input"
                                placeholder="Agregar keyword..."
                            />
                            <button type="button" id="btn-add-keyword"
                                >‚ûï</button
                            >
                        </div>
                        <div id="keywords-list" class="tags-container"></div>
                    </div>

                    <div class="form-group">
                        <label>Resumen Corto (Meta Description)</label>
                        <textarea
                            id="resumen"
                            rows="2"
                            maxlength="160"
                            placeholder="Lo que aparece en Google debajo del t√≠tulo..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <div class="label-row">
                            <label>Contenido (Markdown Activo üìù)</label>
                            <a
                                href="https://www.markdownguide.org/cheat-sheet/"
                                target="_blank"
                                class="md-link">Ver gu√≠a Markdown</a
                            >
                        </div>
                        <textarea
                            id="contenido"
                            rows="15"
                            placeholder="# Usa numeral para t√≠tulos
**Usa asteriscos para negrita**
- Usa guiones para listas"
                        ></textarea>
                    </div>

                    <div class="action-bar">
                        <button type="submit" class="btn-publish"
                            >üöÄ Publicar Art√≠culo</button
                        >
                        <p id="status-msg" class="status"></p>
                    </div>
                </form>
            </section>

            <aside class="sidebar-section">
                <div class="preview-box">
                    <label>Vista previa de imagen:</label>
                    <img
                        id="img-preview"
                        src="https://via.placeholder.com/300x150?text=Sin+Imagen"
                        alt="Preview"
                    />
                </div>

                <div class="content-preview-box">
                    <label>Vista previa del texto:</label>
                    <div id="markdown-preview" class="prose-preview">
                        <em>Escribe para ver la vista previa...</em>
                    </div>
                </div>

                <div class="posts-list-box">
                    <h3>üìö Art√≠culos Publicados</h3>
                    <div id="posts-list" class="posts-list">
                        <p class="text-muted">Cargando...</p>
                    </div>
                </div>
            </aside>
        </div>
    </main>
</Layout>

<script>
    import { auth, db } from "../firebase/client";
    import {
        collection,
        addDoc,
        getDocs,
        doc,
        deleteDoc,
        getDoc,
        query,
        orderBy,
        where,
        updateDoc,
    } from "firebase/firestore";
    import { onAuthStateChanged } from "firebase/auth";
    // IMPORTAMOS EL PARSEADOR DE MARKDOWN
    import { marked } from "marked";

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [BLOG-EDITOR] P√°gina cargada/navegada");

        const loadingState = document.getElementById("loading-state");
        const editorContent = document.getElementById("editor-content");
        const form = document.getElementById("blog-form");
        const titleInput = document.getElementById(
            "titulo",
        ) as HTMLInputElement;
        const slugInput = document.getElementById("slug") as HTMLInputElement;
        const imgInput = document.getElementById("imagen") as HTMLInputElement;
        const imgPreview = document.getElementById(
            "img-preview",
        ) as HTMLImageElement;
        const contentInput = document.getElementById(
            "contenido",
        ) as HTMLTextAreaElement;
        const mdPreview = document.getElementById("markdown-preview");
        const postsList = document.getElementById("posts-list");
        const statusMsg = document.getElementById("status-msg");
        const btnSubmit = form?.querySelector(".btn-publish");

        // KEYWORDS LOGIC
        const keywordInput = document.getElementById("keyword-input");
        const keywordsList = document.getElementById("keywords-list");
        const btnAddKeyword = document.getElementById("btn-add-keyword");
        let keywords = [];

        // EDIT STATE
        let isEditing = false;
        let currentDocId = null;

        // 1. SEGURIDAD
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userSnap = await getDoc(
                        doc(db, "profesionales", user.uid),
                    );
                    if (userSnap.exists() && userSnap.data().rol === "admin") {
                        iniciarEditor();
                    } else {
                        window.location.href = "/";
                    }
                } catch (e) {
                    console.error(e);
                }
            } else {
                window.location.href = "/ingresar";
            }
        });

        async function iniciarEditor() {
            loadingState.style.display = "none";
            editorContent.classList.remove("hidden");
            cargarPosts();

            // Check URL params for edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const slugToEdit = urlParams.get("slug");
            if (slugToEdit) {
                cargarPostParaEditar(slugToEdit);
            }
        }

        // Cargar datos para editar
        async function cargarPostParaEditar(slug) {
            statusMsg.innerText = "Cargando post para editar...";
            try {
                const q = query(
                    collection(db, "blog"),
                    where("slug", "==", slug),
                );
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const docSnap = snapshot.docs[0];
                    const data = docSnap.data();

                    isEditing = true;
                    currentDocId = docSnap.id;

                    // Fill form
                    titleInput.value = data.titulo;
                    slugInput.value = data.slug;
                    document.getElementById("categoria").value = data.categoria;
                    document.getElementById("autor").value = data.autor;
                    imgInput.value = data.imagen;
                    imgPreview.src = data.imagen;
                    document.getElementById("resumen").value = data.resumen;
                    contentInput.value = data.contenido;
                    mdPreview.innerHTML = marked.parse(data.contenido || "");

                    keywords = data.keywords || [];
                    renderKeywords();

                    btnSubmit.textContent = "üíæ Actualizar Art√≠culo";
                    statusMsg.innerText = "Modo Edici√≥n Activado";
                } else {
                    statusMsg.innerText = "Post no encontrado.";
                }
            } catch (e) {
                console.error(e);
                statusMsg.innerText = "Error cargando post.";
            }
        }

        // 2. SLUG AUTOM√ÅTICO (Solo si no estamos editando o si el usuario lo fuerza)
        titleInput.addEventListener("input", (e) => {
            if (!isEditing) {
                const val = e.target.value;
                const slug = val
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, "")
                    .replace(/[\s_-]+/g, "-")
                    .replace(/^-+|-+$/g, "");
                slugInput.value = slug;
            }
        });

        // 3. PREVIEW IMAGEN
        imgInput.addEventListener("input", (e) => {
            imgPreview.src =
                e.target.value.length > 10
                    ? e.target.value
                    : "https://via.placeholder.com/300x150?text=Sin+Imagen";
        });

        // 4. PREVIEW MARKDOWN EN TIEMPO REAL
        contentInput.addEventListener("input", (e) => {
            const textoRaw = e.target.value;
            // Convertimos Markdown a HTML
            const html = marked.parse(textoRaw);
            mdPreview.innerHTML = html;
        });

        // 5. L√ìGICA DE KEYWORDS (FIX COMA)
        function renderKeywords() {
            keywordsList.innerHTML = "";
            keywords.forEach((k, index) => {
                const span = document.createElement("span");
                span.className = "tag-pill";
                span.innerHTML = `${k} <button type="button" onclick="window.removeKeyword(${index})">√ó</button>`;
                keywordsList.appendChild(span);
            });
        }
        function addKeyword() {
            // Limpiamos comas si se pegaron o escribieron
            const val = keywordInput.value
                .replace(",", "")
                .trim()
                .toLowerCase();
            if (val && !keywords.includes(val)) {
                if (keywords.length >= 10) {
                    alert("M√°ximo 10 keywords");
                    return;
                }
                keywords.push(val);
                renderKeywords();
                keywordInput.value = "";
            }
        }

        // Soporte para Enter y Coma
        keywordInput.addEventListener("keyup", (e) => {
            if (e.key === "Enter" || e.key === ",") {
                e.preventDefault();
                addKeyword();
            }
        });

        btnAddKeyword.addEventListener("click", (e) => {
            e.preventDefault();
            addKeyword();
        });
        window.removeKeyword = (i) => {
            keywords.splice(i, 1);
            renderKeywords();
        };

        // 6. PUBLICAR / ACTUALIZAR
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = form.querySelector(".btn-publish");
            btn.disabled = true;
            btn.textContent = isEditing ? "Actualizando..." : "Publicando...";
            statusMsg.textContent = "";

            try {
                const postData = {
                    titulo: document.getElementById("titulo").value,
                    slug: document.getElementById("slug").value,
                    categoria: document.getElementById("categoria").value,
                    autor: document.getElementById("autor").value,
                    imagen: document.getElementById("imagen").value,
                    resumen: document.getElementById("resumen").value,
                    contenido: document.getElementById("contenido").value, // Guardamos el Markdown puro
                    keywords: keywords, // Guardamos array de SEO
                };

                if (isEditing && currentDocId) {
                    // UPDATE
                    await updateDoc(doc(db, "blog", currentDocId), {
                        ...postData,
                        ultima_actualizacion: new Date(),
                    });
                    statusMsg.textContent = "‚úÖ ¬°Actualizado correctamente!";
                } else {
                    // CREATE
                    await addDoc(collection(db, "blog"), {
                        ...postData,
                        fecha: new Date(),
                        vistas: 0,
                    });
                    statusMsg.textContent = "‚úÖ ¬°Publicado!";
                    form.reset();
                    keywords = [];
                    renderKeywords();
                    mdPreview.innerHTML = "<em>Escribe...</em>";
                    imgPreview.src =
                        "https://via.placeholder.com/300x150?text=Sin+Imagen";
                }

                statusMsg.style.color = "green";
                cargarPosts();
            } catch (error) {
                console.error(error);
                statusMsg.textContent = "‚ùå Error: " + error.message;
                statusMsg.style.color = "red";
            } finally {
                btn.disabled = false;
                btn.textContent = isEditing
                    ? "üíæ Actualizar Art√≠culo"
                    : "üöÄ Publicar Art√≠culo";
            }
        });

        // 7. LISTAR POSTS
        async function cargarPosts() {
            postsList.innerHTML =
                '<p class="text-muted" style="text-align:center;">Cargando...</p>';
            try {
                const q = query(
                    collection(db, "blog"),
                    orderBy("fecha", "desc"),
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    postsList.innerHTML = `<div style="text-align: center; padding: 20px; background: #f1f5f9; border-radius: 8px;"><p>üì≠ Sin art√≠culos.</p></div>`;
                    return;
                }

                let html = "";
                snapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    const fecha = p.fecha
                        ? new Date(p.fecha.seconds * 1000).toLocaleDateString()
                        : "Fecha desc.";
                    html += `
                <div class="mini-post-card">
                    <img src="${p.imagen || "https://via.placeholder.com/60"}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; flex-shrink: 0; border: 1px solid #e2e8f0;" onerror="this.src='https://via.placeholder.com/60?text=Error'" />
                    <div class="mini-post-info">
                        <strong title="${p.titulo}">${p.titulo}</strong>
                        <small>${fecha} ‚Ä¢ ${p.categoria}</small>
                        <br/>
                        <a href="/blog-editor?slug=${p.slug}" style="font-size: 0.8rem; color: #ea580c;">‚úèÔ∏è Editar</a>
                    </div>
                    <button class="btn-delete-post" onclick="window.borrarPost('${docSnap.id}')">üóëÔ∏è</button>
                </div>
            `;
                });
                postsList.innerHTML = html;
            } catch (e) {
                console.error(e);
            }
        }

        window.borrarPost = async (id) => {
            if (!confirm("¬øBorrar art√≠culo?")) return;
            try {
                await deleteDoc(doc(db, "blog", id));
                cargarPosts();
            } catch (e) {
                alert("Error");
            }
        };
    }); // End of astro:page-load
</script>

<style>
    .editor-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        font-family: "Segoe UI", system-ui, sans-serif;
        background: #f8fafc;
        min-height: 100vh;
    }
    .editor-header {
        margin-bottom: 30px;
        text-align: center;
    }
    .grid-editor {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
    }
    .form-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        font-weight: bold;
        color: #334155;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .md-link {
        font-size: 0.8rem;
        color: #3b82f6;
        text-decoration: none;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .input-slug {
        background: #f1f5f9;
        color: #64748b;
        font-family: monospace;
    }

    /* TAGS STYLES */
    .tags-input-wrapper {
        display: flex;
        gap: 10px;
    }
    .tags-input-wrapper button {
        background: #374151;
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 8px;
        cursor: pointer;
    }
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    .tag-pill {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .tag-pill button {
        background: none;
        border: none;
        color: #1e40af;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

    .action-bar {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 30px;
    }
    .btn-publish {
        background: #ea580c;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }

    /* SIDEBAR & PREVIEW */
    .sidebar-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .preview-box,
    .posts-list-box,
    .content-preview-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }
    .preview-box img {
        max-width: 100%;
        border-radius: 8px;
    }

    /* PROSE PREVIEW (Simula el art√≠culo real) */
    .prose-preview {
        font-family: "Georgia", serif;
        line-height: 1.6;
        color: #333;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 8px;
    }
    .prose-preview :global(h1),
    .prose-preview :global(h2) {
        margin-top: 0;
        color: #111;
    }
    .prose-preview :global(ul) {
        padding-left: 20px;
    }

    /* MINI POSTS LIST */
    .posts-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
    }
    .mini-post-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border: 1px solid #f1f5f9;
        border-radius: 8px;
        background: #f8fafc;
    }
    .mini-post-info {
        flex: 1;
        overflow: hidden;
    }
    .btn-delete-post {
        background: none;
        border: none;
        cursor: pointer;
    }

    .loading-box {
        text-align: center;
        padding: 50px;
    }
    .hidden {
        display: none;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        .grid-editor {
            grid-template-columns: 1fr;
        }
    }
</style>
