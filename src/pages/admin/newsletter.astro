---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Newsletter - Admin">
    <div class="min-h-screen bg-slate-50 py-8 px-4 font-sans">
        <div class="max-w-4xl mx-auto">
            <!-- HEADER -->
            <header
                class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 mb-8 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a
                        href="/admin"
                        class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-colors">
                        
                    </a>
                    <div>
                        <h1
                            class="text-2xl font-black text-slate-800 tracking-tight">
                            Newsletter
                        </h1>
                        <p class="text-slate-500 text-sm font-medium">
                            Gestin de suscriptores
                        </p>
                    </div>
                </div>
                <div
                    class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl">
                    
                </div>
            </header>

            <!-- SEND MASS EMAIL CARD -->
            <section
                class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 mb-8 relative overflow-hidden">
                <div class="relative z-10">
                    <h2
                        class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span
                            class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-sm"></span>
                        Enviar Email Masivo
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Asunto</label>
                            <input
                                type="text"
                                id="mass-subject"
                                placeholder="Ej: Novedades de Enero!"
                                class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            />
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Mensaje (Markdown) <span
                                        class="text-[10px] text-slate-300 ml-1">Soporta **negrita**, - listas,
                                        [links](url)</span></label>
                                <button
                                    id="btn-toggle-preview"
                                    class="text-xs text-indigo-600 font-bold hover:underline">Ver Previsualizacin</button>
                            </div>
                            <div
                                class="grid grid-cols-1 md:grid-cols-2 gap-4 h-80">
                                <textarea
                                    id="mass-body"
                                    class="w-full h-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all font-mono text-sm resize-none"
                                    placeholder="Hola a todos,

Esta es una **actualizacin importante**..."></textarea>

                                <div
                                    id="preview-area"
                                    class="h-full bg-white border border-slate-200 rounded-xl p-4 overflow-y-auto prose prose-sm max-w-none prose-indigo hidden md:block">
                                    <p
                                        class="text-slate-400 italic text-center mt-10">
                                        Escribe para ver la vista previa...
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-2">
                            <p
                                id="send-status"
                                class="text-xs font-bold text-slate-400 hidden animate-pulse">
                                Procesando...
                            </p>
                            <button
                                id="btn-send-mass"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold transition shadow-lg hover:shadow-indigo-500/30 flex items-center gap-2 transform active:scale-95">
                                <span>Enviar Campa침a</span>
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                    class="w-5 h-5">
                                    <path
                                        d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.086l-1.414 4.926a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.289z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Decorative Blob -->
                <div
                    class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-orange-50 rounded-full blur-3xl opacity-50 pointer-events-none">
                </div>
            </section>

            <!-- CAMPAIGN HISTORY -->
            <section class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 mb-8 overflow-hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-sm">游닆</span>
                        Historial de Campa침as
                    </h2>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="p-4">Asunto</th>
                                <th class="p-4">Fecha</th>
                                <th class="p-4">Enviados</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="campaigns-list" class="divide-y divide-slate-50">
                            <tr>
                                <td colspan="4" class="p-8 text-center text-slate-400">Cargando historial...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- SUBSCRIBERS TABLE -->
            <div
                class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div
                    class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-bold text-slate-800">
                        Lista de Suscriptores
                    </h3>
                    <span
                        class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold"
                        id="sub-count">0</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="p-5">Email</th>
                                <th class="p-5">Fecha</th>
                                <th class="p-5">Estado</th>
                                <th class="p-5 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody
                            id="subscribers-list"
                            class="divide-y divide-slate-50">
                            <tr>
                                <td
                                    colspan="4"
                                    class="p-10 text-center text-slate-400 font-medium">Cargando suscriptores...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { db, auth } from "../../firebase/client";
    import {
        collection,
        getDocs,
        query,
        orderBy,
        deleteDoc,
        addDoc,
        doc,
        where,
        serverTimestamp
    } from "firebase/firestore";
    import { onAuthStateChanged } from "firebase/auth";
    import { marked } from "marked";

    let subscribers = [];
    let campaigns = [];

    document.addEventListener("astro:page-load", () => {
        const list = document.getElementById("subscribers-list");
        const campaignsList = document.getElementById("campaigns-list");
        const btnSend = document.getElementById("btn-send-mass");
        const statusText = document.getElementById("send-status");

        // MARKDOWN PREVIEW LOGIC
        const textArea = document.getElementById("mass-body");
        const subjectInput = document.getElementById("mass-subject");
        const previewArea = document.getElementById("preview-area");

        if (textArea && previewArea) {
            textArea.addEventListener("input", (e) => {
                const md = e.target.value;
                const html = marked.parse(md);
                previewArea.innerHTML = html;
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "/admin/login";
                return;
            }
            loadSubscribers();
            loadCampaigns();
        });

        async function loadSubscribers() {
            try {
                // Temporarily removing orderBy to avoid Index/Permission issues if not indexed
                const q = query(collection(db, "newsletter"));
                const snap = await getDocs(q);

                if (snap.empty) {
                    list.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">No hay suscriptores a칰n.</td></tr>`;
                    return;
                }

                subscribers = [];
                list.innerHTML = "";
                const countBadge = document.getElementById("sub-count");
                if (countBadge) countBadge.innerText = snap.size.toString();

                snap.forEach((d) => {
                    const data = d.data();
                    subscribers.push({ id: d.id, ...data });

                    const tr = document.createElement("tr");
                    tr.className = "border-b hover:bg-slate-50 transition";
                    tr.innerHTML = `
                        <td class="p-4 font-medium text-gray-900">${data.email}</td>
                        <td class="p-4 text-gray-500">${data.fecha ? new Date(data.fecha.seconds * 1000).toLocaleDateString() : "-"}</td>
                        <td class="p-4">
                            ${data.activo ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Activo</span>' : '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">Inactivo</span>'}
                        </td>
                        <td class="p-4 text-right">
                            <button class="delete-sub text-red-500 hover:text-red-700 font-bold text-xs bg-red-50 px-3 py-1.5 rounded transition" data-id="${d.id}">Eliminar</button>
                        </td>
                    `;
                    list.appendChild(tr);
                });

                // Attach events
                document.querySelectorAll(".delete-sub").forEach((btn) => {
                    btn.addEventListener("click", (e) =>
                        deleteSubscriber(e.target.dataset.id),
                    );
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-500">Error cargando datos.</td></tr>`;
            }
        }

        async function loadCampaigns() {
             try {
                const q = query(collection(db, "newsletter_campaigns"), orderBy("fecha", "desc"));
                const snap = await getDocs(q);

                if (snap.empty) {
                    campaignsList.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">No hay campa침as enviadas.</td></tr>`;
                    return;
                }

                campaigns = [];
                campaignsList.innerHTML = "";

                snap.forEach((d) => {
                    const data = d.data();
                    campaigns.push({ id: d.id, ...data });

                    const tr = document.createElement("tr");
                    tr.className = "border-b hover:bg-slate-50 transition";
                    // Using encodeURIComponent to safely store data in attribute is risky for large body, usually better to look up by ID
                    // We will look up by ID from the campaigns array
                    tr.innerHTML = `
                        <td class="p-4 font-bold text-gray-800">${data.asunto}</td>
                        <td class="p-4 text-gray-500 text-xs">${data.fecha ? new Date(data.fecha.seconds * 1000).toLocaleString() : "-"}</td>
                        <td class="p-4">
                             <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${data.enviados || 0} Emails</span>
                        </td>
                        <td class="p-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button class="reuse-camp p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Editar / Reutilizar" data-id="${d.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                </button>
                                <button class="resend-camp p-2 text-green-600 hover:bg-green-50 rounded-lg transition" title="Reenviar Ahora" data-id="${d.id}">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                </button>
                                <button class="delete-camp p-2 text-red-500 hover:bg-red-50 rounded-lg transition" title="Borrar Historial" data-id="${d.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    campaignsList.appendChild(tr);
                });

                // Attach events
                document.querySelectorAll(".reuse-camp").forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        const id = e.target.closest('button').dataset.id;
                        reuseCampaign(id);
                    });
                });
                document.querySelectorAll(".resend-camp").forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        const id = e.target.closest('button').dataset.id;
                        resendCampaign(id);
                    });
                });
                document.querySelectorAll(".delete-camp").forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        const id = e.target.closest('button').dataset.id;
                        deleteCampaign(id);
                    });
                });

             } catch (e) {
                console.error("Error loading campaigns:", e);
                // Fail silently or show error in table
             }
        }

        async function deleteSubscriber(id) {
            if (!confirm("쯉eguro que quer칠s eliminar a este suscriptor?"))
                return;
            try {
                await deleteDoc(doc(db, "newsletter", id));
                loadSubscribers();
            } catch (e) {
                alert("Error al eliminar");
            }
        }

         async function deleteCampaign(id) {
             if (!confirm("Se borrar치 este registro del historial. 쮺ontinuar?")) return;
             try {
                 const res = await fetch("/api/delete-campaign", {
                     method: "DELETE",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ campaignId: id })
                 });
                 
                 const data = await res.json();
                 
                 if (!res.ok) {
                     throw new Error(data.error || "Error al borrar");
                 }
                 
                 loadCampaigns();
             } catch(e) {
                 console.error("Delete error:", e);
                 alert("Error al borrar campa침a: " + e.message);
             }
         }

         function reuseCampaign(id) {
             const camp = campaigns.find(c => c.id === id);
             if(!camp) return;

             subjectInput.value = camp.asunto;
             textArea.value = camp.cuerpoOriginal || ""; // Assuming we save original markdown
             // Trigger preview
             textArea.dispatchEvent(new Event('input'));
             
             window.scrollTo({ top: 0, behavior: 'smooth'});
             alert("Contenido cargado en el editor.");
         }

         async function resendCampaign(id) {
             const camp = campaigns.find(c => c.id === id);
             if(!camp) return;

             if(!confirm(`Reenviar la campa침a "${camp.asunto}" a TODOS los ${subscribers.length} suscriptores?`)) return;

             // Call send logic with existing content
             await sendEmails(camp.asunto, camp.cuerpoOriginal);
         }

        // MASS EMAIL LOGIC
        btnSend?.addEventListener("click", async () => {
            const subject = subjectInput.value;
            const bodyMD = textArea.value;

            if (!subject || !bodyMD) return alert("Complet치 asunto y mensaje.");
            
            if (subscribers.length === 0) return alert("No hay suscriptores.");

            if (
                !confirm(
                    `쮼st치s seguro de enviar este email a ${subscribers.length} personas?`,
                )
            )
                return;

            await sendEmails(subject, bodyMD);
        });

        async function sendEmails(subject, bodyMD) {
            btnSend.disabled = true;
            btnSend.innerText = "Enviando...";
            statusText.classList.remove("hidden");
            statusText.innerText = "Iniciando env칤o masivo...";

            try {
                // Call the new Batch API
                const resp = await fetch("/api/send-newsletter", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        subject,
                        markdownBody: bodyMD
                    })
                });

                const result = await resp.json();

                if (!resp.ok) throw new Error(result.error || "Error en el servidor");

                // Save to Campaign History (Client side or move to server? Server didn't do it in my code, preserving client logic for now or adding to server?)
                // My server code didn't save the campaign to 'newsletter_campaigns'. 
                // It's better if I do it here for now to keep it consistent with the existing UI logic, 
                // OR I should have added it to the API. 
                // Use client side save for now as the API responsiblity was sending.
                
                await addDoc(collection(db, "newsletter_campaigns"), {
                    asunto: subject,
                    cuerpoOriginal: bodyMD,
                    fecha: serverTimestamp(),
                    enviados: result.sent,
                    errores: result.errors
                });
                
                loadCampaigns();

                alert(`Campa침a finalizada.\nEnviados: ${result.sent}\nErrores: ${result.errors}`);
                statusText.innerText = "Env칤o exitoso.";
            } catch (e) {
                console.error(e);
                alert("Hubo un error al procesar el env칤o: " + e.message);
                statusText.innerText = "Error en el env칤o.";
            } finally {
                btnSend.disabled = false;
                btnSend.innerText = "Enviar Campa침a";
            }
        }
    });
</script>

