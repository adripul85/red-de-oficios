---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Verificar Rubros - Admin">
    <div class="min-h-screen bg-slate-50 py-8 px-4">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h1 class="text-3xl font-black text-slate-800 mb-6">
                    üîç Verificar Rubros en Base de Datos
                </h1>
                
                <div class="mb-6">
                    <label class="block font-medium text-gray-700 mb-2">
                        Buscar rubro:
                    </label>
                    <input 
                        type="text" 
                        id="search-rubro" 
                        placeholder="Ej: Maquilladora, Pastelero, DJ"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    >
                </div>

                <button
                    id="btn-search"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-4"
                >
                    Buscar
                </button>

                <button
                    id="btn-list-all"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-4 ml-2"
                >
                    Listar Todos los Rubros
                </button>

                <div id="results" class="mt-8 hidden">
                    <h3 class="font-bold text-xl mb-4">Resultados:</h3>
                    <div id="output" class="bg-gray-900 text-green-400 p-6 rounded-lg font-mono text-sm whitespace-pre-wrap max-h-96 overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { db } from "../../firebase/client";
    import { collection, getDocs, query, where } from "firebase/firestore";

    document.addEventListener("astro:page-load", () => {
        const searchInput = document.getElementById("search-rubro") as HTMLInputElement;
        const btnSearch = document.getElementById("btn-search");
        const btnListAll = document.getElementById("btn-list-all");
        const results = document.getElementById("results");
        const output = document.getElementById("output");

        btnSearch?.addEventListener("click", async () => {
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert("Por favor ingresa un rubro a buscar");
                return;
            }

            results.classList.remove("hidden");
            output.innerHTML = "Buscando...\n";

            try {
                const profRef = collection(db, "profesionales");
                const snapshot = await getDocs(profRef);

                let found = 0;
                let professionals = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const rubros = data.rubros || [];
                    const rubroPrincipal = data.rubro_principal || "";
                    
                    // Buscar en rubros array
                    const matchInArray = rubros.some((r: string) => 
                        r.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    // Buscar en rubro_principal
                    const matchInPrincipal = rubroPrincipal.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    if (matchInArray || matchInPrincipal) {
                        found++;
                        professionals.push({
                            id: doc.id,
                            nombre: data.nombre,
                            rubro_principal: rubroPrincipal,
                            rubros: rubros,
                            email: data.email || "N/A"
                        });
                    }
                });

                output.innerHTML = `üîç B√öSQUEDA: "${searchTerm}"\n`;
                output.innerHTML += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                output.innerHTML += `‚úÖ Encontrados: ${found} profesionales\n\n`;

                if (found === 0) {
                    output.innerHTML += `‚ö†Ô∏è No se encontraron profesionales con el rubro "${searchTerm}"\n`;
                } else {
                    professionals.forEach((prof, index) => {
                        output.innerHTML += `\n${index + 1}. ${prof.nombre}\n`;
                        output.innerHTML += `   ID: ${prof.id}\n`;
                        output.innerHTML += `   Email: ${prof.email}\n`;
                        output.innerHTML += `   Rubro Principal: ${prof.rubro_principal}\n`;
                        output.innerHTML += `   Rubros: ${prof.rubros.join(", ")}\n`;
                    });
                }

            } catch (error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}\n`;
                console.error(error);
            }
        });

        btnListAll?.addEventListener("click", async () => {
            results.classList.remove("hidden");
            output.innerHTML = "Cargando todos los rubros...\n";

            try {
                const profRef = collection(db, "profesionales");
                const snapshot = await getDocs(profRef);

                const rubrosMap = new Map<string, number>();

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const rubros = data.rubros || [];
                    const rubroPrincipal = data.rubro_principal || "";
                    
                    // Contar rubro principal
                    if (rubroPrincipal) {
                        rubrosMap.set(rubroPrincipal, (rubrosMap.get(rubroPrincipal) || 0) + 1);
                    }
                    
                    // Contar rubros del array
                    rubros.forEach((rubro: string) => {
                        if (rubro) {
                            rubrosMap.set(rubro, (rubrosMap.get(rubro) || 0) + 1);
                        }
                    });
                });

                // Ordenar por cantidad
                const sortedRubros = Array.from(rubrosMap.entries())
                    .sort((a, b) => b[1] - a[1]);

                output.innerHTML = `üìä TODOS LOS RUBROS EN LA BASE DE DATOS\n`;
                output.innerHTML += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                output.innerHTML += `Total de rubros √∫nicos: ${sortedRubros.length}\n`;
                output.innerHTML += `Total de profesionales: ${snapshot.size}\n\n`;

                sortedRubros.forEach(([rubro, count]) => {
                    output.innerHTML += `${count.toString().padStart(3, ' ')} - ${rubro}\n`;
                });

            } catch (error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}\n`;
                console.error(error);
            }
        });
    });
</script>
