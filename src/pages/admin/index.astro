---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Panel de Administraci√≥n - Staff">
    <div class="min-h-screen bg-slate-50 py-8 px-4 font-sans">
        <div class="max-w-6xl mx-auto">
            <!-- HEADER -->
            <header
                class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden">
                <div class="relative z-10 flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-2xl">
                        üëÆ‚Äç‚ôÇÔ∏è
                    </div>
                    <div>
                        <h1
                            class="text-2xl font-black text-slate-800 tracking-tight">
                            Centro de Comando
                        </h1>
                        <p class="text-slate-500 text-sm font-medium">
                            Hola, <span id="staff-name" class="text-slate-800 font-bold">...</span>
                            <span
                                id="staff-role"
                                class="ml-2 bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider">...</span>
                        </p>
                    </div>
                </div>

                <div class="relative z-10">
                    <button
                        id="btn-logout-admin"
                        class="group flex items-center gap-2 px-5 py-2.5 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-all font-bold text-sm">
                        <span>Cerrar Sesi√≥n</span>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="2"
                            stroke="currentColor"
                            class="w-4 h-4 group-hover:translate-x-1 transition-transform">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"></path>
                        </svg>
                    </button>
                </div>

                <!-- Decorative Background Blob -->
                <div
                    class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-slate-50 rounded-full blur-3xl opacity-50 pointer-events-none">
                </div>
            </header>

            <!-- STATS GRID -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <!-- Users Stat -->
                <div
                    class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-5 hover:shadow-md transition-shadow">
                    <div
                        class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl shadow-sm">
                        üë•
                    </div>
                    <div>
                        <p
                            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">
                            Total Usuarios
                        </p>
                        <p
                            class="text-3xl font-black text-slate-800"
                            id="count-users">
                            ...
                        </p>
                    </div>
                </div>

                <!-- Reports Stat -->
                <div
                    class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-5 hover:shadow-md transition-shadow">
                    <div
                        class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-2xl shadow-sm">
                        ‚ö†Ô∏è
                    </div>
                    <div>
                        <p
                            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">
                            Reportes
                        </p>
                        <p
                            class="text-3xl font-black text-slate-800"
                            id="count-reports">
                            0
                        </p>
                    </div>
                </div>

                <!-- Finance Stat (Hidden by default) -->
                <div
                    id="finance-card"
                    class="bg-emerald-600 p-6 rounded-2xl shadow-sm border border-emerald-100 flex items-center gap-5 hidden relative overflow-hidden">
                    <div
                        class="relative z-10 w-14 h-14 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl shadow-inner">
                        üí∞
                    </div>
                    <div class="relative z-10">
                        <p
                            class="text-xs font-bold text-emerald-600/70 uppercase tracking-wider mb-1">
                            Facturaci√≥n
                        </p>
                        <p
                            class="text-3xl font-black text-emerald-700"
                            id="revenue">
                            $ 0
                        </p>
                    </div>
                    <div
                        class="absolute right-0 bottom-0 w-24 h-24 bg-emerald-200/20 rounded-full blur-xl">
                    </div>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <h2
                class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                <span class="w-1.5 h-6 bg-orange-500 rounded-full"></span>
                Acciones R√°pidas
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- NEWSLETTER -->
                <a
                    href="/admin/newsletter"
                    class="bg-gradient-to-br from-indigo-600 to-violet-600 text-white p-6 rounded-3xl shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üìß
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Newsletter
                        </h3>
                        <p
                            class="text-indigo-100 text-sm font-medium leading-relaxed opacity-90">
                            Gestionar suscriptores, campa√±as de email y
                            estad√≠sticas.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- USUARIOS -->
                <a
                    href="/admin/usuarios"
                    class="bg-gradient-to-br from-blue-500 to-cyan-500 text-white p-6 rounded-3xl shadow-lg hover:shadow-blue-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üîç
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Usuarios
                        </h3>
                        <p
                            class="text-blue-100 text-sm font-medium leading-relaxed opacity-90">
                            Ver perfiles, editar informaci√≥n y controlar
                            accesos.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- MENSAJES -->
                <a
                    href="/admin/mensajes"
                    class="bg-gradient-to-br from-emerald-500 to-teal-500 text-white p-6 rounded-3xl shadow-lg hover:shadow-emerald-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üí¨
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Mensajes
                        </h3>
                        <p
                            class="text-emerald-100 text-sm font-medium leading-relaxed opacity-90">
                            Buz√≥n de entrada, soporte t√©cnico y contacto
                            directo.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- DENUNCIAS -->
                <a
                    href="/admin/denuncias"
                    class="bg-gradient-to-br from-orange-500 to-red-500 text-white p-6 rounded-3xl shadow-lg hover:shadow-orange-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üö®
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Denuncias
                        </h3>
                        <p
                            class="text-orange-100 text-sm font-medium leading-relaxed opacity-90">
                            Moderaci√≥n de contenido, reportes de usuarios y
                            bloqueos.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- PAGOS -->
                <a
                    href="/admin/pagos"
                    class="bg-gradient-to-br from-pink-500 to-rose-500 text-white p-6 rounded-3xl shadow-lg hover:shadow-pink-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üí≥
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Pagos
                        </h3>
                        <p
                            class="text-pink-100 text-sm font-medium leading-relaxed opacity-90">
                            Historial de transacciones, planes y suscripciones.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- BLOG -->
                <a
                    href="/admin/blog"
                    class="bg-gradient-to-br from-amber-400 to-orange-400 text-white p-6 rounded-3xl shadow-lg hover:shadow-amber-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            ‚úçÔ∏è
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Blog
                        </h3>
                        <p
                            class="text-amber-100 text-sm font-medium leading-relaxed opacity-90">
                            Crear y editar art√≠culos, noticias y novedades.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- FORO -->
                <a
                    href="/foro"
                    class="bg-gradient-to-br from-slate-600 to-slate-800 text-white p-6 rounded-3xl shadow-lg hover:shadow-slate-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48 opacity-90 hover:opacity-100">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üèòÔ∏è
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Foro
                        </h3>
                        <p
                            class="text-slate-200 text-sm font-medium leading-relaxed opacity-90">
                            Ir a la comunidad, moderar temas y conversaciones.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- VALIDACIONES -->
                <a
                    href="/admin/validaciones"
                    class="bg-gradient-to-br from-violet-500 to-fuchsia-500 text-white p-6 rounded-3xl shadow-lg hover:shadow-violet-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            ‚úÖ
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Validaciones
                        </h3>
                        <p
                            class="text-violet-100 text-sm font-medium leading-relaxed opacity-90">
                            Revisar y aprobar documentos de nuevos
                            profesionales.
                        </p>

                        <!-- Dynamic Badge will be injected here via JS -->
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- FINANZAS (Admin Only) -->
                <a
                    href="/admin/finanzas"
                    id="admin-finanzas"
                    class="bg-gradient-to-br from-emerald-600 to-green-700 text-white p-6 rounded-3xl shadow-lg hover:shadow-emerald-500/30 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48 hidden">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm shadow-inner-white">
                            üí∞
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Finanzas
                        </h3>
                        <p
                            class="text-emerald-100 text-sm font-medium leading-relaxed opacity-90">
                            Gesti√≥n de saldos, billetera de la plataforma y
                            retiros.
                        </p>
                    </div>
                    <div
                        class="absolute -bottom-6 -right-6 w-40 h-40 bg-white/10 rounded-full blur-2xl group-hover:bg-white/20 transition-colors">
                    </div>
                </a>

                <!-- CONFIGURACI√ìN (Restricted) -->
                <a
                    href="/admin/configuracion"
                    id="admin-settings"
                    class="bg-white border-2 border-dashed border-slate-300 text-slate-400 p-6 rounded-3xl hover:border-slate-400 hover:bg-slate-50 hover:text-slate-500 hover:scale-[1.02] transition-all group relative overflow-hidden flex flex-col justify-between h-48 hidden">
                    <div class="relative z-10">
                        <div
                            class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:bg-slate-200 transition-colors">
                            ‚öôÔ∏è
                        </div>
                        <h3 class="font-black text-2xl tracking-tight mb-1">
                            Configuraci√≥n
                        </h3>
                        <p
                            class="text-sm font-medium leading-relaxed opacity-80">
                            Ajustes globales del sistema (Solo Admin).
                        </p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <script>
        import { auth, db } from "../../firebase/client";
        import { onAuthStateChanged, signOut } from "firebase/auth";
        import {
            doc,
            getDoc,
            collection,
            getCountFromServer,
            query,
            where,
            onSnapshot,
        } from "firebase/firestore";

        document.addEventListener("astro:page-load", () => {
            console.log("üöÄ [ADMIN] P√°gina cargada/navegada");

        let unsubscribe: (() => void) | null = null;
        let currentUser: any = null;

        document.addEventListener("astro:page-load", () => {
            console.log("üöÄ [ADMIN] P√°gina cargada/navegada");
            
            const user = window.currentUser || auth.currentUser;
            if (user) {
                initAdmin(user);
            } else {
                // Si no hay usuario en window, escuchamos el evento auth-state-ready
                document.addEventListener("auth-state-ready", (e: any) => {
                    if (e.detail) initAdmin(e.detail);
                    else window.location.href = "/ingresar";
                }, { once: true });

                // O el listener standard por si acaso (fallback)
                onAuthStateChanged(auth, (u) => {
                     if(u) initAdmin(u);
                     else if(!window.currentUser) window.location.href = "/ingresar";
                });
            }

            document.addEventListener("astro:before-preparation", () => {
                 if (unsubscribe) unsubscribe();
            }, { once: true });
            
            document.getElementById("btn-logout-admin")?.addEventListener("click", async () => {
                await signOut(auth);
                window.location.href = "/";
            });
        });

        async function initAdmin(user) {
             if(currentUser && currentUser.uid === user.uid) return; // Debounce
             currentUser = user;
             
             try {
                const docRef = doc(db, "profesionales", user.uid);
                const snap = await getDoc(docRef);

                if (!snap.exists()) {
                    window.location.href = "/";
                    return;
                }

                const data = snap.data();
                const rolRaw = data.rol || data.role || "profesional";
                const rolLimpio = String(rolRaw).toLowerCase().trim();

                if (
                    rolLimpio !== "admin" &&
                    rolLimpio !== "moderador" &&
                    rolLimpio !== "moderator"
                ) {
                    alert("‚õî ACCESO DENEGADO");
                    window.location.href = "/mi-perfil";
                    return;
                }

                const staffName = document.getElementById("staff-name");
                const staffRole = document.getElementById("staff-role");
                const financeCard = document.getElementById("finance-card");
                const adminSettings = document.getElementById("admin-settings");
                const adminFinanzas = document.getElementById("admin-finanzas");
                const countUsers = document.getElementById("count-users");

                if (staffName) staffName.textContent = data.nombre || user.email;
                if (staffRole) staffRole.textContent = rolLimpio.toUpperCase();

                if (rolLimpio === "admin") {
                    if (financeCard) financeCard.classList.remove("hidden");
                    if (adminSettings) {
                        adminSettings.classList.remove("hidden");
                        adminSettings.style.display = "flex";
                    }
                    if (adminFinanzas) {
                        adminFinanzas.classList.remove("hidden");
                        adminFinanzas.style.display = "flex";
                    }
                } else {
                    if (staffRole) {
                        staffRole.style.background = "#dbeafe";
                        staffRole.style.color = "#1e40af";
                    }
                }

                // Stats
                const coll = collection(db, "profesionales");
                const snapshotCount = await getCountFromServer(coll);
                if (countUsers) countUsers.textContent = snapshotCount.data().count.toString();

                // Validation Badge
                const validationsBtn = document.querySelector('a[href="/admin/validaciones"]');
                if (validationsBtn) {
                    const qValidations = query(
                        collection(db, "profesionales"),
                        where("validacion_estado", "==", "pendiente"),
                    );
                    if(unsubscribe) unsubscribe();
                    unsubscribe = onSnapshot(qValidations, (snapshot) => {
                        const count = snapshot.size;
                        let badge = validationsBtn.querySelector(".badge-notify");
                        if (count > 0) {
                            if (!badge) {
                                badge = document.createElement("span");
                                badge.className = "badge-notify";
                                validationsBtn.appendChild(badge);
                            }
                            // @ts-ignore
                            badge.innerText = count > 9 ? "+9" : count.toString();
                             // @ts-ignore
                            badge.style.display = "flex";
                        } else if (badge) {
                             // @ts-ignore
                            badge.style.display = "none";
                        }
                    });
                }
            } catch (e) {
                console.error("Error admin", e);
            }
        }

            // Cleanup on page transition
            document.addEventListener(
                "astro:before-preparation",
                () => {
                    if (unsubscribe) unsubscribe();
                },
                { once: true },
            );

            document
                .getElementById("btn-logout-admin")
                ?.addEventListener("click", async () => {
                    await signOut(auth);
                    window.location.href = "/";
                });
        }); // End of astro:page-load
    </script>

    <style>
        /* Custom Pulse Ring for Badges */
        .badge-notify {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: pulse-ring 2s infinite;
            z-index: 10;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</Layout>
