---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import { db } from '../../firebase/client';
import { collection, getDocs, orderBy, query } from 'firebase/firestore';

const reportes = [];
try {
  // Asumimos que la colecciÃ³n se llama "denuncias"
  const q = query(collection(db, "denuncias"), orderBy("fecha", "desc"));
  const snap = await getDocs(q);
  snap.forEach(doc => reportes.push({ id: doc.id, ...doc.data() }));
} catch (e) { console.log("Sin denuncias o falta colecciÃ³n"); }
---

<Layout title="Denuncias - Admin">
  
  <main class="container">
    <h1>ðŸš¨ Reportes y Denuncias</h1>
    <a href="/admin" class="btn-back">â¬… Volver</a>

    {reportes.length === 0 ? (
        <div class="empty-box">âœ… Todo tranquilo. No hay denuncias pendientes.</div>
    ) : (
        <div class="reports-grid">
            {reportes.map(r => (
                <div class="report-card">
                    <div class="report-header">
                        <strong>Denuncia contra:</strong> 
                        <a href={`/perfil?id=${r.profesionalId}`} target="_blank">{r.profesionalNombre || 'Ver Perfil'}</a>
                    </div>
                    <div class="report-body">
                        <p><strong>Motivo:</strong> {r.motivo}</p>
                        <p><strong>Detalle:</strong> "{r.descripcion}"</p>
                        <small>Reportado por: {r.denuncianteEmail || 'AnÃ³nimo'} el {new Date(r.fecha?.seconds * 1000).toLocaleDateString()}</small>
                    </div>
                    <div class="report-actions">
                        <button onclick={`borrarDenuncia('${r.id}')`}>Archivar</button>
                    </div>
                </div>
            ))}
        </div>
    )}
  </main>
</Layout>

<script>
    // Script simple para borrar denuncias (requiere implementar window.borrarDenuncia con deleteDoc)
    import { db } from '../../firebase/client';
    import { doc, deleteDoc } from 'firebase/firestore';
    
    window.borrarDenuncia = async (id) => {
        if(confirm("Â¿Archivar esta denuncia?")) {
            await deleteDoc(doc(db, "denuncias", id));
            window.location.reload();
        }
    }
</script>

<style>
    .container { max-width: 800px; margin: 40px auto; padding: 20px; font-family: sans-serif; }
    .empty-box { background: #f0fdf4; color: green; padding: 40px; text-align: center; border-radius: 8px; margin-top: 20px; }
    .btn-back { display: inline-block; margin-bottom: 20px; color: #333; }
    
    .reports-grid { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .report-card { background: white; border: 1px solid #fee2e2; border-left: 5px solid #ef4444; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .report-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1rem; }
    .report-header a { color: #2563eb; }
    .report-body p { margin: 5px 0; color: #333; }
    .report-body small { color: #666; font-size: 0.85rem; display: block; margin-top: 10px; }
    .report-actions { margin-top: 15px; text-align: right; }
    .report-actions button { background: #eee; border: none; padding: 5px 15px; cursor: pointer; border-radius: 4px; }
</style>