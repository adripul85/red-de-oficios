---
import Layout from "../../layouts/Layout.astro";
import { db } from "../../firebase/client";
import {
    collection,
    query,
    orderBy,
    limit,
    getDocs,
    where,
} from "firebase/firestore";

// OBTENER PAGOS REALES desde Firebase
let pagosRecientes = [];
let totalMes = 0;
let totalPendiente = 0;
let suscripcionesActivas = 0;

try {
    // Query real a pagos_historial
    const qPagos = query(
        collection(db, "pagos_historial"),
        orderBy("fecha", "desc"),
        limit(20),
    );

    const snapshot = await getDocs(qPagos);

    // Calcular fecha de inicio del mes actual
    const inicioMes = new Date();
    inicioMes.setDate(1);
    inicioMes.setHours(0, 0, 0, 0);

    pagosRecientes = snapshot.docs.map((doc) => {
        const data = doc.data();
        const fecha = data.fecha?.toDate ? data.fecha.toDate() : new Date();
        const monto = Number(data.monto) || 0;

        // Calcular total del mes
        if (fecha >= inicioMes && data.estado === "approved") {
            totalMes += monto;
        }

        // Calcular pendientes
        if (data.estado === "pending") {
            totalPendiente += monto;
        }

        return {
            id: data.mp_id || doc.id,
            usuario: data.usuarioId
                ? `Usuario ${data.usuarioId.substring(0, 8)}...`
                : "N/A",
            plan: data.plan || "N/A",
            monto: monto,
            estado: data.estado || "unknown",
            fecha: fecha.toLocaleDateString("es-AR"),
        };
    });

    // Contar suscripciones activas (profesionales con plan activo)
    const qSubs = query(
        collection(db, "profesionales"),
        where("plan", "in", ["mensual", "semestral", "experto"]),
    );
    const subsSnapshot = await getDocs(qSubs);
    suscripcionesActivas = subsSnapshot.size;
} catch (error) {
    console.error("Error cargando pagos:", error);
    // Fallback si hay error
    pagosRecientes = [
        {
            id: "ERROR",
            usuario: "Error cargando datos",
            plan: "N/A",
            monto: 0,
            estado: "pending",
            fecha: new Date().toLocaleDateString("es-AR"),
        },
    ];
}
---

<Layout title="Finanzas - DeOficios">
    <div class="admin-container">
        <header class="header-finance">
            <a href="/admin" class="btn-back">‚¨Ö Volver al Panel</a>
            <h1>Finanzas y Pagos üí∞</h1>
        </header>

        <div class="finance-grid">
            <div class="kpi-card income">
                <span class="kpi-icon">üí∏</span>
                <div class="kpi-info">
                    <small>Ingresos este Mes</small>
                    <strong>$ {totalMes.toLocaleString("es-AR")}</strong>
                </div>
            </div>

            <div class="kpi-card pending">
                <span class="kpi-icon">‚è≥</span>
                <div class="kpi-info">
                    <small>En proceso / Pendiente</small>
                    <strong>$ {totalPendiente.toLocaleString("es-AR")}</strong>
                </div>
            </div>

            <div class="kpi-card subscriptions">
                <span class="kpi-icon">üíé</span>
                <div class="kpi-info">
                    <small>Suscripciones Activas</small>
                    <strong>{suscripcionesActivas}</strong>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>√öltimas Transacciones</h3>
                <span class="text-sm text-gray-500"
                    >Total: {pagosRecientes.length}</span
                >
            </div>

            <table class="finance-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>ID Pago</th>
                        <th>Usuario</th>
                        <th>Plan</th>
                        <th>Monto</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {
                        pagosRecientes.length > 0 ? (
                            pagosRecientes.map((pago) => (
                                <tr>
                                    <td>{pago.fecha}</td>
                                    <td class="font-mono text-xs">{pago.id}</td>
                                    <td>{pago.usuario}</td>
                                    <td class="capitalize">{pago.plan}</td>
                                    <td class="font-bold">
                                        $ {pago.monto.toLocaleString("es-AR")}
                                    </td>
                                    <td>
                                        <span
                                            class={`status-pill ${pago.estado}`}
                                        >
                                            {pago.estado === "approved" &&
                                                "Aprobado"}
                                            {pago.estado === "rejected" &&
                                                "Rechazado"}
                                            {pago.estado === "pending" &&
                                                "Pendiente"}
                                            {pago.estado === "unknown" &&
                                                "Desconocido"}
                                        </span>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td
                                    colspan="6"
                                    class="text-center text-gray-500 py-8"
                                >
                                    No hay pagos registrados a√∫n
                                </td>
                            </tr>
                        )
                    }
                </tbody>
            </table>
        </div>
    </div>
</Layout>

<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        font-family: "Segoe UI", system-ui, sans-serif;
        background-color: #f8fafc;
        min-height: 100vh;
    }

    .header-finance {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .header-finance h1 {
        margin: 0;
        color: #1e293b;
        font-size: 1.8rem;
    }
    .btn-back {
        text-decoration: none;
        color: #64748b;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: color 0.2s;
    }
    .btn-back:hover {
        color: #1e293b;
    }

    /* KPIs */
    .finance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid #e2e8f0;
    }
    .kpi-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .kpi-card.income .kpi-icon {
        background: #dcfce7;
        color: #166534;
    }
    .kpi-card.pending .kpi-icon {
        background: #fef9c3;
        color: #854d0e;
    }
    .kpi-card.subscriptions .kpi-icon {
        background: #dbeafe;
        color: #1e40af;
    }

    .kpi-info small {
        display: block;
        color: #64748b;
        font-size: 0.85rem;
        margin-bottom: 5px;
    }
    .kpi-info strong {
        display: block;
        font-size: 1.5rem;
        color: #0f172a;
    }

    /* TABLE */
    .table-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    }
    .table-header {
        padding: 20px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .table-header h3 {
        margin: 0;
        color: #334155;
    }

    .finance-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    .finance-table th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-align: left;
        padding: 12px 20px;
        border-bottom: 1px solid #e2e8f0;
    }
    .finance-table td {
        padding: 12px 20px;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
    }
    .finance-table tr:last-child td {
        border-bottom: none;
    }

    .status-pill {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .status-pill.approved {
        background: #dcfce7;
        color: #166534;
    }
    .status-pill.rejected {
        background: #fee2e2;
        color: #991b1b;
    }
    .status-pill.pending {
        background: #ffedd5;
        color: #9a3412;
    }
    .status-pill.unknown {
        background: #f1f5f9;
        color: #64748b;
    }

    .capitalize {
        text-transform: capitalize;
    }

    .text-center {
        text-align: center;
    }

    .text-gray-500 {
        color: #64748b;
    }

    .py-8 {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .finance-table {
            display: block;
            overflow-x: auto;
        }
    }
</style>
