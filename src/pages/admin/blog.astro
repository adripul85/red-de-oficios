---
import Layout from "../../layouts/Layout.astro";
import { db } from "../../firebase/client";
import { collection, getDocs } from "firebase/firestore";

// Simple fetch (only for SSR if needed, but we'll do client-side for dynamic)
---

<Layout title="Editor de Blog - Admin">
    <div class="blog-container">
        <header class="header-row">
            <h1>DeOficios<span class="text-orange">.com.ar</span></h1>
            <div>
                <a href="/admin" class="btn-back">‚¨Ö Volver</a>
            </div>
        </header>

        <div class="main-layout">
            <!-- COLUMNA IZQUIERDA: EDITOR -->
            <form id="blog-form" class="editor-column">
                <div class="form-group">
                    <label>T√≠tulo del Art√≠culo (H1)</label>
                    <input
                        type="text"
                        id="post-title"
                        placeholder="Ej: Cu√°nto cuesta un plomero en 2026"
                        required
                    />
                </div>

                <div class="form-group">
                    <label>URL Amigable (Slug)</label>
                    <input
                        type="text"
                        id="post-slug"
                        class="input-readonly"
                        placeholder="se-genera-automaticamente"
                        readonly
                    />
                </div>

                <div class="row-group">
                    <div class="form-group half">
                        <label>Categor√≠a</label>
                        <select id="post-category">
                            <option value="consejos">üí° Consejos</option>
                            <option value="noticias">üì∞ Noticias</option>
                            <option value="historias">üöÄ Historias</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label>Autor</label>
                        <input
                            type="text"
                            id="post-author"
                            value="Equipo DeOficios"
                        />
                    </div>
                </div>

                <div class="form-group">
                    <label>Imagen Principal (URL)</label>
                    <input
                        type="text"
                        id="post-image"
                        placeholder="https://..."
                    />
                </div>

                <!-- KEYWORDS SECTION -->
                <div class="form-group">
                    <label>üîë Keywords / Palabras Clave (SEO)</label>
                    <div class="keywords-input-container">
                        <input
                            type="text"
                            id="keyword-input"
                            placeholder="Escribe y presiona ENTER..."
                        />
                        <button
                            type="button"
                            id="btn-add-keyword"
                            class="btn-add">+</button
                        >
                    </div>
                    <div id="keywords-list" class="keywords-container">
                        <!-- Tags will appear here -->
                    </div>
                    <!-- Hidden input to store the array for form submission -->
                    <input type="hidden" id="post-keywords-json" value="[]" />
                </div>

                <div class="form-group">
                    <label>Resumen Corto (Meta Description)</label>
                    <textarea
                        id="post-description"
                        rows="3"
                        placeholder="Lo que aparece en Google debajo del t√≠tulo..."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label>
                        Contenido (Markdown Activo)
                        <a
                            href="https://www.markdownguide.org/cheat-sheet/"
                            target="_blank"
                            class="help-link">Ver gu√≠a markdown</a
                        >
                    </label>
                    <textarea
                        id="post-content"
                        rows="12"
                        placeholder="# Usa numeral para t√≠tulos
**Usa asteriscos para negrita**
- Usa guiones para listas"
                    ></textarea>
                </div>

                <button type="submit" id="btn-publish" class="btn-publish">
                    ‚úèÔ∏è Publicar Art√≠culo
                </button>
                <p id="feedback" class="feedback-msg"></p>
            </form>

            <!-- COLUMNA DERECHA: PREVIEW Y LISTA -->
            <aside class="sidebar-column">
                <!-- PREVIEWS -->
                <div class="preview-card">
                    <label>Vista previa de imagen:</label>
                    <div class="image-preview-box">
                        <img
                            id="preview-img-el"
                            src=""
                            alt="Preview"
                            class="hidden"
                        />
                        <span id="preview-placeholder">üñºÔ∏è Preview</span>
                    </div>
                </div>

                <div class="preview-card">
                    <label>Vista previa del texto:</label>
                    <div id="text-preview" class="text-preview-box">
                        <em>Escribe para ver la vista previa...</em>
                    </div>
                </div>

                <!-- LISTA DE ARTICULOS -->
                <div class="published-section">
                    <h3>üìö Art√≠culos Publicados</h3>
                    <div id="posts-list" class="posts-list-container">
                        <p class="loading-text">Cargando...</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</Layout>

<script>
    import { db, auth } from "../../firebase/client";
    import {
        collection,
        addDoc,
        getDocs,
        orderBy,
        query,
        serverTimestamp,
        deleteDoc,
        doc,
        getDoc,
        updateDoc,
    } from "firebase/firestore";
    import { onAuthStateChanged } from "firebase/auth";

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [ADMIN-BLOG] P√°gina cargada/navegada");

        const form = document.getElementById("blog-form") as HTMLFormElement;
        const postsList = document.getElementById("posts-list");
        const feedback = document.getElementById("feedback");

        // Inputs
        const titleInput = document.getElementById(
            "post-title",
        ) as HTMLInputElement;
        const slugInput = document.getElementById(
            "post-slug",
        ) as HTMLInputElement;
        const imageInput = document.getElementById(
            "post-image",
        ) as HTMLInputElement;
        const contentInput = document.getElementById(
            "post-content",
        ) as HTMLTextAreaElement;
        const keywordInput = document.getElementById(
            "keyword-input",
        ) as HTMLInputElement;
        const keywordsList = document.getElementById("keywords-list");
        const keywordsJson = document.getElementById(
            "post-keywords-json",
        ) as HTMLInputElement;

        // Previews
        const previewImgEl = document.getElementById(
            "preview-img-el",
        ) as HTMLImageElement;
        const previewPlaceholder = document.getElementById(
            "preview-placeholder",
        );
        const textPreview = document.getElementById("text-preview");

        // State
        let keywords = [];
        let editingId = null;

        // 1. AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = "/";
            loadPosts();
        });

        // 2. SLUG AUTOMATION & PREVIEWS
        titleInput?.addEventListener("input", (e) => {
            const val = (e.target as HTMLInputElement).value;
            // Simple slugify
            const slug = val
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, "") // Remove special chars
                .replace(/[\s_-]+/g, "-") // Replace spaces with dash
                .replace(/^-+|-+$/g, "");
            if (slugInput) (slugInput as HTMLInputElement).value = slug;

            updateTextPreview();
        });

        contentInput?.addEventListener("input", updateTextPreview);

        function updateTextPreview() {
            if (!textPreview) return;
            const title =
                (titleInput as HTMLInputElement).value || "Sin t√≠tulo";
            if (
                title === "Sin t√≠tulo" &&
                !(contentInput as HTMLTextAreaElement).value
            ) {
                textPreview.innerHTML =
                    "<em>Escribe para ver la vista previa...</em>";
                return;
            }
            textPreview.innerHTML = `<strong>${title}</strong><br/><br/>${(contentInput as HTMLTextAreaElement).value.substring(0, 100)}...`;
        }

        imageInput?.addEventListener("input", (e) => {
            const url = (e.target as HTMLInputElement).value;
            if (url) {
                previewImgEl.src = url;
                previewImgEl.classList.remove("hidden");
                previewPlaceholder.classList.add("hidden");
            } else {
                previewImgEl.classList.add("hidden");
                previewPlaceholder.classList.remove("hidden");
            }
        });

        // 3. KEYWORDS LOGIC
        keywordInput?.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === ",") {
                e.preventDefault();
                addKeyword();
            }
        });
        document
            .getElementById("btn-add-keyword")
            ?.addEventListener("click", addKeyword);

        function addKeyword() {
            const val = (keywordInput as HTMLInputElement).value.trim();
            if (val && !keywords.includes(val)) {
                keywords.push(val);
                renderKeywords();
                (keywordInput as HTMLInputElement).value = "";
            }
        }

        function removeKeyword(tag) {
            keywords = keywords.filter((k) => k !== tag);
            renderKeywords();
        }

        // Expose to window for inline onclicks
        (window as any).removeKeyword = removeKeyword;

        function renderKeywords() {
            keywordsList.innerHTML = "";
            keywords.forEach((tag) => {
                const span = document.createElement("span");
                span.className = "keyword-tag";
                span.innerHTML = `${tag} <button onclick="removeKeyword('${tag}')">√ó</button>`;
                keywordsList.appendChild(span);
            });
            (keywordsJson as HTMLInputElement).value = JSON.stringify(keywords);
        }

        // 4. PUBLISH (NOW USING SPANISH KEYS & 'blog' COLLECTION)
        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = document.getElementById("btn-publish");
            btn.disabled = true;
            btn.textContent = editingId ? "Actualizando..." : "Publicando...";

            try {
                const docData = {
                    titulo: (titleInput as HTMLInputElement).value,
                    slug: (slugInput as HTMLInputElement).value,
                    contenido: (contentInput as HTMLTextAreaElement).value,
                    resumen: (
                        document.getElementById(
                            "post-description",
                        ) as HTMLTextAreaElement
                    ).value,
                    imagen: (imageInput as HTMLInputElement).value,
                    categoria: (
                        document.getElementById(
                            "post-category",
                        ) as HTMLSelectElement
                    ).value,
                    autor: (
                        document.getElementById(
                            "post-author",
                        ) as HTMLInputElement
                    ).value,
                    keywords: keywords,
                    fecha: serverTimestamp(), // Update timestamp on edit? Maybe yes to bump it up or keep original? Let's bump it.
                };

                if (editingId) {
                    await updateDoc(doc(db, "blog", editingId), docData);
                    feedback.textContent = "‚úÖ Actualizado con √©xito";
                    editingId = null;
                    btn.innerHTML = "‚úèÔ∏è Publicar Art√≠culo";
                } else {
                    await addDoc(collection(db, "blog"), docData);
                    feedback.textContent = "‚úÖ Publicado con √©xito";
                }

                feedback.style.color = "green";
                form.reset();
                keywords = [];
                renderKeywords();

                // Reset previews
                previewImgEl.classList.add("hidden");
                previewPlaceholder.classList.remove("hidden");
                textPreview.innerHTML =
                    "<em>Escribe para ver la vista previa...</em>";

                loadPosts();
            } catch (error) {
                console.error(error);
                feedback.textContent = "‚ùå Error: " + error.message;
                feedback.style.color = "red";
            } finally {
                btn.disabled = false;
                if (!editingId) btn.innerHTML = "‚úèÔ∏è Publicar Art√≠culo";
            }
        });

        // 5. LIST & DELETE (NOW USING SPANISH KEYS)
        async function loadPosts() {
            postsList.innerHTML = "<p>Cargando posts...</p>";
            try {
                // Updated to 'blog' and 'fecha'
                const q = query(
                    collection(db, "blog"),
                    orderBy("fecha", "desc"),
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    postsList.innerHTML = "<p>No hay art√≠culos publicados.</p>";
                    return;
                }

                let html = "";
                snapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    const id = docSnap.id;
                    // 'fecha' instead of 'date_created'
                    const date = p.fecha
                        ? new Date(p.fecha.seconds * 1000).toLocaleDateString()
                        : "-";

                    // Fields renamed: imagen, titulo, categoria
                    html += `
                    <div class="post-item">
                        <img src="${p.imagen || "https://via.placeholder.com/50"}" alt="Thumb" class="post-thumb" />
                        <div class="post-info">
                            <h4>${p.titulo}</h4>
                            <span class="post-meta">${date} ‚Ä¢ ${p.categoria}</span>
                        </div>
                        <button class="btn-edit" onclick="editPost('${id}')">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="deletePost('${id}')">üóëÔ∏è</button>
                    </div>
                `;
                });
                postsList.innerHTML = html;
            } catch (e) {
                console.error("Error loading posts:", e);
                postsList.innerHTML =
                    "<p class='error'>Error al cargar (Ver consola)</p>";
            }
        }

        (window as any).deletePost = async (id) => {
            if (!confirm("¬øSeguro que quieres borrar este post?")) return;
            try {
                await deleteDoc(doc(db, "blog", id));
                loadPosts();
            } catch (e) {
                alert("Error al borrar: " + e.message);
            }
        };

        (window as any).editPost = async (id) => {
            try {
                const docSnap = await getDoc(doc(db, "blog", id));
                if (!docSnap.exists()) {
                    alert("El post no existe");
                    return;
                }
                const data = docSnap.data();
                editingId = id;

                // Populate form
                (titleInput as HTMLInputElement).value = data.titulo;
                (slugInput as HTMLInputElement).value = data.slug;
                (contentInput as HTMLTextAreaElement).value = data.contenido;
                (
                    document.getElementById(
                        "post-description",
                    ) as HTMLTextAreaElement
                ).value = data.resumen;
                (imageInput as HTMLInputElement).value = data.imagen;
                (
                    document.getElementById(
                        "post-category",
                    ) as HTMLSelectElement
                ).value = data.categoria;
                (
                    document.getElementById("post-author") as HTMLInputElement
                ).value = data.autor;

                // Keywords
                keywords = data.keywords || [];
                renderKeywords();

                // Update UI
                document.getElementById("btn-publish").innerHTML =
                    "üíæ Actualizar Art√≠culo";
                window.scrollTo({ top: 0, behavior: "smooth" });

                // Trigger events
                imageInput.dispatchEvent(new Event("input"));
                updateTextPreview();
            } catch (e) {
                console.error(e);
                alert("Error al cargar post");
            }
        };
    }); // End of astro:page-load
</script>

<style>
    :root {
        --primary: #f97316; /* Orange */
        --primary-hover: #ea580c;
        --bg-gray: #f3f4f6;
        --border-color: #e5e7eb;
    }

    .blog-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: "Segoe UI", system-ui, sans-serif;
        color: #374151;
    }

    /* HEADER */
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .header-row h1 {
        font-size: 1.5rem;
        margin: 0;
        color: #111827;
    }
    .text-orange {
        color: var(--primary);
    }
    .btn-back {
        text-decoration: none;
        color: #6b7280;
        font-size: 0.9rem;
    }

    /* LAYOUT */
    .main-layout {
        display: grid;
        grid-template-columns: 1fr 300px; /* Editor | Sidebar */
        gap: 40px;
    }

    /* EDITOR STYLES */
    .editor-column {
        background: white;
        padding: 20px;
        border-radius: 8px; /* Screenshot styling looks flat but clean */
    }

    .form-group {
        margin-bottom: 20px;
    }
    .row-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    .half {
        flex: 1;
        margin-bottom: 0;
    }

    label {
        display: block;
        font-weight: 700;
        font-size: 0.85rem;
        margin-bottom: 6px;
        color: #1f2937;
    }
    .help-link {
        font-weight: 400;
        font-size: 0.75rem;
        color: var(--primary);
        float: right;
        text-decoration: none;
    }

    input,
    select,
    textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box; /* Important fix */
    }
    input:focus,
    select:focus,
    textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1);
    }

    .input-readonly {
        background-color: #f3f4f6;
        color: #6b7280;
        cursor: not-allowed;
    }

    /* KEYWORDS */
    .keywords-input-container {
        display: flex;
        gap: 5px;
    }
    .btn-add {
        background: #374151;
        color: white;
        border: none;
        border-radius: 6px;
        width: 40px;
        font-size: 1.2rem;
        cursor: pointer;
    }
    .keywords-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 8px;
    }
    .keyword-tag {
        background: #e5e7eb;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .keyword-tag button {
        border: none;
        background: none; /* transparent */
        font-weight: bold;
        color: #666;
        cursor: pointer;
        padding: 0;
        font-size: 1rem;
        line-height: 1;
    }
    .keyword-tag button:hover {
        color: red;
    }

    /* BUTTONS */
    .btn-publish {
        width: 100%;
        background: var(--primary);
        color: white;
        font-weight: bold;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
    }
    .btn-publish:hover {
        background: var(--primary-hover);
    }
    .btn-publish:disabled {
        background: #fdba74;
        cursor: not-allowed;
    }

    .feedback-msg {
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
        font-size: 0.9rem;
    }

    /* SIDEBAR */
    .sidebar-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .preview-card,
    .published-section {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
    }

    .image-preview-box {
        width: 100%;
        height: 150px;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        overflow: hidden;
        color: #9ca3af;
    }
    .image-preview-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .text-preview-box {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        color: #4b5563;
        min-height: 80px;
        max-height: 200px;
        overflow-y: auto;
    }

    /* POST LIST ITEM */
    .posts-list-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .post-item {
        display: flex;
        gap: 10px;
        align-items: center;
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 10px;
    }
    .post-item:last-child {
        border-bottom: none;
    }

    .post-thumb {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        object-fit: cover;
        background: #eee;
    }
    .post-info {
        flex: 1;
    }
    .post-info h4 {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.2;
        color: #111827;
    }
    .post-meta {
        font-size: 0.75rem;
        color: #6b7280;
    }
    .btn-delete {
        background: none;
        border: none;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    .btn-delete:hover {
        opacity: 1;
    }

    @media (max-width: 768px) {
        .main-layout {
            grid-template-columns: 1fr;
        }
        .sidebar-column {
            order: 1;
        }
    }
</style>
