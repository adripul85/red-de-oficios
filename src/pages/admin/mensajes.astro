---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Mensajes - Admin">
    <div class="admin-container">
        <header class="header-msg">
<a href="/admin" class="btn-back">‚¨Ö Volver</a>
            <h1>Buz√≥n de Mensajes üì©</h1>
        </header>

        <div id="msg-list" class="msg-grid">
            <p class="text-center text-gray-500 col-span-full">
                Cargando mensajes...
            </p>
        </div>
    </div>
</Layout>

<style>
    .admin-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
        font-family: sans-serif;
    }
    .header-msg {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
    }
    .btn-back {
        text-decoration: none;
        color: #666;
        font-weight: bold;
        background: #eee;
        padding: 8px 16px;
        border-radius: 8px;
    }

    .msg-grid {
        display: grid;
        gap: 20px;
    }
    .msg-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 5px solid #3b82f6;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .msg-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #666;
    }
    .msg-subject {
        font-size: 1.1rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 8px;
    }
    .msg-body {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        color: #334155;
        line-height: 1.5;
        font-style: italic;
    }
    .msg-actions {
        margin-top: 15px;
        text-align: right;
    }
    .btn-delete {
        color: #ef4444;
        background: none;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.8rem;
    }
</style>

<script>
    import { db, auth } from "../../firebase/client";
    import {
        collection,
        getDocs,
        getDoc,
        orderBy,
        query,
        deleteDoc,
        doc,
    } from "firebase/firestore";
    import { onAuthStateChanged } from "firebase/auth";

document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [ADMIN-MENSAJES] P√°gina cargada/navegada");

        const list = document.getElementById("msg-list");

        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = "/admin/login";
            else {
                // Timeout de seguridad
                setTimeout(() => {
                    if (list && list.innerHTML.includes("Cargando")) {
list.innerHTML = `<div class="text-center p-10 bg-red-50 rounded-xl"><h3 class="text-red-600">‚ö†Ô∏è Error</h3><p>No se pudieron cargar los mensajes. <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded mt-4">Reintentar</button></p></div>`;
                    }
                }, 5000);
                loadMessages();
            }
        });

        async function loadMessages() {
            try {
                console.log(
"üì• [ADMIN-MENSAJES] Verificando permisos de admin...",
                );

                // Verificar que el usuario sea admin
                const user = auth.currentUser;
                if (!user) {
                    console.error(
"‚ùå [ADMIN-MENSAJES] No hay usuario autenticado",
                    );
                    throw new Error("No autenticado");
                }

                const userDoc = await getDoc(
                    doc(db, "profesionales", user.uid),
                );
if (!userDoc.exists() || userDoc.data().rol !== "admin") {
                    console.error("‚ùå [ADMIN-MENSAJES] Usuario no es admin");
                    list.innerHTML = `<div class="text-center p-10 bg-red-50 rounded-xl"><h3 class="text-red-600">‚õî Acceso Denegado</h3><p>No tienes permisos de administrador.</p></div>`;
                    return;
                }

                console.log(
"‚úÖ [ADMIN-MENSAJES] Usuario admin verificado, cargando mensajes...",
                );

                const q = query(
                    collection(db, "mensajes_web"),
                    orderBy("fecha", "desc"),
                );
const snap = await getDocs(q);

                console.log(
                    `‚úÖ [ADMIN-MENSAJES] Cargados ${snap.size} mensajes`,
                );

                if (snap.empty) {
                    // @ts-ignore
list.innerHTML = `<div class="text-center p-10 bg-gray-50 rounded-xl"><h3 class="text-gray-600">üì≠ Sin mensajes</h3><p>No hay mensajes de contacto a√∫n.</p></div>`;
                    return;
                }

                // @ts-ignore
list.innerHTML = "";
                snap.forEach((d) => {
                    const data = d.data();
                    const card = document.createElement("div");
                    card.className =
                        "bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition";
                    card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">${data.nombre}</h3>
<p class="text-sm text-gray-500">${data.email} ‚Ä¢ ${data.telefono || "Sin tel√©fono"}</p>
                        </div>
                        <span class="text-xs text-gray-400">${data.fecha ? new Date(data.fecha.seconds * 1000).toLocaleDateString() : "Sin fecha"}</span>
                    </div>
                    <p class="text-gray-700">${data.mensaje}</p>
                `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error(
                    "‚ùå [ADMIN-MENSAJES] Error cargando mensajes:",
                    error,
                );
                // @ts-ignore
                list.innerHTML = `<div class="text-center p-10 bg-red-50 rounded-xl"><h3 class="text-red-600">‚ö†Ô∏è Error</h3><p>${error.message || "Error desconocido"}</p><button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded mt-4">Reintentar</button></div>`;
            }
        }

        // @ts-ignore
        window.deleteMsg = async (id) => {
if (confirm("¬øEliminar este mensaje?")) {
                await deleteDoc(doc(db, "mensajes_web", id));
                loadMessages();
            }
        };
    }); // End of astro:page-load
</script>
