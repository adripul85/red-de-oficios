---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Mensajes - Admin">
    <div class="admin-container">
        <header class="header-msg">
            <a href="/admin" class="btn-back">‚¨Ö Volver</a>
            <h1>Buz√≥n de Mensajes üì©</h1>
        </header>

        <div id="msg-list" class="msg-grid">
            <p class="text-center text-gray-500 col-span-full">
                Cargando mensajes...
            </p>
        </div>
    </div>
</Layout>

<style>
    .admin-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
        font-family: sans-serif;
    }
    .header-msg {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
    }
    .btn-back {
        text-decoration: none;
        color: #666;
        font-weight: bold;
        background: #eee;
        padding: 8px 16px;
        border-radius: 8px;
    }

    .msg-grid {
        display: grid;
        gap: 20px;
    }
    .msg-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 5px solid #3b82f6;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .msg-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #666;
    }
    .msg-subject {
        font-size: 1.1rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 8px;
    }
    .msg-body {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        color: #334155;
        line-height: 1.5;
        font-style: italic;
    }
    .msg-actions {
        margin-top: 15px;
        text-align: right;
    }
    .btn-delete {
        color: #ef4444;
        background: none;
        border: none;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.8rem;
    }
</style>

<script>
    import { db, auth } from "../../firebase/client";
    import {
        collection,
        getDocs,
        getDoc,
        orderBy,
        query,
        deleteDoc,
        doc,
    } from "firebase/firestore";
    import { onAuthStateChanged } from "firebase/auth";

    declare global {
        interface Window {
            deleteMsg: (id: string) => Promise<void>;
            toggleReply: (id: string) => void;
            sendReply: (
                id: string,
                email: string,
                nombre: string,
            ) => Promise<void>;
        }
    }

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [ADMIN-MENSAJES] P√°gina cargada/navegada");

        const list = document.getElementById("msg-list");

        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = "/admin/login";
            else {
                // Timeout de seguridad
                setTimeout(() => {
                    if (list && list.innerHTML.includes("Cargando")) {
                        list.innerHTML = `<div class="text-center p-10 bg-red-50 rounded-xl"><h3 class="text-red-600">‚ö†Ô∏è Error</h3><p>No se pudieron cargar los mensajes. <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded mt-4">Reintentar</button></p></div>`;
                    }
                }, 5000);
                loadMessages();
            }
        });

        async function loadMessages() {
            try {
                console.log(
                    "üì• [ADMIN-MENSAJES] Verificando permisos de admin...",
                );

                // Verificar que el usuario sea admin
                const user = auth.currentUser;
                if (!user) {
                    console.error(
                        "‚ùå [ADMIN-MENSAJES] No hay usuario autenticado",
                    );
                    throw new Error("No autenticado");
                }

                const userDoc = await getDoc(
                    doc(db, "profesionales", user.uid),
                );
                const dataUser = userDoc.data();
                const rol = (
                    dataUser?.rol ||
                    dataUser?.role ||
                    ""
                ).toLowerCase();

                if (!userDoc.exists() || rol !== "admin") {
                    console.error("‚ùå [ADMIN-MENSAJES] Usuario no es admin");
                    if (list)
                        list.innerHTML = `<div class="text-center p-10 bg-red-50 rounded-xl"><h3 class="text-red-600">‚õî Acceso Denegado</h3><p>No tienes permisos de administrador.</p></div>`;
                    return;
                }

                console.log(
                    "‚úÖ [ADMIN-MENSAJES] Usuario admin verificado, cargando mensajes...",
                );

                const q = query(
                    collection(db, "mensajes_web"),
                    orderBy("fecha", "desc"),
                );

                // Re-obtener el elemento 'list' aqu√≠ para asegurar que referenciamos el nodo actual del DOM en Astro
                const list = document.getElementById("msg-list");

                const snap = await getDocs(q);

                console.log(
                    `‚úÖ [ADMIN-MENSAJES] Cargados ${snap.size} mensajes`,
                );

                if (snap.empty) {
                    // @ts-ignore
                    if (list)
                        list.innerHTML = `<div class="text-center p-10 bg-gray-50 rounded-xl"><h3 class="text-gray-600">üì≠ Sin mensajes</h3><p>No hay mensajes de contacto a√∫n.</p></div>`;
                    return;
                }

                // @ts-ignore
                if (list) list.innerHTML = "";
                snap.forEach((d) => {
                    const data = d.data();
                    const id = d.id;
                    const card = document.createElement("div");
                    card.className =
                        "bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition card-mensaje";
                    card.id = `msg-${id}`;
                    card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">${data.nombre}</h3>
                            <p class="text-sm text-gray-500">${data.email} ‚Ä¢ ${data.telefono || "Sin tel√©fono"}</p>
                        </div>
                        <span class="text-xs text-gray-400">${data.fecha ? new Date(data.fecha.seconds * 1000).toLocaleDateString() : "Sin fecha"}</span>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg mb-4 italic text-gray-700 border-l-4 border-blue-500">
                        "${data.mensaje}"
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <button onclick="window.deleteMsg('${id}')" class="text-red-500 hover:text-red-700 text-sm font-bold transition">üóëÔ∏è Eliminar</button>
                        <button onclick="window.toggleReply('${id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">‚úâÔ∏è Responder</button>
                    </div>

                    <!-- REPLY FORM (HIDDEN) -->
                    <div id="reply-container-${id}" class="mt-4 pt-4 border-t border-gray-100 hidden animate-fade-in">
                        <textarea id="reply-text-${id}" class="w-full border p-3 rounded-lg text-sm h-32 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button onclick="window.toggleReply('${id}')" class="text-gray-500 px-3 py-1 text-sm">Cancelar</button>
                            <button onclick="window.sendReply('${id}', '${data.email}', '${data.nombre}')" id="btn-reply-${id}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded-lg text-sm font-bold transition">Enviar Respuesta</button>
                        </div>
                    </div>
                `;
                    if (list) list.appendChild(card);
                });
            } catch (error: any) {
                console.error(
                    "‚ùå [ADMIN-MENSAJES] Error cargando mensajes:",
                    error,
                );
                // Re-obtener el elemento por seguridad en Astro
                const listEl = document.getElementById("msg-list");
                if (listEl)
                    listEl.innerHTML = `<div class="text-center p-10 bg-red-50 rounded-xl"><h3 class="text-red-600">‚ö†Ô∏è Error de Permisos</h3><p>${error.message || "Error desconocido"}</p><p class="text-xs mt-2 text-gray-500">Aseg√∫rate de tener rol de administrador.</p><button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded mt-4">Reintentar</button></div>`;
            }
        }

        // @ts-ignore
        window.deleteMsg = async (id) => {
            if (confirm("¬øEliminar este mensaje?")) {
                try {
                    await deleteDoc(doc(db, "mensajes_web", id));
                    loadMessages();
                } catch (e) {
                    alert("Error eliminando mensaje");
                }
            }
        };

        // @ts-ignore
        window.toggleReply = (id) => {
            const container = document.getElementById(`reply-container-${id}`);
            container?.classList.toggle("hidden");
        };

        // @ts-ignore
        window.sendReply = async (id, email, nombre) => {
            // @ts-ignore
            const msg = document.getElementById(`reply-text-${id}`).value;
            const btn = document.getElementById(`btn-reply-${id}`);

            if (msg.length < 10) return alert("La respuesta es muy corta.");

            if (btn) {
                btn.innerText = "Enviando...";
                // @ts-ignore
                btn.disabled = true;
            }

            try {
                const response = await fetch("/api/send-email", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        to: email,
                        subject: `Red de Oficios: Respuesta a tu consulta`,
                        html: `
                            <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #eee; border-radius: 15px; padding: 30px;">
                                <h1 style="color: #ea580c;">Hola ${nombre} üëã</h1>
                                <p style="font-size: 16px; color: #333; line-height: 1.6;">
                                    Recibimos tu consulta y aqu√≠ tienes nuestra respuesta:
                                </p>
                                <div style="background: #f9fafb; padding: 20px; border-radius: 10px; font-style: italic; color: #444; border-left: 4px solid #ea580c; margin: 20px 0;">
                                    "${msg}"
                                </div>
                                <p style="font-size: 14px; color: #666;">
                                    Si tienes m√°s dudas, no dudes en contactarnos nuevamente.
                                </p>
                                <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">
                                <p style="font-size: 12px; color: #aaa; text-align: center;">
                                    ¬© 2026 DeOficios.com.ar
                                </p>
                            </div>
                        `,
                    }),
                });

                const res = await response.json();
                if (res.success) {
                    alert("‚úÖ Respuesta enviada con √©xito");
                    // Opcionalmente marcar como respondido en la DB o simplemente cerrar
                    window.toggleReply(id);
                } else {
                    alert(
                        "‚ùå Error: " +
                            (res.error?.message || "No se pudo enviar"),
                    );
                }
            } catch (e) {
                alert("Ocurri√≥ un error inesperado.");
            } finally {
                if (btn) {
                    btn.innerText = "Enviar Respuesta";
                    // @ts-ignore
                    btn.disabled = false;
                }
            }
        };
    }); // End of astro:page-load
</script>
