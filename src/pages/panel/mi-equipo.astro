---
import { auth, db } from "../../firebase/client";
import Sidebar from "../../components/panel/Sidebar.astro";
import MobileSidebar from "../../components/panel/MobileSidebar.astro";
---

<!doctype html>
<html lang="es">
    <head>
        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-LG6RPRWWDY"></script>
        <script is:inline>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-LG6RPRWWDY");
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mi Equipo - DeOficios Pro</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
                background-color: #f8fafc;
            }
            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }

            /* Page Transitions */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fade-in {
                animation: fadeIn 0.3s ease-out;
            }
        </style>
    </head>
    <body class="text-slate-800">
        <!-- Mobile Sidebar Overlay Removed -->

        <div class="flex h-screen overflow-hidden">
            <!-- SIDEBARS -->
            <Sidebar currentPath={Astro.url.pathname} />
            <MobileSidebar currentPath={Astro.url.pathname} />

            <!-- MAIN CONTENT -->
            <main class="flex-1 flex flex-col h-screen overflow-hidden">
                <!-- HEADER -->
                <header
                    class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6">
                    <button id="open-sidebar" class="md:hidden text-2xl mr-4"></button>
                    <h2 class="text-lg font-bold text-slate-800">
                        Mi Equipo de Trabajo
                    </h2>

                    <button
                        id="btn-add-member"
                        class="bg-orange-600 hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                        <span>+</span> Agregar Miembro
                    </button>
                </header>

                <!-- CONTENT AREA -->
                <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                    <!-- STATS -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Total Miembros -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-3 bg-indigo-50 rounded-xl">
                                    <span class="text-2xl"></span>
                                </div>
                            </div>
                            <p class="text-sm text-slate-500 font-medium mb-1">
                                Total Miembros
                            </p>
                            <h3
                                id="stat-total-members"
                                class="text-3xl font-bold text-indigo-600">
                                0
                            </h3>
                        </div>

                        <!-- Derivaciones Pendientes -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-3 bg-orange-50 rounded-xl">
                                    <span class="text-2xl"></span>
                                </div>
                            </div>
                            <p class="text-sm text-slate-500 font-medium mb-1">
                                Derivaciones Pendientes
                            </p>
                            <h3
                                id="stat-pending-payments"
                                class="text-3xl font-bold text-orange-600">
                                $0
                            </h3>
                        </div>

                        <!-- Total Derivado -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-4">
                                <div class="p-3 bg-green-50 rounded-xl">
                                    <span class="text-2xl"></span>
                                </div>
                            </div>
                            <p class="text-sm text-slate-500 font-medium mb-1">
                                Total Derivado (Histrico)
                            </p>
                            <h3
                                id="stat-total-derived"
                                class="text-3xl font-bold text-green-600">
                                $0
                            </h3>
                        </div>
                    </div>

                    <!-- TEAM MEMBERS GRID -->
                    <div
                        class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-6">
                            Miembros del Equipo
                        </h3>

                        <!-- Empty State -->
                        <div id="empty-state" class="text-center py-12">
                            <div class="text-6xl mb-4"></div>
                            <p class="text-slate-600 font-medium mb-2">
                                No hay miembros en tu equipo
                            </p>
                            <p class="text-sm text-slate-400 mb-6">
                                Agrega ayudantes o socios para calcular
                                derivaciones automticamente
                            </p>
                            <button
                                onclick="document.getElementById('btn-add-member').click()"
                                class="bg-orange-600 hover:bg-orange-700 text-white font-bold px-6 py-3 rounded-lg transition">
                                + Agregar Primer Miembro
                            </button>
                        </div>

                        <!-- Team Grid -->
                        <div
                            id="team-grid"
                            class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- ADD/EDIT MEMBER MODAL -->
        <div
            id="modal-member"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div
                class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-all">
                <div class="p-6 border-b border-slate-100">
                    <h3 class="text-xl font-bold text-slate-800">
                        Agregar Miembro del Equipo
                    </h3>
                </div>

                <form id="form-member" class="p-6 space-y-4">
                    <div>
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2">
                            Nombre Completo
                        </label>
                        <input
                            type="text"
                            id="member-nombre"
                            required
                            class="w-full border border-slate-300 rounded-lg px-4 py-2 outline-none focus:border-orange-500"
                            placeholder="Ej: Juan Prez"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2">
                            Rol
                        </label>
                        <select
                            id="member-rol"
                            required
                            class="w-full border border-slate-300 rounded-lg px-4 py-2 outline-none focus:border-orange-500">
                            <option value="ayudante">Ayudante</option>
                            <option value="socio">Socio</option>
                            <option value="subcontratista">Subcontratista</option>
                        </select>
                    </div>

                    <div>
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2">
                            Tipo de Pago
                        </label>
                        <select
                            id="member-tipo-pago"
                            required
                            class="w-full border border-slate-300 rounded-lg px-4 py-2 outline-none focus:border-orange-500">
                            <option value="porcentaje">Porcentaje (%)</option>
                            <option value="fijo">Monto Fijo ($)</option>
                        </select>
                    </div>

                    <div>
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2">
                            <span id="label-valor">Porcentaje</span>
                        </label>
                        <input
                            type="number"
                            id="member-valor"
                            required
                            min="0"
                            step="any"
                            class="w-full border border-slate-300 rounded-lg px-4 py-2 outline-none focus:border-orange-500"
                            placeholder="Ej: 30"
                        />
                        <p id="hint-valor" class="text-xs text-slate-500 mt-1">
                            Ingresa el porcentaje (ej: 30 para 30%)
                        </p>
                    </div>

                    <div>
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2">
                            Telfono (opcional)
                        </label>
                        <input
                            type="tel"
                            id="member-telefono"
                            class="w-full border border-slate-300 rounded-lg px-4 py-2 outline-none focus:border-orange-500"
                            placeholder="Ej: 1234567890"
                        />
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button
                            type="button"
                            id="btn-cancel-member"
                            class="flex-1 border border-slate-300 text-slate-700 font-bold px-4 py-2 rounded-lg hover:bg-slate-50 transition">
                            Cancelar
                        </button>
                        <button
                            type="submit"
                            class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-lg transition">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ALERT MODAL -->
        <div
            id="alert-modal"
            class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div
                class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all relative z-10 overflow-hidden">
                <div
                    id="alert-header"
                    class="p-4 border-b border-slate-100 flex items-center gap-3">
                    <div id="alert-icon" class="text-2xl"></div>
                    <h3 id="alert-title" class="font-bold text-slate-800">
                        Alerta
                    </h3>
                </div>
                <div class="p-6">
                    <p id="alert-message" class="text-slate-600 text-sm">
                        Mensaje de alerta
                    </p>
                </div>
                <div class="p-4 bg-slate-50 flex gap-3 justify-end">
                    <button
                        id="alert-cancel"
                        class="hidden px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded-lg transition">
                        Cancelar
                    </button>
                    <button
                        id="alert-ok"
                        class="flex-1 bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-900 transition shadow-lg shadow-slate-200">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>

        <script>
            import { auth, db } from "../../firebase/client";
            import { onAuthStateChanged, signOut } from "firebase/auth";
            import {
                collection,
                addDoc,
                getDocs,
                doc,
                updateDoc,
                deleteDoc,
                query,
                where,
                Timestamp,
            } from "firebase/firestore";

            (function () {
                console.log(" [MI EQUIPO] Pgina cargada/navegada");

                const logoutBtn = document.getElementById("btn-logout");
                const btnAddMember = document.getElementById("btn-add-member");
                const modalMember = document.getElementById("modal-member");
                const formMember = document.getElementById("form-member");
                const btnCancelMember =
                    document.getElementById("btn-cancel-member");
                const emptyState = document.getElementById("empty-state");
                const teamGrid = document.getElementById("team-grid");

                let currentUser = null;
                let teamData = [];

                // AUTH
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        loadTeam(user.uid);
                    } else {
                        window.location.href = "/ingresar";
                    }
                });

                // LOAD TEAM
                async function loadTeam(uid) {
                    try {
                        const q = query(
                            collection(db, "profesionales", uid, "equipo"),
                            where("activo", "==", true),
                        );

                        const snapshot = await getDocs(q);
                        teamData = snapshot.docs.map((doc) => ({
                            id: doc.id,
                            ...doc.data(),
                        }));

                        renderTeam();
                        updateStats();
                    } catch (error) {
                        console.error("Error cargando equipo:", error);
                        showAlert(
                            "Error",
                            "No se pudo cargar el equipo",
                            "error",
                        );
                    }
                }

                // RENDER TEAM
                function renderTeam() {
                    if (teamData.length === 0) {
                        emptyState.classList.remove("hidden");
                        teamGrid.classList.add("hidden");
                        return;
                    }

                    emptyState.classList.add("hidden");
                    teamGrid.classList.remove("hidden");

                    teamGrid.innerHTML = teamData
                        .map(
                            (member) => `
                    <div class="p-4 border border-slate-200 rounded-xl hover:border-orange-300 transition">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <p class="font-bold text-slate-800">${member.nombre}</p>
                                <p class="text-sm text-slate-500 capitalize">${member.rol}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="bg-orange-100 text-orange-700 text-xs font-bold px-2 py-1 rounded-full">
                                    ${member.tipoPago === "porcentaje" ? member.valor + "%" : "$" + member.valor.toLocaleString()}
                                </span>
                                <button onclick="deleteMember('${member.id}', '${member.nombre}')" class="text-red-500 hover:text-red-700 text-xl" title="Eliminar"></button>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 space-y-1">
                            <p>Trabajos juntos: ${member.totalTrabajosJuntos || 0}</p>
                            <p>Total derivado: $${(member.totalDerivado || 0).toLocaleString()}</p>
                            ${
                                member.pendientePago > 0
                                    ? `
                                <div class="flex items-center justify-between pt-2 border-t border-slate-200 mt-2">
                                    <p class="text-orange-600 font-bold">Pendiente: $${member.pendientePago.toLocaleString()}</p>
                                    <button onclick="markAsPaid('${member.id}')" class="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded"> Pagado</button>
                                </div>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                `,
                        )
                        .join("");
                }

                // UPDATE STATS
                function updateStats() {
                    const totalMembers = teamData.length;
                    const totalPending = teamData.reduce(
                        (sum, m) => sum + (m.pendientePago || 0),
                        0,
                    );
                    const totalDerived = teamData.reduce(
                        (sum, m) => sum + (m.totalDerivado || 0),
                        0,
                    );

                    document.getElementById("stat-total-members").textContent =
                        totalMembers;
                    document.getElementById(
                        "stat-pending-payments",
                    ).textContent = "$" + totalPending.toLocaleString();
                    document.getElementById("stat-total-derived").textContent =
                        "$" + totalDerived.toLocaleString();
                }

                // MODAL CONTROLS
                btnAddMember.addEventListener("click", () => {
                    modalMember.classList.remove("hidden");
                });

                btnCancelMember.addEventListener("click", () => {
                    modalMember.classList.add("hidden");
                    formMember.reset();
                });

                // TIPO PAGO CHANGE
                document
                    .getElementById("member-tipo-pago")
                    .addEventListener("change", (e) => {
                        const tipo = e.target.value;
                        const label = document.getElementById("label-valor");
                        const hint = document.getElementById("hint-valor");

                        if (tipo === "porcentaje") {
                            label.textContent = "Porcentaje";
                            hint.textContent =
                                "Ingresa el porcentaje (ej: 30 para 30%)";
                        } else {
                            label.textContent = "Monto Fijo";
                            hint.textContent =
                                "Ingresa el monto fijo por trabajo (ej: 50000)";
                        }
                    });

                // ADD MEMBER
                formMember.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    if (!currentUser) return;

                    const nombre =
                        document.getElementById("member-nombre").value;
                    const rol = document.getElementById("member-rol").value;
                    const tipoPago =
                        document.getElementById("member-tipo-pago").value;
                    const valor = parseFloat(
                        document.getElementById("member-valor").value,
                    );
                    const telefono =
                        document.getElementById("member-telefono").value;

                    try {
                        await addDoc(
                            collection(
                                db,
                                "profesionales",
                                currentUser.uid,
                                "equipo",
                            ),
                            {
                                nombre,
                                rol,
                                tipoPago,
                                valor,
                                telefono: telefono || "",
                                activo: true,
                                totalTrabajosJuntos: 0,
                                totalDerivado: 0,
                                pendientePago: 0,
                                createdAt: Timestamp.now(),
                            },
                        );

                        await showAlert(
                            "Miembro Agregado!",
                            `${nombre} ha sido agregado a tu equipo.`,
                            "success",
                        );

                        modalMember.classList.add("hidden");
                        formMember.reset();
                        await loadTeam(currentUser.uid);
                    } catch (error) {
                        console.error(error);
                        await showAlert(
                            "Error",
                            "No se pudo agregar el miembro.",
                            "error",
                        );
                    }
                });

                // DELETE MEMBER
                window.deleteMember = async (memberId, nombre) => {
                    const confirmed = await showConfirm(
                        "Eliminar Miembro",
                        `Ests seguro de eliminar a ${nombre} de tu equipo?\nEsto NO eliminar el historial de trabajos anteriores.`,
                        "Eliminar",
                        "bg-red-600",
                    );

                    if (!confirmed) return;

                    try {
                        await deleteDoc(
                            doc(
                                db,
                                "profesionales",
                                currentUser.uid,
                                "equipo",
                                memberId,
                            ),
                        );
                        await showAlert(
                            "Miembro Eliminado",
                            `${nombre} ha sido eliminado de tu equipo.`,
                            "success",
                        );
                        await loadTeam(currentUser.uid);
                    } catch (error) {
                        console.error(error);
                        await showAlert(
                            "Error",
                            "No se pudo eliminar al miembro.",
                            "error",
                        );
                    }
                };

                // MARK AS PAID
                window.markAsPaid = async (memberId) => {
                    const confirmed = await showConfirm(
                        "Confirmar Pago",
                        "Confirmas que pagaste todas las derivaciones pendientes a este miembro?",
                        "S, pagado",
                        "bg-green-600",
                    );

                    if (!confirmed) return;

                    try {
                        const memberDoc = doc(
                            db,
                            "profesionales",
                            currentUser.uid,
                            "equipo",
                            memberId,
                        );
                        await updateDoc(memberDoc, {
                            pendientePago: 0,
                        });

                        // Mark derivaciones as paid
                        const derivacionesQuery = query(
                            collection(
                                db,
                                "profesionales",
                                currentUser.uid,
                                "derivaciones",
                            ),
                            where("miembroId", "==", memberId),
                            where("pagado", "==", false),
                        );
                        const derivacionesSnap =
                            await getDocs(derivacionesQuery);

                        const updatePromises = derivacionesSnap.docs.map(
                            (derivacionDoc) =>
                                updateDoc(derivacionDoc.ref, {
                                    pagado: true,
                                    fechaPago: Timestamp.now(),
                                }),
                        );
                        await Promise.all(updatePromises);

                        await showAlert(
                            "Pago Registrado",
                            "Has marcado las derivaciones como pagadas.",
                            "success",
                        );
                        await loadTeam(currentUser.uid);
                    } catch (error) {
                        console.error(error);
                        await showAlert(
                            "Error",
                            "No se pudo registrar el pago.",
                            "error",
                        );
                    }
                };

                // ALERT SYSTEM
                function showAlert(title, message, type = "info") {
                    return new Promise((resolve) => {
                        const modal = document.getElementById("alert-modal");
                        const titleEl = document.getElementById("alert-title");
                        const msgEl = document.getElementById("alert-message");
                        const iconEl = document.getElementById("alert-icon");
                        const okBtn = document.getElementById("alert-ok");
                        const cancelBtn =
                            document.getElementById("alert-cancel");

                        if (!modal) return resolve();

                        titleEl.innerText = title;
                        msgEl.innerText = message;
                        cancelBtn.classList.add("hidden");
                        okBtn.innerText = "Aceptar";
                        okBtn.onclick = () => {
                            modal.classList.add("hidden");
                            resolve(true);
                        };

                        if (type === "success") {
                            iconEl.innerText = "";
                            okBtn.className =
                                "flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-lg shadow-green-200";
                        } else if (type === "error") {
                            iconEl.innerText = "";
                            okBtn.className =
                                "flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-lg shadow-red-200";
                        } else {
                            iconEl.innerText = "";
                            okBtn.className =
                                "flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-200";
                        }

                        modal.classList.remove("hidden");
                    });
                }

                function showConfirm(
                    title,
                    message,
                    actionText = "Aceptar",
                    actionClass = "bg-orange-600",
                ) {
                    return new Promise((resolve) => {
                        const modal = document.getElementById("alert-modal");
                        const titleEl = document.getElementById("alert-title");
                        const msgEl = document.getElementById("alert-message");
                        const iconEl = document.getElementById("alert-icon");
                        const okBtn = document.getElementById("alert-ok");
                        const cancelBtn =
                            document.getElementById("alert-cancel");

                        if (!modal) return resolve(false);

                        titleEl.innerText = title;
                        msgEl.innerText = message;
                        iconEl.innerText = "";

                        cancelBtn.classList.remove("hidden");
                        cancelBtn.onclick = () => {
                            modal.classList.add("hidden");
                            resolve(false);
                        };

                        okBtn.innerText = actionText;
                        okBtn.className = `flex-1 text-white font-bold py-2 px-4 rounded-lg transition shadow-lg ${actionClass}`;
                        okBtn.onclick = () => {
                            modal.classList.add("hidden");
                            resolve(true);
                        };

                        modal.classList.remove("hidden");
                    });
                }

                // LOGOUT
                logoutBtn?.addEventListener("click", async () => {
                    await signOut(auth);
                    window.location.href = "/";
                });
            })(); // End of IIFE
        </script>
    </body>
</html>

