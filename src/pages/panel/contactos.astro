---
import { auth, db } from "../../firebase/client";
import Sidebar from "../../components/panel/Sidebar.astro";
import MobileSidebar from "../../components/panel/MobileSidebar.astro";
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mis Contactos - Panel Profesional</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body class="bg-slate-50 font-['Inter'] text-slate-800">
        <div class="flex h-screen overflow-hidden">
            <!-- SIDEBARS -->
            <Sidebar currentPath={Astro.url.pathname} />
            <MobileSidebar currentPath={Astro.url.pathname} />

            <!-- MAIN CONTENT -->
            <main class="flex-1 overflow-y-auto w-full">
                <!-- Mobile Menu Button -->
                <div class="md:hidden p-4 pb-0">
                    <button
                        id="open-sidebar"
                        class="p-2 bg-white rounded-lg shadow-sm border border-slate-100 text-slate-600"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><line x1="3" y1="12" x2="21" y2="12"></line><line
                                x1="3"
                                y1="6"
                                x2="21"
                                y2="6"></line><line
                                x1="3"
                                y1="18"
                                x2="21"
                                y2="18"></line></svg
                        >
                    </button>
                </div>

                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900">
                            C√≥digos de Seguridad
                        </h1>
                        <p class="text-slate-500 mt-1">
                            Tus visitas programadas
                        </p>
                    </div>

                    <!-- INFO CARD -->
                    <div
                        class="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-2xl p-6 text-white shadow-xl shadow-indigo-200 mb-8"
                    >
                        <div class="flex items-start gap-4">
                            <div class="p-3 bg-white/20 rounded-xl">
                                <span class="text-2xl">üõ°Ô∏è</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-1">
                                    Seguridad Primero
                                </h3>
                                <p
                                    class="text-indigo-100 text-sm leading-relaxed"
                                >
                                    Cuando un cliente te contacta por WhatsApp,
                                    el sistema le genera un c√≥digo de 6 d√≠gitos.
                                    Pedile ese c√≥digo cuando llegues al lugar
                                    para confirmar que la visita fue coordinada
                                    por DeOficios.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 class="font-bold text-lg text-slate-800 mb-4 px-1">
                    Contactos Recientes <span
                        class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                        >EN VIVO</span
                    >
                </h3>

                <div id="contactos-list" class="space-y-4 min-h-[200px]">
                    <div
                        class="animate-pulse flex space-x-4 p-4 bg-white rounded-xl"
                    >
                        <div class="rounded-full bg-slate-200 h-10 w-10"></div>
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-slate-200 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </body>
</html>

<script>
    import { auth, db } from "../../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        collection,
        query,
        where,
        onSnapshot,
        limit,
    } from "firebase/firestore";

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "/ingresar";
            return;
        }

        const q = query(
            collection(db, "contactos"),
            where("proId", "==", user.uid),
            limit(50),
        );

        onSnapshot(
            q,
            (snapshot) => {
                const listContainer = document.getElementById("contactos-list");
                if (!listContainer) return;

                if (snapshot.empty) {
                    listContainer.innerHTML = `
                            <div class="p-12 text-center text-slate-400">
                                <p class="text-4xl mb-4">üí¨</p>
                                <p class="font-medium text-slate-600">A√∫n no tienes contactos registrados</p>
                                <p class="text-sm">Cuando alguien te contacte por WhatsApp aparecer√° ac√°.</p>
                            </div>
                        `;
                    return;
                }

                listContainer.innerHTML = snapshot.docs
                    .map((doc) => {
                        const data = doc.data();
                        const fecha = data.fecha?.toDate() || new Date();
                        const timeStr = fecha.toLocaleTimeString([], {
                            hour: "2-digit",
                            minute: "2-digit",
                        });
                        const dateStr = fecha.toLocaleDateString();

                        return `
                        <div class="p-6 flex flex-col md:flex-row md:items-center justify-between gap-4 hover:bg-slate-50/50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-white border-2 border-slate-100 shadow-sm rounded-full flex items-center justify-center text-xl">
                                    üë§
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">${data.clienteNombre}</h4>
                                    <p class="text-xs text-slate-500">${dateStr} ‚Ä¢ ${timeStr}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-6">
                                <div class="text-right hidden md:block">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">C√≥digo de Seguridad</p>
                                    <div class="flex items-center gap-2 justify-end">
                                        <p class="text-2xl font-black text-orange-600 tracking-widest token-pill">${data.token}</p>
                                        <button onclick="window.deleteContact('${doc.id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Eliminar contacto">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="md:hidden flex items-center justify-between border-t pt-4 border-slate-100 w-full">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">C√≥digo</p>
                                    <p class="text-xl font-black text-orange-600 tracking-widest token-pill">${data.token}</p>
                                </div>
                            </div>
                        </div>
                        `;
                    })
                    .join("");
            },
            (error) => {
                console.error("‚ùå [CONTACTOS] Error en listener:", error);
                const listContainer = document.getElementById("contactos-list");
                if (listContainer) {
                    listContainer.innerHTML = `
                            <div class="p-12 text-center text-red-400">
                                <p class="text-4xl mb-4">‚ö†Ô∏è</p>
                                <p class="font-medium text-slate-600">Error al cargar contactos</p>
                            </div>
                        `;
                }
            },
        );
    });

    // Funci√≥n Global de Borrado
    window.deleteContact = async (id) => {
        if (!confirm("¬øSeguro que quieres eliminar este contacto?")) return;

        try {
            const { deleteDoc, doc, getFirestore } =
                await import("firebase/firestore");
            const db = getFirestore(); // Ensure we get the instance or use the imported one from client if available.
            // Better to re-use the 'db' from line 118 if possible, but inside module...
            // Actually 'db' is imported at top level. We can use it.
            // But strict module scoping might prevent access inside 'window' assignment if not careful.
            // However, 'db' is top level variable in this module.
            // Let's use the explicit import to be safe inside the dynamic function or just rely on closure.
            // Since this script tag is type="module" (implied by imports), window functions need access to 'db'.

            // Re-importing inside function to be 100% sure of availability in global scope context if needed,
            // though closure should work. To be safe, I'll pass 'db' from closure.
            await deleteDoc(doc(db, "contactos", id));
        } catch (e) {
            console.error(e);
            alert("Error al eliminar el contacto.");
        }
    };
</script>
