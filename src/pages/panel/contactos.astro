---
import { auth, db } from "../../firebase/client";
import Sidebar from "../../components/panel/Sidebar.astro";
import MobileSidebar from "../../components/panel/MobileSidebar.astro";
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mis Contactos - Panel Profesional</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body class="bg-slate-50 font-['Inter'] text-slate-800">
        <div class="flex h-screen overflow-hidden">
            <!-- SIDEBARS -->
            <Sidebar currentPath={Astro.url.pathname} />
            <MobileSidebar currentPath={Astro.url.pathname} />

            <!-- MAIN CONTENT -->
            <main class="flex-1 overflow-y-auto w-full">
                <!-- Mobile Menu Button -->
                <div class="md:hidden p-4 pb-0">
                    <button
                        id="open-sidebar"
                        class="p-2 bg-white rounded-lg shadow-sm border border-slate-100 text-slate-600">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line
                                x1="3"
                                y1="6"
                                x2="21"
                                y2="6"></line><line
                                x1="3"
                                y1="18"
                                x2="21"
                                y2="18"></line></svg>
                    </button>
                </div>

                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900">
                            Mis Contactos
                        </h1>
                        <p class="text-slate-500 mt-1">
                            Clientes que te han contactado
                        </p>
                    </div>

                </div>

                <h3 class="font-bold text-lg text-slate-800 mb-4 px-1">
                    Contactos Recientes <span
                        class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">EN VIVO</span>
                </h3>

                <div id="contactos-list" class="space-y-4 min-h-[200px]">
                    <div
                        class="animate-pulse flex space-x-4 p-4 bg-white rounded-xl">
                        <div class="rounded-full bg-slate-200 h-10 w-10"></div>
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-slate-200 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </body>
</html>

<script>
    import { auth, db } from "../../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        collection,
        query,
        where,
        onSnapshot,
        limit,
        deleteDoc,
        doc,
    } from "firebase/firestore";

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "/ingresar";
            return;
        }

        const q = query(
            collection(db, "contactos"),
            where("proId", "==", user.uid),
            limit(50),
        );

        onSnapshot(
            q,
            (snapshot) => {
                const listContainer = document.getElementById("contactos-list");
                if (!listContainer) return;

                if (snapshot.empty) {
                    listContainer.innerHTML = `
                            <div class="p-12 text-center text-slate-400">
                                <p class="text-4xl mb-4"></p>
                                <p class="font-medium text-slate-600">An no tienes contactos registrados</p>
                                <p class="text-sm">Cuando alguien te contacte por WhatsApp aparecer ac.</p>
                            </div>
                        `;
                    return;
                }

                listContainer.innerHTML = snapshot.docs
                    .map((doc) => {
                        const data = doc.data();
                        const fecha = data.fecha?.toDate() || new Date();
                        const timeStr = fecha.toLocaleTimeString([], {
                            hour: "2-digit",
                            minute: "2-digit",
                        });
                        const dateStr = fecha.toLocaleDateString();

                        return `
                        <div class="p-6 flex flex-col md:flex-row md:items-center justify-between gap-4 hover:bg-slate-50/50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-white border-2 border-slate-100 shadow-sm rounded-full flex items-center justify-center text-xl">
                                    
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800">${data.clienteNombre}</h4>
                                    <p class="text-xs text-slate-500">${dateStr}  ${timeStr}</p>
                                    ${data.token ? `<div class="mt-1 inline-block px-2 py-0.5 bg-slate-900 text-white text-[10px] font-mono rounded-md border border-slate-700">Cód: ${data.token}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div class="text-right hidden md:flex items-center gap-3">
                                    <div class="flex items-center gap-2">
                                        ${data.clienteTelefono ? `
                                            <a href="https://wa.me/549${data.clienteTelefono.replace(/\D/g, "")}" target="_blank" class="p-2.5 bg-green-50 text-green-600 hover:bg-green-100 rounded-xl transition-all border border-green-100" title="Responder por WhatsApp">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                            </a>
                                        ` : ''}
                                        <button onclick="window.deleteContact('${doc.id}')" class="p-2.5 bg-red-50 text-red-500 hover:bg-red-100 rounded-xl transition-all border border-red-100" title="Eliminar contacto">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="md:hidden flex flex-col border-t pt-4 border-slate-100 w-full gap-4">
                                    <div class="flex gap-2">
                                        ${data.clienteTelefono ? `
                                            <a href="https://wa.me/549${data.clienteTelefono.replace(/\D/g, "")}" target="_blank" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                                Responder
                                            </a>
                                        ` : ''}
                                        <button onclick="window.deleteContact('${doc.id}')" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                            Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    })
                    .join("");
            },
            (error) => {
                console.error(" [CONTACTOS] Error en listener:", error);
                const listContainer = document.getElementById("contactos-list");
                if (listContainer) {
                    listContainer.innerHTML = `
                            <div class="p-12 text-center text-red-400">
                                <p class="text-4xl mb-4"></p>
                                <p class="font-medium text-slate-600">Error al cargar contactos</p>
                            </div>
                        `;
                }
            },
        );
    });

    // Funcin Global de Borrado
    window.deleteContact = async (id) => {
        if (!confirm("Seguro que quieres eliminar este contacto?")) return;

        try {
            // Usamos la instancia db importada arriba
            await deleteDoc(doc(db, "contactos", id));
        } catch (e) {
            console.error(e);
            alert("Error al eliminar el contacto.");
        }
    };
</script>

