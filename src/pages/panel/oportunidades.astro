---
import { auth } from "../../firebase/client";
import Sidebar from "../../components/panel/Sidebar.astro";
import MobileSidebar from "../../components/panel/MobileSidebar.astro";
---

<html lang="es">
    <head>
        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-LG6RPRWWDY"
        ></script>
        <script is:inline>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-LG6RPRWWDY");
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Oportunidades - Panel Profesional</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
                background-color: #f8fafc;
            }
            /* Scrollbar personalizada */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            /* Page Transitions */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fade-in {
                animation: fadeIn 0.3s ease-out;
            }

            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.5);
                backdrop-filter: blur(4px);
                z-index: 999;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            .modal-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            .modal-container {
                background: white;
                border-radius: 1.5rem;
                width: 90%;
                max-width: 400px;
                padding: 2rem;
                box-shadow:
                    0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
                transform: scale(0.95);
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            .modal-overlay.active .modal-container {
                transform: scale(1);
            }
        </style>
    </head>
    <body class="text-slate-800">
        <div class="flex h-screen overflow-hidden">
            <!-- SIDEBARS -->
            <Sidebar currentPath={Astro.url.pathname} />
            <MobileSidebar currentPath={Astro.url.pathname} />

            <!-- MAIN CONTENT -->
            <main class="flex-1 overflow-y-auto bg-slate-50">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Mobile Menu Button -->
                    <button
                        id="open-sidebar"
                        class="md:hidden text-2xl mb-4 p-2 bg-white rounded-lg shadow-sm"
                        >‚ò∞</button
                    >

                    <!-- HEADER -->
                    <div
                        class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4"
                    >
                        <div>
                            <h1 class="text-2xl font-bold text-slate-900">
                                Oportunidades de Trabajo
                            </h1>
                            <p class="text-slate-500 mt-1">
                                Solicitudes de clientes que coinciden con tu
                                perfil
                            </p>
                        </div>
                    </div>

                    <!-- TABS -->
                    <div class="border-b border-slate-200 mb-6 overflow-x-auto">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button
                                id="tab-nuevas"
                                class="tab-btn active border-orange-500 text-orange-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            >
                                Nuevas
                            </button>
                            <button
                                id="tab-contactadas"
                                class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            >
                                Contactadas
                            </button>
                            <button
                                id="tab-descartadas"
                                class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
                            >
                                Descartadas
                            </button>
                        </nav>
                    </div>

                    <!-- LOADING STATE -->
                    <div id="loading" class="text-center py-12">
                        <div
                            class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto"
                        >
                        </div>
                        <p class="text-slate-400 mt-4">
                            Buscando oportunidades en tu zona...
                        </p>
                    </div>

                    <!-- ERROR STATE -->
                    <div id="error-state" class="hidden text-center py-12">
                        <div class="text-5xl mb-4">‚ö†Ô∏è</div>
                        <p class="text-slate-500">
                            Ocurri√≥ un error al cargar las oportunidades.
                        </p>
                        <p class="text-xs text-slate-400 mt-2">
                            Si es la primera vez, es posible que se est√© creando
                            el √≠ndice de base de datos.
                        </p>
                    </div>

                    <!-- EMPTY STATE -->
                    <div
                        id="empty-state"
                        class="hidden text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300"
                    >
                        <div class="mx-auto h-12 w-12 text-slate-300 mb-4">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                                ></path>
                            </svg>
                        </div>
                        <h3
                            id="empty-title"
                            class="mt-2 text-sm font-medium text-slate-900"
                        >
                            No hay nuevas oportunidades
                        </h3>
                        <p id="empty-desc" class="mt-1 text-sm text-slate-500">
                            Te avisaremos cuando alguien busque un servicio en
                            tu zona.
                        </p>
                    </div>

                    <!-- GRID OPORTUNIDADES -->
                    <div
                        id="oportunidades-grid"
                        class="grid grid-cols-1 gap-6"
                        style="display: none;"
                    >
                        <!-- Cards will be injected here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- MODAL ALERTA -->
        <div id="custom-alert" class="modal-overlay">
            <div class="modal-container text-center">
                <div id="alert-icon" class="text-5xl mb-4"></div>
                <h3
                    id="alert-title"
                    class="text-xl font-bold text-slate-900 mb-2"
                >
                </h3>
                <p id="alert-message" class="text-slate-600 mb-6"></p>
                <button
                    onclick="closeAlert()"
                    class="w-full bg-slate-900 text-white font-bold py-3 px-6 rounded-xl hover:bg-slate-800 transition shadow-lg active:scale-95"
                >
                    Entendido
                </button>
            </div>
        </div>

        <script>
            import { db, auth } from "../../firebase/client";
            import {
                collection,
                query,
                where,
                getDocs,
                orderBy,
                limit,
                doc,
                updateDoc,
                arrayUnion,
                getDoc,
                deleteField,
            } from "firebase/firestore";
            import { onAuthStateChanged } from "firebase/auth";

            let currentUser: any = null;
            let todasSolicitudes: any[] = [];

            // Execute immediately - IIFE pattern
            (function () {
                console.log("üöÄ [OPORTUNIDADES] Ejecutando inicializaci√≥n...");

                // Referencias DOM
                const grid = document.getElementById("oportunidades-grid");
                const loading = document.getElementById("loading");
                const errorState = document.getElementById("error-state");
                const emptyState = document.getElementById("empty-state");
                const emptyTitle = document.getElementById("empty-title");
                const emptyDesc = document.getElementById("empty-desc");
                const tabs = document.querySelectorAll(".tab-btn");

                // Estado local
                let activeTab = "nuevas"; // nuevas | contactadas | descartadas

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadOportunidades();
                    } else {
                        window.location.href = "/ingresar-profesional";
                    }
                });

                // LOGOUT
                document
                    .getElementById("btn-logout")
                    ?.addEventListener("click", () => {
                        auth.signOut().then(() => (window.location.href = "/"));
                    });

                // TABS
                tabs.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        // Update UI
                        tabs.forEach((t) => {
                            t.classList.remove(
                                "border-orange-500",
                                "text-orange-600",
                                "active",
                            );
                            t.classList.add(
                                "border-transparent",
                                "text-slate-500",
                            );
                        });
                        btn.classList.add(
                            "border-orange-500",
                            "text-orange-600",
                            "active",
                        );
                        btn.classList.remove(
                            "border-transparent",
                            "text-slate-500",
                        );

                        // Update Logic
                        activeTab = btn.id.split("-")[1]; // nuevas, contactadas, descartadas
                        renderOportunidades();
                    });
                });

                async function loadOportunidades() {
                    console.log("üîç [OPORTUNIDADES] Iniciando carga...");

                    // Ocultar todo inicialmente
                    [loading, grid, emptyState, errorState].forEach((el) => {
                        if (el) {
                            el.style.display = "none";
                            el.classList.add("hidden");
                        }
                    });

                    try {
                        loading.style.display = "block";
                        loading.classList.remove("hidden");

                        console.log(
                            "üîç [OPORTUNIDADES] Consultando Firestore para UID:",
                            currentUser?.uid,
                        );

                        // 1. Primero, obtener el perfil del profesional para saber su rubro y zona
                        const profDoc = await getDoc(
                            doc(db, "profesionales", currentUser.uid),
                        );

                        if (!profDoc.exists()) {
                            console.error(
                                "‚ùå No se encontr√≥ el perfil del profesional",
                            );
                            errorState.style.display = "block";
                            errorState.classList.remove("hidden");
                            return;
                        }

                        const profData = profDoc.data();

                        // OBTENER TODOS LOS RUBROS Y ZONAS DISPONIBLES DEL PERFIL
                        // Prioridad: Arrays nuevos -> Campos legacy -> Defaults
                        const misRubros =
                            profData.rubros?.length > 0
                                ? profData.rubros
                                : profData.rubro_principal
                                  ? [profData.rubro_principal]
                                  : [];

                        const misZonas =
                            profData.zonas?.length > 0
                                ? profData.zonas
                                : profData.zona
                                  ? [profData.zona]
                                  : [];

                        console.log(
                            "üîç [OPORTUNIDADES] Mis rubros:",
                            misRubros,
                            "Mis zonas:",
                            misZonas,
                        );

                        // 2. Buscar solicitudes que coincidan con mis rubros
                        // Firestore 'in' limitation: max 10 items (App limit is 5, so we are safe)

                        const allSolicitudes = new Map();

                        // Query 1: Donde soy candidato (el sistema me seleccion√≥)
                        const qCandidato = query(
                            collection(db, "solicitudes"),
                            where(
                                "candidatos",
                                "array-contains",
                                currentUser.uid,
                            ),
                            orderBy("fecha", "desc"),
                            limit(50),
                        );

                        const snapCandidato = await getDocs(qCandidato);
                        snapCandidato.docs.forEach((doc) => {
                            const data = doc.data();
                            if (
                                !data.eliminadosPor?.includes(currentUser.uid)
                            ) {
                                allSolicitudes.set(doc.id, {
                                    id: doc.id,
                                    ...data,
                                });
                            }
                        });

                        // Query 2: Coincidencia por Rubro (Multi-Rubro)
                        if (misRubros.length > 0) {
                            try {
                                const qRubros = query(
                                    collection(db, "solicitudes"),
                                    where("rubro", "in", misRubros), // BUSCAR EN LISTA DE RUBROS
                                    where("status", "==", "nueva"),
                                    orderBy("fecha", "desc"),
                                    limit(50),
                                );

                                const snapRubros = await getDocs(qRubros);

                                snapRubros.docs.forEach((doc) => {
                                    if (!allSolicitudes.has(doc.id)) {
                                        const data = doc.data();

                                        // FILTRADO CLIENT-SIDE POR ZONA Y ELIMINADOS
                                        const zonaMatch =
                                            misZonas.length === 0 ||
                                            misZonas.includes(data.zona);
                                        const notDeleted =
                                            !data.eliminadosPor?.includes(
                                                currentUser.uid,
                                            );

                                        if (zonaMatch && notDeleted) {
                                            allSolicitudes.set(doc.id, {
                                                id: doc.id,
                                                ...data,
                                            });
                                        }
                                    }
                                });
                            } catch (error) {
                                console.error(
                                    "‚ö†Ô∏è Query multi-rubro fall√≥:",
                                    error,
                                );
                            }
                        }

                        // Query 3: Mis Presupuestos / Aceptados (para que sigan apareciendo en 'Contactadas' o una nueva tab)
                        const qAceptados = query(
                            collection(db, "solicitudes"),
                            where("profesionalId", "==", currentUser.uid),
                            orderBy("fecha", "desc"),
                        );
                        console.log(
                            "üîç [OPORTUNIDADES] Ejecutando query aceptados...",
                        );
                        try {
                            const snapAceptados = await getDocs(qAceptados);
                            snapAceptados.docs.forEach((doc) => {
                                allSolicitudes.set(doc.id, {
                                    id: doc.id,
                                    ...doc.data(),
                                });
                            });
                        } catch (e) {
                            console.warn("‚ö†Ô∏è Query aceptados fall√≥:", e);
                        }

                        // Convertir Map a Array y ordenar por fecha
                        todasSolicitudes = Array.from(
                            allSolicitudes.values(),
                        ).sort((a, b) => {
                            const fechaA =
                                a.fecha?.toDate?.() || new Date(a.fecha);
                            const fechaB =
                                b.fecha?.toDate?.() || new Date(b.fecha);
                            return fechaB - fechaA;
                        });

                        console.log(
                            "üîç [OPORTUNIDADES] Total docs combinados:",
                            todasSolicitudes.length,
                        );

                        renderOportunidades();
                    } catch (error) {
                        console.error("‚ùå [OPORTUNIDADES] Error:", error);
                        errorState.style.display = "block";
                        errorState.classList.remove("hidden");
                    } finally {
                        loading.style.display = "none";
                        loading.classList.add("hidden");
                        console.log("üîç [OPORTUNIDADES] Carga finalizada");
                    }
                }

                function renderOportunidades() {
                    console.log("üé® [RENDER] Iniciando renderOportunidades...");
                    console.log(
                        "üé® [RENDER] Total solicitudes:",
                        todasSolicitudes.length,
                    );
                    console.log("üé® [RENDER] Tab activo:", activeTab);

                    // Filtrar seg√∫n Tab
                    const filtered = todasSolicitudes.filter((sol) => {
                        const contactado = sol.contactadosPor?.includes(
                            currentUser.uid,
                        );
                        const descartado = sol.descartadosPor?.includes(
                            currentUser.uid,
                        );

                        if (activeTab === "nuevas")
                            return (
                                !contactado &&
                                !descartado &&
                                sol.status === "nueva"
                            ); // Only show truly new ones
                        if (activeTab === "contactadas") return contactado;
                        if (activeTab === "descartadas") return descartado;
                        return false;
                    });

                    console.log(
                        "üé® [RENDER] Solicitudes filtradas:",
                        filtered.length,
                    );
                    console.log("üé® [RENDER] Datos filtrados:", filtered);
                    if (filtered.length === 0) {
                        console.log(
                            "‚ö†Ô∏è [RENDER] No hay solicitudes filtradas - mostrando empty state",
                        );
                    }

                    // Update count badge
                    const nuevasCount = todasSolicitudes.filter(
                        (s) =>
                            !s.contactadosPor?.includes(currentUser.uid) &&
                            !s.descartadosPor?.includes(currentUser.uid),
                    ).length;

                    const badge = document.getElementById(
                        "badge-oportunidades",
                    );
                    if (badge) {
                        badge.innerText = nuevasCount.toString();
                        if (nuevasCount > 0) {
                            badge.style.display = "inline-block";
                            badge.classList.remove("hidden");
                        } else {
                            badge.style.display = "none";
                            badge.classList.add("hidden");
                        }
                    }

                    // Empty State Logic
                    if (filtered.length === 0) {
                        console.log("‚ö†Ô∏è [RENDER] Mostrando empty state");
                        grid.style.display = "none";
                        emptyState.style.display = "";
                        emptyState.classList.remove("hidden");

                        if (activeTab === "nuevas") {
                            emptyTitle.innerText =
                                "No hay nuevas oportunidades";
                            emptyDesc.innerText =
                                "Te avisaremos cuando alguien busque un servicio en tu zona.";
                        } else if (activeTab === "contactadas") {
                            emptyTitle.innerText =
                                "A√∫n no has contactado a nadie";
                            emptyDesc.innerText =
                                "Las oportunidades que contactes aparecer√°n aqu√≠.";
                        } else {
                            emptyTitle.innerText = "Papelera vac√≠a";
                            emptyDesc.innerText =
                                "Las oportunidades descartadas aparecer√°n aqu√≠.";
                        }
                        return;
                    }

                    console.log("üé® [RENDER] Mostrando grid...");
                    emptyState.style.display = "none";
                    grid.style.display = "grid";
                    grid.classList.remove("hidden");

                    console.log(
                        "üé® [RENDER] Generando HTML para",
                        filtered.length,
                        "items",
                    );
                    grid.innerHTML = filtered
                        .map((sol) => {
                            // Formatear fecha
                            let fechaStr = "Reciente";
                            if (sol.fecha && sol.fecha.seconds) {
                                const date = new Date(sol.fecha.seconds * 1000);
                                fechaStr = new Intl.DateTimeFormat("es-AR", {
                                    day: "numeric",
                                    month: "short",
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }).format(date);
                            }

                            // Badges
                            const urgenteBadge = sol.urgente
                                ? `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">üö® Urgente</span>`
                                : "";

                            const nuevoBadge =
                                !sol.leidoPor?.includes(currentUser.uid) &&
                                activeTab === "nuevas"
                                    ? `<span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">Nuevo</span>`
                                    : "";

                            const isAcceptedByMe =
                                sol.profesionalId === currentUser.uid;
                            const acceptedBadge = isAcceptedByMe
                                ? `<span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded-full border border-purple-200">üíé Tu Trabajo</span>`
                                : "";

                            return `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row gap-6 hover:shadow-md transition">
                            <!-- Info Principal -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <span class="bg-slate-100 text-slate-700 text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wide">${sol.rubro}</span>
                                        ${urgenteBadge}
                                        ${nuevoBadge}
                                        ${acceptedBadge}
                                        ${
                                            sol.presupuesto
                                                ? `<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">üí∞ Presupuesto: $${sol.presupuesto}</span>`
                                                : ""
                                        }
                                    </div>
                                    <span class="text-xs text-slate-400 flex items-center gap-1 whitespace-nowrap">
                                        ‚è± ${fechaStr}
                                    </span>
                                </div>
                                
                                <h3 class="text-xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    ${sol.zona}
                                </h3>
                                
                                <p class="text-slate-600 mb-4 line-clamp-3 md:line-clamp-none bg-slate-50 p-3 rounded-lg border border-slate-100 text-sm italic">
                                    "${sol.detalle}"
                                </p>

                                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                                    <span class="flex items-center gap-2 font-medium text-slate-700">
                                        <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs">üë§</div>
                                        ${sol.clienteNombre}
                                    </span>
                                    ${
                                        activeTab === "contactadas"
                                            ? `
                                        <span class="text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded">‚úÖ Contactado</span>
                                    `
                                            : ""
                                    }
                                    ${
                                        sol.profesionalId === currentUser.uid
                                            ? `<span class="text-purple-600 font-bold text-xs bg-purple-50 px-2 py-1 rounded border border-purple-100">üìå Presupuestando</span>`
                                            : ""
                                    }
                                </div>
                            </div>

                            <!-- Acciones -->
                            <div class="flex flex-col gap-3 justify-center min-w-[220px] border-t md:border-t-0 md:border-l border-slate-100 pt-5 md:pt-0 md:pl-6">
                                ${
                                    activeTab === "nuevas"
                                        ? `
                                    <button 
                                        onclick="contactarCliente('${sol.id}', '${sol.clienteNombre}', '${sol.telefono || ""}')"
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition shadow-sm hover:shadow active:scale-95"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                        Contactar Cliente
                                    </button>
                                    
                                    <button 
                                        onclick="descartarSolicitud('${sol.id}')"
                                        class="w-full text-slate-500 hover:text-red-600 hover:bg-red-50 font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition text-sm"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                        Descartar
                                    </button>
                                    `
                                        : ""
                                }

                                ${
                                    activeTab === "descartadas"
                                        ? `
                                    <button onclick="eliminarOportunidad('${sol.id}')" class="w-full px-4 py-2 border border-red-200 text-red-600 font-bold rounded-lg hover:bg-red-50 transition flex items-center justify-center gap-2">
                                        üóëÔ∏è Eliminar permanentemente
                                    </button>
                                    `
                                        : ""
                                }

                                ${
                                    activeTab === "contactadas"
                                        ? `
                                    ${
                                        sol.profesionalId === currentUser.uid
                                            ? `<button onclick="liberarOportunidad('${sol.id}')" class="w-full mb-2 px-4 py-2 border border-orange-200 text-orange-600 font-bold rounded-lg hover:bg-orange-50 transition flex items-center justify-center gap-2 text-xs">
                                        üîÑ Cancelar / Liberar
                                    </button>`
                                            : ""
                                    }
                                    <div class="text-center py-4 bg-green-50 rounded-lg border border-green-100">
                                        <span class="block text-2xl mb-1">üí¨</span>
                                        <p class="text-green-800 font-bold text-sm">Conversaci√≥n Iniciada</p>
                                        <a href="https://wa.me/549${sol.telefono?.replace(/\D/g, "")}" target="_blank" class="text-xs text-green-600 hover:underline mt-1 block">Abrir WhatsApp de nuevo</a>
                                    </div>
                                    `
                                        : ""
                                }
                            </div>
                        </div>
                    `;
                        })
                        .join("");

                    console.log(
                        "üé® [RENDER] HTML generado, longitud:",
                        grid.innerHTML.length,
                    );
                    console.log("üé® [RENDER] Grid renderizado exitosamente");
                }

                // ACCIONES
                async function contactarCliente(id, nombre, telefono) {
                    if (!currentUser) return;

                    if (!telefono) {
                        alert(
                            "Este cliente no dej√≥ tel√©fono (versi√≥n antigua de solicitud).",
                        );
                        return;
                    }

                    // 1. Marcar como contactado en DB Y Bloquear para mi (status: aceptada)
                    try {
                        const solRef = doc(db, "solicitudes", id);
                        await updateDoc(solRef, {
                            contactadosPor: arrayUnion(currentUser.uid),
                            status: "aceptada",
                            profesionalId: currentUser.uid,
                            profesionalNombre:
                                currentUser.displayName || "Profesional",
                            profesionalFoto: currentUser.photoURL || "",
                            fechaAceptacion: new Date(),
                        });

                        // Actualizar estado local
                        todasSolicitudes = todasSolicitudes.map((s) => {
                            if (s.id === id) {
                                const prev = s.contactadosPor || [];
                                return {
                                    ...s,
                                    contactadosPor: [...prev, currentUser.uid],
                                    status: "aceptada",
                                    profesionalId: currentUser.uid,
                                };
                            }
                            return s;
                        });

                        renderOportunidades();

                        // 2. Abrir WhatsApp
                        const mensaje = `Hola ${nombre}, soy ${currentUser.displayName || "profesional"} de DeOficios. Vi tu pedido de ${todasSolicitudes.find((s) => s.id === id)?.rubro || "trabajo"} y me interesa pasarte un presupuesto.`;
                        const url = `https://wa.me/549${telefono}?text=${encodeURIComponent(mensaje)}`;
                        window.open(url, "_blank");
                    } catch (e) {
                        console.error(e);
                        alert("Error al procesar contacto");
                    }
                }

                async function descartarSolicitud(id) {
                    if (
                        !confirm(
                            "¬øSeguro que quieres descartar esta oportunidad?",
                        )
                    )
                        return;

                    try {
                        const solRef = doc(db, "solicitudes", id);
                        await updateDoc(solRef, {
                            descartadosPor: arrayUnion(currentUser.uid),
                        });

                        // Actualizar local
                        todasSolicitudes = todasSolicitudes.map((s) => {
                            if (s.id === id) {
                                const prev = s.descartadosPor || [];
                                return {
                                    ...s,
                                    descartadosPor: [...prev, currentUser.uid],
                                };
                            }
                            return s;
                        });

                        renderOportunidades();
                    } catch (e) {
                        console.error(e);
                        alert("Error al descartar");
                    }
                }

                async function eliminarOportunidad(id) {
                    if (
                        !confirm(
                            "¬øEliminar de la lista? No podr√°s recuperarla.",
                        )
                    )
                        return;

                    try {
                        const solRef = doc(db, "solicitudes", id);
                        await updateDoc(solRef, {
                            eliminadosPor: arrayUnion(currentUser.uid),
                        });

                        // Actualizar local
                        todasSolicitudes = todasSolicitudes.map((s) => {
                            if (s.id === id) {
                                const prev = s.eliminadosPor || [];
                                return {
                                    ...s,
                                    eliminadosPor: [...prev, currentUser.uid],
                                };
                            }
                            return s;
                        });

                        renderOportunidades();
                    } catch (error) {
                        console.error("Error eliminando:", error);
                        alert("No se pudo eliminar la oportunidad");
                    }
                }

                async function liberarOportunidad(id) {
                    if (
                        !confirm(
                            "¬øLiberar esta oportunidad? Volver√° a estar disponible para otros profesionales.",
                        )
                    )
                        return;

                    try {
                        const solRef = doc(db, "solicitudes", id);

                        await updateDoc(solRef, {
                            status: "nueva",
                            profesionalId: deleteField(),
                            profesionalNombre: deleteField(),
                            profesionalFoto: deleteField(),
                            fechaAceptacion: deleteField(),
                        });

                        // Update local state and remove from view if needed
                        todasSolicitudes = todasSolicitudes.map((s) => {
                            if (s.id === id) {
                                const copy = { ...s };
                                delete copy.profesionalId;
                                copy.status = "nueva";
                                return copy;
                            }
                            return s;
                        });

                        renderOportunidades();
                        alert("Oportunidad liberada correctamente.");
                    } catch (e) {
                        console.error(e);
                        alert("Error al liberar oportunidad");
                    }
                }

                // MODAL SYSTEM
                function showAlert(title, message, icon = "‚ú®") {
                    document.getElementById("alert-title").innerText = title;
                    document.getElementById("alert-message").innerText =
                        message;
                    document.getElementById("alert-icon").innerText = icon;
                    document
                        .getElementById("custom-alert")
                        .classList.add("active");
                }

                window.closeAlert = () => {
                    document
                        .getElementById("custom-alert")
                        .classList.remove("active");
                };

                // Exponer funciones globales
                window.contactarCliente = contactarCliente;
                window.descartarSolicitud = descartarSolicitud;
                window.eliminarOportunidad = eliminarOportunidad;
                (window as any).liberarOportunidad = liberarOportunidad;
                window.restaurarSolicitud = async function (id: any) {
                    showAlert(
                        "Pr√≥ximamente",
                        "La funcionalidad de restaurar estar√° disponible pronto.",
                        "‚è≥",
                    );
                };
            })(); // End of IIFE
        </script>
    </body>
</html>
