---
import { auth } from "../../firebase/client";
import Sidebar from "../../components/panel/Sidebar.astro";
import MobileSidebar from "../../components/panel/MobileSidebar.astro";
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Oportunidades - DeOficios Pro" hideHeader={true} hideIA={true} hideBottomNav={true}>

    <style>
        /* Custom scrollbar for better look */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        /* Page Transitions */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-container {
            background: white;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            box-shadow:
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.active .modal-container {
            transform: scale(1);
        }
    </style>

    <div class="flex h-screen overflow-hidden">
        <!-- SIDEBARS -->
        <Sidebar currentPath={Astro.url.pathname} />
        <MobileSidebar currentPath={Astro.url.pathname} />

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-screen relative overflow-hidden bg-slate-50">
            <!-- Header Panel -->
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-30 relative shrink-0">
                <div class="flex items-center gap-4">
                    <button id="open-sidebar" class="md:hidden text-2xl mr-2">☰</button>
                    <h2 class="text-lg font-bold text-slate-800">Oportunidades</h2>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto">
                <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- HEADER -->
                <div
                    class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">
                            Oportunidades de Trabajo
                        </h1>
                        <p class="text-slate-500 mt-1">
                            Solicitudes de clientes que coinciden con tu
                            perfil
                        </p>
                    </div>
                </div>

                <!-- TABS -->
                <div class="border-b border-slate-200 mb-6 overflow-x-auto">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button
                            id="tab-nuevas"
                            class="tab-btn active border-orange-500 text-orange-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            Nuevas
                        </button>
                        <button
                            id="tab-contactadas"
                            class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            Contactadas
                        </button>
                        <button
                            id="tab-descartadas"
                            class="tab-btn border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                            Descartadas
                        </button>
                    </nav>
                </div>

                <!-- LOADING STATE -->
                <div id="loading" class="text-center py-12">
                    <div
                        class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto">
                    </div>
                    <p class="text-slate-400 mt-4">
                        Buscando oportunidades en tu zona...
                    </p>
                </div>

                <!-- ERROR STATE -->
                <div id="error-state" class="hidden text-center py-12">
                    <div class="text-5xl mb-4">⚠️</div>
                    <p class="text-slate-500">
                        Ocurrió un error al cargar las oportunidades.
                    </p>
                    <p class="text-xs text-slate-400 mt-2">
                        Si es la primera vez, es posible que se esté creando
                        el índice de base de datos.
                    </p>
                </div>

                <!-- EMPTY STATE -->
                <div
                    id="empty-state"
                    class="hidden text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300">
                    <div class="mx-auto h-12 w-12 text-slate-300 mb-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                    </div>
                    <h3
                        id="empty-title"
                        class="mt-2 text-sm font-medium text-slate-900">
                        No hay nuevas oportunidades
                    </h3>
                    <p id="empty-desc" class="mt-1 text-sm text-slate-500">
                        Te avisaremos cuando alguien busque un servicio en
                        tu zona.
                    </p>
                </div>

                <!-- GRID OPORTUNIDADES -->
                <div
                    id="oportunidades-grid"
                    class="grid grid-cols-1 gap-6"
                    style="display: none;">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL ALERTA -->
    <div id="custom-alert" class="modal-overlay">
        <div class="modal-container text-center">
            <div id="alert-icon" class="text-5xl mb-4"></div>
            <h3
                id="alert-title"
                class="text-xl font-bold text-slate-900 mb-2">
            </h3>
            <p id="alert-message" class="text-slate-600 mb-6"></p>
            <button
                onclick="closeAlert()"
                class="w-full bg-slate-900 text-white font-bold py-3 px-6 rounded-xl hover:bg-slate-800 transition shadow-lg active:scale-95">
                Entendido
            </button>
        </div>
    </div>

    <!-- MODAL COTIZACIÓN -->
    <div id="modal-cotizacion" class="modal-overlay">
        <div class="modal-container text-left">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-900">
                    Enviar Presupuesto
                </h3>
                <button
                    onclick="cerrarModalCotizacion()"
                    class="text-slate-400 hover:text-slate-600">✕</button>
            </div>

            <p class="text-sm text-slate-500 mb-4">
                Estás cotizando para <b id="cot-cliente-nombre">Cliente</b>.
            </p>

            <form
                id="form-cotizacion"
                onsubmit="event.preventDefault(); enviarCotizacion();">
                <div class="mb-4">
                    <label
                        class="block text-sm font-medium text-slate-700 mb-1">Precio Estimado ($)</label>
                    <input
                        type="number"
                        id="cot-precio"
                        class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition"
                        placeholder="Ej: 15000"
                        required
                        min="1">
                </div>

                <div class="mb-6">
                    <label
                        class="block text-sm font-medium text-slate-700 mb-1">Mensaje / Detalle</label>
                    <textarea
                        id="cot-mensaje"
                        rows="3"
                        class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition"
                        placeholder="Hola, puedo realizar el trabajo. Incluye materiales..."
                        required></textarea>
                </div>

                <p
                    class="text-xs text-slate-400 mb-4 bg-yellow-50 p-2 rounded border border-yellow-100">
                    ⚠️ Tu presupuesto se mostrará al cliente junto con otros
                    para que pueda comparar.
                </p>

                <div class="flex gap-3">
                    <button
                        type="button"
                        onclick="cerrarModalCotizacion()"
                        class="flex-1 bg-white border border-slate-300 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-50 transition">
                        Cancelar
                    </button>
                    <button
                        type="submit"
                        id="btn-enviar-cotizacion"
                        class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg active:scale-95 flex justify-center items-center gap-2">
                        <span>💰</span> Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        import { db, auth } from "../../firebase/client";
        import {
            collection,
            query,
            where,
            getDocs,
            orderBy,
            limit,
            doc,
            updateDoc,
            arrayUnion,
            getDoc,
            deleteField,
            addDoc,
            increment,
        } from "firebase/firestore";
        import { onAuthStateChanged } from "firebase/auth";

        let currentUser: any = null;
        let todasSolicitudes: any[] = [];

        // Execute immediately - IIFE pattern
        (function () {
            console.log("🚀 [OPORTUNIDADES] Ejecutando inicialización...");

            // Referencias DOM
            const grid = document.getElementById("oportunidades-grid");
            const loading = document.getElementById("loading");
            const errorState = document.getElementById("error-state");
            const emptyState = document.getElementById("empty-state");
            const emptyTitle = document.getElementById("empty-title");
            const emptyDesc = document.getElementById("empty-desc");
            const tabs = document.querySelectorAll(".tab-btn");

            // Estado local
            let activeTab = "nuevas"; // nuevas | contactadas | descartadas
            // Variable global para almacenar los unsubscribe de los listeners
            let unsubscribers: any[] = [];
            let clientNames = new Map(); // Cache para nombres reales de clientes

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadOportunidades();
                } else {
                    window.location.href = "/ingresar-profesional";
                }
            });

            // LOGOUT
            document
                .getElementById("btn-logout")
                ?.addEventListener("click", () => {
                    auth.signOut().then(() => (window.location.href = "/"));
                });

            // TABS
            tabs.forEach((btn) => {
                btn.addEventListener("click", () => {
                    // Update UI
                    tabs.forEach((t) => {
                        t.classList.remove(
                            "border-orange-500",
                            "text-orange-600",
                            "active",
                        );
                        t.classList.add(
                            "border-transparent",
                            "text-slate-500",
                        );
                    });
                    btn.classList.add(
                        "border-orange-500",
                        "text-orange-600",
                        "active",
                    );
                    btn.classList.remove(
                        "border-transparent",
                        "text-slate-500",
                    );

                    // Update Logic
                    activeTab = btn.id.split("-")[1]; // nuevas, contactadas, descartadas
                    renderOportunidades();
                });
            });


            async function loadOportunidades() {
                console.log(
                    "🚀 [OPORTUNIDADES] Iniciando carga en tiempo real...",
                );

                // Limpiar listeners anteriores si existen
                unsubscribers.forEach((unsub) => unsub());
                unsubscribers = [];

                // Ocultar todo inicialmente
                [loading, grid, emptyState, errorState].forEach((el) => {
                    if (el) {
                        el.style.display = "none";
                        el.classList.add("hidden");
                    }
                });

                try {
                    if (loading) loading.style.display = "block";
                    if (loading) loading.classList.remove("hidden");

                    console.log(
                        "🔍 [OPORTUNIDADES] Consultando Firestore para UID:",
                        currentUser?.uid,
                    );

                    // 1. Primero, obtener el perfil del profesional para saber su rubro y zona
                    const profDoc = await getDoc(
                        doc(db, "profesionales", currentUser.uid),
                    );

                    if (!profDoc.exists()) {
                        console.error(
                            "❌ No se encontró el perfil del profesional",
                        );
                        if (errorState) errorState.style.display = "block";
                        if (errorState)
                            errorState.classList.remove("hidden");
                        return;
                    }

                    const profData = profDoc.data();

                    // OBTENER TODOS LOS RUBROS Y ZONAS DISPONIBLES DEL PERFIL
                    const misRubros =
                        profData.rubros?.length > 0
                            ? profData.rubros
                            : profData.rubro_principal
                              ? [profData.rubro_principal]
                              : [];

                    const misZonas =
                        profData.zonas?.length > 0
                            ? profData.zonas
                            : profData.zona
                              ? [profData.zona]
                              : [];

                    // 2. CONFIGURAR LISTENERS EN TIEMPO REAL
                    // Usamos onSnapshot en lugar de getDocs
                    const { onSnapshot } =
                        await import("firebase/firestore");

                    const updateUI = async () => {
                        // Convertir Map a Array and sort
                        const arr = Array.from(allSolicitudes.values());
                        
                        // Resolver nombres
                        const { doc, getDoc } = await import("firebase/firestore");
                        const namePromises = arr.map(async (sol: any) => {
                            if (sol.clienteId && !clientNames.has(sol.clienteId)) {
                                const isGeneric = !sol.clienteNombre || sol.clienteNombre.toLowerCase().includes('cliente') || sol.clienteNombre.includes('@');
                                if (isGeneric) {
                                    try {
                                        const cSnap = await getDoc(doc(db, "clientes", sol.clienteId));
                                        if (cSnap.exists()) {
                                            const cData = cSnap.data();
                                            if (cData.nombre) {
                                                clientNames.set(sol.clienteId, cData.nombre);
                                                return;
                                            }
                                        }
                                        clientNames.set(sol.clienteId, sol.clienteNombre || 'Cliente');
                                    } catch (e) {
                                        clientNames.set(sol.clienteId, sol.clienteNombre || 'Cliente');
                                    }
                                } else {
                                    clientNames.set(sol.clienteId, sol.clienteNombre);
                                }
                            }
                        });

                        await Promise.all(namePromises);

                        todasSolicitudes = arr.sort((a, b) => {
                            const fechaA =
                                a.fecha?.toDate?.() ||
                                new Date(a.fecha || 0);
                            const fechaB =
                                b.fecha?.toDate?.() ||
                                new Date(b.fecha || 0);
                            //@ts-ignore
                            return fechaB - fechaA;
                        });

                        renderOportunidades();
                        if (loading) loading.style.display = "none";
                    };

                    const allSolicitudes = new Map();

                    // Listener 1: Donde soy candidato (el sistema me seleccionó)
                    const qCandidato = query(
                        collection(db, "solicitudes"),
                        where(
                            "candidatos",
                            "array-contains",
                            currentUser.uid,
                        ),
                        orderBy("fecha", "desc"),
                        limit(50),
                    );

                    const unsub1 = onSnapshot(qCandidato, (snapshot) => {
                        snapshot.docs.forEach((doc) => {
                            const data = doc.data();
                            if (
                                !data.eliminadosPor?.includes(
                                    currentUser.uid,
                                )
                            ) {
                                allSolicitudes.set(doc.id, {
                                    id: doc.id,
                                    ...data,
                                });
                            }
                        });
                        updateUI();
                    });
                    unsubscribers.push(unsub1);

                    // Listener 2: Coincidencia por Rubro (Multi-Rubro)
                    if (misRubros.length > 0) {
                        const qRubros = query(
                            collection(db, "solicitudes"),
                            where("rubro", "in", misRubros),
                            where("status", "==", "nueva"),
                            // orderBy("fecha", "desc"), // Requires composite index: https://console.firebase.google.com/
                            limit(50),
                        );

                        const unsub2 = onSnapshot(
                            qRubros,
                            (snapshot) => {
                                snapshot.docs.forEach((doc) => {
                                    if (!allSolicitudes.has(doc.id)) {
                                        const data = doc.data();
                                        // FILTRADO CLIENT-SIDE POR ZONA Y ELIMINADOS
                                        const zonaMatch =
                                            misZonas.length === 0 ||
                                            misZonas.includes(data.zona);
                                        const notDeleted =
                                            !data.eliminadosPor?.includes(
                                                currentUser.uid,
                                            );

                                        if (zonaMatch && notDeleted) {
                                            allSolicitudes.set(doc.id, {
                                                id: doc.id,
                                                ...data,
                                            });
                                        }
                                    }
                                });
                                updateUI();
                            },
                            (error) => {
                                console.warn(
                                    "⚠️ Listener multi-rubro falló (puede ser falta de permisos):",
                                    error,
                                );
                            },
                        );
                        unsubscribers.push(unsub2);
                    }

                    // Listener 3: Mis Presupuestos / Aceptados
                    const qAceptados = query(
                        collection(db, "solicitudes"),
                        where("profesionalId", "==", currentUser.uid),
                        orderBy("fecha", "desc"),
                    );

                    const unsub3 = onSnapshot(qAceptados, (snapshot) => {
                        snapshot.docs.forEach((doc) => {
                            allSolicitudes.set(doc.id, {
                                id: doc.id,
                                ...doc.data(),
                            });
                        });
                        updateUI();
                    });
                    unsubscribers.push(unsub3);
                } catch (error) {
                    console.error(
                        "❌ [OPORTUNIDADES] Error configurando listeners:",
                        error,
                    );
                    if (errorState) errorState.style.display = "block";
                    if (errorState) errorState.classList.remove("hidden");
                    if (loading) loading.style.display = "none";
                }
            }

            function renderOportunidades() {
                console.log("🔄 [RENDER] Iniciando renderOportunidades...");
                console.log(
                    "📊 [RENDER] Total solicitudes:",
                    todasSolicitudes.length,
                );
                console.log("🏷️ [RENDER] Tab activo:", activeTab);

                // Filtrar según Tab
                const filtered = todasSolicitudes.filter((sol) => {
                    const contactado = sol.contactadosPor?.includes(
                        currentUser.uid,
                    );
                    const descartado = sol.descartadosPor?.includes(
                        currentUser.uid,
                    );

                    if (activeTab === "nuevas") {
                        return (
                            !contactado &&
                            !descartado &&
                            sol.status === "nueva"
                        );
                    }
                    if (activeTab === "contactadas") return contactado;
                    if (activeTab === "descartadas") return descartado;
                    return false;
                });

                console.log(
                    "✅ [RENDER] Solicitudes filtradas:",
                    filtered.length,
                );
                console.log("📦 [RENDER] Datos filtrados:", filtered);
                if (filtered.length === 0) {
                    console.log(
                        "📭 [RENDER] No hay solicitudes filtradas - mostrando empty state",
                    );
                }

                // Update count badge
                const nuevasCount = todasSolicitudes.filter(
                    (s) =>
                        !s.contactadosPor?.includes(currentUser.uid) &&
                        !s.descartadosPor?.includes(currentUser.uid),
                ).length;

                const badge = document.getElementById(
                    "badge-oportunidades",
                );
                if (badge) {
                    badge.innerText = nuevasCount.toString();
                    if (nuevasCount > 0) {
                        badge.style.display = "inline-block";
                        badge.classList.remove("hidden");
                    } else {
                        badge.style.display = "none";
                        badge.classList.add("hidden");
                    }
                }

                // Empty State Logic
                if (filtered.length === 0) {
                    console.log("📭 [RENDER] Mostrando empty state");
                    if (grid) grid.style.display = "none";
                    if (emptyState) emptyState.style.display = "";
                    if (emptyState) emptyState.classList.remove("hidden");

                    if (activeTab === "nuevas") {
                        if (emptyTitle)
                            emptyTitle.innerText =
                                "No hay nuevas oportunidades";
                        if (emptyDesc)
                            emptyDesc.innerText =
                                "Te avisaremos cuando alguien busque un servicio en tu zona.";
                    } else if (activeTab === "contactadas") {
                        if (emptyTitle)
                            emptyTitle.innerText =
                                "Aún no has contactado a nadie";
                        if (emptyDesc)
                            emptyDesc.innerText =
                                "Las oportunidades que contactes aparecerán aquí.";
                    } else {
                        if (emptyTitle)
                            emptyTitle.innerText = "Papelera vacía";
                        if (emptyDesc)
                            emptyDesc.innerText =
                                "Las oportunidades descartadas aparecerán aquí.";
                    }
                    return;
                }

                if (loading) loading.style.display = "none";
                if (grid) grid.style.display = "grid";
                if (grid) grid.classList.remove("hidden");

                console.log(
                    "🎨 [RENDER] Generando HTML para",
                    filtered.length,
                    "items",
                );
                if (grid)
                    grid.innerHTML = filtered
                        .map((sol) => {
                            // Formatear fecha
                            let fechaStr = "Reciente";
                            if (sol.fecha && sol.fecha.seconds) {
                                const date = new Date(
                                    sol.fecha.seconds * 1000,
                                );
                                fechaStr = new Intl.DateTimeFormat(
                                    "es-AR",
                                    {
                                        day: "numeric",
                                        month: "short",
                                        hour: "2-digit",
                                        minute: "2-digit",
                                    },
                                ).format(date);
                            }

                            // Badges
                            const urgenteBadge = sol.urgente
                                ? `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">🚨 Urgente</span>`
                                : "";

                            const nuevoBadge =
                                !sol.leidoPor?.includes(currentUser.uid) &&
                                activeTab === "nuevas"
                                    ? `<span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">Nuevo</span>`
                                    : "";

                            const isAcceptedByMe =
                                sol.profesionalId === currentUser.uid;
                            const acceptedBadge = isAcceptedByMe
                                ? `<span class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded-full border border-purple-200">🎯 Tu Trabajo</span>`
                                : "";

                            const yaCotice =
                                sol.presupuestadosPor?.includes(
                                    currentUser.uid,
                                );
                            const cotizadoBadge = yaCotice
                                ? `<span class="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded-full border border-indigo-200">💼 Cotizado</span>`
                                : "";

                            return `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row gap-6 hover:shadow-md transition">
                            <!-- Info Principal -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <span class="bg-slate-100 text-slate-700 text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wide">${sol.rubro}</span>
                                        ${urgenteBadge}
                                        ${nuevoBadge}
                                        ${acceptedBadge}
                                        ${cotizadoBadge}
                                        ${
                                            sol.presupuesto
                                                ? `<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">💰 Presupuesto: $${sol.presupuesto}</span>`
                                                : ""
                                        }
                                    </div>
                                    <span class="text-xs text-slate-400 flex items-center gap-1 whitespace-nowrap">
                                        🕐 ${fechaStr}
                                    </span>
                                </div>

                                <h3 class="text-xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    ${(() => {
                                        const nameFromCache = clientNames.get(sol.clienteId);
                                        const nombre = nameFromCache || sol.clienteNombre || 'Cliente';
                                        
                                        if (nombre.includes('@')) {
                                            return nombre.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                        }
                                        return nombre;
                                    })()}
                                </h3>

                                <div class="flex items-center gap-2 text-slate-600 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100 w-fit">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    <span class="font-bold text-sm text-slate-700">${sol.zona}</span>
                                </div>

                                <p class="text-slate-600 mb-4 line-clamp-3 md:line-clamp-none bg-white p-3 rounded-lg border border-slate-50 text-sm italic">
                                    "${sol.detalle}"
                                </p>

                                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                                    <span class="flex items-center gap-2 font-medium text-slate-400">
                                        <div class="flex flex-col">
                                            <span class="text-xs">${sol.clienteEmail || ''}</span>
                                        </div>
                                    </span>
                                    ${
                                        activeTab === "contactadas"
                                            ? `
                                        <span class="text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded">✅ Contactado</span>
                                    `
                                            : ""
                                    }
                                    ${
                                        sol.profesionalId === currentUser.uid
                                            ? `<span class="text-purple-600 font-bold text-xs bg-purple-50 px-2 py-1 rounded border border-purple-100">💼 Presupuestando</span>`
                                            : ""
                                    }
                                </div>
                            </div>

                            <!-- Acciones -->
                            <div class="flex flex-col gap-3 justify-center min-w-[220px] border-t md:border-t-0 md:border-l border-slate-100 pt-5 md:pt-0 md:pl-6">
                                ${
                                    activeTab === "nuevas"
                                        ? `
                                    ${
                                        yaCotice
                                            ? `
                                    <button
                                        disabled
                                        class="w-full bg-indigo-50 border border-indigo-100 text-indigo-400 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed opacity-80">
                                        <span>✔️</span> Ya Cotizaste
                                    </button>
                                    `
                                            : `
                                    <button
                                        onclick="abrirModalCotizacion('${sol.id}', '${sol.clienteNombre}')"
                                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition shadow-sm hover:shadow active:scale-95">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                        Cotizar Ahora
                                    </button>
                                    `
                                }

                                <button
                                        onclick="descartarSolicitud('${sol.id}')"
                                        class="w-full text-slate-500 hover:text-red-600 hover:bg-red-50 font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                        Descartar
                                    </button>
                                    `
                                        : ""
                                }

                                ${
                                    activeTab === "descartadas"
                                        ? `
                                    <button onclick="eliminarOportunidad('${sol.id}')" class="w-full px-4 py-2 border border-red-200 text-red-600 font-bold rounded-lg hover:bg-red-50 transition flex items-center justify-center gap-2">
                                        🗑️ Eliminar permanentemente
                                    </button>
                                    `
                                        : ""
                                }

                                ${
                                    activeTab === "contactadas"
                                        ? `
                                    ${
                                        sol.profesionalId === currentUser.uid
                                            ? `<button onclick="liberarOportunidad('${sol.id}')" class="w-full mb-2 px-4 py-2 border border-orange-200 text-orange-600 font-bold rounded-lg hover:bg-orange-50 transition flex items-center justify-center gap-2 text-xs">
                                        ❌ Cancelar / Liberar
                                    </button>`
                                            : ""
                                    }
                                    <div class="text-center py-4 bg-green-50 rounded-lg border border-green-100">
                                        <span class="block text-2xl mb-1">✅</span>
                                        <p class="text-green-800 font-bold text-sm">Conversación Iniciada</p>
                                        <a href="https://wa.me/549${sol.telefono?.replace(/\D/g, "")}" target="_blank" class="text-xs text-green-600 hover:underline mt-1 block">Abrir WhatsApp de nuevo</a>
                                    </div>
                                    `
                                        : ""
                                }
                            </div>
                        </div>
                    `;
                        })
                        .join("");

                console.log(
                    "✅ [RENDER] HTML generado, longitud:",
                    grid.innerHTML.length,
                );
                console.log("🎉 [RENDER] Grid renderizado exitosamente");
            }

            // ACCIONES
            async function contactarCliente(id, nombre, telefono) {
                if (!currentUser) return;

                if (!telefono) {
                    alert(
                        "Este cliente no dejó teléfono (versión antigua de solicitud).",
                    );
                    return;
                }

                try {
                    // 0. Generar Token de Seguridad
                    const token = Math.floor(
                        100000 + Math.random() * 900000,
                    ).toString();
                    console.log("🔐 [CONTACTAR] Generando token:", token);

                    // 1. Guardar en Colección 'contactos' (Para que ambos vean el código)
                    const solData = todasSolicitudes.find(
                        (s) => s.id === id,
                    );
                    console.log(
                        "📋 [CONTACTAR] Datos de solicitud encontrados:",
                        solData,
                    );

                    if (!solData) {
                        console.error(
                            "❌ [CONTACTAR] No se encontró solData para ID:",
                            id,
                        );
                        alert(
                            "Error interno: No se encontraron datos de la solicitud.",
                        );
                        return;
                    }

                    const contactoData = {
                        clienteId: solData.clienteId || "unknown",
                        clienteNombre: nombre,
                        clienteTelefono: telefono, // Added phone for "Responder" feature
                        proId: currentUser.uid,
                        proNombre: currentUser.displayName || "Profesional",
                        rubro: solData.rubro || "Servicio",
                        fecha: new Date(),
                        token: token,
                        solicitudId: id,
                    };
                    console.log(
                        "💾 [CONTACTAR] Intentando crear contacto:",
                        contactoData,
                    );

                    try {
                        const contactRef = await addDoc(
                            collection(db, "contactos"),
                            contactoData,
                        );
                        console.log(
                            "✅ [CONTACTAR] Contacto creado con ID:",
                            contactRef.id,
                        );
                    } catch (docError) {
                        console.error(
                            "❌ [CONTACTAR] Error creando documento en 'contactos':",
                            docError,
                        );
                        alert(
                            "Error al generar código de seguridad. Revisa la consola.",
                        );
                        // Continue anyway to open WhatsApp but warn user
                    }

                    // 2. Marcar como contactado en DB Y Bloquear para mi (status: aceptada)
                    const solRef = doc(db, "solicitudes", id);
                    await updateDoc(solRef, {
                        contactadosPor: arrayUnion(currentUser.uid),
                        status: "aceptada",
                        profesionalId: currentUser.uid,
                        profesionalNombre:
                            currentUser.displayName || "Profesional",
                        profesionalFoto: currentUser.photoURL || "",
                        fechaAceptacion: new Date(),
                    });

                    // Actualizar estado local
                    todasSolicitudes = todasSolicitudes.map((s) => {
                        if (s.id === id) {
                            const prev = s.contactadosPor || [];
                            return {
                                ...s,
                                contactadosPor: [...prev, currentUser.uid],
                                status: "aceptada",
                                profesionalId: currentUser.uid,
                            };
                        }
                        return s;
                    });

                    renderOportunidades();

                    // 3. Enviar Email Notificación (Simulado)
                    if (solData?.clienteEmail) {
                        fetch("/api/send-email", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                to: solData.clienteEmail,
                                subject: `${currentUser.displayName || "Un profesional"} ha aceptado tu solicitud! `,
                                html: `
                                        <h2>Buenas noticias, ${nombre}!</h2>
                                        <p>El profesional <strong>${currentUser.displayName || "DeOficios Pro"}</strong> ha visto tu solicitud para <strong>${solData.rubro}</strong> y quiere contactarte.</p>
                                        <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0;">
                                            <p style="margin: 0; font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: bold;">Tu Código de Seguridad</p>
                                            <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: 900; letter-spacing: 5px; color: #ea580c;">${token}</p>
                                            <p style="margin: 10px 0 0 0; font-size: 11px; color: #6b7280;">Pídele este código al profesional cuando llegue a tu domicilio.</p>
                                        </div>
                                        <p>Te escribirá por WhatsApp a la brevedad.</p>
                                    `,
                                type: "Solicitud Aceptada",
                            }),
                        }).catch((err) =>
                            console.error("Error enviando email:", err),
                        );
                    }

                    // 4. Abrir WhatsApp
                    const mensaje = `Hola ${nombre}, soy ${currentUser.displayName || "profesional"} de DeOficios. Vi tu pedido de ${solData?.rubro || "trabajo"} y mi código de seguridad es ${token}. Me interesa pasarte un presupuesto.`;
                    const url = `https://wa.me/549${telefono}?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, "_blank");
                } catch (e) {
                    console.error(e);
                    alert("Error al procesar contacto");
                }
            }

            async function descartarSolicitud(id) {
                if (
                    !confirm(
                        "¿Seguro que quieres descartar esta oportunidad?",
                    )
                )
                    return;

                try {
                    const solRef = doc(db, "solicitudes", id);
                    await updateDoc(solRef, {
                        descartadosPor: arrayUnion(currentUser.uid),
                    });

                    // Actualizar local
                    todasSolicitudes = todasSolicitudes.map((s) => {
                        if (s.id === id) {
                            const prev = s.descartadosPor || [];
                            return {
                                ...s,
                                descartadosPor: [...prev, currentUser.uid],
                            };
                        }
                        return s;
                    });

                    renderOportunidades();
                } catch (e) {
                    console.error(e);
                    alert("Error al descartar");
                }
            }

            async function eliminarOportunidad(id) {
                if (
                    !confirm(
                        "¿Eliminar de la lista? No podrás recuperarla.",
                    )
                )
                    return;

                try {
                    const solRef = doc(db, "solicitudes", id);
                    await updateDoc(solRef, {
                        eliminadosPor: arrayUnion(currentUser.uid),
                    });

                    // Actualizar local
                    todasSolicitudes = todasSolicitudes.map((s) => {
                        if (s.id === id) {
                            const prev = s.eliminadosPor || [];
                            return {
                                ...s,
                                eliminadosPor: [...prev, currentUser.uid],
                            };
                        }
                        return s;
                    });

                    renderOportunidades();
                } catch (error) {
                    console.error("Error eliminando:", error);
                    alert("No se pudo eliminar la oportunidad");
                }
            }

            async function liberarOportunidad(id) {
                if (
                    !confirm(
                        "¿Liberar esta oportunidad? Volverá a estar disponible para otros profesionales.",
                    )
                )
                    return;

                try {
                    const solRef = doc(db, "solicitudes", id);

                    await updateDoc(solRef, {
                        status: "nueva",
                        profesionalId: deleteField(),
                        profesionalNombre: deleteField(),
                        profesionalFoto: deleteField(),
                        fechaAceptacion: deleteField(),
                    });

                    // Update local state and remove from view if needed
                    todasSolicitudes = todasSolicitudes.map((s) => {
                        if (s.id === id) {
                            const copy = { ...s };
                            delete copy.profesionalId;
                            copy.status = "nueva";
                            return copy;
                        }
                        return s;
                    });

                    renderOportunidades();
                    alert("Oportunidad liberada correctamente.");
                } catch (e) {
                    console.error(e);
                    alert("Error al liberar oportunidad");
                }
            }

            // MODAL SYSTEM
            function showAlert(title, message, icon = "ℹ️") {
                document.getElementById("alert-title").innerText = title;
                document.getElementById("alert-message").innerText =
                    message;
                document.getElementById("alert-icon").innerText = icon;
                document
                    .getElementById("custom-alert")
                    .classList.add("active");
            }

            window.closeAlert = () => {
                document
                    .getElementById("custom-alert")
                    .classList.remove("active");
            };

            // Exponer funciones globales
            window.contactarCliente = contactarCliente;
            window.descartarSolicitud = descartarSolicitud;
            window.eliminarOportunidad = eliminarOportunidad;
            (window as any).liberarOportunidad = liberarOportunidad;
            (window as any).abrirModalCotizacion =
                window.abrirModalCotizacion;
            (window as any).cerrarModalCotizacion =
                window.cerrarModalCotizacion;
            (window as any).enviarCotizacion = window.enviarCotizacion;
            // --- LÓGICA DE COTIZACIÓN ---
            let cotizacionActual = { id: null, clienteNombre: null };

            window.abrirModalCotizacion = (id, nombre) => {
                cotizacionActual = { id, clienteNombre: nombre };

                const spanNombre =
                    document.getElementById("cot-cliente-nombre");
                if (spanNombre) spanNombre.innerText = nombre;

                // Limpiar form
                (
                    document.getElementById(
                        "form-cotizacion",
                    ) as HTMLFormElement
                )?.reset();

                document
                    .getElementById("modal-cotizacion")
                    ?.classList.add("active");
            };

            window.cerrarModalCotizacion = () => {
                document
                    .getElementById("modal-cotizacion")
                    ?.classList.remove("active");
                cotizacionActual = { id: null, clienteNombre: null };
            };

            window.enviarCotizacion = async () => {
                if (!currentUser || !cotizacionActual.id) return;

                const precioInput = document.getElementById(
                    "cot-precio",
                ) as HTMLInputElement;
                const mensajeInput = document.getElementById(
                    "cot-mensaje",
                ) as HTMLTextAreaElement;
                const btnEnviar = document.getElementById(
                    "btn-enviar-cotizacion",
                ) as HTMLButtonElement;

                const precio = precioInput.value;
                const mensaje = mensajeInput.value;

                if (!precio || !mensaje) {
                    alert("Por favor completa el precio y el mensaje.");
                    return;
                }

                try {
                    btnEnviar.disabled = true;
                    btnEnviar.innerText = "Enviando...";

                    // 1. Guardar propuesta en subcolección
                    const propuestaData = {
                        proId: currentUser.uid,
                        proNombre: currentUser.displayName || "Profesional",
                        proFoto: currentUser.photoURL || "",
                        precio: Number(precio),
                        mensaje: mensaje,
                        fecha: new Date(),
                        estado: "enviada", // enviada | aceptada | rechazada
                    };

                    // Referencia a la subcolección: solicitudes/{solicitudId}/propuestas
                    await addDoc(
                        collection(
                            db,
                            `solicitudes/${cotizacionActual.id}/propuestas`,
                        ),
                        propuestaData,
                    );

                    console.log("✅ Propuesta enviada exitosamente");

                    // 1.5 Crear Notificación para el cliente
                    const currentSol = todasSolicitudes.find(s => s.id === cotizacionActual.id);
                    if (currentSol && currentSol.clienteId) {
                        try {
                            await addDoc(
                                collection(db, `clientes/${currentSol.clienteId}/notificaciones`),
                                {
                                    titulo: "¡Nuevo presupuesto recibido! 💰",
                                    mensaje: `${currentUser.displayName || 'Un profesional'} te envió una propuesta por $${Number(precio).toLocaleString('es-AR')} para tu pedido de ${currentSol.rubro || 'servicio'}.`,
                                    tipo: "presupuesto",
                                    solicitudId: cotizacionActual.id,
                                    proId: currentUser.uid,
                                    proNombre: currentUser.displayName || "Profesional",
                                    fecha: new Date(),
                                    leida: false
                                }
                            );
                            console.log("🔔 [NOTIF] Notificación al cliente creada");
                        } catch (notifErr) {
                            console.error("❌ Error creando notificación:", notifErr);
                        }
                    }

                    // 2. Marcar solicitud como "Presupuestada" por este PRO (para feedback visual)
                    // Podemos usar 'presupuestadosPor' arrayUnion en la solicitud padre
                    await updateDoc(
                        doc(db, "solicitudes", cotizacionActual.id),
                        {
                            presupuestadosPor: arrayUnion(currentUser.uid),
                        },
                    );

                    // Actualizar UI Local
                    todasSolicitudes = todasSolicitudes.map((s) => {
                        if (s.id === cotizacionActual.id) {
                            const prev = s.presupuestadosPor || []; // Ojo: hay que agregar este campo en la render logic para mostrar badge
                            return {
                                ...s,
                                presupuestadosPor: [
                                    ...prev,
                                    currentUser.uid,
                                ],
                                // NO cambiamos status global a "aceptada" todavía, sigue en "nueva" para otros
                            };
                        }
                        return s;
                    });

                    window.cerrarModalCotizacion();
                    renderOportunidades(); // Re-render para mostrar badge "Presupuestando"
                    showAlert(
                        "Presupuesto Enviado!",
                        "El cliente recibirá tu propuesta. Si le interesa, te contactará.",
                        "✅",
                    );

                    // Opcional: Abrir WhatsApp con aviso
                    // const sol = todasSolicitudes.find(s => s.id === cotizacionActual.id);
                    // if(sol && sol.telefono) {
                    //    if(confirm("¿Querés avisarle por WhatsApp también?")) {
                    //        const text = `Hola ${sol.clienteNombre}, te envié un presupuesto de $${precio} por DeOficios. Avisame si te sirve.`;
                    //        window.open(`https://wa.me/549${sol.telefono.replace(/\D/g, "")}?text=${encodeURIComponent(text)}`, "_blank");
                    //    }
                    // }
                } catch (error) {
                    console.error("Error enviando cotización:", error);
                    alert(
                        "Error al enviar el presupuesto. Intenta nuevamente.",
                    );
                } finally {
                    btnEnviar.disabled = false;
                    btnEnviar.innerHTML = "<span>💰</span> Enviar";
                }
            };

            window.restaurarSolicitud = async function (id: any) {
                showAlert(
                    "Próximamente",
                    "La funcionalidad de restaurar estará disponible pronto.",
                    "ℹ️",
                );
            };
        })(); // End of IIFE
    </script>

                </div> <!-- max-w-5xl -->
            </div> <!-- flex-1 overflow-y-auto -->
        </main>
    </div> <!-- outer flex -->

    <script>
        // Sidebar Mobile Toggle
        const btnOpenSidebar = document.getElementById("open-sidebar");
        
        btnOpenSidebar?.addEventListener("click", () => {
            document.dispatchEvent(new CustomEvent("toggle-sidebar"));
        });
    </script>
</Layout>
