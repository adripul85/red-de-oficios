---
import { auth, db } from "../../firebase/client";
import Sidebar from "../../components/panel/Sidebar.astro";
import MobileSidebar from "../../components/panel/MobileSidebar.astro";
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Presupuestos - DeOficios Pro" hideHeader={true} hideBottomNav={true} hideIA={true}>
    
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }

        /* Page Transitions */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
        <div class="flex h-screen overflow-hidden">
            <!-- SIDEBARS -->
            <Sidebar currentPath={Astro.url.pathname} />
            <MobileSidebar currentPath={Astro.url.pathname} />

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-50">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4">
                    <button id="open-sidebar" class="md:hidden text-2xl mr-2">☰</button>
                    <h2 class="text-lg font-bold text-slate-800">
                        Gestor de Presupuestos
                    </h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <button id="btn-notifications" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 relative transition-colors">
                        🔔
                        <span id="badge-bell" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                    </button>
                    <button
                        id="btn-nuevo"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2"
                    >
                        <span>+</span> Nuevo Directo
                    </button>
                </div>

                <!-- Notification Dropdown -->
                <div id="notification-dropdown" class="hidden absolute top-16 right-6 w-80 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 class="font-bold text-sm text-slate-800">Notificaciones</h3>
                        <button id="mark-all-read" class="text-xs text-orange-600 hover:text-orange-700 font-medium">Marcar leídas</button>
                    </div>
                    <div id="notification-list" class="max-h-64 overflow-y-auto">
                        <div class="p-4 text-center text-slate-400 text-xs">No tienes notificaciones</div>
                    </div>
                    <div class="p-2 border-t border-slate-100 text-center">
                        <a href="/panel/oportunidades" class="text-xs text-indigo-600 font-medium hover:underline">Ver todas las oportunidades</a>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6">
                <!-- TABS -->
                <div class="flex gap-4 mb-6 border-b border-slate-200">
                    <button id="tab-directos" class="pb-3 px-2 text-sm font-bold border-b-2 border-orange-600 text-orange-600 transition-all">
                        Presupuestos Directos
                    </button>
                    <button id="tab-oportunidades" class="pb-3 px-2 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all">
                        Propuestas Enviadas
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                    <!-- LOADING STATE -->
                    <div
                        id="loading-state"
class="flex justify-center items-center h-64"
                    >
                        <div
                            class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600"
                        >
                        </div>
                    </div>

                <!-- EMPTY STATE -->
                <div id="empty-state" class="hidden">
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <div class="bg-orange-100 p-4 rounded-full mb-4 text-4xl">📝</div>
                        <h3 class="text-lg font-bold text-slate-800">No hay presupuestos aún</h3>
                        <p class="text-slate-500 text-sm max-w-xs mx-auto mt-2">
                            Crea presupuestos profesionales y envíalos a tus clientes en minutos.
                        </p>
                    </div>
                </div>

                <!-- TABLE DIRECTOS -->
                <div id="content-table" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left text-sm text-slate-600">
                        <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs">
                            <tr>
                                <th class="px-6 py-3">Cliente</th>
                                <th class="px-6 py-3">Trabajo</th>
                                <th class="px-6 py-3">Fecha</th>
                                <th class="px-6 py-3 text-right">Total</th>
                                <th class="px-6 py-3 text-center">Estado</th>
                                <th class="px-6 py-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="presupuestos-list" class="divide-y divide-slate-100">
                            <!-- Rendered internally -->
                        </tbody>
                    </table>
                </div>

                <!-- VIEW OPORTUNIDADES -->
                <div id="content-oportunidades" class="hidden space-y-4">
                    <!-- Cards will be here -->
                </div>
            </div>
        </main>
    </div>
</Layout>

                    <div id="alert-modal" class="fixed inset-0 z-[60] hidden">
                        <div class="flex items-center justify-center p-4 h-full w-full">
                            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="alert-overlay"></div>
                            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-all relative z-10 overflow-hidden">
                                <div id="alert-header" class="p-4 border-b border-slate-100 flex items-center gap-3">
                                    <div id="alert-icon" class="text-2xl">⚠️</div>
                                    <h3 id="alert-title" class="font-bold text-slate-800">Alerta</h3>
                                </div>
                                <div class="p-6">
                                    <p id="alert-message" class="text-slate-600 text-sm">Mensaje de alerta</p>
                                </div>
                                <div class="p-4 bg-slate-50 flex gap-3 justify-end">
                                    <button id="alert-cancel" class="hidden px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded-lg transition">Cancelar</button>
                                    <button id="alert-ok" class="flex-1 bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-900 transition shadow-lg shadow-slate-200">Aceptar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MODAL PRESUPUESTO -->
                    <div id="modal-presupuesto" class="fixed inset-0 z-50 hidden transition-opacity duration-300 opacity-0 pointer-events-none">
                        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" id="modal-overlay"></div>
                        <div class="flex min-h-screen items-center justify-center p-4">
                            <div id="modal-content" class="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl transform transition-transform duration-300 scale-95 overflow-hidden">
                                <header class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 class="text-xl font-bold text-slate-800">Nuevo Presupuesto</h3>
                                    <button id="btn-cancel" class="text-slate-400 hover:text-slate-600 transition-colors">✕</button>
                                </header>
                                
                                <form id="form-presupuesto" class="p-6 space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-1.5">Cliente</label>
                                            <input type="text" name="cliente" required placeholder="Nombre del cliente" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-1.5">WhatsApp / Cel</label>
                                            <input type="tel" name="telefono" required placeholder="Ej: 1122334455" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-1.5">Título del Trabajo</label>
                                        <input type="text" name="titulo" required placeholder="Ej: Pintura de Living" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all">
                                    </div>

                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <label class="block text-xs font-black text-slate-400 uppercase tracking-widest">Items / Detalle</label>
                                            <button type="button" id="btn-add-item" class="text-xs font-bold text-orange-600 hover:text-orange-700">+ Agregar fila</button>
                                        </div>
                                        <div id="items-container" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                            <!-- Items dyamic -->
                                        </div>
                                    </div>

                                    <div class="pt-4 border-t border-slate-100 flex items-center justify-between">
                                        <div class="text-slate-500">
                                            <p class="text-[10px] font-bold uppercase tracking-widest">Total Estimado</p>
                                            <p id="total-display" class="text-2xl font-black text-slate-900 leading-none">$0</p>
                                        </div>
                                        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-2xl transition-all shadow-lg shadow-orange-100 active:scale-95">
                                            Guardar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

        <script>
            import { onAuthStateChanged } from "firebase/auth";
            import {
                getFirestore,
                collection,
                query,
                where,
                getDocs,
                addDoc,
                updateDoc,
                doc,
                deleteDoc,
                orderBy,
                onSnapshot,
                collectionGroup,
                limit,
            } from "firebase/firestore";
            import { auth, app, db } from "../../firebase/client";


            // Add jsPDF type definition to window
            declare global {
                interface Window {
                    jspdf: any;
                    updateStatus: (
                        id: string,
                        newStatus: string,
                    ) => Promise<void>;
                    deleteBudget: (id: string) => Promise<void>;
                    printPDF: (id: string) => Promise<void>;
                    updateItem: (
                        index: number,
                        field: string,
                        value: string,
                    ) => void;
                    removeItem: (index: number) => void;
                    verNotificacion: (id: string, link: string, leido: boolean) => Promise<void>;
                    borrarNotificacion: (id: string) => Promise<void>;
                }
            }

            // Execute immediately - IIFE pattern
            (function () {
console.log("🚀 [PRESUPUESTOS] Página cargada/navegada");

                const loadingState = document.getElementById("loading-state");
                const emptyState = document.getElementById("empty-state");
                const contentTable = document.getElementById("content-table");
                const listContainer =
                    document.getElementById("presupuestos-list");
                const modal = document.getElementById("modal-presupuesto");
                const modalContent = document.getElementById("modal-content");
                const form = document.getElementById(
                    "form-presupuesto",
                ) as HTMLFormElement;

                let currentUser: any = null;
                let items = [{ desc: "", cant: 1, precio: 0 }];
                let allPresupuestos: any = {}; // Store fetched data by ID
                let notificationsUnsub: any = null;
                let activeTab = "directos";

                // AUTH CHECK
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        loadNotifications(user.uid);
                        loadPresupuestos(user.uid);
                    } else {
                        window.location.href = "/";
                    }
                });

                // LOAD DATA
                function loadPresupuestos(uid: string) {
// UPDATE: Usar subcolección profesionales/{uid}/presupuestos para cumplir reglas de seguridad
                    const q = query(
                        collection(db, "profesionales", uid, "presupuestos"),
                    );

                    onSnapshot(
                        q,
                        (snapshot) => {
                            loadingState?.classList.add("hidden");

                            if (snapshot.empty) {
                                emptyState?.classList.remove("hidden");
                                contentTable?.classList.add("hidden");
                            } else {
                                emptyState?.classList.add("hidden");
                                contentTable?.classList.remove("hidden");

                                // Update cache
                                snapshot.docs.forEach(
                                    (d) =>
                                        (allPresupuestos[d.id] = {
                                            id: d.id,
                                            ...d.data(),
                                        }),
                                );

                                renderList(
                                    snapshot.docs.sort(
                                        (a, b) =>
                                            b.data().fecha - a.data().fecha,
                                    ),
                                );
                            }
                        },
                        (error) => {
                            console.error(
                                "Error cargando presupuestos:",
                                error,
                            );
                            loadingState.innerHTML =
'<p class="text-red-500">Error cargando datos. Verifica tu conexión.</p>';
                        },
                    );
                }

                function renderList(docs: any[]) {
                    if (!listContainer) return;
                    listContainer.innerHTML = "";
                    docs.forEach((doc: any) => {
                        const data = doc.data();
                        const date = data.fecha
                            ? new Date(
                                  data.fecha.seconds * 1000,
                              ).toLocaleDateString()
                            : "Sin fecha";
                        const statusColors = {
                            Pendiente: "bg-yellow-100 text-yellow-700",
                            Aprobado: "bg-blue-100 text-blue-700",
                            Cobrado: "bg-green-100 text-green-700",
                            Rechazado: "bg-red-100 text-red-700",
                        };

                        const tr = document.createElement("tr");
                        tr.className =
                            "hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0";
                        tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-800">${data.cliente}</td>
                        <td class="px-6 py-4">${data.titulo}</td>
                        <td class="px-6 py-4 text-slate-500">${date}</td>
                        <td class="px-6 py-4 text-right font-bold">$${(data.total || 0).toLocaleString()}</td>
                        <td class="px-6 py-4 text-center">
                            <select onchange="updateStatus('${doc.id}', this.value)" class="${statusColors[data.estado] || "bg-slate-100"} text-[10px] font-bold px-2 py-1 rounded-full outline-none cursor-pointer border-none appearance-none text-center">
                                <option value="Pendiente" ${data.estado === "Pendiente" ? "selected" : ""}>Pendiente</option>
                                <option value="Aprobado" ${data.estado === "Aprobado" ? "selected" : ""}>Aprobado</option>
                                <option value="Cobrado" ${data.estado === "Cobrado" ? "selected" : ""}>Cobrado</option>
                                <option value="Rechazado" ${data.estado === "Rechazado" ? "selected" : ""}>Rechazado</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="printPDF('${doc.id}')" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors" title="Descargar PDF">
                                    📄
                                </button>
                                <button onclick="window.vincularSolicitud('${doc.id}')" class="p-1.5 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded transition-colors" title="Vincular a oportunidad">
                                    🔗
                                </button>
                                <button onclick="window.shareWhatsAppDirect('${doc.id}')" class="p-1.5 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded transition-colors" title="Enviar por WhatsApp">
                                    📱
                                </button>
                                <button onclick="deleteBudget('${doc.id}')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Eliminar">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    `;
                        listContainer.appendChild(tr);
                    });
                }

                // === NOTIFICATIONS LOGIC (Consistent with index.astro) ===
                async function loadNotifications(uid) {
                    if (notificationsUnsub) notificationsUnsub();
                    
                    const q = query(
                        collection(db, "profesionales", uid, "notificaciones"),
                        orderBy("fecha", "desc"),
                        limit(10)
                    );

                    let isInitialLoad = true;
                    notificationsUnsub = onSnapshot(q, (snapshot) => {
                        const notifs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Toasts for new notifications
                        if (!isInitialLoad) {
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === "added") {
                                    const n = change.doc.data();
                                    if (!n.leido) {
                                        // @ts-ignore
                                        Swal.fire({
                                            title: n.titulo || "Nueva Notificación",
                                            text: n.mensaje || "",
                                            icon: "info",
                                            toast: true,
                                            position: "top-end",
                                            showConfirmButton: false,
                                            timer: 5000,
                                            timerProgressBar: true,
                                            didOpen: (toast) => {
                                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                                                toast.addEventListener('click', () => {
                                                    window.verNotificacion(change.doc.id, n.link || '#', false);
                                                })
                                            }
                                        });
                                    }
                                }
                            });
                        }
                        isInitialLoad = false;

                        // Render dropdown
                        const list = document.getElementById("notification-list");
                        const badge = document.getElementById("badge-bell");
                        
                        if (list) {
                            if (notifs.length === 0) {
                                list.innerHTML = `<div class="p-4 text-center text-slate-400 text-xs">No hay notificaciones</div>`;
                            } else {
                                list.innerHTML = notifs.map(n => {
                                    // Escapar comillas para el objeto JSON
                                    const notifJson = JSON.stringify(n).replace(/'/g, "\\'");
                                    return `
                                        <div class="p-3 border-b border-slate-50 hover:bg-slate-50 transition cursor-pointer ${n.leido ? 'opacity-60' : ''}" 
                                             onclick='window.verNotificacion("${n.id}", "${n.link || "#"}", ${n.leido}, ${notifJson})'>
                                            <p class="font-bold text-[11px] text-slate-700 leading-tight">${n.titulo || 'Notificación'}</p>
                                            <p class="text-[10px] text-slate-500 line-clamp-2">${n.mensaje || ''}</p>
                                        </div>
                                    `;
                                }).join('');
                            }
                        }

                        if (badge) {
                            const unread = notifs.filter(n => !n.leido).length;
                            unread > 0 ? badge.classList.remove("hidden") : badge.classList.add("hidden");
                        }
                    });
                }

                window.verNotificacion = async (id, link, leido, notifData) => {
                    if (!currentUser) return;
                    
                    if (!leido) {
                        try {
                            const docRef = doc(db, "profesionales", currentUser.uid, "notificaciones", id);
                            await updateDoc(docRef, { leido: true });
                        } catch (e) {
                            console.error("Error marking as read:", e);
                        }
                    }

                    // Handle special notification types
                    if (notifData && notifData.tipo === "presupuesto_aceptado") {
                        // @ts-ignore
                        Swal.fire({
                            title: "✅ ¡Presupuesto Aceptado!",
                            html: `
                                <div class="text-left space-y-4 pt-2">
                                    <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl border border-slate-100 shadow-sm">
                                        <img src="${notifData.clienteFoto || '/default-avatar.png'}" alt="${notifData.clienteNombre}" class="w-16 h-16 rounded-full object-cover border-2 border-green-500 shadow-sm" />
                                        <div>
                                            <h3 class="font-bold text-lg text-slate-900 leading-tight">${notifData.clienteNombre || "Cliente"}</h3>
                                            <p class="text-xs text-slate-500 uppercase font-black tracking-widest mt-1">CLIENTE</p>
                                        </div>
                                    </div>
                                    

                                    <div class="grid grid-cols-1 gap-2 text-sm px-1">
                                        ${notifData.clienteTelefono ? `
                                            <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl">
                                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center text-green-600">📱</div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-[10px] text-slate-400 font-bold uppercase">Teléfono</p>
                                                    <a href="https://wa.me/549${notifData.clienteTelefono.replace(/\D/g, '')}" target="_blank" class="font-bold text-slate-700 hover:text-green-600 transition truncate block">${notifData.clienteTelefono}</a>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${notifData.clienteEmail ? `
                                            <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl">
                                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">📧</div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-[10px] text-slate-400 font-bold uppercase">Email</p>
                                                    <span class="font-bold text-slate-700 truncate block">${notifData.clienteEmail}</span>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>

                                    ${notifData.clienteTelefono ? `
                                        <a href="https://wa.me/549${notifData.clienteTelefono.replace(/\D/g, '')}" target="_blank" class="flex items-center justify-center gap-2 w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-black py-4 px-6 rounded-2xl transition-all shadow-lg shadow-green-100 transform active:scale-95">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.888 11.888-11.888 3.176 0 6.161 1.237 8.404 3.483 2.247 2.248 3.481 5.234 3.481 8.406 0 6.556-5.332 11.888-11.888 11.888-2.01 0-3.988-.511-5.741-1.483l-6.243 1.692zm6.205-4.008l.445.265c1.404.835 3.028 1.277 4.693 1.277 5.175 0 9.387-4.212 9.387-9.387 0-2.506-.975-4.861-2.744-6.632-1.771-1.77-4.125-2.745-6.631-2.745-5.176 0-9.387 4.212-9.387 9.387 0 1.954.59 3.86 1.706 5.466l.29.418-.992 3.623 3.712-.998zm11.239-5.918c-.31-.155-1.838-.906-2.119-1.008-.281-.102-.486-.155-.69.155-.205.31-.79.998-.968 1.205-.178.207-.356.233-.666.078-.31-.155-1.31-.483-2.496-1.542-.922-.822-1.544-1.838-1.724-2.148-.181-.31-.019-.478.136-.632.14-.138.31-.359.466-.539.15-.181.2-.31.3-.517.102-.207.051-.389-.026-.544-.076-.155-.69-1.662-.946-2.278-.249-.6-.503-.518-.69-.527-.179-.009-.384-.011-.59-.011-.205 0-.539.077-.82.384-.282.311-1.077 1.053-1.077 2.568 0 1.516 1.102 2.977 1.256 3.184.154.207 2.169 3.328 5.253 4.653.733.315 1.306.503 1.751.644.737.234 1.406.201 1.936.121.591-.088 1.838-.751 2.094-1.477.256-.725.256-1.346.179-1.477-.077-.13-.282-.207-.591-.362z"></path></svg>
                                            CONTACTAR POR WHATSAPP
                                        </a>
                                    ` : ''}
                                </div>
                            `,
                            width: "450px",
                            confirmButtonText: "Entendido",
                            confirmButtonColor: "#1e293b",
                            customClass: {
                                container: 'budget-notif-container',
                                popup: 'rounded-3xl shadow-2xl border border-slate-100',
                                confirmButton: 'rounded-xl font-black px-8 py-3 uppercase tracking-widest text-sm'
                            }
                        });
                    } else if (notifData && notifData.tipo === "presupuesto_rechazado") {
                        // @ts-ignore
                        Swal.fire({
                            title: "Presupuesto Rechazado",
                            text: notifData.mensaje,
                            icon: "info",
                            confirmButtonText: "Cerrar",
                            confirmButtonColor: "#64748b"
                        });
                    } else {
                        // Fallback: original logic
                        if (link && link !== '#') {
                            window.location.href = link;
                        }
                    }
                };

                // === TABS LOGIC ===
                const tabDirectos = document.getElementById("tab-directos");
                const tabOportunidades = document.getElementById("tab-oportunidades");
                const contentDirectos = document.getElementById("content-table");
                const contentOportunidades = document.getElementById("content-oportunidades");

                tabDirectos?.addEventListener("click", () => switchTab("directos"));
                tabOportunidades?.addEventListener("click", () => switchTab("oportunidades"));

                async function switchTab(tab) {
                    activeTab = tab;
                    
                    // Reset UI
                    [tabDirectos, tabOportunidades].forEach(el => el?.classList.remove("border-orange-600", "text-orange-600"));
                    [tabDirectos, tabOportunidades].forEach(el => el?.classList.add("border-transparent", "text-slate-400"));
                    [contentDirectos, contentOportunidades].forEach(el => el?.classList.add("hidden"));

                    if (tab === "directos") {
                        tabDirectos?.classList.add("border-orange-600", "text-orange-600");
                        tabDirectos?.classList.remove("border-transparent", "text-slate-400");
                        contentDirectos?.classList.remove("hidden");
                        loadPresupuestos(currentUser.uid);
                    } else {
                        tabOportunidades?.classList.add("border-orange-600", "text-orange-600");
                        tabOportunidades?.classList.remove("border-transparent", "text-slate-400");
                        contentOportunidades?.classList.remove("hidden");
                        loadSentProposals();
                    }
                }

                async function loadSentProposals() {
                    if (!currentUser) return;
                    loadingState?.classList.remove("hidden");
                    emptyState?.classList.add("hidden");
                    contentOportunidades.innerHTML = "";

                    try {
                        console.log("🔍 [TABS] Buscando propuestas enviadas...");
                        const q = query(
                            collectionGroup(db, "propuestas"),
                            where("proId", "==", currentUser.uid),
                            orderBy("fecha", "desc")
                        );
                        
                        const snap = await getDocs(q);
                        loadingState?.classList.add("hidden");

                        if (snap.empty) {
                            emptyState?.classList.remove("hidden");
                            return;
                        }

                        // We have proposals. Note: they are in subcollections solicitudes/{solId}/propuestas
                        // We need the parent request data for context (rubro, cliente, etc.)
                        const cardsHtml = await Promise.all(snap.docs.map(async (pDoc) => {
                            const pData = pDoc.data();
                            const solId = pDoc.ref.parent.parent?.id;
                            
                            // Get request data (optional cache would be better)
                            let solData: any = {};
                            if (solId) {
                                const solSnap = await getDocs(query(collection(db, "solicitudes"), where("__name__", "==", solId)));
                                if (!solSnap.empty) solData = solSnap.docs[0].data();
                            }

                            const fecha = pData.fecha?.toDate ? pData.fecha.toDate().toLocaleDateString() : "Sin fecha";
                            const statusColor = pData.estado === "aceptada" ? "bg-green-100 text-green-700" : (pData.estado === "rechazada" ? "bg-red-100 text-red-700" : "bg-blue-100 text-blue-700");

                            return `
                                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400">${solData.rubro || 'Trabajo'}</span>
                                            <span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${statusColor}">${pData.estado?.toUpperCase() || 'ENVIADO'}</span>
                                        </div>
                                        <h4 class="font-bold text-slate-800">${solData.clienteNombre || 'Cliente'}</h4>
                                        <p class="text-xs text-slate-500 line-clamp-1">${pData.mensaje || 'Sin mensaje'}</p>
                                    </div>
                                    <div class="text-right flex flex-col items-end shrink-0">
                                        <span class="text-xl font-bold text-orange-600">$${(pData.precio || 0).toLocaleString()}</span>
                                        <span class="text-[10px] text-slate-400">${fecha}</span>
                                        <div class="mt-2 flex gap-2">
                                            <a href="/panel/oportunidades" class="text-[10px] font-bold text-indigo-600 hover:underline">Ver oportunidad</a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }));

                        contentOportunidades.innerHTML = cardsHtml.join("");

                    } catch (err) {
                        console.error("Error loading proposals:", err);
                        loadingState?.classList.add("hidden");
                        contentOportunidades.innerHTML = `<p class="text-red-500 text-center text-sm">Error cargando propuestas.</p>`;
                    }
                }

                // === VINCULAR LOGIC ===
                window.vincularSolicitud = async (budgetId) => {
                    if (!currentUser) return;
                    
                    try {
                        // 1. Get accepted opportunities
                        const q = query(
                            collection(db, "solicitudes"),
                            where("profesionalId", "==", currentUser.uid),
                            limit(10)
                        );
                        const snap = await getDocs(q);
                        
                        if (snap.empty) {
                            return showAlert("No tienes oportunidades", "Primero debes contactar a un cliente desde el panel de Oportunidades.", "info");
                        }

                        const options = {};
                        snap.docs.forEach(doc => {
                            const data = doc.data();
                            options[doc.id] = `${data.rubro} - ${data.clienteNombre || 'Sin nombre'}`;
                        });

                        // @ts-ignore
                        const { value: solId } = await Swal.fire({
                            title: 'Vincular Presupuesto',
                            input: 'select',
                            inputOptions: options,
                            inputPlaceholder: 'Selecciona una oportunidad',
                            showCancelButton: true,
                            confirmButtonColor: '#ea580c',
                        });

                        if (solId) {
                            // Update budget with solicitudId
                            const budgetRef = doc(db, "profesionales", currentUser.uid, "presupuestos", budgetId);
                            await updateDoc(budgetRef, { solicitudId: solId });
                            
                            showAlert("¡Vinculado!", "El presupuesto se ha vinculado correctamente a la oportunidad seleccionada.", "success");
                        }
                    } catch (err) {
                        console.error("Error linking:", err);
                        showAlert("Error", "No se pudo vincular el presupuesto.", "error");
                    }
                };

                window.shareWhatsAppDirect = (id) => {
                    const p = allPresupuestos[id];
                    if (!p) return;
                    
                    const text = `Hola ${p.cliente}, te envío el presupuesto para "${p.titulo}". Total: $${p.total.toLocaleString()}. Puedes verlo en detalle aquí: (Próximamente link público)`;
                    const url = `https://wa.me/549${p.telefono?.replace(/\D/g, '') || ''}?text=${encodeURIComponent(text)}`;
                    window.open(url, '_blank');
                };

                // MODAL LOGIC
                document
                    .getElementById("btn-nuevo")
                    ?.addEventListener("click", () => openModal());
                document
                    .getElementById("btn-close-modal")
                    ?.addEventListener("click", closeModal);
                document
                    .getElementById("btn-cancel")
                    ?.addEventListener("click", closeModal);
                document
                    .getElementById("modal-overlay")
                    ?.addEventListener("click", closeModal);

                document
                    .getElementById("btn-add-item")
                    ?.addEventListener("click", () => {
                        items.push({ desc: "", cant: 1, precio: 0 });
                        renderItems();
                    });

                function openModal() {
                    if (!modal || !modalContent) return;
                    modal.classList.remove(
                        "hidden",
                        "opacity-0",
                        "pointer-events-none",
                    );
                    modalContent.classList.remove("scale-95");
                    modalContent.classList.add("scale-100");
                    items = [{ desc: "", cant: 1, precio: 0 }];
                    renderItems();
                }

                function closeModal() {
                    if (!modal || !modalContent) return;
                    modal.classList.add("opacity-0", "pointer-events-none");
                    modalContent.classList.remove("scale-100");
                    modalContent.classList.add("scale-95");
                    setTimeout(() => modal.classList.add("hidden"), 300);
                    if (form) form.reset();
                }

                // DYNAMIC ITEMS
                function calculateTotal() {
                    const total = items.reduce(
                        (sum, i) => sum + i.cant * i.precio,
                        0,
                    );
                    const totalDisplay =
                        document.getElementById("total-display");
                    if (totalDisplay) {
                        totalDisplay.innerText = `$${total.toLocaleString()}`;
                    }
                }

                function renderItems() {
                    const container =
                        document.getElementById("items-container");
                    if (!container) return;
                    container.innerHTML = "";

                    items.forEach((item, index) => {
                        const div = document.createElement("div");
                        div.className = "flex gap-2 items-start";
                        div.innerHTML = `
<input type="text" placeholder="Descripción" value="${item.desc}" oninput="updateItem(${index}, 'desc', this.value)" class="flex-1 border border-slate-300 rounded px-2 py-1 text-sm outline-none focus:border-orange-500">
                        <input type="number" placeholder="Cant." value="${item.cant}" oninput="updateItem(${index}, 'cant', this.value)" class="w-16 border border-slate-300 rounded px-2 py-1 text-sm outline-none focus:border-orange-500">
                        <input type="number" placeholder="Precio" value="${item.precio}" oninput="updateItem(${index}, 'precio', this.value)" class="w-24 border border-slate-300 rounded px-2 py-1 text-sm outline-none focus:border-orange-500">
                        <button type="button" onclick="removeItem(${index})" class="text-red-400 hover:text-red-600 px-1">✕</button>
                    `;
                        container.appendChild(div);
                    });

                    calculateTotal();
                }

                window.updateItem = (
                    index: number,
                    field: string,
                    value: string,
                ) => {
                    items[index][field] =
                        field === "desc" ? value : Number(value);
                    // Solo recalculamos total, NO renderizamos todo para no perder foco
                    calculateTotal();
                };

                window.removeItem = (index: number) => {
                    if (items.length > 1) {
                        items.splice(index, 1);
                        renderItems();
                    }
                };

                // CREATE BUDGET
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const total = items.reduce(
                        (sum, i) => sum + i.cant * i.precio,
                        0,
                    );

                    const newBudget = {
                        uid: currentUser.uid,
                        cliente: formData.get("cliente"),
                        telefono: formData.get("telefono"),
                        titulo: formData.get("titulo"),
                        items: items,
                        total: total,
                        fecha: new Date(),
                        estado: "Pendiente",
                    };

                    try {
                        if (!db) {
                            throw new Error(
"La conexión a la base de datos no está inicializada",
                            );
                        }

                        console.log(
"💾 Guardando presupuesto para UID:",
                            currentUser.uid,
                        );

                        await addDoc(
                            collection(
                                db,
                                "profesionales",
                                currentUser.uid,
                                "presupuestos",
                            ),
                            newBudget,
                        );
                        await showAlert(
"¡Éxito!",
                            "El presupuesto se ha guardado correctamente",
                            "success",
                        );
                        closeModal();
                    } catch (error) {
                        console.error("Error creating budget:", error);
                        await showAlert(
                            "Error",
                            "Error al guardar el presupuesto: " + error.message,
                            "error",
                        );
                    }
                });

                // ACTIONS
                window.updateStatus = async (id: string, newStatus: string) => {
                    try {
// UPDATE: Referencia a subcolección
                        const ref = doc(
                            db,
                            "profesionales",
                            currentUser.uid,
                            "presupuestos",
                            id,
                        );
                        await updateDoc(ref, { estado: newStatus });

// Si se marca como cobrado, podría integrarse con Finanzas (opcional)
                    } catch (error) {
                        console.error("Error updating status:", error);
                    }
                };

                window.deleteBudget = async (id: string) => {
                    const confirmed = await showConfirm(
                        "Eliminar Presupuesto",
"¿Estás seguro de que quieres eliminar este presupuesto? Esta acción no se puede deshacer.",
                        "Eliminar",
                        "bg-red-600",
                    );

                    if (confirmed) {
                        try {
// UPDATE: Referencia a subcolección
                            await deleteDoc(
                                doc(
                                    db,
                                    "profesionales",
                                    currentUser.uid,
                                    "presupuestos",
                                    id,
                                ),
                            );
                            await showAlert(
                                "Eliminado",
                                "El presupuesto ha sido eliminado correctamente",
                                "success",
                            );
                        } catch (error) {
                            console.error("Error deleting:", error);
                            await showAlert(
                                "Error",
                                "No se pudo eliminar el presupuesto",
                                "error",
                            );
                        }
                    }
                };

                window.printPDF = async (id: string) => {
                    const p = allPresupuestos[id];
                    if (!p)
                        return showAlert(
                            "Error",
                            "Presupuesto no encontrado",
                            "error",
                        );

                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        // Header
                        doc.setFillColor(234, 88, 12); // Orange
                        doc.rect(0, 0, 210, 40, "F");

                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(22);
                        doc.text("PRESUPUESTO", 14, 25);
                        doc.setFontSize(12);
                        doc.text("DeOficios Pro", 160, 25);

                        // Info
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.text(`Cliente: ${p.cliente}`, 14, 50);
                        if (p.telefono)
doc.text(`Teléfono: ${p.telefono}`, 14, 56);

                        const fecha = p.fecha
                            ? new Date(
                                  p.fecha.seconds * 1000,
                              ).toLocaleDateString()
                            : "N/A";
                        doc.text(`Fecha: ${fecha}`, 160, 50);
                        doc.text(
                            `Ref: #${id.slice(0, 6).toUpperCase()}`,
                            160,
                            56,
                        );

                        // Titulo Trabajo
                        doc.setFontSize(14);
                        doc.setFont(undefined, "bold");
                        doc.text(p.titulo || "Presupuesto de Trabajo", 14, 70);

                        // Tabla items
                        let y = 85;
                        doc.setFillColor(245, 245, 245);
                        doc.rect(14, y - 5, 180, 8, "F");
                        doc.setFontSize(10);
doc.text("Descripción", 16, y);
                        doc.text("Cant.", 130, y);
                        doc.text("Precio", 150, y);
                        doc.text("Total", 180, y);

                        doc.setFont(undefined, "normal");
                        y += 10;

                        p.items.forEach((item) => {
                            const subtotal = item.cant * item.precio;
                            doc.text(item.desc || "Item", 16, y);
                            doc.text(item.cant.toString(), 130, y);
                            doc.text(`$${item.precio}`, 150, y);
                            doc.text(`$${subtotal}`, 180, y);
                            y += 8;
                        });

                        // Totales
                        y += 5;
                        doc.line(14, y, 194, y);
                        y += 10;
                        doc.setFont(undefined, "bold");
                        doc.setFontSize(14);
                        doc.text(
                            `TOTAL: $${parseInt(p.total).toLocaleString()}`,
                            150,
                            y,
                        );

                        // Footer
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(
"Presupuesto válido por 15 días. Documento generado con DeOficios.net",
                            105,
                            280,
                            { align: "center" },
                        );

                        doc.save(
                            `Presupuesto_${p.cliente}_${id.slice(0, 4)}.pdf`,
                        );
                    } catch (e) {
                        console.error("PDF Error", e);
                        showAlert(
                            "Error PDF",
"Hubo un error generando el PDF. Asegúrate de tener conexión para cargar las librerías.",
                            "error",
                        );
                    }
                };

                // === ALERT SYSTEM ===
                function showAlert(
                    title: string,
                    message: string,
                    type = "info",
                ) {
                    return new Promise((resolve) => {
                        const modal = document.getElementById("alert-modal");
                        const titleEl = document.getElementById("alert-title");
                        const msgEl = document.getElementById("alert-message");
                        const iconEl = document.getElementById("alert-icon");
                        const okBtn = document.getElementById("alert-ok");
                        const cancelBtn =
                            document.getElementById("alert-cancel");
                        const header = document.getElementById("alert-header");

                        if (!modal) return resolve();

                        // Config
                        titleEl.innerText = title;
                        msgEl.innerText = message;
                        cancelBtn.classList.add("hidden");
                        okBtn.innerText = "Aceptar";
                        okBtn.onclick = () => {
                            modal.classList.add("hidden");
                            resolve(true);
                        };

                        // Styles
                        if (type === "success") {
iconEl.innerText = "✅";
                            okBtn.className =
                                "flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-lg shadow-green-200";
                        } else if (type === "error") {
                            iconEl.innerText = "❌";
                            okBtn.className =
                                "flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-lg shadow-red-200";
                        } else {
                            iconEl.innerText = "ℹ️";
                            okBtn.className =
                                "flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-200";
                        }

                        modal.classList.remove("hidden");
                    });
                }

                function showConfirm(
                    title: string,
                    message: string,
                    actionText = "Aceptar",
                    actionClass = "bg-orange-600",
                ) {
                    return new Promise((resolve) => {
                        const modal = document.getElementById("alert-modal");
                        const titleEl = document.getElementById("alert-title");
                        const msgEl = document.getElementById("alert-message");
                        const iconEl = document.getElementById("alert-icon");
                        const okBtn = document.getElementById("alert-ok");
                        const cancelBtn =
                            document.getElementById("alert-cancel");

                        if (!modal) return resolve(false);

                        // Config
                        titleEl.innerText = title;
                        msgEl.innerText = message;
iconEl.innerText = "🤔";

                        cancelBtn.classList.remove("hidden");
                        cancelBtn.onclick = () => {
                            modal.classList.add("hidden");
                            resolve(false);
                        };

                        okBtn.innerText = actionText;
                        okBtn.className = `flex-1 text-white font-bold py-2 px-4 rounded-lg transition shadow-lg ${actionClass}`;
                        okBtn.onclick = () => {
                            modal.classList.add("hidden");
                            resolve(true);
                        };

                        modal.classList.remove("hidden");
                    });
                }

                document
                    .getElementById("btn-logout-mobile")
                    ?.addEventListener("click", async () => {
                        // Logout logic now handled by MobileSidebar component
                    });

                // Add fade-in animation to main content
                document.querySelector("main")?.classList.add("fade-in");
            })(); // End of IIFE
        </script>
    </body>
</html>
