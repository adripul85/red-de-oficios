---
layout: ../../../layouts/Layout.astro
title: Detalle de Solicitud | DeOficios
---

<div class="bg-gray-50 min-h-screen py-10">
    <div class="max-w-6xl mx-auto px-4">
        <!-- HEADER -->
        <a href="/mi-cuenta" class="text-slate-500 hover:text-orange-600 font-bold flex items-center gap-2 mb-6">
            ‚Üê Volver a Mi Cuenta
        </a>

        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Comparador de Presupuestos ‚öñÔ∏è</h1>
            <div id="solicitud-info">
                <!-- Data injected via JS -->
                <div class="animate-pulse flex gap-4">
                    <div class="h-6 bg-slate-200 rounded w-1/4"></div>
                    <div class="h-6 bg-slate-200 rounded w-1/4"></div>
                </div>
            </div>
        </div>

        <!-- COMPARATOR GRID -->
        <div id="loading-props" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        </div>

        <div id="propuestas-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Cards of proposals -->
        </div>

        <div id="empty-props" class="hidden text-center py-12 bg-white rounded-3xl border border-dashed border-slate-300">
            <p class="text-slate-500 text-lg">A√∫n no has recibido presupuestos para esta solicitud.</p>
            <p class="text-sm text-slate-400">Te avisaremos cuando los profesionales respondan.</p>
        </div>
    </div>
</div>

<script>
    import { auth, db } from "../../../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc, collection, getDocs, updateDoc } from "firebase/firestore";

    const solicitudId = window.location.pathname.split("/").pop();

    document.addEventListener("astro:page-load", () => {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadData(user.uid, solicitudId);
            } else {
                window.location.href = "/ingresar-cliente";
            }
        });
    });

    async function loadData(userId, id) {
        if(!id) return;
        
        // 1. Load Solicitud Info
        const docRef = doc(db, "solicitudes", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
            alert("Solicitud no encontrada");
            window.location.href = "/mi-cuenta";
            return;
        }

        const data = docSnap.data();
        if (data.clienteId !== userId) {
            alert("No tienes permiso para ver esto");
            window.location.href = "/mi-cuenta";
            return;
        }

        const infoContainer = document.getElementById("solicitud-info");
        if(infoContainer) {
            infoContainer.innerHTML = `
                <div class="flex flex-wrap gap-4 mt-4">
                    <span class="px-3 py-1 bg-slate-100 rounded-lg text-sm font-bold text-slate-700">üìå ${data.rubro}</span>
                    <span class="px-3 py-1 bg-slate-100 rounded-lg text-sm font-bold text-slate-700">üìç ${data.zona}</span>
                    <span class="px-3 py-1 bg-${data.urgente ? 'red' : 'green'}-100 rounded-lg text-sm font-bold text-${data.urgente ? 'red' : 'green'}-700">${data.urgente ? 'üö® URGENTE' : 'üü¢ Normal'}</span>
                </div>
                <p class="mt-4 text-slate-600 bg-slate-50 p-4 rounded-xl border border-slate-200">"${data.detalle}"</p>
                <p class="text-xs text-slate-400 mt-2">Publicado el ${data.fecha?.toDate ? data.fecha.toDate().toLocaleDateString() : 'Reciente'}</p>
            `;
        }

        // 2. Load Proposals (Subcollection)
        const propsRef = collection(db, "solicitudes", id, "propuestas");
        const propsSnap = await getDocs(propsRef);
        
        const grid = document.getElementById("propuestas-grid");
        const loading = document.getElementById("loading-props");
        const empty = document.getElementById("empty-props");

        if(loading) loading.style.display = "none";

        if (propsSnap.empty) {
            if(empty) empty.classList.remove("hidden");
            if(grid) grid.style.display = "none";
            return;
        }

        if(grid) {
            grid.innerHTML = propsSnap.docs.map(p => {
                const prop = p.data();
                // Precio puede venir como 'precio' o 'monto' (legacy support)
                const price = prop.precio || prop.monto || 0;
                
                return `
                <div class="bg-white rounded-3xl overflow-hidden shadow-lg border-2 border-transparent hover:border-indigo-500 transition-all flex flex-col relative group">
                    ${ propsSnap.docs.indexOf(p) === 0 ? 
                        `<div class="absolute top-4 left-4 z-10 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded shadow">ü•á Mejor Opci√≥n</div>` : '' 
                    }
                    <div class="bg-slate-900 p-6 text-center text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                        <img src="${prop.proFoto || 'https://ui-avatars.com/api/?name=' + prop.proNombre}" class="w-20 h-20 rounded-full border-4 border-white mx-auto shadow-md object-cover mb-3" />
                        <h3 class="text-xl font-bold">${prop.proNombre}</h3>
                        <a href="/perfil?id=${prop.proId}" target="_blank" class="text-indigo-300 text-xs font-bold hover:text-white hover:underline">Ver Perfil Completo ‚Üó</a>
                    </div>
                    
                    <div class="p-6 flex-1 flex flex-col">
                        <div class="text-center mb-6">
                            <span class="block text-xs uppercase tracking-widest text-slate-500 font-bold mb-1">Presupuesto</span>
                            <span class="text-4xl font-black text-indigo-600">$${price.toLocaleString()}</span>
                        </div>
                        
                        <div class="bg-slate-50 rounded-xl p-4 mb-6 flex-1 border border-slate-100 relative">
                             <svg class="absolute -top-2 -left-2 w-6 h-6 text-slate-300 transform -rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C20.1216 16 21.017 16.8954 21.017 18V21C21.017 22.1046 20.1216 23 19.017 23H16.017C14.9124 23 14.017 22.1046 14.017 21ZM14.017 13V10C14.017 8.89543 14.9124 8 16.017 8H19.017C20.1216 8 21.017 8.89543 21.017 10V13C21.017 14.1046 20.1216 15 19.017 15H16.017C14.9124 15 14.017 14.1046 14.017 13ZM3.01697 21L3.01697 18C3.01697 16.8954 3.9124 16 5.01697 16H8.01697C9.12154 16 10.017 16.8954 10.017 18V21C10.017 22.1046 9.12154 23 8.01697 23H5.01697C3.91157 23 3.01697 22.1046 3.01697 21ZM3.01697 13V10C3.01697 8.89543 3.9124 8 5.01697 8H8.01697C9.12154 8 10.017 8.89543 10.017 10V13C10.017 14.1046 9.12154 15 8.01697 15H5.01697C3.91157 15 3.01697 14.1046 3.01697 13Z" /></svg>
                            <p class="text-sm text-slate-600 italic relative z-10">"${prop.mensaje}"</p>
                        </div>

                        <button onclick="contactarPro('${prop.proId}', '${prop.proNombre}', ${price})" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl mb-3 shadow-lg shadow-green-200 transition flex items-center justify-center gap-2">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.683-2.031-.967-.272-.297-.471-.446-.644-.446-.174 0-.347.001-.52.001-.173 0-.446.049-.644.273-.198.223-.743.744-.743 1.835 0 1.091.793 2.132.892 2.281.099.149 1.537 2.479 3.834 3.393 (2.298.914 2.298.618 2.694.766.397.149 1.264-.545 1.437-1.091.173-.545.174-1.041.124-1.115z"/></svg>
                             Aceptar por WhatsApp
                        </button>
                    </div>
                </div>
                `;
            }).join("");
        }
    }
    
    // Global Actions
    window.contactarPro = async (proId, proNombre, precio) => {
        try {
            // Fetch phone from pro profile
            const proDoc = await getDoc(doc(db, "profesionales", proId));
            if(proDoc.exists()) {
                const phone = proDoc.data().telefono;
                if(phone) {
                    const msg = `Hola ${proNombre}, acepto tu presupuesto de $${precio} en DeOficios. ¬øPodemos coordinar?`;
                    const cleanPhone = phone.replace(/\D/g, "");
                    window.open(`https://wa.me/549${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
                } else {
                    alert("El profesional no tiene tel√©fono registrado. Contacta a soporte.");
                }
            } else {
                 alert("No se encontr√≥ contacto del profesional.");
            }
        } catch(e) {
            console.error(e);
            alert("Error al contactar.");
        }
    };

</script>
