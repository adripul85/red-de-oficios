---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Acceso Clientes - DeOficios">
<div class="login-wrapper">
        <div class="login-card">
            <div class="icon">üõ°Ô∏è</div>
            <h1>√Årea de Clientes</h1>
            <p>Acceso seguro para opinar y contratar</p>

            <div class="tabs">
                <button class="tab-btn active" data-tab="login"
                    >Iniciar Sesi√≥n</button
                >
                <button class="tab-btn" data-tab="register">Registrarse</button>
            </div>

            <div id="tab-login" class="tab-content active">
                <form id="login-form" class="auth-form">
                    <input
                        type="email"
                        id="login-email"
                        placeholder="Email"
                        required
                    />
                    <input
                        type="password"
                        id="login-password"
                        placeholder="Contrase√±a"
                        required
                    />
                    <button type="submit" class="btn-submit">Ingresar</button>
                    <p id="login-feedback" class="feedback hidden"></p>
                    <button
                        type="button"
                        id="btn-resend"
                        class="text-sm text-blue-600 underline mt-2 hidden hover:text-blue-800"
                        >Reenviar correo de verificaci√≥n</button
                    >
                </form>
            </div>

            <div id="tab-register" class="tab-content">
                <div id="reg-form-container">
                    <form id="register-form" class="auth-form">
                        <input
                            type="text"
                            id="register-name"
                            placeholder="Nombre completo"
                            required
                        />
                        <input
                            type="email"
                            id="register-email"
                            placeholder="Email real (te enviaremos un link)"
                            required
                        />
                        <input
                            type="password"
                            id="register-password"
                            placeholder="Contrase√±a (m√≠nimo 6 caracteres)"
                            required
                            minlength="6"
                        />
                        <button
                            type="submit"
                            class="btn-submit bg-green-600 hover:bg-green-700"
                            >Crear Cuenta</button
                        >
                        <p id="register-feedback" class="feedback hidden"></p>
                    </form>
                </div>

                <div id="reg-success" class="hidden text-center py-6">
                    <div class="text-4xl mb-4">üì©</div>
                    <h3 class="font-bold text-gray-800 text-lg">
                        ¬°Revisa tu correo!
                    </h3>
                    <p class="text-gray-600 text-sm mt-2 mb-4">
                        Te enviamos un enlace de confirmaci√≥n. <br />
                        <strong
                            >Debes hacer clic en √©l para activar tu cuenta.</strong
                        >
                    </p>
                    <button
                        onclick="window.location.reload()"
                        class="btn-submit bg-gray-100 text-gray-700 border border-gray-300"
                        >Ya lo confirm√©, Iniciar Sesi√≥n</button
                    >
                </div>
            </div>

            <div class="divider"><span>o r√°pido con</span></div>
            <button id="btn-google" class="btn-google">
                <img
                    src="https://www.svgrepo.com/show/475656/google-color.svg"
                    alt="G"
                /> Google (Verificaci√≥n autom√°tica)
            </button>

            <a href="/ingresar" class="link-pro">¬øSos profesional? Clic aqu√≠</a>
        </div>
    </div>
</Layout>

<script>
    import { auth, db } from "../firebase/client";
    import {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        sendEmailVerification,
        signOut,
    } from "firebase/auth";
    import { doc, setDoc, getDoc } from "firebase/firestore";

    const tabBtns = document.querySelectorAll(".tab-btn");
    const params = new URLSearchParams(window.location.search);
    const returnUrl = params.get("returnUrl") || "/mi-cuenta";

    // TABS LOGIC
    tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
const tab = btn.dataset.tab;
            tabBtns.forEach((b) => b.classList.remove("active"));
            document
                .querySelectorAll(".tab-content")
                .forEach((c) => c.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(`tab-${tab}`).classList.add("active");
        });
    });

    // 1. INICIAR SESI√ìN (CON CONTROL DE VERIFICACI√ìN)
    document
        .getElementById("login-form")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();
const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const feedback = document.getElementById("login-feedback");
            const btnResend = document.getElementById("btn-resend");

            feedback.classList.add("hidden");
            btnResend.classList.add("hidden");

            try {
                const userCredential = await signInWithEmailAndPassword(
                    auth,
                    email,
                    password,
                );
                const user = userCredential.user;

// üîí CANDADO: ¬øEst√° verificado?
                if (!user.emailVerified) {
                    await signOut(auth); // Lo sacamos inmediatamente
                    feedback.innerHTML = `‚ö†Ô∏è <strong>Email no verificado.</strong><br>Por favor revisa tu bandeja de entrada o spam.`;
                    feedback.classList.remove("hidden");
                    feedback.style.color = "#b91c1c"; // Rojo oscuro
                    feedback.style.backgroundColor = "#fef2f2";

                    // Opci√≥n para reenviar
                    btnResend.classList.remove("hidden");
                    btnResend.onclick = async () => {
                        await sendEmailVerification(user);
                        alert("Correo reenviado a " + email);
                    };
                    return;
                }

// Si pasa, redireccionamos
                window.location.href = returnUrl;
            } catch (error) {
                feedback.textContent = "‚ùå Email o contrase√±a incorrectos";
                feedback.classList.remove("hidden");
                feedback.style.color = "red";
            }
        });

    // 2. REGISTRO (ENV√çA EMAIL Y BLOQUEA)
    document
        .getElementById("register-form")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();
const name = document.getElementById("register-name").value;
            const email = document.getElementById("register-email").value;
            const password = document.getElementById("register-password").value;
            const feedback = document.getElementById("register-feedback");

            if (password.length < 6)
                return alert("La contrase√±a debe tener al menos 6 caracteres");

            try {
                // A. Crear usuario en Auth
                const userCredential = await createUserWithEmailAndPassword(
                    auth,
                    email,
                    password,
                );
                const user = userCredential.user;

// B. Enviar Email de Verificaci√≥n
                await sendEmailVerification(user);

                // C. Guardar en Firestore (Aunque no est√© verificado a√∫n, guardamos sus datos)
                await setDoc(doc(db, "clientes", user.uid), {
                    nombre: name,
                    email: email,
                    rol: "cliente",
                    createdAt: new Date(),
                });

                // üöÄ ENVIAR EMAIL DE BIENVENIDA (Async)
                try {
                  fetch("/api/send-welcome", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      email: email,
                      name: name,
                      role: "cliente",
                    }),
                  }).catch(console.warn);
                } catch (e) { console.warn(e) }

// D. Cerrar sesi√≥n para que no entre directo
                await signOut(auth);

                // E. Mostrar pantalla de √©xito
                document
                    .getElementById("reg-form-container")
                    .classList.add("hidden");
                document
                    .getElementById("reg-success")
                    .classList.remove("hidden");
            } catch (error) {
                console.error(error);
                feedback.textContent =
                    "‚ùå Error: " +
                    (error.code === "auth/email-already-in-use"
                        ? "El email ya est√° registrado"
                        : error.message);
                feedback.classList.remove("hidden");
                feedback.style.color = "red";
            }
        });

    // 3. GOOGLE (YA VIENE VERIFICADO POR DEFECTO)
    document
        .getElementById("btn-google")
        ?.addEventListener("click", async () => {
            try {
                const result = await signInWithPopup(
                    auth,
                    new GoogleAuthProvider(),
                );
// Guardar si es nuevo
                const docSnap = await getDoc(
                    doc(db, "clientes", result.user.uid),
                );
                if (!docSnap.exists()) {
                    await setDoc(doc(db, "clientes", result.user.uid), {
                        nombre: result.user.displayName || "Usuario Google",
                        email: result.user.email,
                        foto: result.user.photoURL,
                        rol: "cliente",
                        createdAt: new Date(),
                    });
}
                window.location.href = returnUrl;
            } catch (error) {
                alert("Error con Google: " + error.message);
            }
        });
</script>

<style>
.login-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
    }
    .login-card {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        width: 100%;
        max-width: 450px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .icon {
        font-size: 3.5rem;
        margin-bottom: 10px;
    }
    h1 {
        color: #1f2937;
        margin-bottom: 5px;
        font-size: 2rem;
        font-weight: 700;
    }
    p {
        color: #6b7280;
        margin-bottom: 25px;
        font-size: 0.95rem;
    }
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
    }
    .tab-btn {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        background: #f9fafb;
        border-radius: 10px;
        font-weight: 600;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .auth-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .auth-form input {
        width: 100%;
        padding: 14px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .btn-submit {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 14px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
    }
    .divider {
        margin: 25px 0;
        border-top: 1px solid #e5e7eb;
        position: relative;
    }
    .divider span {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0 15px;
        color: #9ca3af;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .btn-google {
        width: 100%;
        background: white;
        border: 2px solid #e5e7eb;
        padding: 14px;
        border-radius: 10px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        cursor: pointer;
    }
    .btn-google img {
        width: 22px;
    }
    .link-pro {
        display: block;
        margin-top: 25px;
        color: #7c3aed;
        text-decoration: none;
        font-weight: 600;
    }
    .feedback {
        font-size: 0.9rem;
        padding: 10px;
        background: #fef2f2;
        margin-top: 10px;
        border-radius: 8px;
    }
    .hidden {
        display: none;
    }
</style>
