---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Acceso Clientes - DeOficios">
    <div
        class="min-h-screen flex font-sans bg-slate-50 dark:bg-slate-900 transition-colors duration-300"
    >
        <!-- BANNER IZQUIERDO (Decorative - matching pro style) -->
        <div
            class="hidden lg:flex flex-1 relative bg-cover bg-center"
            style="background-image: url('https://images.unsplash.com/photo-1556742044-3c52d6e88c62?q=80&w=1000&auto=format&fit=crop');"
        >
            <div
                class="absolute inset-0 bg-indigo-900/40 z-10 backdrop-blur-[2px]"
            >
            </div>
            <div
                class="relative z-20 max-w-md text-center text-white p-12 self-center mx-auto"
            >
                <div
                    class="w-20 h-20 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-4xl mb-6 mx-auto shadow-xl border border-white/30"
                >
                    üõ°Ô∏è
                </div>
                <h1 class="text-5xl font-bold mb-6 drop-shadow-lg">
                    √Årea de Clientes
                </h1>
                <p class="text-xl opacity-90 leading-relaxed font-medium">
                    Acced√© para valorar profesionales, gestionar tus pedidos y
                    conectarte con seguridad.
                </p>
            </div>
        </div>

        <!-- FORMULARIO DERECHO -->
        <div
            class="flex-1 flex flex-col justify-center p-6 sm:p-12 lg:p-24 bg-white dark:bg-slate-900 transition-colors duration-300"
        >
            <div class="w-full max-w-md mx-auto">
                <!-- HEADER -->
                <div class="flex justify-between items-center mb-10">
                    <a
                        href="/"
                        class="text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400 text-sm font-medium transition-colors"
                    >
                        ‚Üê Volver al inicio
                    </a>
                    <img src="/favicon.svg" alt="Logo" class="w-10 h-10" />
                </div>

                <!-- TABS -->
                <div
                    class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl mb-8"
                >
                    <button
                        class="flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-200 tab-btn active"
                        data-tab="login"
                        id="btn-tab-login"
                    >
                        Iniciar Sesi√≥n
                    </button>
                    <button
                        class="flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-200 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 tab-btn"
                        data-tab="register"
                        id="btn-tab-register"
                    >
                        Registrarse
                    </button>
                </div>

                <!-- LOGIN CONTENT -->
                <div id="tab-login" class="tab-content active">
                    <div class="text-center mb-8">
                        <h2
                            class="text-3xl font-bold text-slate-800 dark:text-white mb-2"
                        >
                            Hola de nuevo üëã
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400">
                            Ingres√° tus datos para acceder a tu cuenta.
                        </p>
                    </div>

                    <form id="login-form" class="space-y-5">
                        <div class="space-y-2">
                            <label
                                class="block text-sm font-bold text-slate-700 dark:text-slate-200"
                                >Email</label
                            >
                            <input
                                type="email"
                                id="login-email"
                                placeholder="tu@email.com"
                                required
                                class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
                            />
                        </div>
                        <div class="space-y-2">
                            <label
                                class="block text-sm font-bold text-slate-700 dark:text-slate-200"
                                >Contrase√±a</label
                            >
                            <input
                                type="password"
                                id="login-password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                required
                                class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
                            />
                        </div>
                        <button
                            type="submit"
                            class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transition-all transform active:scale-[0.98]"
                        >
                            Ingresar
                        </button>
                        <p
                            id="login-feedback"
                            class="text-sm p-3 rounded-lg hidden text-center"
                        >
                        </p>
                        <div class="text-center">
                            <button
                                type="button"
                                id="btn-resend"
                                class="text-sm text-indigo-600 dark:text-indigo-400 underline hidden hover:text-indigo-800 font-medium"
                            >
                                Reenviar correo de verificaci√≥n
                            </button>
                        </div>
                    </form>
                </div>

                <!-- REGISTER CONTENT -->
                <div id="tab-register" class="tab-content hidden">
                    <div id="reg-form-container">
                        <div class="text-center mb-8">
                            <h2
                                class="text-3xl font-bold text-slate-800 dark:text-white mb-2"
                            >
                                Crear Cuenta üöÄ
                            </h2>
                            <p class="text-slate-500 dark:text-slate-400">
                                Un√≠te a la comunidad de vecinos.
                            </p>
                        </div>

                        <form id="register-form" class="space-y-5">
                            <div class="space-y-2">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-200"
                                    >Nombre completo</label
                                >
                                <input
                                    type="text"
                                    id="register-name"
                                    placeholder="Juan P√©rez"
                                    required
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
                                />
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-200"
                                    >Email real</label
                                >
                                <input
                                    type="email"
                                    id="register-email"
                                    placeholder="te@enviaremos-un-link.com"
                                    required
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
                                />
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="block text-sm font-bold text-slate-700 dark:text-slate-200"
                                    >Contrase√±a</label
                                >
                                <input
                                    type="password"
                                    id="register-password"
                                    placeholder="M√≠nimo 6 caracteres"
                                    required
                                    minlength="6"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
                                />
                            </div>
                            <button
                                type="submit"
                                class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-500/30 transition-all transform active:scale-[0.98]"
                            >
                                Crear Cuenta
                            </button>
                            <p
                                id="register-feedback"
                                class="text-sm p-3 rounded-lg hidden text-center"
                            >
                            </p>
                        </form>
                    </div>

                    <div id="reg-success" class="hidden text-center py-6">
                        <div
                            class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-2xl flex items-center justify-center text-4xl mb-6 mx-auto"
                        >
                            üì©
                        </div>
                        <h3
                            class="text-2xl font-bold text-slate-800 dark:text-white"
                        >
                            ¬°Revisa tu correo!
                        </h3>
                        <p
                            class="text-slate-500 dark:text-slate-400 mt-2 mb-8 leading-relaxed"
                        >
                            Te enviamos un enlace de confirmaci√≥n. <br />
                            <strong
                                >Debes hacer clic en √©l para activar tu cuenta.</strong
                            >
                        </p>
                        <button
                            onclick="window.location.reload()"
                            class="w-full py-4 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                        >
                            Ya lo confirm√©, Iniciar Sesi√≥n
                        </button>
                    </div>
                </div>

                <!-- SOCILA LOGIN -->
                <div class="relative py-8">
                    <div class="absolute inset-0 flex items-center">
                        <div
                            class="w-full border-t border-slate-200 dark:border-slate-700"
                        >
                        </div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span
                            class="px-4 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400 font-medium italic"
                            >o r√°pido con</span
                        >
                    </div>
                </div>

                <button
                    id="btn-google"
                    class="w-full py-3.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-bold rounded-xl flex items-center justify-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all shadow-sm active:scale-[0.98]"
                >
                    <img
                        src="https://www.svgrepo.com/show/475656/google-color.svg"
                        alt="G"
                        class="w-5 h-5"
                    /> Google (Verificaci√≥n autom√°tica)
                </button>

                <div class="mt-10 text-center">
                    <a
                        href="/ingresar"
                        class="text-indigo-600 dark:text-indigo-400 font-bold hover:underline transition-all"
                    >
                        ¬øSos profesional? Clic aqu√≠
                    </a>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { auth, db } from "../firebase/client";
    import {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        sendEmailVerification,
        signOut,
    } from "firebase/auth";
    import { doc, setDoc, getDoc } from "firebase/firestore";

    const tabBtns = document.querySelectorAll(".tab-btn");
    const params = new URLSearchParams(window.location.search);
    const returnUrl = params.get("returnUrl") || "/mi-cuenta";

    // TABS LOGIC
    tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const tab = (btn as HTMLElement).dataset.tab;

            // UI Update
            tabBtns.forEach((b) => {
                b.classList.remove(
                    "active",
                    "bg-white",
                    "text-indigo-600",
                    "shadow-md",
                );
                b.classList.add("text-slate-500", "dark:text-slate-400");
            });

            btn.classList.add(
                "active",
                "bg-white",
                "text-indigo-600",
                "shadow-md",
            );
            btn.classList.remove("text-slate-500", "dark:text-slate-400");

            // Content Update
            document
                .querySelectorAll(".tab-content")
                .forEach((c) => c.classList.add("hidden"));
            document.getElementById(`tab-${tab}`)?.classList.remove("hidden");
        });
    });

    // 1. INICIAR SESI√ìN
    document
        .getElementById("login-form")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = (
                document.getElementById("login-email") as HTMLInputElement
            ).value;
            const password = (
                document.getElementById("login-password") as HTMLInputElement
            ).value;
            const feedback = document.getElementById("login-feedback");
            const btnResend = document.getElementById("btn-resend");

            if (!feedback || !btnResend) return;

            feedback.classList.add("hidden");
            btnResend.classList.add("hidden");

            try {
                const userCredential = await signInWithEmailAndPassword(
                    auth,
                    email,
                    password,
                );
                const user = userCredential.user;

                if (!user.emailVerified) {
                    await signOut(auth);
                    feedback.innerHTML = `‚ö†Ô∏è <strong>Email no verificado.</strong><br>Por favor revis√° tu bandeja de entrada o spam.`;
                    feedback.classList.remove("hidden");
                    feedback.classList.add(
                        "bg-red-50",
                        "text-red-700",
                        "dark:bg-red-900/20",
                        "dark:text-red-400",
                    );

                    btnResend.classList.remove("hidden");
                    btnResend.onclick = async () => {
                        await sendEmailVerification(user);
                        alert("Correo reenviado a " + email);
                    };
                    return;
                }

                // Check user role
                const docSnap = await getDoc(doc(db, "clientes", user.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.rol === "profesional" || data.rol === "experto") {
                        window.location.href = "/panel";
                    } else {
                        window.location.href = "/mi-cuenta";
                    }
                } else {
                    // Should not happen for registered users, but fallback:
                    window.location.href = "/mi-cuenta";
                }
            } catch (error: any) {
                console.error("Login error:", error);

                let msg = "‚ùå Email o contrase√±a incorrectos";
                let showRegisterLink = false;

                if (
                    error.code === "auth/user-not-found" ||
                    error.code === "auth/invalid-credential"
                ) {
                    msg = "‚ö†Ô∏è Usuario no encontrado. ¬øQuer√©s crear una cuenta?";
                    showRegisterLink = true;
                } else if (error.code === "auth/wrong-password") {
                    msg = "‚ùå Contrase√±a incorrecta.";
                }

                feedback.innerHTML = msg;
                if (showRegisterLink) {
                    feedback.innerHTML += `<br><button id="btn-switch-to-register" class="text-indigo-600 underline mt-2 font-bold hover:text-indigo-800" type="button">Ir a Registrarse</button>`;
                }

                feedback.classList.remove("hidden");
                feedback.classList.add(
                    "bg-red-50",
                    "text-red-700",
                    "dark:bg-red-900/20",
                    "dark:text-red-400",
                );

                // Add listener to new button
                setTimeout(() => {
                    document
                        .getElementById("btn-switch-to-register")
                        ?.addEventListener("click", () => {
                            document
                                .getElementById("btn-tab-register")
                                ?.click();
                        });
                }, 100);
            }
        });

    // 2. REGISTRO
    document
        .getElementById("register-form")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = (
                document.getElementById("register-name") as HTMLInputElement
            ).value;
            const email = (
                document.getElementById("register-email") as HTMLInputElement
            ).value;
            const password = (
                document.getElementById("register-password") as HTMLInputElement
            ).value;
            const feedback = document.getElementById("register-feedback");

            if (!feedback) return;

            if (password.length < 6)
                return alert("La contrase√±a debe tener al menos 6 caracteres");

            try {
                const userCredential = await createUserWithEmailAndPassword(
                    auth,
                    email,
                    password,
                );
                const user = userCredential.user;

                await sendEmailVerification(user);

                await setDoc(doc(db, "clientes", user.uid), {
                    nombre: name,
                    email: email,
                    rol: "cliente",
                    createdAt: new Date(),
                });

                await signOut(auth);

                document
                    .getElementById("reg-form-container")
                    ?.classList.add("hidden");
                document
                    .getElementById("reg-success")
                    ?.classList.remove("hidden");
            } catch (error: any) {
                console.error(error);
                feedback.textContent =
                    "‚ùå Error: " +
                    (error.code === "auth/email-already-in-use"
                        ? "El email ya est√° registrado"
                        : error.message);
                feedback.classList.remove("hidden");
                feedback.classList.add(
                    "bg-red-50",
                    "text-red-700",
                    "dark:bg-red-900/30",
                    "dark:text-red-400",
                );
            }
        });

    // 3. GOOGLE
    document
        .getElementById("btn-google")
        ?.addEventListener("click", async () => {
            try {
                const result = await signInWithPopup(
                    auth,
                    new GoogleAuthProvider(),
                );

                // Fetch user data to check role
                const docRef = doc(db, "clientes", result.user.uid);
                const docSnap = await getDoc(docRef);

                let targetUrl = "/mi-cuenta"; // Default for clients

                if (!docSnap.exists()) {
                    // New User -> Create as Cliente
                    await setDoc(docRef, {
                        nombre: result.user.displayName || "Usuario Google",
                        email: result.user.email,
                        foto: result.user.photoURL,
                        rol: "cliente",
                        createdAt: new Date(),
                    });
                    // Force mi-cuenta for new users
                    window.location.href = "/mi-cuenta";
                    return;
                } else {
                    // Existing User -> Check Role
                    const data = docSnap.data();
                    if (data.rol === "profesional" || data.rol === "experto") {
                        targetUrl = "/panel";
                    } else {
                        targetUrl = "/mi-cuenta";
                    }
                }

                // If returnUrl is set and safe, valid, use it?
                // Better to force role-based home to avoid cross-contamination
                // unless we strictly validate returnUrl permissions (hard to do here).
                // Let's prioritize correct panel.

                window.location.href = targetUrl;
            } catch (error: any) {
                alert("Error con Google: " + error.message);
            }
        });
</script>

<style>
    .tab-btn.active {
        background-color: white;
        color: #4f46e5; /* indigo-600 */
        box-shadow:
            0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    :global(.dark) .tab-btn.active {
        background-color: #1e293b; /* slate-800 */
        color: #818cf8; /* indigo-400 */
    }
</style>
