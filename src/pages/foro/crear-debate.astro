---
import Layout from "../../layouts/Layout.astro";

// Mapeo de categoras display -> Firebase ID
const CATEGORY_MAP = {
    General: "general",
    Electricidad: "electricidad",
    Fontanera: "plomeria",
    Albailera: "albanileria",
    Jardinera: "jardineria",
    Herramientas: "herramientas",
    Presupuestos: "negocios",
};

const groups = Object.keys(CATEGORY_MAP);
---

<Layout title="Iniciar nuevo debate - Oficios">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet"
    />

    <div class="bg-[#F8FAFC] min-h-screen font-sans py-8">
        <div
            class="max-w-6xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
            <main class="lg:col-span-8">
                <div class="mb-6">
                    <a
                        href="/foro"
                        class="text-sm text-slate-400 hover:text-[#FF5A5F] mb-2 inline-block"> Volver a la comunidad</a>
                    <h1 class="text-3xl md:text-4xl font-serif text-slate-800">
                        Iniciar un nuevo debate
                    </h1>
                </div>

                <form
                    id="create-debate-form"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-8">
                    <div class="mb-6">
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">
                            En qu grupo quieres publicar? <span
                                class="text-[#FF5A5F]">*</span>
                        </label>
                        <div class="relative">
                            <select
                                id="category"
                                required
                                class="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-700 py-3 px-4 pr-8 rounded-lg focus:outline-none focus:border-[#FF5A5F] focus:ring-1 focus:ring-[#FF5A5F] cursor-pointer font-medium">
                                <option value="" disabled selected>Selecciona un grupo...</option>
                                {
                                    groups.map((group) => (
                                        <option value={group}>{group}</option>
                                    ))
                                }
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                                <svg
                                    class="w-5 h-5"
                                    fill="currentColor"
                                    viewBox="0 0 20 20">
                                    <path
                                        fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">
                            Ttulo del debate <span class="text-[#FF5A5F]">*</span>
                        </label>
                        <input
                            type="text"
                            id="title"
                            required
                            minlength="10"
                            maxlength="100"
                            placeholder="Ej: Cul es la mejor manera de impermeabilizar una terraza?"
                            class="w-full bg-slate-50 border border-slate-300 text-slate-700 py-3 px-4 rounded-lg focus:outline-none focus:border-[#FF5A5F] focus:ring-1 focus:ring-[#FF5A5F] placeholder:text-slate-400"
                        />
                        <p class="text-xs text-slate-400 mt-2 text-right">
                            Mnimo 10 caracteres
                        </p>
                    </div>

                    <div class="mb-6">
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">
                            Tu mensaje <span class="text-[#FF5A5F]">*</span>
                        </label>

                        <textarea
                            id="content"
                            rows="10"
                            required
                            minlength="20"
                            class="w-full p-4 bg-slate-50 border border-slate-300 text-slate-700 rounded-lg focus:outline-none focus:border-[#FF5A5F] focus:ring-1 focus:ring-[#FF5A5F] resize-y min-h-[200px]"
                            placeholder="Explica tu duda o comparte tu experiencia aqu. Cuantos ms detalles des, mejor te podrn ayudar..."></textarea>
                        <p class="text-xs text-slate-400 mt-2 text-right">
                            Mnimo 20 caracteres
                        </p>
                    </div>

                    <div class="mb-8">
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">
                            Fotos (Opcional)
                        </label>
                        <input
                            type="file"
                            id="file-input"
                            accept="image/*"
                            multiple
                            class="hidden"
                        />
                        <div
                            id="upload-area"
                            class="border-2 border-dashed border-slate-300 rounded-lg p-6 flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 hover:border-[#FF5A5F] transition-colors cursor-pointer bg-slate-50/50">
                            <svg
                                class="w-8 h-8 mb-2 opacity-50"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-sm font-medium">Haz clic para subir fotos o arrstralas aqu</span>
                            <span class="text-xs opacity-70 mt-1">JPG, PNG hasta 5MB</span>
                        </div>
                        <div
                            id="preview-container"
                            class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                        </div>
                    </div>

                    <div class="mb-8 flex items-center gap-3">
                        <input
                            type="checkbox"
                            id="notify"
                            checked
                            class="w-5 h-5 text-[#FF5A5F] border-gray-300 rounded focus:ring-[#FF5A5F] cursor-pointer accent-[#FF5A5F]"
                        />
                        <label
                            for="notify"
                            class="text-sm text-slate-600 cursor-pointer select-none">
                            Avsame por email cuando alguien responda
                        </label>
                    </div>

                    <div
                        class="flex flex-col-reverse sm:flex-row items-center justify-end gap-4">
                        <a
                            href="/foro"
                            class="text-slate-500 font-bold hover:text-slate-800 px-4 py-2 transition-colors">Cancelar</a>
                        <button
                            type="submit"
                            id="submit-btn"
                            class="w-full sm:w-auto bg-[#FF5A5F] hover:bg-[#ff4146] text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-rose-100 transition-all hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                            Publicar debate
                        </button>
                    </div>
                </form>
            </main>

            <aside class="lg:col-span-4 space-y-6">
                <div
                    class="bg-blue-50 border border-blue-100 rounded-xl p-6 text-blue-900">
                    <div class="flex items-center gap-2 mb-4 text-blue-600">
                        <svg
                            class="w-6 h-6"
                            fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                                fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <h3 class="font-serif font-bold text-lg">
                            Antes de publicar
                        </h3>
                    </div>
                    <ul class="space-y-3 text-sm leading-relaxed opacity-90">
                        <li class="flex gap-2">
                            <span></span>
                            <span><strong>Busca antes de preguntar:</strong> Es posible
                                que alguien ya haya resuelto tu duda.</span>
                        </li>
                        <li class="flex gap-2">
                            <span></span>
                            <span><strong>S especfico:</strong> Un ttulo claro ayuda
                                a que los expertos entren a responder.</span>
                        </li>
                        <li class="flex gap-2">
                            <span></span>
                            <span><strong>Elige el grupo correcto:</strong> Si es sobre
                                cables, ponlo en "Electricidad".</span>
                        </li>
                    </ul>
                </div>

                <div
                    class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                    <h3
                        class="font-serif font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span></span> Normas de la comunidad
                    </h3>
                    <ul
                        class="space-y-3 text-sm text-slate-600 leading-relaxed mb-6">
                        <li class="flex gap-2">
                            <span class="text-green-500 font-bold"></span>
                            <span>S respetuoso y amable con todos los miembros.</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-green-500 font-bold"></span>
                            <span>Aporta valor: respuestas tiles y
                                constructivas.</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-red-500 font-bold"></span>
                            <span>No hagas spam ni autopromocin excesiva.</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-red-500 font-bold"></span>
                            <span>Evita temas polticos o religiosos polmicos.</span>
                        </li>
                    </ul>
                    <a
                        href="/foro/reglas"
                        class="block w-full text-center bg-slate-50 hover:bg-slate-100 text-slate-600 font-bold py-3 rounded-lg border border-slate-200 transition-colors text-sm">
                        Leer reglamento completo
                    </a>
                </div>
            </aside>
        </div>
    </div>
</Layout>

<style>
    :global(body) {
        font-family: "Inter", sans-serif;
    }

    :global(.font-serif) {
        font-family: "DM Serif Display", serif;
    }

    .preview-image {
        position: relative;
        aspect-ratio: 1;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 2px solid #e2e8f0;
    }

    .preview-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-image button {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .preview-image button:hover {
        background: rgb(220, 38, 38);
        transform: scale(1.1);
    }
</style>

<script>
    import { auth, db, storage } from "../../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import { collection, addDoc, serverTimestamp } from "firebase/firestore";
    import { ref, uploadBytes, getDownloadURL } from "firebase/storage";

    const CATEGORY_MAP = {
        General: "general",
        Electricidad: "electricidad",
        Fontanera: "plomeria",
        Albailera: "albanileria",
        Jardinera: "jardineria",
        Herramientas: "herramientas",
        Presupuestos: "negocios",
    };

    document.addEventListener("astro:page-load", () => {
        console.log(" [FORO-NUEVO] Pgina cargada/navegada");

        let currentUser = null;
        let selectedFiles: File[] = [];

        // Verificar autenticacin
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                alert(" Debes iniciar sesin para crear debates");
                window.location.href = "/ingresar";
                return;
            }
            currentUser = user;
            console.log("Usuario autenticado:", user.uid);
        });

        // Manejo de subida de archivos
        const fileInput = document.getElementById(
            "file-input",
        ) as HTMLInputElement;
        const uploadArea = document.getElementById("upload-area");
        const previewContainer = document.getElementById("preview-container");

        uploadArea?.addEventListener("click", () => fileInput?.click());

        // Drag and drop
        uploadArea?.addEventListener("dragover", (e) => {
            e.preventDefault();
            uploadArea.classList.add("border-[#FF5A5F]", "bg-rose-50");
        });

        uploadArea?.addEventListener("dragleave", () => {
            uploadArea.classList.remove("border-[#FF5A5F]", "bg-rose-50");
        });

        uploadArea?.addEventListener("drop", (e) => {
            e.preventDefault();
            uploadArea.classList.remove("border-[#FF5A5F]", "bg-rose-50");
            const files = Array.from(e.dataTransfer?.files || []);
            handleFiles(files as File[]);
        });

        fileInput?.addEventListener("change", (e) => {
            const files = Array.from(
                (e.target as HTMLInputElement).files || [],
            );
            handleFiles(files);
        });

        function handleFiles(files: File[]) {
            // Filtrar solo imgenes y limitar a 5MB
            const validFiles = files.filter((file) => {
                if (!file.type.startsWith("image/")) {
                    alert(`${file.name} no es una imagen vlida`);
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} es demasiado grande (mx 5MB)`);
                    return false;
                }
                return true;
            });

            selectedFiles = [...selectedFiles, ...validFiles].slice(0, 5); // Mximo 5 fotos
            updatePreview();
        }

        function updatePreview() {
            if (!previewContainer) return;

            previewContainer.innerHTML = "";
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement("div");
                    div.className = "preview-image";
                    div.innerHTML = `
                    <img src="${e.target?.result}" alt="Preview">
                    <button type="button" data-index="${index}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                `;
                    previewContainer.appendChild(div);

                    // Botn eliminar
                    div.querySelector("button")?.addEventListener(
                        "click",
                        () => {
                            selectedFiles.splice(index, 1);
                            updatePreview();
                        },
                    );
                };
                reader.readAsDataURL(file);
            });
        }

        // Submit del formulario
        const form = document.getElementById(
            "create-debate-form",
        ) as HTMLFormElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert(" Debes iniciar sesin");
                return;
            }

            const titleInput = document.getElementById(
                "title",
            ) as HTMLInputElement;
            const categorySelect = document.getElementById(
                "category",
            ) as HTMLSelectElement;
            const contentTextarea = document.getElementById(
                "content",
            ) as HTMLTextAreaElement;

            const title = titleInput.value.trim();
            const categoryDisplay = categorySelect.value;
            const content = contentTextarea.value.trim();

            if (!title || !categoryDisplay || !content) {
                alert("Por favor completa todos los campos obligatorios");
                return;
            }

            if (title.length < 10) {
                alert("El ttulo debe tener al menos 10 caracteres");
                return;
            }

            if (content.length < 20) {
                alert("El mensaje debe tener al menos 20 caracteres");
                return;
            }

            const category = CATEGORY_MAP[categoryDisplay];
            if (!category) {
                alert("Categora no vlida");
                return;
            }

            // Deshabilitar botn
            submitBtn.disabled = true;
            submitBtn.textContent = "Publicando...";

            try {
                // Subir imgenes si hay (opcional, no bloquea si falla)
                const imageUrls: string[] = [];

                if (selectedFiles.length > 0) {
                    console.log(
                        ` Intentando subir ${selectedFiles.length} imgenes...`,
                    );

                    for (const file of selectedFiles) {
                        try {
                            const fileName = `foro/${currentUser.uid}/${Date.now()}_${file.name}`;
                            const storageRef = ref(storage, fileName);
                            await uploadBytes(storageRef, file);
                            const downloadURL =
                                await getDownloadURL(storageRef);
                            imageUrls.push(downloadURL);
                            console.log(` Imagen subida: ${file.name}`);
                        } catch (imgError) {
                            console.warn(
                                ` No se pudo subir ${file.name}:`,
                                imgError,
                            );
                            // Continuar sin esta imagen
                        }
                    }

                    if (imageUrls.length === 0 && selectedFiles.length > 0) {
                        console.warn(
                            " No se pudieron subir las imgenes, continuando sin ellas",
                        );
                        alert(
                            " No se pudieron subir las imgenes (verifica permisos de Storage), pero tu debate se publicar sin fotos.",
                        );
                    }
                }

                // Crear thread en Firebase
                const docRef = await addDoc(collection(db, "foro_threads"), {
                    title,
                    category,
                    content,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || "Usuario",
                    authorPhoto: currentUser.photoURL || null,
                    createdAt: serverTimestamp(),
                    lastReplyAt: serverTimestamp(),
                    replyCount: 0,
                    views: 0,
                    likes: 0,
                    images: imageUrls.length > 0 ? imageUrls : [],
                    isOfficial: false,
                });

                console.log(" Thread creado:", docRef.id);
                alert(" Debate publicado exitosamente!");
                window.location.href = `/foro/${docRef.id}`;
            } catch (error) {
                console.error(" Error al publicar:", error);
                alert(" Error al publicar el debate: " + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = "Publicar debate";
            }
        });
    }); // End of astro:page-load
</script>

