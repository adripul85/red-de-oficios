---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { db } from "../../firebase/client";
import {
    doc,
    getDoc,
    collection,
    query,
    where,
    getDocs,
    orderBy,
} from "firebase/firestore";

const { id } = Astro.params;

if (!id) return Astro.redirect("/foro");

let thread = null;
let replies = [];
let error = null;

// Helper de fechas ULTRA SEGURO
function formatDate(timestamp) {
    if (!timestamp) return "Fecha desconocida";
    try {
        // 1. Si es Timestamp de Firestore
        if (timestamp && typeof timestamp.toDate === "function") {
            return timestamp.toDate().toLocaleDateString();
        }
        // 2. Si es objeto Date JS
        else if (timestamp instanceof Date) {
            return timestamp.toLocaleDateString();
        }
        // 3. Si es String (ej: "2024-01-01")
        else if (typeof timestamp === "string") {
            return timestamp;
        }
        return "Fecha inv√°lida";
    } catch (e) {
        return "Error fecha";
    }
}

try {
    // 1. OBTENER EL DEBATE
    const threadRef = doc(db, "foro_threads", id);
    const snap = await getDoc(threadRef);

    if (snap.exists()) {
        const data = snap.data();

        // üî• SANITIZACI√ìN DE DATOS (Rellena huecos si faltan datos en Firebase)
        thread = {
            id: snap.id,
            title: data?.title || "Sin t√≠tulo",
            content: data?.content || "Sin contenido.",
            category: data?.category || "general",

            // Datos de Autor (Importante: authorId puede venir null si es viejo)
            authorName: data?.authorName || "An√≥nimo",
            authorPhoto:
                data?.authorPhoto || `https://ui-avatars.com/api/?name=User`,
            authorId: data?.authorId || "unknown",

            // Fecha
            date: formatDate(data?.createdAt),

            // Contadores (Asegurar que sean n√∫meros)
            likes: Number(data?.likes) || 0,
            views: Number(data?.views) || 0,

            // Arrays
            images: Array.isArray(data?.images) ? data.images : [],
        };

        // 2. OBTENER RESPUESTAS
        try {
            const repliesRef = collection(db, "foro_posts");
            const q = query(
                repliesRef,
                where("threadId", "==", id),
                orderBy("createdAt", "asc"),
            );
            const repliesSnap = await getDocs(q);

            replies = repliesSnap.docs.map((doc) => {
                const rData = doc.data();
                return {
                    id: doc.id,
                    content: rData?.content || "",
                    authorName: rData?.authorName || "An√≥nimo",
                    authorPhoto:
                        rData?.authorPhoto ||
                        `https://ui-avatars.com/api/?name=A`,
                    authorId: rData?.authorId, 
                    date: formatDate(rData?.createdAt),
                };
            });
        } catch (replyError) {
            console.error(
                "Error cargando respuestas (no bloqueante):",
                replyError,
            );
            replies = []; // Si falla, mostramos 0 respuestas pero cargamos el post
        }
    } else {
        error = "El debate no existe.";
    }
} catch (e) {
    console.error("‚ùå Error CR√çTICO renderizando [id].astro:", e);
    error = `Error t√©cnico: ${e.message}`;
}

const PRIVATE_IDS = ["proveedores", "herramientas", "negocios", "offtopic", "herramientas_pro", "gestoria", "offtopic_pro"];
const isPrivate = thread && PRIVATE_IDS.includes(thread.category);
---

<Layout title={thread ? thread.title : "Error"}>
    <script is:inline src="https://cdn.jsdelivr.net/npm/sweetalert2@11"
    ></script>

    <div class="bg-[#F8F9FA] min-h-screen py-8 font-sans">
        <div class="max-w-4xl mx-auto px-4">
            <a
                href="/foro"
                class="text-slate-500 hover:text-[#FF5A5F] mb-6 inline-block font-bold text-sm"
            >
                ‚Üê Volver a la Comunidad
            </a>

            {
                error ? (
                    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r shadow-sm text-center">
                        <h3 class="text-red-700 font-bold text-lg mb-2">
                            üòï Ups, algo sali√≥ mal
                        </h3>
                        <p class="text-red-600 mb-4">{error}</p>
                        <a
                            href="/foro"
                            class="bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200"
                        >
                            Volver al Foro
                        </a>
                    </div>
                ) : (
                    <div id="thread-container" data-category={thread.category}>
                        {/* --- LOCK SCREEN --- */}
                        <div id="lock-screen" class={isPrivate ? "flex flex-col items-center justify-center py-20 bg-white rounded-2xl border border-slate-200 shadow-sm text-center" : "hidden"}>
                            <div class="text-6xl mb-4">üîí</div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Contenido Exclusivo</h2>
                            <p class="text-slate-500 max-w-md mx-auto mb-6">Esta secci√≥n es exclusiva para profesionales de la comunidad.</p>
                            
                            <div id="access-loading" class="hidden flex flex-col items-center gap-2 mb-6">
                                <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                                <span class="text-indigo-600 font-bold text-sm">Verificando tu acceso...</span>
                            </div>

                            <div class="flex gap-4 justify-center">
                                <a href={`/ingresar?redirect=/foro/${id}`} class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                                    Iniciar Sesi√≥n
                                </a>
                                <a href="/foro" class="text-slate-500 px-6 py-2.5 font-bold hover:underline">
                                    Volver al Foro
                                </a>
                            </div>
                        </div>

                        {/* --- DEBATE PRINCIPAL (Protected) --- */}
                        <div id="thread-content" class={isPrivate ? "hidden" : ""}>
                            <article class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-200 mb-8 relative group">
                                <div class="flex items-start justify-between mb-6">
                                <div class="flex items-center gap-4">
                                        <img
                                            src={thread.authorPhoto}
                                            class="w-12 h-12 rounded-full border-2 border-slate-100"
                                        />
                                        <div>
                                            <h1 class="text-2xl md:text-3xl font-bold text-slate-800 leading-tight mb-1">
                                                {thread.title}
                                            </h1>
                                            <div class="flex items-center gap-2 text-sm text-slate-500">
                                                <span class="font-bold text-[#FF5A5F]">
                                                    {thread.authorName}
                                                </span>
                                                <span>‚Ä¢ {thread.date}</span>
                                                <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold uppercase ml-2">
                                                    {thread.category}
                                                </span>
                                                {thread.authorId && thread.authorId !== "unknown" && (
                                                    <a href={`/perfil?id=${thread.authorId}`} class="ml-2 text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 font-bold hover:bg-blue-100 transition">
                                                        Ver Perfil Profesional
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="prose prose-slate max-w-none text-slate-700 leading-relaxed text-lg mb-6 whitespace-pre-line">
                                    {thread.content}
                                </div>

                                {thread.images.length > 0 && (
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                                        {thread.images.map((img) => (
                                            <img
                                                src={img}
                                                class="rounded-xl border border-slate-100 w-full h-48 object-cover cursor-pointer hover:opacity-90"
                                                onclick={`window.open('${img}', '_blank')`}
                                            />
                                        ))}
                                    </div>
                                )}

                                {/* CONTROLES (Solo visibles para el due√±o) */}
                                <div
                                    class="owner-controls hidden absolute top-6 right-6 flex gap-2"
                                    data-author-id={thread.authorId}
                                    data-thread-id={thread.id}
                                >
                                    <button
                                        class="btn-edit text-slate-400 hover:text-blue-600 p-2 transition"
                                        title="Editar"
                                    >
                                        ‚úèÔ∏è
                                    </button>
                                    <button
                                        class="btn-delete text-slate-400 hover:text-red-600 p-2 transition"
                                        title="Eliminar"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>

                                <div class="flex items-center gap-6 pt-6 border-t border-slate-100 text-slate-500 font-medium">
                                    <span>‚ù§Ô∏è {thread.likes} √ötil</span>
                                    <span>üí¨ {replies.length} Respuestas</span>
                                    <span>üëÅÔ∏è {thread.views} Vistas</span>
                                </div>
                            </article>

                            {/* --- RESPUESTAS --- */}
                            <div class="space-y-6 mb-12">
                                <h3 class="text-xl font-bold text-slate-800 px-2">
                                    {replies.length} Respuestas
                                </h3>
                                {replies.map((reply) => (
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex gap-4">
                                        <img
                                            src={reply.authorPhoto}
                                            class="w-10 h-10 rounded-full border border-slate-100 flex-shrink-0"
                                        />
                                        <div class="flex-1">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="font-bold text-slate-800 text-sm">
                                                    {reply.authorName}
                                                </span>
                                                <span class="text-xs text-slate-400">
                                                    {reply.date}
                                                </span>
                                            </div>
                                            <p class="text-slate-600 text-sm leading-relaxed whitespace-pre-line mb-3">
                                                {reply.content}
                                            </p>
                                            
                                            {reply.authorId && (
                                                <a href={`/perfil?id=${reply.authorId}`} class="inline-flex items-center gap-2 text-xs bg-orange-50 text-orange-700 px-3 py-1.5 rounded-lg border border-orange-100 font-bold hover:bg-orange-100 transition">
                                                    üë∑ Ver perfil de {reply.authorName} y contactar
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* --- INPUT RESPUESTA --- */}
                            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 sticky bottom-4 z-10">
                                <textarea
                                    id="reply-content"
                                    rows="3"
                                    class="w-full border border-slate-200 rounded-xl p-3 focus:border-[#FF5A5F] resize-none outline-none"
                                    placeholder="Escribe tu respuesta..."
                                />
                                <div class="flex justify-end mt-3">
                                    <button
                                        id="btn-reply"
                                        class="bg-[#FF5A5F] hover:bg-[#ff4146] text-white font-bold py-2 px-6 rounded-lg shadow-md transition"
                                    >
                                        Publicar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        </div>
    </div>
</Layout>

</script>
    <script>
    import { auth, db } from "../../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        doc,
        getDoc,
        updateDoc,
        addDoc,
        collection,
        serverTimestamp,
        increment,
        deleteDoc,
    } from "firebase/firestore";

    // Define private categories
    const PRIVATE_CATEGORIES = [
        "proveedores", 
        "herramientas_pro", 
        "negocios", // Fix: 'negocios' was missing regarding index.astro
        "offtopic", // index.astro says "offtopic_pro" but structure says "offtopic" in validCategories but "offtopic" in structure array? 
                    // Let's match index.astro list: "proveedores", "herramientas_pro", "gestoria", "offtopic_pro" 
                    // AND "negocios" from structure? 
                    // Looking at index.astro line 40: items are suppliers, tools, business, off-topic.
                    // IDs: proveedores, herramientas, negocios, offtopic.
                    // Wait, index.astro validCategories line 12 has "offtopic_pro" but line 44 structure has ID "offtopic".
                    // I will include ALL potentially private IDs to be safe.
        "gestoria",
        "offtopic_pro" 
    ];
    // Add IDs from forumStructure in index.astro to be sure
    const PRIVATE_IDS = ["proveedores", "herramientas", "negocios", "offtopic", "herramientas_pro", "gestoria", "offtopic_pro"];

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [FORO-POST] P√°gina cargada/navegada");

        // @ts-ignore
        const currentThreadId = window.location.pathname.split("/").pop();
        
        // Access Control Logic
        const article = document.querySelector('article'); 
        const categoryBadge = article?.querySelector('.bg-slate-100'); // Assuming category is here
        // Better: Read from server rendered data attribute if possible, or parse HTML
        // For now, let's rely on the DOM content or pass it via data attribute
        
        // We need the category ID. The HTML shows "Name", not ID.
        // Let's assume we need to check this securely.
        // But since we are modifying the file, let's add a data attribute to the article.
        
        const threadContainer = document.getElementById("thread-container");
        // @ts-ignore
        const currentCategory = threadContainer?.dataset.category;

        // AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            const lockScreen = document.getElementById("lock-screen");
            const content = document.getElementById("thread-content");
            const loading = document.getElementById("access-loading");

            if (!content || !currentCategory) return;
            
            // Check if private
            if (PRIVATE_IDS.includes(currentCategory)) {
                if (!user) {
                    // Not logged in -> Redirect
                    window.location.href = `/ingresar?redirect=/foro/${currentThreadId}`;
                    return;
                }

                // Logged in -> Check Role
                if (loading) loading.classList.remove("hidden");
                
                try {
                    // Check if Admin or Professional
                    const proRef = doc(db, "profesionales", user.uid);
                    const proSnap = await getDoc(proRef);

                    let accessGranted = false;

                    if (proSnap.exists()) {
                        accessGranted = true; // Is a professional
                        // Check if admin (optional, as pros have access anyway)
                        const data = proSnap.data();
                        if (data.rol === 'admin') console.log("üëÆ‚Äç‚ôÇÔ∏è Acceso Admin");
                    } else {
                        // Check if explicitly Admin in other collection (e.g. specialized admin auth)
                        // Or maybe 'clientes' with admin role?
                        const clientRef = doc(db, "clientes", user.uid);
                        const clientSnap = await getDoc(clientRef);
                        if (clientSnap.exists() && clientSnap.data().rol === 'admin') {
                            accessGranted = true;
                        }
                    }
                    
                    // Allow owner access regardless of role
                    // @ts-ignore
                    const ownerId = document.querySelector(".owner-controls")?.dataset.authorId;
                    if (user.uid === ownerId) accessGranted = true;

                    if (accessGranted) {
                        if (lockScreen) lockScreen.remove();
                        content.classList.remove("hidden");
                    } else {
                        if (loading) loading.classList.add("hidden");
                        if (lockScreen) lockScreen.classList.remove("hidden");
                        // Optional: Redirect after few seconds
                        setTimeout(() => window.location.href = "/foro", 3000);
                    }

                } catch (e) {
                    console.error("Error verificando acceso:", e);
                    alert("Error verificando permisos.");
                    window.location.href = "/foro";
                }
            } else {
                // Public category -> Show content
                content.classList.remove("hidden");
                if (lockScreen) lockScreen.remove();
            }

            // Owner Controls (Existing Logic)
            if (user) {
                document.querySelectorAll(".owner-controls").forEach((div) => {
                    // @ts-ignore
                    if (div.dataset.authorId === user.uid)
                        div.classList.remove("hidden");
                });
            }
        });

        document
            .getElementById("btn-reply")
            ?.addEventListener("click", async () => {
                // @ts-ignore
                const content = document.getElementById("reply-content").value;
                if (!content.trim()) return alert("Escribe algo.");
                const user = auth.currentUser;
                if (!user) return (window.location.href = "/ingresar");

                try {
                    await addDoc(collection(db, "foro_posts"), {
                        threadId: currentThreadId,
                        content: content,
                        authorId: user.uid,
                        authorName: user.displayName || "Usuario",
                        authorPhoto: user.photoURL,
                        createdAt: serverTimestamp(),
                    });
                    await updateDoc(doc(db, "foro_threads", currentThreadId), {
                        replyCount: increment(1),
                        lastReplyAt: serverTimestamp(),
                    });
                    window.location.reload();
                } catch (e) {
                    alert("Error al publicar.");
                }
            });

        document.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                // @ts-ignore
                if (confirm("¬øBorrar debate?")) {
                    try {
                        // @ts-ignore
                        const id =
                            e.target.closest(".owner-controls").dataset
                                .threadId;
                        await deleteDoc(doc(db, "foro_threads", id));
                        window.location.href = "/foro";
                    } catch (e) {
                        alert("Error al borrar");
                    }
                }
            });
        });

        document.querySelectorAll(".btn-edit").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                // @ts-ignore
                const id = e.target.closest(".owner-controls").dataset.threadId;
                window.location.href = `/foro/editar/${id}`;
            });
        });
    }); // End of astro:page-load
</script>
