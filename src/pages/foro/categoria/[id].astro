---
import Layout from "../../../layouts/Layout.astro";
import { db } from "../../../firebase/client";
import { collection, query, where, getDocs } from "firebase/firestore";

// Obtener ID de la categor√≠a de la URL
const { id } = Astro.params;

const CAT_DATA = {
    reglamentos: {
        title: "Reglamentos y Novedades",
        icon: "üì¢",
        color: "from-orange-500 to-red-500",
    },
    electricidad: {
        title: "Electricidad e Iluminaci√≥n",
        icon: "‚ö°",
        color: "from-yellow-500 to-orange-500",
    },
    plomeria: {
        title: "Plomer√≠a y Gas",
        icon: "üîß",
        color: "from-blue-500 to-cyan-500",
    },
    albanileria: {
        title: "Alba√±iler√≠a y Construcci√≥n",
        icon: "üß±",
        color: "from-red-600 to-orange-600",
    },
    "aire-acondicionado": {
        title: "Refrigeraci√≥n",
        icon: "‚ùÑÔ∏è",
        color: "from-cyan-400 to-blue-500",
    },
    herramientas: {
        title: "El Taller de Herramientas",
        icon: "üß∞",
        color: "from-slate-600 to-slate-800",
    },
    negocios: {
        title: "Presupuestos y Negocios",
        icon: "üí∞",
        color: "from-green-500 to-emerald-600",
    },
    ayuda: {
        title: "Mesa de Ayuda",
        icon: "üÜò",
        color: "from-purple-500 to-pink-500",
    },
    offtopic: {
        title: "El Bar de los Trabajadores",
        icon: "‚òï",
        color: "from-amber-600 to-orange-700",
    },
    "compra-venta": {
        title: "Clasificados",
        icon: "üí∏",
        color: "from-teal-500 to-cyan-600",
    },
    general: {
        title: "General / Presentaciones",
        icon: "üè†",
        color: "from-slate-500 to-gray-600",
    },
};

const category = CAT_DATA[id] || {
    title: "Foro",
    icon: "üìã",
    color: "from-slate-500 to-gray-600",
};

// Consultar Firebase
let threads = [];
let error = null;

try {
    const threadsRef = collection(db, "foro_threads");
    const q = query(threadsRef, where("category", "==", id));
    const snapshot = await getDocs(q);

    threads = snapshot.docs.map((doc) => {
        const data = doc.data();
        let dateStr = "Reciente";
        let timestamp = 0;

        if (data.createdAt && data.createdAt.toDate) {
            const date = data.createdAt.toDate();
            timestamp = date.getTime();
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const hours = Math.floor(diff / (1000 * 60 * 60));

            if (hours < 1) dateStr = "Hace menos de 1 hora";
            else if (hours < 24) dateStr = `Hace ${hours} horas`;
            else if (hours < 48) dateStr = "Ayer";
            else dateStr = date.toLocaleDateString();
        }

        return {
            id: doc.id,
            title: data.title,
            authorName: data.authorName || "Usuario",
            authorPhoto:
                data.authorPhoto ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(data.authorName || "U")}&background=FF5A5F&color=fff`,
            replyCount: data.replyCount || 0,
            views: data.views || 0,
            isOfficial: data.isOfficial || false,
            dateStr,
            timestamp,
        };
    });

    // Ordenar manualmente
    threads.sort((a, b) => b.timestamp - a.timestamp);
} catch (e) {
    console.error(e);
    error = "Error cargando los temas.";
}
---

<Layout title={`${category.title} - Foro DeOficios`}>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet"
    />

    <div class="bg-[#F8F9FA] min-h-screen font-sans">
        <!-- Hero con gradiente -->
        <section
            class={`bg-gradient-to-r ${category.color} text-white py-12 px-4 shadow-lg`}
        >
            <div class="max-w-6xl mx-auto">
                <a
                    href="/foro"
                    class="inline-flex items-center gap-2 text-white/80 hover:text-white mb-4 transition-colors"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Volver al foro
                </a>

                <div class="flex items-center gap-4">
                    <div
                        class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-4xl shadow-xl"
                    >
                        {category.icon}
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-serif font-bold">
                            {category.title}
                        </h1>
                        <p class="text-white/90 mt-2">
                            {threads.length} debate{threads.length !== 1 && "s"} en
                            esta categor√≠a
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <div class="max-w-6xl mx-auto px-4 py-8">
            <!-- Bot√≥n crear debate -->
            <div class="mb-6 flex justify-end">
                <a
                    href="/foro/crear-debate"
                    class="bg-[#FF5A5F] hover:bg-[#ff4146] text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-rose-200/50 transition-all hover:-translate-y-0.5 flex items-center gap-2"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"></path>
                    </svg>
                    Crear nuevo debate
                </a>
            </div>

            <!-- Lista de threads -->
            {
                error && (
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
                        <p class="text-red-600">{error}</p>
                    </div>
                )
            }

            {
                !error && threads.length === 0 && (
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-12 text-center">
                        <div class="text-6xl mb-4">üí¨</div>
                        <h3 class="text-xl font-bold text-slate-700 mb-2">
                            A√∫n no hay debates en esta categor√≠a
                        </h3>
                        <p class="text-slate-500 mb-6">
                            S√© el primero en iniciar una conversaci√≥n
                        </p>
                        <a
                            href="/foro/crear-debate"
                            class="inline-block bg-[#FF5A5F] hover:bg-[#ff4146] text-white font-bold px-6 py-3 rounded-xl transition-colors"
                        >
                            Crear primer debate
                        </a>
                    </div>
                )
            }

            {
                !error && threads.length > 0 && (
                    <div class="space-y-3">
                        {threads.map((thread) => (
                            <article
                                class={`bg-white rounded-xl shadow-sm border transition-all hover:shadow-md group ${thread.isOfficial ? "border-orange-200 bg-orange-50/30" : "border-slate-200 hover:border-slate-300"}`}
                            >
                                <a
                                    href={`/foro/${thread.id}`}
                                    class="block p-6"
                                >
                                    <div class="flex items-start gap-4">
                                        {/* Avatar */}
                                        <div class="flex-shrink-0 hidden sm:block">
                                            <img
                                                src={thread.authorPhoto}
                                                alt={thread.authorName}
                                                class="w-12 h-12 rounded-full border-2 border-white shadow-sm"
                                            />
                                        </div>

                                        {/* Contenido */}
                                        <div class="flex-1 min-w-0">
                                            {/* Badge oficial */}
                                            {thread.isOfficial && (
                                                <span class="inline-flex items-center gap-1 text-xs font-bold text-orange-700 bg-orange-100 px-2 py-1 rounded-full mb-2">
                                                    <svg
                                                        class="w-3 h-3"
                                                        fill="currentColor"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                    </svg>
                                                    OFICIAL
                                                </span>
                                            )}

                                            {/* T√≠tulo */}
                                            <h2
                                                class={`text-lg font-bold mb-2 group-hover:text-[#FF5A5F] transition-colors line-clamp-2 ${thread.isOfficial ? "text-orange-900" : "text-slate-800"}`}
                                            >
                                                {thread.title}
                                            </h2>

                                            {/* Metadata */}
                                            <div class="flex flex-wrap items-center gap-4 text-xs text-slate-500">
                                                <span class="flex items-center gap-1">
                                                    <svg
                                                        class="w-4 h-4"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                                        />
                                                    </svg>
                                                    <strong>
                                                        {thread.authorName}
                                                    </strong>
                                                </span>
                                                <span>‚Ä¢</span>
                                                <span>{thread.dateStr}</span>
                                                <span class="hidden sm:inline">
                                                    ‚Ä¢
                                                </span>
                                                <span class="hidden sm:flex items-center gap-1">
                                                    <svg
                                                        class="w-4 h-4"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                                        />
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                                        />
                                                    </svg>
                                                    {thread.views} vistas
                                                </span>
                                            </div>
                                        </div>

                                        {/* Stats */}
                                        <div class="hidden md:flex flex-col items-center gap-1 px-4 py-2 bg-slate-50 rounded-lg min-w-[80px]">
                                            <svg
                                                class="w-5 h-5 text-slate-400"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                                />
                                            </svg>
                                            <span class="text-lg font-bold text-slate-700">
                                                {thread.replyCount}
                                            </span>
                                            <span class="text-xs text-slate-500">
                                                respuestas
                                            </span>
                                        </div>
                                    </div>
                                </a>
                            </article>
                        ))}
                    </div>
                )
            }
        </div>
    </div>
</Layout>

<style>
    :global(body) {
        font-family: "Inter", sans-serif;
    }

    :global(.font-serif) {
        font-family: "DM Serif Display", serif;
    }
</style>
