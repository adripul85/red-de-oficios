---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Mis Favoritos - DeOficios">
  

  <main class="favs-container">
    <div class="container">
        
        <div class="header-section">
            <h1>Mis Favoritos ‚ù§Ô∏è</h1>
            <p>Tus profesionales guardados para contactar r√°pido.</p>
        </div>

        <div id="favs-grid" class="featured-grid">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Cargando tus guardados...</p>
            </div>
        </div>

        <div id="empty-state" class="hidden empty-box">
            <div class="icon">üíî</div>
            <h3>A√∫n no tienes favoritos</h3>
            <p>Navega por los perfiles y toca el coraz√≥n para guardarlos ac√°.</p>
            <a href="/resultados?q=todos" class="btn-explore">Explorar Profesionales</a>
        </div>
    </div>
  </main>

  
</Layout>

<script>
    import { db } from '../firebase/client';
    import { doc, getDoc } from 'firebase/firestore';

    const grid = document.getElementById('favs-grid');
    const emptyState = document.getElementById('empty-state');

    async function cargarFavoritos() {
        // 1. Leer del LocalStorage
        const favorites = JSON.parse(localStorage.getItem('my_favorites') || '[]');

        if (favorites.length === 0) {
            grid.style.display = 'none';
            emptyState.classList.remove('hidden');
            return;
        }

        // Limpiamos el loading
        grid.innerHTML = ''; 

        // 2. Buscar datos en Firebase uno por uno
        for (const id of favorites) {
            try {
                const docRef = doc(db, "profesionales", id);
                const snap = await getDoc(docRef);

                if (snap.exists()) {
                    const pro = snap.data();
                    const cardHTML = crearTarjetaHTML(id, pro);
                    grid.innerHTML += cardHTML;
                }
            } catch (error) {
                console.error("Error cargando favorito", id);
            }
        }
    }

    function crearTarjetaHTML(id, pro) {
        const foto = pro.foto || '';
        const inicial = pro.nombre ? pro.nombre[0] : 'U';
        const estrellas = '‚≠ê'.repeat(Math.round(pro.promedio || 0));
        const votos = pro.total_votos || 0;
        const esPremium = (pro.plan === 'mensual' || pro.plan === 'semestral');
        const verificado = pro.verificado ? '‚úÖ' : '';

        return `
            <a href="/perfil?id=${id}" class="pro-card animate-in">
              <div class="pro-image">
                ${foto 
                    ? `<img src="${foto}" alt="${pro.nombre}" />` 
                    : `<div class="placeholder">${inicial}</div>`
                }
                ${esPremium ? `<span class="badge-pro">PREMIUM</span>` : ''}
              </div>
              
              <div class="pro-info">
                <h3>${pro.nombre} ${verificado}</h3>
                <span class="category">${pro.categoria}</span>
                <p class="zona">üìç ${pro.zona || 'Buenos Aires'}</p>
                
                <div class="rating">
                  ${estrellas} <span class="num">(${votos})</span>
                </div>
                
                <button class="btn-remove" onclick="event.preventDefault(); window.borrarFav('${id}')">
                    üóëÔ∏è Quitar
                </button>
              </div>
            </a>
        `;
    }

    window.borrarFav = (id) => {
        if(!confirm("¬øQuitar de favoritos?")) return;
        let favorites = JSON.parse(localStorage.getItem('my_favorites') || '[]');
        favorites = favorites.filter(favId => favId !== id);
        localStorage.setItem('my_favorites', JSON.stringify(favorites));
        window.location.reload();
    };

    cargarFavoritos();
</script>

<style>
  /* ESTILOS ESTRUCTURALES (SCOPED) */
  .favs-container { min-height: 80vh; padding: 60px 20px; background: #f3f4f6; font-family: 'Segoe UI', system-ui, sans-serif; }
  .container { max-width: 1100px; margin: 0 auto; }
  
  .header-section { text-align: center; margin-bottom: 40px; }
  h1 { color: #1f2937; margin: 0 0 10px 0; font-size: 2.2rem; }
  p { color: #6b7280; font-size: 1.1rem; }

  .featured-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
      gap: 25px; 
  }
  
  .loading-state { grid-column: 1 / -1; text-align: center; padding: 40px; }
  .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #ea580c; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .empty-box { text-align: center; padding: 60px 20px; background: white; border-radius: 12px; border: 1px dashed #d1d5db; margin-top: 20px; }
  .empty-box .icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
  .btn-explore { display: inline-block; background: #ea580c; color: white; padding: 12px 30px; border-radius: 50px; text-decoration: none; font-weight: bold; margin-top: 20px; transition: 0.2s; box-shadow: 0 5px 15px rgba(234, 88, 12, 0.3); }
  .btn-explore:hover { transform: scale(1.05); background: #c2410c; }
  .hidden { display: none !important; }
</style>

<style is:global>
  .pro-card { 
      background: white; 
      border-radius: 12px; 
      overflow: hidden; 
      border: 1px solid #e5e7eb; 
      text-decoration: none; 
      color: inherit; 
      transition: 0.3s; 
      display: flex; 
      flex-direction: column; 
      position: relative; 
      height: 100%;
  }
  .pro-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: #fbbf24; }
  
  .pro-image { height: 200px; position: relative; background: #f3f4f6; }
  .pro-image img { width: 100%; height: 100%; object-fit: cover; }
  .pro-image .placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #cbd5e1; background: #e5e7eb; }
  
  .badge-pro { position: absolute; top: 10px; right: 10px; background: #fbbf24; color: #1f2937; font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  .pro-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
  .pro-info h3 { margin: 0 0 5px; font-size: 1.1rem; color: #1f2937; }
  .category { color: #e67e22; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; display: block; }
  .zona { font-size: 0.9rem; color: #6b7280; margin: 0 0 10px 0; }
  .rating { color: #fbbf24; font-weight: bold; margin-bottom: 15px; }
  .rating .num { color: #9ca3af; font-size: 0.8rem; font-weight: normal; }

  .btn-remove { 
      margin-top: auto; 
      width: 100%; 
      padding: 10px; 
      border: 1px solid #fee2e2; 
      background: #fff1f2; 
      color: #ef4444; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 0.9rem; 
      font-weight: 600;
      transition: 0.2s;
  }
  .btn-remove:hover { background: #ef4444; color: white; border-color: #ef4444; }

  .animate-in { animation: fadeIn 0.5s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>