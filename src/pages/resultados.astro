---
import Layout from "../layouts/Layout.astro";
import { db } from "../firebase/client";
import { collection, getDocs } from "firebase/firestore";

// 1. OBTENER PAR√ÅMETROS
const { searchParams } = Astro.url;
const q = searchParams.get("q") || "";

// 2. BUSCAR EN FIREBASE
const snapshot = await getDocs(collection(db, "profesionales"));
const todos = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));

// 3. FILTRADO DE TEXTO (L√ìGICA "TODOS")
const resultados = todos.filter((pro: any) => {
  const termino = q.toLowerCase().trim();

  // EXCLUIR STAFF
  const esStaff =
    pro.rol === "admin" || pro.rol === "moderador" || pro.rol === "moderator";
  if (esStaff) return false;

  if (termino === "" || termino === "todos") {
    return true;
  }

  const matchNombre = pro.nombre?.toLowerCase().includes(termino);
  const matchRubro = pro.rubro_principal?.toLowerCase().includes(termino);
  // B√∫squeda de zona: primero exacta, luego parcial solo si no hay match exacto
  const zonaLower = pro.zona?.toLowerCase() || "";
  const matchZonaExacta = zonaLower === termino;
  const matchZonaParcial = zonaLower.includes(termino) && termino.length > 3;
  const matchZona = matchZonaExacta || matchZonaParcial;

  const matchTags = pro.etiquetas?.some((t: string) =>
    t.toLowerCase().includes(termino),
  );

  return matchNombre || matchRubro || matchZona || matchTags;
});

// Ordenar: Premium primero (Experto > Impulso > Free)
const getPlanWeight = (plan: string) => {
  if (plan === "experto" || plan === "semestral") return 3;
  if (plan === "impulso" || plan === "mensual") return 2;
  return 1;
};

resultados.sort((a: any, b: any) => {
  const weightA = getPlanWeight(a.plan);
  const weightB = getPlanWeight(b.plan);
  return weightB - weightA;
});
---

<Layout title={`Resultados para "${q}" - DeOficios`}>
  <main class="results-container">
    <div class="search-header">
      <div class="container">
        <h1>
          {
            q === "" || q === "todos"
              ? "Todos los Profesionales"
              : `Resultados para "${q}"`
          }
        </h1>
        <p>
          <span id="count-display">{resultados.length}</span> profesionales encontrados.
        </p>

        <form action="/resultados" class="search-bar-mini">
          <input
            type="text"
            name="q"
            value={q === "todos" ? "" : q}
            placeholder="Buscar oficio, barrio o nombre..."
          />
          <button type="submit">üîç</button>
        </form>
      </div>
    </div>

    <div class="container grid-layout">
      <aside class="filters hidden-mobile">
        <div class="filter-sticky">
          <h3>Filtrar por:</h3>

          <div class="filter-group">
            <label class="checkbox-label">
              <input type="checkbox" id="check-verified" />
              <span>‚úÖ Verificados</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="check-24hs" />
              <span>üö® Urgencias 24hs</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="check-premium" />
              <span>‚≠ê Premium / Destacados</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="check-nearby" />
              <span>üìç M√°s cercanos a m√≠</span>
            </label>
          </div>

          <div class="banner-premium">
            <p><strong>¬øSos Profesional?</strong></p>
            <a href="/planes">Destacate aqu√≠ üöÄ</a>
          </div>
        </div>
      </aside>

      <div class="results-list" id="results-grid">
        {
          resultados.map((p: any) => (
            <a
              href={`/perfil?id=${p.id}`}
              class="card-professional-link"
              data-verified={p.verificado}
              data-24hs={p.es_24hs}
              data-24hs={p.es_24hs}
              data-premium={
                p.plan === "experto" ||
                p.plan === "semestral" ||
                p.plan === "impulso" ||
                p.plan === "mensual"
              }
              data-lat={p.ubicacion_exacta?.lat}
              data-lng={p.ubicacion_exacta?.lng}
            >
              <div class="card-professional">
                <div class="card-img-wrapper">
                  {p.foto && p.foto.startsWith("http") ? (
                    <img src={p.foto} alt={p.nombre} />
                  ) : (
                    <div
                      class="avatar-fallback"
                      style="background-color: #34495e;"
                    >
                      {p.nombre ? p.nombre[0].toUpperCase() : "U"}
                    </div>
                  )}

                  {(p.plan === "experto" || p.plan === "semestral") && (
                    <span
                      class="badge-premium"
                      style="background: #f1c40f; color: #3e2723;"
                    >
                      ‚ö° EXPERTO
                    </span>
                  )}
                  {(p.plan === "impulso" || p.plan === "mensual") && (
                    <span
                      class="badge-premium"
                      style="background: #3b82f6; color: white;"
                    >
                      üíé IMPULSO
                    </span>
                  )}
                </div>
                <div class="card-body">
                  <small class="category-text">
                    {p.rubro_principal || p.categoria}
                  </small>
                  <h2>
                    {p.nombre} {p.verificado && "‚úÖ"}
                  </h2>
                  <div class="location-row">
                    <span>üìç {p.zona}</span>
                  </div>
                  <p class="desc-preview">
                    {p.descripcion_servicio ||
                      p.descripcion ||
                      "Sin descripci√≥n disponible."}
                  </p>

                  <div class="tags-row">
                    {p.es_24hs && <span class="tag-urgency">üö® 24hs</span>}
                    {Array.isArray(p.etiquetas) &&
                      p.etiquetas
                        .slice(0, 2)
                        .map((t: string) => <span class="tag">{t}</span>)}
                  </div>

                  <span class="btn-contact">Ver Perfil</span>
                </div>
              </div>
            </a>
          ))
        }

        {
          resultados.length === 0 && (
            <div class="no-results">
              <h3>No encontramos nada üòî</h3>
              <p>Intenta buscando "todos" o cambiando los t√©rminos.</p>
            </div>
          )
        }
      </div>
    </div>
  </main>
</Layout>

<script>
  // CLIENT SIDE FILTERING & SORTING LOGIC
  const checkVerified = document.getElementById("check-verified");
  const check24hs = document.getElementById("check-24hs");
  const checkPremium = document.getElementById("check-premium");
  const checkNearby = document.getElementById("check-nearby");
  const grid = document.getElementById("results-grid");
  const countDisplay = document.getElementById("count-display");

  // @ts-ignore
  const cards = Array.from(
    document.querySelectorAll(".card-professional-link"),
  );

  // Funci√≥n para filtrar
  function aplicarFiltros() {
    let visibles = 0;
    cards.forEach((card: any) => {
      const isVerified =
        card.getAttribute("data-verified") !== "false" &&
        card.getAttribute("data-verified") !== null;
      const is24hs =
        card.getAttribute("data-24hs") !== "false" &&
        card.getAttribute("data-24hs") !== null;
      const isPremium = card.getAttribute("data-premium") === "true";

      let show = true;

      if ((checkVerified as HTMLInputElement).checked && !isVerified)
        show = false;
      if ((check24hs as HTMLInputElement).checked && !is24hs) show = false;
      if ((checkPremium as HTMLInputElement).checked && !isPremium)
        show = false;

      if (show) {
        card.style.display = "block"; // Asegurar que sea visible
        visibles++;
      } else {
        card.style.display = "none";
      }
    });
    if (countDisplay) countDisplay.textContent = String(visibles);
  }

  // Event Listeners Filtros
  checkVerified?.addEventListener("change", aplicarFiltros);
  check24hs?.addEventListener("change", aplicarFiltros);
  checkPremium?.addEventListener("change", aplicarFiltros);

  // --- L√ìGICA DE GEOLOCALIZACI√ìN ---

  // F√≥rmula de Haversine para distancia en KM
  function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radio de la tierra en km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(deg2rad(lat1)) *
        Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; // Distancia en km
    return d;
  }

  function deg2rad(deg) {
    return deg * (Math.PI / 180);
  }

  checkNearby?.addEventListener("change", async () => {
    const checkbox = checkNearby as HTMLInputElement;
    if (!checkbox.checked) {
      // Si desmarca, recargamos para volver al orden original (m√°s f√°cil)
      window.location.reload();
      return;
    }

    if (!navigator.geolocation) {
      alert("Tu navegador no soporta geolocalizaci√≥n.");
      checkbox.checked = false;
      return;
    }

    // Pedir ubicaci√≥n
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        // Ordenar tarjetas
        cards.sort((a: any, b: any) => {
          const latA = parseFloat(a.getAttribute("data-lat"));
          const lngA = parseFloat(a.getAttribute("data-lng"));
          const latB = parseFloat(b.getAttribute("data-lat"));
          const lngB = parseFloat(b.getAttribute("data-lng"));

          // Si no tiene ubicaci√≥n, lo mandamos al fondo
          if (isNaN(latA)) return 1;
          if (isNaN(latB)) return -1;

          const distA = getDistanceFromLatLonInKm(userLat, userLng, latA, lngA);
          const distB = getDistanceFromLatLonInKm(userLat, userLng, latB, lngB);

          return distA - distB;
        });

        // Re-insertar en el DOM ordenados
        const container = document.getElementById("results-grid");
        if (container) {
          container.innerHTML = ""; // Limpiar
          cards.forEach((card) => container.appendChild(card as Node));
        }

        aplicarFiltros(); // Re-aplicar filtros si hab√≠a alguno
      },
      (error) => {
        console.error(error);
        alert(
          "No pudimos obtener tu ubicaci√≥n. Aseg√∫rate de permitir el acceso.",
        );
        checkbox.checked = false;
      },
    );
  });
</script>

<style>
  .results-container {
    background: #f8f9fa;
    min-height: 80vh;
    padding-bottom: 60px;
    font-family: "Segoe UI", system-ui, sans-serif;
  }
  .search-header {
    background: #2c3e50;
    color: white;
    padding: 40px 0;
    text-align: center;
  }
  .search-header h1 {
    margin: 0 0 10px;
  }
  .search-bar-mini {
    margin-top: 20px;
    display: inline-flex;
    background: white;
    padding: 5px;
    border-radius: 50px;
    overflow: hidden;
  }
  .search-bar-mini input {
    border: none;
    padding: 10px 20px;
    outline: none;
    width: 250px;
    color: #333; /* ‚úÖ COLOR DE TEXTO ARREGLADO */
  }
  .search-bar-mini button {
    background: #e67e22;
    border: none;
    padding: 10px 20px;
    color: white;
    font-weight: bold;
    border-radius: 50px;
    cursor: pointer;
  }

  /* LAYOUT */
  .grid-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 30px;
    margin-top: 40px;
  }

  /* FILTERS */
  .filter-sticky {
    background: white;
    padding: 20px;
    border-radius: 12px;
    position: sticky;
    top: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
  }
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 0.95rem;
    color: #34495e;
  }
  .banner-premium {
    margin-top: 30px;
    background: #fef3c7;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #fcd34d;
  }
  .banner-premium a {
    color: #d97706;
    font-weight: bold;
    text-decoration: none;
  }

  /* CARDS */
  .results-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .card-professional-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .card-professional {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition:
      transform 0.2s,
      box-shadow 0.2s;
    border: 1px solid #eee;
  }
  .card-professional-link:hover .card-professional {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    border-color: #e67e22;
  }

  .card-img-wrapper {
    width: 150px;
    background: #ecf0f1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-img-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-fallback {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
    font-weight: bold;
  }

  .badge-premium {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #f1c40f;
    color: #2c3e50;
    font-weight: 800;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .card-body {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }
  .category-text {
    color: #e67e22;
    text-transform: uppercase;
    font-weight: bold;
    font-size: 0.8rem;
    letter-spacing: 0.5px;
  }
  .card-body h2 {
    margin: 5px 0;
    font-size: 1.3rem;
    color: #2c3e50;
  }
  .location-row {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-bottom: 10px;
  }
  .desc-preview {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 15px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tags-row {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
  }
  .tag {
    background: #f3f4f6;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #666;
  }
  .tag-urgency {
    background: #fee2e2;
    color: #c0392b;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
  }

  .btn-contact {
    align-self: flex-start;
    background: #e67e22;
    color: white;
    padding: 8px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    transition: 0.2s;
  }
  .btn-contact:hover {
    background: #d35400;
  }

  .no-results {
    text-align: center;
    padding: 40px;
    color: #7f8c8d;
  }

  /* MOBILE */
  @media (max-width: 768px) {
    .grid-layout {
      grid-template-columns: 1fr;
    }
    .hidden-mobile {
      display: none;
    } /* Ocultamos filtros en mobile por ahora */
    .card-professional {
      flex-direction: column;
    }
    .card-img-wrapper {
      width: 100%;
      height: 180px;
    }
  }
</style>
