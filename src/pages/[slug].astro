---
import Layout from "../layouts/Layout.astro";
// Aseg√∫rate de que la extensi√≥n sea correcta (.jsx o .tsx si es React)
import PortfolioGallery from "../components/PortfolioGallery"; 
import { db } from "../firebase/client";
import {
    collection,
    query,
    where,
    getDocs,
    limit,
    doc,
    updateDoc,
    increment,
    addDoc,
    serverTimestamp
} from "firebase/firestore";

// 1. OBTENER EL SLUG
const { slug } = Astro.params;

if (!slug) return Astro.redirect("/");

// 2. BUSCAR PROFESIONAL
const prosRef = collection(db, "profesionales");
const q = query(prosRef, where("slug", "==", slug), limit(1));
const snapshot = await getDocs(q);

if (snapshot.empty) {
    return Astro.redirect("/404");
}

const docSnap = snapshot.docs[0];
const p = docSnap.data();
const id = docSnap.id;

// 3. MODO LANDING Y PRIVACIDAD
const isLandingMode = (p.plan === "experto" || p.plan === "semestral") && p.modo_landing === true;

// Bloquear Staff (DESHABILITADO PARA QUE PUEDAS VER TU PERFIL)
/* const rol = (p.rol || "profesional").toLowerCase();
if (["admin", "moderador"].includes(rol)) return Astro.redirect("/404");
*/

// 4. DATOS
const nombre = p.nombre || "Profesional";
const rubro = p.rubro_principal || "Servicios";
const foto = p.foto || "";
const desc = p.descripcion || "";
const telefono = p.celular || p.telefono || "";
const portfolio = p.portfolio || [];
const matricula = p.numero_matricula || "";
const zona = p.zona || "Buenos Aires";
const instagram = p.instagram || "";
const website = p.website || "";

// Link WhatsApp
const cleanPhone = telefono.replace(/\D/g, "");
const waLink = `https://wa.me/549${cleanPhone.replace(/^0/, "")}?text=Hola, vi tu web personal y quiero consultarte...`;
const mapaLink = p.ubicacion_exacta 
    ? `http://googleusercontent.com/maps.google.com/?q=${p.ubicacion_exacta.lat},${p.ubicacion_exacta.lng}` 
    : "#";

// Rese√±as (Solo para mostrar cantidad, en modo landing no mostramos el detalle completo por limpieza)
const votos = p.total_votos || 0;
const promedio = p.promedio || 0;
---

{
    isLandingMode && (
        <style is:global>
            nav, header.main-header, footer, .top-bar { display: none !important; }
            body { background-color: #f3f4f6; margin: 0; }
            .profile-container { padding-top: 0 !important; }
        </style>
    )
}

<Layout title={`${nombre} - ${rubro}`}>
    {isLandingMode && (
        <a href="/" class="powered-by">
            Powered by <strong>DeOficios</strong> ‚ú®
        </a>
    )}

    <div class="bento-wrapper" id="landing-main-container" data-profile-id={id}>
        <div class="bento-card">
            
            <!-- Header Minimalista -->
            <header class="bento-header">
                <div class="header-tag">{rubro}</div>
                <div class="header-content">
                    <div class="name-section">
                        <h1 class="pro-name">{nombre}</h1>
                        {p.nombre_fantasia && <p class="fantasy-name">{p.nombre_fantasia}</p>}
                    </div>
                    <div class="avatar-bento">
                        {foto ? <img src={foto} alt={nombre} /> : <div class="avatar-fallback">{nombre[0]}</div>}
                    </div>
                </div>
            </header>

            <!-- About Section -->
            <section class="bento-section about-section">
                <p class="description">{desc || `Profesional ${rubro.toLowerCase()} verificado en la red de oficios.`}</p>
                
                {(votos > 0) && (
                    <div class="rating-compact">
                        <span class="rating-stars">{"‚≠ê".repeat(Math.round(promedio))}</span>
                        <span class="rating-text">{promedio.toFixed(1)} ({votos} opiniones)</span>
                    </div>
                )}

                <div class="location-badge">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    {zona} {matricula && `‚Ä¢ Mat. ${matricula}`}
                </div>
            </section>

            <!-- Social Icons -->
            {(instagram || website || p.ubicacion_exacta) && (
                <section class="bento-section social-icons">
                    {instagram && (
                        <a href={`https://instagram.com/${instagram.replace("@", "")}`} target="_blank" class="icon-button" title="Instagram">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    )}
                    {website && (
                        <a href={website} target="_blank" class="icon-button" title="Sitio Web">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                        </a>
                    )}
                    {p.ubicacion_exacta && (
                        <a href={mapaLink} target="_blank" class="icon-button" title="Ver Ubicaci√≥n">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                        </a>
                    )}
                </section>
            )}

            <!-- CTA WhatsApp -->
            {telefono && (
                <section class="bento-section">
                    <a href={waLink} target="_blank" class="link-button whatsapp-link" id="btn-whatsapp-track">
                        <span>Contactar por WhatsApp</span>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </a>
                </section>
            )}

            <!-- Services Grid (si hay servicios) -->
            {p.presupuestos_config?.servicios && p.presupuestos_config.servicios.length > 0 && (
                <section class="bento-section">
                    <h3 class="section-title">Servicios</h3>
                    <div class="services-grid">
                        {p.presupuestos_config.servicios.slice(0, 4).map((servicio: any) => (
                            <div class="service-card">
                                <div class="service-name">{servicio.nombre}</div>
                                <div class="service-price">${servicio.min} - ${servicio.max}</div>
                            </div>
                        ))}
                    </div>
                </section>
            )}

            <!-- Portfolio Gallery -->
            {portfolio.length > 0 && (
                <section class="bento-section">
                    <h3 class="section-title">Trabajos</h3>
                    <div class="portfolio-grid">
                        {portfolio.slice(0, 4).map((img: string) => (
                            <a href={img} target="_blank" class="portfolio-item">
                                <img src={img} loading="lazy" alt="Trabajo" />
                            </a>
                        ))}
                    </div>
                </section>
            )}

            <!-- Ver Perfil Completo -->
            <section class="bento-section">
                <a href={`/perfil?id=${id}`} class="link-button profile-link">
                    <span>Ver Perfil Completo</span>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                        <polyline points="12 5 19 12 12 19"/>
                    </svg>
                </a>
            </section>

        </div>
    </div>
</Layout>

<script>
    import { db } from "../firebase/client";
    import { doc, updateDoc, increment } from "firebase/firestore";

    // üî• SOLUCI√ìN JS: Usar astro:page-load y leer ID del DOM
    document.addEventListener("astro:page-load", () => {
        const container = document.getElementById("landing-main-container");
        if (!container) return;
        
        // LEER ID DE FORMA SEGURA SIN ROMPER MODULOS
        const profileId = container.dataset.profileId; 
        if(!profileId) return;

        // 1. Contador de Vistas
        const yaVisto = sessionStorage.getItem(`visto_landing_${profileId}`);
        if (!yaVisto) {
            try {
                const profRef = doc(db, "profesionales", profileId);
                updateDoc(profRef, { vistas_perfil: increment(1) });
                sessionStorage.setItem(`visto_landing_${profileId}`, "true");
            } catch (e) {
                console.error("Error vista landing", e);
            }
        }

        // 2. Click WhatsApp Tracking
        const btnWa = document.getElementById("btn-whatsapp-track");
        if (btnWa) {
            btnWa.addEventListener("click", () => {
                try {
                    const profRef = doc(db, "profesionales", profileId);
                    updateDoc(profRef, { contactos_whatsapp: increment(1) });
                } catch (e) {}
            });
        }
    });
</script>

<style>
    /* BENTO CARD DESIGN - Estilo Limpio y Minimalista */
    
    .bento-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(135deg, #ebe8e3 0%, #d4cfc7 100%);
    }

    .bento-card {
        width: 100%;
        max-width: 420px;
        background: #f5f3f0;
        border-radius: 28px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* HEADER MINIMALISTA */
    .bento-header {
        background: white;
        padding: 30px 24px 24px;
        border-bottom: 1px solid #e7e4e0;
    }

    .header-tag {
        display: inline-block;
        background: #2d2d2d;
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        padding: 4px 12px;
        border-radius: 20px;
        margin-bottom: 16px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
    }

    .name-section {
        flex: 1;
    }

    .pro-name {
        font-size: 1.9rem;
        font-weight: 800;
        color: #1a1a1a;
        margin: 0 0 4px 0;
        line-height: 1.1;
        letter-spacing: -0.5px;
    }

    .fantasy-name {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
        font-weight: 400;
    }

    /* AVATAR CIRCULAR */
    .avatar-bento {
        width: 88px;
        height: 88px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: linear-gradient(135deg, #e8d5c4, #d4bfae);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .avatar-bento img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
    }

    /* SECCIONES */
    .bento-section {
        background: white;
        padding: 22px 24px;
        border-bottom: 1px solid #e7e4e0;
    }

    .bento-section:last-child {
        border-bottom: none;
    }

    /* ABOUT SECTION */
    .about-section .description {
        color: #444;
        line-height: 1.65;
        font-size: 0.92rem;
        margin: 0 0 14px 0;
    }

    .rating-compact {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #fef9f5;
        padding: 6px 12px;
        border-radius: 20px;
        margin-bottom: 12px;
    }

    .rating-stars {
        font-size: 0.85rem;
        line-height: 1;
    }

    .rating-text {
        font-size: 0.8rem;
        color: #666;
        font-weight: 600;
    }

    .location-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #555;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .location-badge svg {
        opacity: 0.6;
    }

    /* SOCIAL ICONS */
    .social-icons {
        display: flex;
        gap: 10px;
        padding: 18px 24px;
    }

    .icon-button {
        width: 44px;
        height: 44px;
        background: #f5f3f0;
        border: 1.5px solid #ddd;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .icon-button svg {
        width: 20px;
        height: 20px;
        color: #333;
    }

    .icon-button:hover {
        background: #2d2d2d;
        border-color: #2d2d2d;
        transform: translateY(-2px);
    }

    .icon-button:hover svg {
        color: white;
    }

    /* LINK BUTTONS */
    .link-button {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        background: #f5f3f0;
        border: 1.5px solid #ddd;
        padding: 14px 18px;
        border-radius: 12px;
        text-decoration: none;
        color: #1a1a1a;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .link-button:hover {
        background: #2d2d2d;
        border-color: #2d2d2d;
        color: white;
        transform: translateX(2px);
    }

    .link-button svg {
        transition: transform 0.2s ease;
    }

    .link-button:hover svg {
        transform: translateX(3px);
    }

    .whatsapp-link {
        background: #25d366;
        border-color: #25d366;
        color: white;
    }

    .whatsapp-link:hover {
        background: #1faa52;
        border-color: #1faa52;
    }

    .profile-link {
        background: white;
        border: 1.5px solid #2d2d2d;
    }

    /* SECTION TITLE */
    .section-title {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: #999;
        margin: 0 0 14px 0;
    }

    /* SERVICES GRID */
    .services-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .service-card {
        background: #f5f3f0;
        border: 1.5px solid #e0ddd8;
        padding: 16px 14px;
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .service-card:hover {
        border-color: #2d2d2d;
        transform: translateY(-2px);
    }

    .service-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 6px;
    }

    .service-price {
        font-size: 0.75rem;
        color: #666;
        font-weight: 500;
    }

    /* PORTFOLIO GRID */
    .portfolio-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .portfolio-item {
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        display: block;
        position: relative;
        background: #e7e4e0;
    }

    .portfolio-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .portfolio-item:hover img {
        transform: scale(1.05);
    }

    /* POWERED BY */
    .powered-by {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: rgba(45, 45, 45, 0.95);
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.75rem;
        text-decoration: none;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .powered-by:hover {
        background: rgba(59, 130, 246, 0.95);
        transform: scale(1.05);
    }

    .powered-by strong {
        font-weight: 700;
    }

    /* RESPONSIVE */
    @media (max-width: 480px) {
        .bento-wrapper {
            padding: 12px;
        }

        .bento-card {
            max-width: 100%;
            border-radius: 24px;
        }

        .pro-name {
            font-size: 1.6rem;
        }

        .avatar-bento {
            width: 72px;
            height: 72px;
        }

        .services-grid {
            grid-template-columns: 1fr;
        }

        .portfolio-grid {
            grid-template-columns: 1fr;
        }
    }
</style>