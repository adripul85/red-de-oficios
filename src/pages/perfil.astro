---
import Layout from "../layouts/Layout.astro";
import { db } from "../firebase/client";
import { doc, getDoc, updateDoc, increment } from "firebase/firestore";

const id = Astro.url.searchParams.get("id");
let profesional = null;
let idProfesional = null;

if (id) {
    try {
        const docRef = doc(db, "profesionales", id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            profesional = docSnap.data();
            idProfesional = docSnap.id;
        }
    } catch (e) {
        console.error("Error:", e);
    }
}

if (!profesional) return Astro.redirect("/");

// SI TIENE SLUG, REDIRECCIONAR A LA URL LIMPIA
if (profesional.slug) {
    return Astro.redirect(`/${profesional.slug}`);
}

// --- ELIMINADO: Bloqueo de perfiles gratuitos ---
// Los perfiles FREE ahora son p√∫blicos
// const planActual = profesional.plan || "gratuito";
// if (planActual === "semilla" || planActual === "gratuito" || planActual === "prueba_gratis") {
//     return Astro.redirect("/?error=perfil_privado");
// }
// -----------------------------------------------------

// --- L√ìGICA DE VISUALIZACI√ìN ---
const esExperto =
    profesional.plan === "experto" || profesional.plan === "semestral";
const mostrarComoLanding = esExperto && profesional.web_propia;
const promedio = profesional.promedio || 0;
const votos = profesional.total_votos || 0;
const ubicacion = profesional.zona || "Argentina";

const portfolioJson = JSON.stringify(profesional.portfolio || []);
const serviciosJson = JSON.stringify(profesional.servicios_lista || []);

const seoTitle = profesional.seo_nombre || `${profesional.nombre} | DeOficios`;
const seoDescription =
    profesional.seo_profesion ||
    `Contacta a ${profesional.nombre}, ${profesional.rubro_principal} en ${ubicacion}. Ver perfil, fotos y opiniones.`;
const serviceIcons: Record<string, string> = {
    "Aire Acondicionado": "‚ùÑÔ∏è",
    Electricidad: "‚ö°",
    Electricista: "‚ö°",
    Gasista: "üî•",
    Plomero: "üö∞",
    Plomer√≠a: "üö∞",
    Pintor: "üé®",
    Alba√±il: "üß±",
    Construcci√≥n: "üèóÔ∏è",
    Flete: "üöö",
    Mudanza: "üì¶",
    Jardiner√≠a: "üåø",
    Limpieza: "üßπ",
    Carpintero: "ü™ö",
    Herrero: "‚öîÔ∏è",
    Mec√°nico: "üîß",
    Cerrajero: "üîë",
    Techista: "üè†",
    Durlock: "üèóÔ∏è",
};

const getServiceIcon = (serviceName: any) => {
    if (!serviceName || typeof serviceName !== "string") return "üõ†Ô∏è";
    // Buscar coincidencia parcial
    const lowerName = serviceName.toLowerCase();
    for (const key in serviceIcons) {
        if (lowerName.includes(key.toLowerCase())) {
            return serviceIcons[key];
        }
    }
    return "üõ†Ô∏è"; // Icono por defecto
};

const mappedServices = (profesional.servicios_lista || [])
    .filter((s: any) => s && typeof s === "string")
    .slice(0, 4)
    .map((s: string) => ({
        label: s,
        icon: getServiceIcon(s),
    }));

import ModernProfileCard from "../components/ModernProfileCard.astro";
---

<Layout
    title={seoTitle}
    description={seoDescription}
    hideHeader={mostrarComoLanding}
    hideFooter={mostrarComoLanding}
    hideIA={mostrarComoLanding}
>
    <script
        is:inline
        src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    ></script>

    {
        mostrarComoLanding ? (
            /* MODO LANDING NUEVO */
            <div class="landing-body font-sans min-h-screen bg-slate-100 flex items-center justify-center py-10 px-4 overflow-x-hidden">
                <ModernProfileCard
                    name={profesional.nombre}
                    role={
                        profesional.seo_profesion || profesional.rubro_principal
                    }
                    avatar={profesional.foto}
                    location={ubicacion}
                    rating={promedio.toFixed(1)}
                    priceInfo={
                        profesional.presupuestos_config?.activo
                            ? "Presupuestos sin cargo"
                            : "Consultar precio"
                    }
                    services={mappedServices}
                    bio={profesional.descripcion}
                    experience={profesional.experiencia}
                    category={profesional.rubro_principal}
                    whatsappUrl={`https://wa.me/549${profesional.telefono}?text=Hola, vi tu perfil en Red de Oficio y quer√≠a hacerte una consulta.`}
                />
            </div>
        ) : (
            /* MODO DIRECTORIO */
            <div
                id="profile-directory"
                data-id={idProfesional}
                class="min-h-screen bg-gray-50 pb-20"
            >
                <div class="bg-white border-b shadow-sm">
                    <div class="container mx-auto px-4 py-8 max-w-6xl">
                        <div class="flex flex-col md:flex-row items-center gap-8">
                            <div class="relative">
                                <img
                                    src={
                                        profesional.foto ||
                                        `https://ui-avatars.com/api/?name=${profesional.nombre}`
                                    }
                                    class="w-36 h-36 rounded-full object-cover border-4 border-white shadow-lg"
                                />
                                {esExperto && (
                                    <span class="absolute bottom-1 right-1 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded shadow-md border border-white">
                                        ‚ö° EXPERTO
                                    </span>
                                )}
                            </div>
                            <div class="text-center md:text-left flex-1">
                                <div class="flex items-center justify-center md:justify-start gap-2 mb-2">
                                    <h1 class="text-3xl font-bold text-gray-900">
                                        {profesional.nombre}
                                    </h1>
                                    {profesional.verificado && (
                                        <span
                                            class="text-blue-500 text-xl"
                                            title="Verificado"
                                        >
                                            ‚úÖ
                                        </span>
                                    )}
                                    <button
                                        id="btn-fav"
                                        class="text-2xl text-gray-300 hover:text-red-500 transition ml-2 focus:outline-none"
                                    >
                                        ‚ô•
                                    </button>
                                </div>
                                <p class="text-xl text-gray-600 mb-3">
                                    {profesional.seo_profesion ||
                                        profesional.rubro_principal}{" "}
                                    en{" "}
                                    <span class="font-bold text-gray-800">
                                        {ubicacion}
                                    </span>
                                </p>

                                <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-4">
                                    <span class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-bold border border-green-200">
                                        üü¢ En l√≠nea
                                    </span>
                                    {profesional.es_24hs && (
                                        <span class="bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full font-bold border border-red-200">
                                            üö® 24hs
                                        </span>
                                    )}
                                    {profesional.matricula && (
                                        <span class="bg-blue-50 text-blue-800 text-xs px-3 py-1 rounded-full font-bold border border-blue-200">
                                            üéì Mat.: {profesional.matricula}
                                        </span>
                                    )}
                                    {promedio >= 4.5 && (
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-full font-bold border border-yellow-200">
                                            üèÜ Top
                                        </span>
                                    )}
                                </div>

                                <div class="flex items-center justify-center md:justify-start gap-4">
                                    <div class="bg-gray-100 px-4 py-2 rounded-lg flex items-center gap-2">
                                        <span class="text-yellow-500 font-bold text-xl">
                                            ‚òÖ {promedio.toFixed(1)}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            ({votos} op.)
                                        </span>
                                    </div>
                                    <button
                                        onclick="document.getElementById('reviews-section').scrollIntoView({behavior: 'smooth'})"
                                        class="text-orange-600 font-bold text-sm hover:underline"
                                    >
                                        Leer Opiniones
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <main class="container mx-auto px-4 py-8 max-w-6xl grid md:grid-cols-3 gap-8">
                    <div class="md:col-span-2 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">
                                Sobre m√≠
                            </h3>
                            <p class="text-gray-600 whitespace-pre-line leading-relaxed mb-6">
                                {profesional.descripcion ||
                                    "Sin descripci√≥n detallada."}
                            </p>

                            <div class="border-t pt-4">
                                <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">
                                    Informaci√≥n de Contrataci√≥n
                                </h4>
                                <div class="flex flex-wrap gap-3">
                                    {profesional.emite_factura ? (
                                        <span class="flex items-center gap-1 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100">
                                            üßæ Emite Factura
                                        </span>
                                    ) : (
                                        <span class="text-xs text-gray-400 px-2 py-1">
                                            No factura
                                        </span>
                                    )}
                                    {profesional.formas_pago?.map((p) => (
                                        <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-medium border border-gray-200">
                                            üí≥ {p}
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                {profesional.etiquetas?.map((t) => (
                                    <span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-500 font-medium">
                                        #{t}
                                    </span>
                                ))}
                            </div>
                        </div>

                        {profesional.portfolio && (
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="font-bold text-lg mb-4 text-gray-800">
                                    üì∏ Trabajos Realizados
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {profesional.portfolio.map((img, index) => (
                                        <img
                                            src={img}
                                            class="aspect-square object-cover rounded-lg bg-gray-100 cursor-pointer hover:opacity-90 transition open-lightbox"
                                            data-index={index}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        <div
                            id="reviews-section"
                            class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"
                        >
                            <h3 class="font-bold text-lg mb-6 text-gray-800">
                                Opiniones de Clientes
                            </h3>
                            <div
                                id="review-action-box"
                                class="bg-blue-50 p-6 rounded-xl text-center mb-6 border border-blue-100"
                            >
                                <div id="guest-view">
                                    <p class="text-blue-900 font-bold mb-2">
                                        ¬øLo contrataste?
                                    </p>
                                    <a
                                        href={`/ingresar-cliente?returnUrl=/perfil?id=${idProfesional}`}
                                        class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition inline-block"
                                    >
                                        üîí Iniciar Sesi√≥n para Opinar
                                    </a>
                                </div>
                                <div id="user-view" class="hidden text-left">
                                    <div class="flex items-center gap-2 mb-3">
                                        <img
                                            id="user-avatar"
                                            class="w-8 h-8 rounded-full bg-white border"
                                        />
                                        <div>
                                            <>
                                                <p
                                                    id="user-name"
                                                    class="font-bold text-sm text-gray-900"
                                                >
                                                    Usuario
                                                </p>
                                                <p class="text-xs text-green-600 font-bold">
                                                    Verificado ‚úÖ
                                                </p>
                                            </>
                                        </div>
                                    </div>
                                    <div
                                        class="flex gap-2 text-2xl mb-3 cursor-pointer"
                                        id="stars-selector"
                                    >
                                        <>
                                            <span
                                                data-v="1"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ‚òÖ
                                            </span>
                                            <span
                                                data-v="2"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ‚òÖ
                                            </span>
                                            <span
                                                data-v="3"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ‚òÖ
                                            </span>
                                            <span
                                                data-v="4"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ‚òÖ
                                            </span>
                                            <span
                                                data-v="5"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ‚òÖ
                                            </span>
                                        </>
                                    </div>
                                    <input
                                        type="hidden"
                                        id="rating-val"
                                        value="0"
                                    />
                                    <textarea
                                        id="review-text"
                                        class="w-full p-3 rounded border border-gray-300 mb-3 bg-white"
                                        placeholder="Cu√©ntanos tu experiencia..."
                                    />
                                    <button
                                        id="btn-send-review"
                                        class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition w-full md:w-auto"
                                    >
                                        Publicar Rese√±a
                                    </button>
                                </div>
                            </div>
                            <div id="reviews-list" class="space-y-4" />
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 sticky top-24">
                            <div class="text-center mb-6">
                                <p class="text-gray-500 text-sm">Contactar a</p>
                                <h2 class="text-xl font-bold text-gray-900">
                                    {profesional.nombre}
                                </h2>
                                <p class="text-sm font-medium text-green-600 mt-1">
                                    ‚ö° Respuesta R√°pida
                                </p>
                            </div>

                            {profesional.telefono ? (
                                <a
                                    href={`https://wa.me/549${profesional.telefono}`}
                                    target="_blank"
                                    class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl text-center shadow-md transition transform hover:scale-105 flex items-center justify-center gap-2 mb-3"
                                    onclick="trackClick()"
                                >
                                    <span class="text-xl">üí¨</span> WhatsApp
                                </a>
                            ) : (
                                <button
                                    disabled
                                    class="w-full bg-gray-200 py-3 rounded-xl font-bold text-gray-400 mb-3"
                                >
                                    Sin WhatsApp
                                </button>
                            )}

                            {profesional.servicios_lista?.length > 0 && (
                                <button
                                    id="btn-generate-pdf-sidebar"
                                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-200 transition transform hover:-translate-y-1 flex items-center justify-center gap-2"
                                >
                                    <span>üìÑ</span> Ver Presupuestos
                                </button>
                            )}

                            {profesional.ubicacion_exacta?.activo &&
                                profesional.ubicacion_exacta?.lat && (
                                    <div class="mt-4 pt-4 border-t border-gray-100">
                                        <p class="font-bold text-sm mb-2 text-gray-700">
                                            üìç Zona de Trabajo
                                        </p>
                                        <div
                                            id="mini-map"
                                            class="w-full h-40 bg-gray-200 rounded-lg overflow-hidden border border-gray-200"
                                            data-lat={
                                                profesional.ubicacion_exacta.lat
                                            }
                                            data-lng={
                                                profesional.ubicacion_exacta.lng
                                            }
                                        />
                                        <p class="text-xs text-gray-500 mt-2 text-center">
                                            {ubicacion}
                                        </p>
                                    </div>
                                )}
                        </div>
                    </div>
                </main>
            </div>
        )
    }

    <div
        id="lightbox"
        class="fixed inset-0 bg-black bg-opacity-95 z-[9999] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm"
    >
        <button
            id="close-lightbox"
            class="absolute top-5 right-5 text-white text-4xl font-bold hover:text-gray-300 focus:outline-none z-50"
            >√ó</button
        >
        <div
            class="relative w-full max-w-4xl h-[70vh] flex items-center justify-center"
        >
            <button
                id="prev-img"
                class="absolute left-2 text-white text-5xl hover:text-orange-500 transition opacity-70 hover:opacity-100 drop-shadow-lg"
                >‚Äπ</button
            >
            <img
                id="lightbox-img"
                src=""
                class="max-w-full max-h-full rounded shadow-2xl object-contain"
            />
            <button
                id="next-img"
                class="absolute right-2 text-white text-5xl hover:text-orange-500 transition opacity-70 hover:opacity-100 drop-shadow-lg"
                >‚Ä∫</button
            >
        </div>
        <div
            class="mt-4 w-full max-w-4xl overflow-x-auto flex gap-2 p-2 scrollbar-hide bg-white/10 rounded-lg backdrop-blur-md border border-white/20"
        >
            {
                profesional.portfolio?.map((img, idx) => (
                    <img
                        src={img}
                        data-idx={idx}
                        class="thumb-img h-16 w-16 object-cover rounded-md cursor-pointer opacity-60 hover:opacity-100 border-2 border-transparent transition"
                    />
                ))
            }
        </div>
    </div>

    <!-- Modal de Selecci√≥n de Presupuesto -->
    <div
        id="budget-modal"
        class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
        <div
            class="bg-white rounded-2xl w-full max-w-lg mx-4 relative shadow-2xl overflow-hidden animate-fade-in-up"
        >
            <div
                class="bg-gradient-to-r from-orange-500 to-red-600 p-6 text-white flex justify-between items-center"
            >
                <div>
                    <h3 class="font-bold text-xl">Ver Presupuestos</h3>
                    <p class="text-xs text-orange-100 mt-1">
                        Selecciona los servicios de inter√©s
                    </p>
                </div>
                <button
                    id="btn-close-modal"
                    class="text-white hover:text-gray-200 text-2xl font-bold"
                    >&times;</button
                >
            </div>

            <div
                id="modal-services-list"
                class="flex-1 overflow-y-auto p-6 space-y-3"
            >
            </div>

            <div class="p-6 border-t bg-gray-50 flex gap-3 justify-end">
                <button
                    id="btn-cancel"
                    class="px-4 py-2 text-gray-600 font-medium">Cancelar</button
                >
                <button
                    id="btn-download-pdf"
                    class="px-6 py-2 bg-orange-600 text-white rounded-lg font-bold shadow-md hover:bg-orange-700 transition"
                >
                    Descargar PDF
                </button>
            </div>
        </div>
    </div>
</Layout>

<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

<script
    is:inline
    define:vars={{
        portfolioJson,
        serviciosJson,
        nombre: profesional.nombre,
        rubro: profesional.rubro_principal,
        tel: profesional.telefono,
        matricula: profesional.matricula,
    }}
>
    const images = JSON.parse(portfolioJson);
    const services = JSON.parse(serviciosJson);
    const proName = nombre;
    const proRubro = rubro;
    const proTel = tel;
    const proMat = matricula;
    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [PERFIL-INLINE] P√°gina cargada/navegada");
        // LIGHTBOX
        const lightbox = document.getElementById("lightbox");
        const mainImg = document.getElementById("lightbox-img");
        const thumbs = document.querySelectorAll(".thumb-img");

        function updateLightbox(index) {
            if (index < 0) index = images.length - 1;
            if (index >= images.length) index = 0;
            currentIndex = index;
            mainImg.src = images[currentIndex];
            thumbs.forEach((t) => {
                t.style.opacity = "0.6";
                t.style.borderColor = "transparent";
            });
            const activeThumb = document.querySelector(
                `.thumb-img[data-idx="${currentIndex}"]`,
            );
            if (activeThumb) {
                activeThumb.style.opacity = "1";
                activeThumb.style.borderColor = "#f97316";
                activeThumb.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "center",
                });
            }
        }

        document.querySelectorAll(".open-lightbox").forEach((img) => {
            img.addEventListener("click", (e) => {
                const idx = parseInt(e.target.dataset.index);
                lightbox.classList.remove("hidden");
                updateLightbox(idx);
            });
        });

        document
            .getElementById("close-lightbox")
            ?.addEventListener("click", () => lightbox.classList.add("hidden"));
        document
            .getElementById("prev-img")
            ?.addEventListener("click", () => updateLightbox(currentIndex - 1));
        document
            .getElementById("next-img")
            ?.addEventListener("click", () => updateLightbox(currentIndex + 1));
        thumbs.forEach((t) =>
            t.addEventListener("click", (e) =>
                updateLightbox(parseInt(e.target.dataset.idx)),
            ),
        );
        document.addEventListener("keydown", (e) => {
            if (lightbox.classList.contains("hidden")) return;
            if (e.key === "Escape") lightbox.classList.add("hidden");
            if (e.key === "ArrowLeft") updateLightbox(currentIndex - 1);
            if (e.key === "ArrowRight") updateLightbox(currentIndex + 1);
        });

        // GENERATE CUSTOM PDF (SAFE VERSION)
        function generateCustomPDF(selected) {
            if (!window.jspdf) {
                return Swal.fire(
                    "Error",
                    "La librer√≠a PDF no se carg√≥ correctamente. Intenta recargar la p√°gina.",
                    "error",
                );
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Colores del tema
            const primaryDark = [31, 41, 55]; // Gris oscuro
            const accentOrange = [234, 88, 12]; // Naranja
            const lightGray = [245, 245, 245]; // Gris claro
            const textDark = [40, 40, 40]; // Texto oscuro
            const textGray = [100, 100, 100]; // Texto gris

            // === HEADER ===
            // Fondo principal
            doc.setFillColor(...primaryDark);
            doc.rect(0, 0, 210, 45, "F");

            // Barra naranja decorativa
            doc.setFillColor(...accentOrange);
            doc.rect(0, 45, 210, 3, "F");

            // Logo/Icono (c√≠rculo decorativo)
            doc.setFillColor(255, 255, 255);
            doc.circle(20, 22, 8, "F");
            doc.setFillColor(...accentOrange);
            doc.circle(20, 22, 6, "F");

            // T√≠tulo principal
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, "bold");
            doc.text("PRESUPUESTO PROFESIONAL", 35, 22);

            // Fecha
            doc.setFontSize(9);
            doc.setFont(undefined, "normal");
            doc.setTextColor(200, 200, 200);
            const fecha = new Date().toLocaleDateString("es-AR", {
                year: "numeric",
                month: "long",
                day: "numeric",
            });
            doc.text("Emitido: " + fecha, 35, 30);

            // N√∫mero de presupuesto
            const numPresupuesto = "#" + Date.now().toString().slice(-6);
            doc.text("No. " + numPresupuesto, 35, 36);

            // === INFORMACI√ìN DEL PROFESIONAL ===
            let y = 60;

            // Caja con info del profesional
            doc.setFillColor(...lightGray);
            doc.roundedRect(15, y, 180, 28, 3, 3, "F");

            doc.setTextColor(...textDark);
            doc.setFontSize(16);
            doc.setFont(undefined, "bold");
            doc.text(proName, 20, y + 8);

            doc.setFontSize(11);
            doc.setFont(undefined, "normal");
            doc.setTextColor(...textGray);
            doc.text(proRubro, 20, y + 15);

            if (proTel) {
                doc.text("Tel: " + proTel, 20, y + 22);
            }

            if (proMat) {
                doc.setFontSize(9);
                doc.text("Mat. " + proMat, 150, y + 22);
            }

            // === TABLA DE SERVICIOS ===
            y = 100;

            // Header de tabla
            doc.setFillColor(...accentOrange);
            doc.roundedRect(15, y, 180, 12, 2, 2, "F");

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont(undefined, "bold");
            doc.text("DESCRIPCION DEL SERVICIO", 20, y + 8);
            doc.text("VALOR ESTIMADO", 150, y + 8);

            y += 20;
            let totalMin = 0;
            let totalMax = 0;

            // Servicios
            selected.forEach((s, index) => {
                // Fondo alternado para mejor legibilidad
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(15, y - 5, 180, 0, "F");
                }

                // Nombre del servicio
                doc.setFont(undefined, "bold");
                doc.setFontSize(11);
                doc.setTextColor(...textDark);
                doc.text(s.nombre, 20, y);

                // Precio
                doc.setTextColor(...accentOrange);
                doc.setFont(undefined, "bold");
                doc.text(
                    "$" +
                        s.min.toLocaleString() +
                        " - $" +
                        s.max.toLocaleString(),
                    150,
                    y,
                );

                totalMin += parseInt(s.min);
                totalMax += parseInt(s.max);

                y += 6;

                // Descripci√≥n
                if (s.descripcion) {
                    doc.setFontSize(9);
                    doc.setTextColor(...textGray);
                    doc.setFont(undefined, "normal");
                    const lines = doc.splitTextToSize(s.descripcion, 125);
                    doc.text(lines, 20, y);
                    y += lines.length * 4;
                }

                // L√≠nea separadora sutil
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.line(15, y + 2, 195, y + 2);
                y += 8;

                // Nueva p√°gina si es necesario
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
            });

            // === RESUMEN TOTAL ===
            y += 5;
            doc.setFillColor(...lightGray);
            doc.roundedRect(15, y, 180, 20, 2, 2, "F");

            doc.setFontSize(12);
            doc.setFont(undefined, "bold");
            doc.setTextColor(...textDark);
            doc.text("RANGO TOTAL ESTIMADO:", 20, y + 8);

            doc.setFontSize(14);
            doc.setTextColor(...accentOrange);
            doc.text(
                "$" +
                    totalMin.toLocaleString() +
                    " - $" +
                    totalMax.toLocaleString(),
                20,
                y + 15,
            );

            // === FOOTER ===
            const pageHeight = doc.internal.pageSize.height;

            // L√≠nea decorativa
            doc.setDrawColor(...accentOrange);
            doc.setLineWidth(1);
            doc.line(15, pageHeight - 35, 195, pageHeight - 35);

            // Nota de validez
            doc.setFontSize(11);
            doc.setTextColor(...accentOrange);
            doc.setFont(undefined, "bold");
            doc.text(
                "Presupuesto valido por 7 dias corridos",
                105,
                pageHeight - 27,
                { align: "center" },
            );

            // Disclaimer
            doc.setFontSize(8);
            doc.setTextColor(...textGray);
            doc.setFont(undefined, "normal");
            doc.text(
                "Los precios son estimativos y pueden variar segun complejidad del trabajo.",
                105,
                pageHeight - 20,
                { align: "center" },
            );

            // Branding
            doc.setFontSize(9);
            doc.setTextColor(...primaryDark);
            doc.setFont(undefined, "bold");
            doc.text("DeOficios.com.ar", 105, pageHeight - 12, {
                align: "center",
            });

            doc.setFontSize(7);
            doc.setTextColor(...textGray);
            doc.setFont(undefined, "normal");
            doc.text(
                "Conectando profesionales con clientes desde 2024",
                105,
                pageHeight - 7,
                { align: "center" },
            );

            // Guardar
            doc.save(
                "Presupuesto_" +
                    proName.replace(/\s+/g, "_") +
                    "_" +
                    numPresupuesto +
                    ".pdf",
            );
        }

        // Renderizar servicios en el modal
        function renderServicesInModal() {
            const container = document.getElementById("modal-services-list");
            if (!container) return;
            container.innerHTML = "";

            if (!services || services.length === 0) {
                container.innerHTML =
                    '<p class="text-gray-500 text-center py-4">Este profesional no tiene servicios configurados.</p>';
                return;
            }

            services.forEach((s, idx) => {
                const div = document.createElement("div");
                div.className =
                    "flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100 hover:bg-orange-50 transition cursor-pointer";
                div.onclick = (e) => {
                    // @ts-ignore
                    if (e.target.type !== "checkbox") {
                        const chk = document.getElementById(`chk-srv-${idx}`);
                        // @ts-ignore
                        if (chk) chk.checked = !chk.checked;
                    }
                };

                div.innerHTML = `
                    <input type="checkbox" id="chk-srv-${idx}" class="mt-1 w-5 h-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500 service-check" value="${idx}">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 text-sm">${s.nombre}</h4>
                            <span class="text-orange-600 font-bold text-sm">$${s.min.toLocaleString()} - $${s.max.toLocaleString()}</span>
                        </div>
                        ${s.descripcion ? `<p class="text-xs text-gray-500 mt-1">${s.descripcion}</p>` : ""}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Setup completo del modal
        function setupModal() {
            console.log("üöÄ [DEBUG] setupModal called");
            const modal = document.getElementById("budget-modal");
            const btnLanding = document.getElementById("btn-landing-pdf");
            const btnSidebar = document.getElementById(
                "btn-generate-pdf-sidebar",
            );
            const btnClose = document.getElementById("btn-close-modal");
            const btnCancel = document.getElementById("btn-cancel");
            const btnDownload = document.getElementById("btn-download-pdf");

            const openModal = () => {
                if (modal) {
                    renderServicesInModal(); // Renderizar al abrir
                    modal.classList.remove("hidden");
                    modal.classList.add("flex");
                }
            };

            const closeModal = () => {
                if (modal) {
                    modal.classList.add("hidden");
                    modal.classList.remove("flex");
                }
            };

            if (btnLanding) btnLanding.addEventListener("click", openModal);
            if (btnSidebar) btnSidebar.addEventListener("click", openModal);
            if (btnClose) btnClose.addEventListener("click", closeModal);
            if (btnCancel) btnCancel.addEventListener("click", closeModal);

            if (btnDownload) {
                btnDownload.addEventListener("click", () => {
                    // Recopilar seleccionados
                    const selected = [];
                    document
                        .querySelectorAll(".service-check:checked")
                        .forEach((chk) => {
                            // @ts-ignore
                            const index = parseInt(chk.value);
                            if (services[index]) selected.push(services[index]);
                        });

                    if (selected.length === 0) {
                        // @ts-ignore
                        return Swal.fire(
                            "Atenci√≥n",
                            "Por favor selecciona al menos un servicio.",
                            "warning",
                        );
                    }

                    // @ts-ignore
                    btnDownload.innerText = "Generando...";
                    // @ts-ignore
                    btnDownload.disabled = true;

                    setTimeout(() => {
                        generateCustomPDF(selected);
                        // @ts-ignore
                        btnDownload.innerText = "Descargar PDF";
                        // @ts-ignore
                        btnDownload.disabled = false;
                        closeModal();
                        // @ts-ignore
                        Swal.fire(
                            "¬°Listo!",
                            "Tu presupuesto se ha descargado.",
                            "success",
                        );
                    }, 500);
                });
            }

            // Cerrar al hacer click fuera del contenido
            if (modal) {
                modal.addEventListener("click", (e) => {
                    // @ts-ignore
                    if (e.target === modal) closeModal();
                });
            }
        }

        setupModal();

        // MAPA
        console.log("üöÄ [DEBUG] Initializing Map logic");
        const mapDiv = document.getElementById("mini-map");
        if (mapDiv) {
            try {
                // @ts-ignore
                if (typeof L === "undefined") {
                    console.error("‚ùå [DEBUG] Leaflet L is undefined");
                } else {
                    const lat = mapDiv.dataset.lat;
                    const lng = mapDiv.dataset.lng;
                    console.log("üöÄ [DEBUG] Map found, lat:", lat, "lng:", lng);
                    // @ts-ignore
                    const map = L.map("mini-map", {
                        zoomControl: false,
                        dragging: false,
                        scrollWheelZoom: false,
                    }).setView([lat, lng], 13);
                    // @ts-ignore
                    L.tileLayer(
                        "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
                    ).addTo(map);
                    // @ts-ignore
                    L.circle([lat, lng], {
                        radius: 800,
                        color: "#3b82f6",
                        fillColor: "#3b82f6",
                        fillOpacity: 0.2,
                    }).addTo(map);
                }
            } catch (e) {
                console.error("‚ùå [DEBUG] Map Error:", e);
            }
        } else {
            console.warn("‚ö†Ô∏è [DEBUG] #mini-map not found in DOM");
        }
    });
</script>

<script>
    import { auth, db } from "../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        doc,
        getDoc,
        addDoc,
        collection,
        query,
        orderBy,
        getDocs,
        runTransaction,
        serverTimestamp,
        updateDoc,
        increment,
    } from "firebase/firestore";

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [PERFIL-IMPORT] P√°gina cargada/navegada");

        // @ts-ignore
        window.trackClick = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get("id");
            if (pid)
                await updateDoc(doc(db, "profesionales", pid), {
                    contacto_clicks: increment(1),
                });
        };

        const container = document.getElementById("profile-directory");
        const idPro = container?.dataset.id;

        if (idPro) {
            const list = document.getElementById("reviews-list");
            if (list) {
                const q = query(
                    collection(db, "profesionales", idPro, "resenas"),
                    orderBy("fecha", "desc"),
                );
                getDocs(q).then((snap) => {
                    list.innerHTML = "";
                    if (snap.empty) {
                        list.innerHTML = `<div class="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300"><p class="text-3xl mb-2">üí¨</p><p class="text-gray-500 italic mb-2">A√∫n no hay opiniones.</p><p class="text-orange-600 font-bold text-sm">¬°S√© el primero en compartir tu experiencia!</p></div>`;
                        return;
                    }
                    snap.forEach((doc) => {
                        const d = doc.data();
                        const date = d.fecha
                            ? new Date(
                                  d.fecha.seconds * 1000,
                              ).toLocaleDateString()
                            : "";
                        const avatarSrc =
                            d.clienteFoto ||
                            `https://ui-avatars.com/api/?name=${d.clienteNombre}&background=random&color=fff&size=64`;
                        list.innerHTML += `<div class="border-b border-gray-100 pb-4 last:border-0 mb-4"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-3"><img src="${avatarSrc}" class="w-8 h-8 rounded-full shadow-sm"><span class="font-bold text-sm text-gray-800">${d.clienteNombre}</span></div><span class="text-xs text-gray-400">${date}</span></div><div class="text-yellow-400 text-xs mb-2">${"‚òÖ".repeat(d.estrellas)}</div><p class="text-sm text-gray-600 leading-relaxed">"${d.comentario}"</p></div>`;
                    });
                });
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const snap = await getDoc(doc(db, "clientes", user.uid));
                    if (snap.exists()) {
                        document
                            .getElementById("guest-view")
                            ?.classList.add("hidden");
                        document
                            .getElementById("user-view")
                            ?.classList.remove("hidden");
                        // @ts-ignore
                        document.getElementById("user-name").innerText =
                            snap.data().nombre;
                        // @ts-ignore
                        document.getElementById("user-avatar").src =
                            snap.data().foto ||
                            user.photoURL ||
                            `https://ui-avatars.com/api/?name=${snap.data().nombre}&background=0D8ABC&color=fff`;
                        checkFav(user.uid);
                    }
                }
            });

            const stars = document.querySelectorAll("#stars-selector span");
            const ratingInput = document.getElementById("rating-val");
            stars.forEach((s, idx) => {
                s.addEventListener("click", () => {
                    // @ts-ignore
                    ratingInput.value = idx + 1;
                    stars.forEach((st, i) =>
                        st.classList.toggle("text-yellow-400", i <= idx),
                    );
                });
            });

            document
                .getElementById("btn-send-review")
                ?.addEventListener("click", async () => {
                    // @ts-ignore
                    const val = parseInt(ratingInput.value);
                    // @ts-ignore
                    const txt = document.getElementById("review-text").value;
                    if (!val || !txt)
                        return alert(
                            "Por favor califica y escribe un comentario.",
                        );
                    try {
                        // @ts-ignore
                        await runTransaction(db, async (t) => {
                            const ref = doc(
                                collection(
                                    db,
                                    "profesionales",
                                    idPro,
                                    "resenas",
                                ),
                            );
                            const proRef = doc(db, "profesionales", idPro);
                            const proDoc = await t.get(proRef);
                            const d = proDoc.data();
                            const newTotal = (d.total_votos || 0) + 1;
                            const newAvg =
                                ((d.promedio || 0) * (d.total_votos || 0) +
                                    val) /
                                newTotal;
                            // @ts-ignore
                            const userName =
                                document.getElementById("user-name").innerText;
                            // @ts-ignore
                            const userPic =
                                document.getElementById("user-avatar").src;

                            t.set(ref, {
                                estrellas: val,
                                comentario: txt,
                                fecha: serverTimestamp(),
                                clienteNombre: userName,
                                clienteId: auth.currentUser.uid,
                                clienteFoto: userPic,
                            });
                            t.update(proRef, {
                                total_votos: newTotal,
                                promedio: newAvg,
                            });
                        });
                        alert("¬°Opini√≥n publicada!");
                        window.location.reload();
                    } catch (e) {
                        console.error(e);
                        alert("Error al publicar.");
                    }
                });
        }

        async function checkFav(uid) {
            const btn = document.getElementById("btn-fav");
            if (!btn) return;
            const snap = await getDoc(doc(db, "clientes", uid));
            if (snap.exists() && snap.data().favoritos?.includes(idPro))
                btn.style.color = "#ef4444";
            btn.addEventListener("click", async () => {
                const ref = doc(db, "clientes", uid);
                const isRed = btn.style.color === "rgb(239, 68, 68)";
                btn.style.color = isRed ? "#d1d5db" : "#ef4444";
                // @ts-ignore
                await runTransaction(db, async (t) => {
                    const d = await t.get(ref);
                    let favs = d.data().favoritos || [];
                    if (isRed) favs = favs.filter((id) => id !== idPro);
                    else if (!favs.includes(idPro)) favs.push(idPro);
                    t.update(ref, { favoritos: favs });
                });
            });
        }

        // üö© REPORTAR PERFIL
        document
            .getElementById("btn-report-profile")
            ?.addEventListener("click", async () => {
                const { value: formValues } = await Swal.fire({
                    title: "üö© Reportar Perfil",
                    html: `
                <div class="text-left">
                    <p class="text-sm text-gray-600 mb-4">Ay√∫danos a mantener la comunidad segura reportando perfiles inapropiados.</p>
                    <label class="block text-xs font-bold text-gray-700 mb-2">Motivo del reporte:</label>
                    <select id="report-reason" class="w-full border p-2 rounded mb-4">
                        <option value="">Selecciona un motivo...</option>
                        <option value="contenido_inapropiado">Contenido inapropiado</option>
                        <option value="informacion_falsa">Informaci√≥n falsa</option>
                        <option value="spam">Spam o publicidad</option>
                        <option value="suplantacion">Suplantaci√≥n de identidad</option>
                        <option value="otro">Otro</option>
                    </select>
                    <label class="block text-xs font-bold text-gray-700 mb-2">Descripci√≥n (opcional):</label>
                    <textarea id="report-description" class="w-full border p-2 rounded" rows="3" placeholder="Describe el problema..."></textarea>
                </div>
            `,
                    showCancelButton: true,
                    confirmButtonText: "Enviar Reporte",
                    cancelButtonText: "Cancelar",
                    confirmButtonColor: "#ef4444",
                    preConfirm: () => {
                        const reason =
                            document.getElementById("report-reason").value;
                        const description =
                            document.getElementById("report-description").value;

                        if (!reason) {
                            Swal.showValidationMessage(
                                "Por favor selecciona un motivo",
                            );
                            return false;
                        }

                        return { reason, description };
                    },
                });

                if (formValues) {
                    try {
                        const user = auth.currentUser;
                        if (!user) {
                            Swal.fire(
                                "Error",
                                "Debes iniciar sesi√≥n para reportar",
                                "error",
                            );
                            return;
                        }

                        // Guardar reporte en Firestore
                        await addDoc(collection(db, "reportes_perfiles"), {
                            perfilReportado: idProfesional,
                            nombreReportado: profesional.nombre,
                            reportadoPor: user.uid,
                            motivo: formValues.reason,
                            descripcion: formValues.description || "",
                            fecha: new Date(),
                            estado: "pendiente",
                        });

                        Swal.fire({
                            icon: "success",
                            title: "Reporte Enviado",
                            text: "Gracias por ayudarnos a mantener la comunidad segura. Revisaremos tu reporte pronto.",
                            confirmButtonColor: "#10b981",
                        });
                    } catch (error) {
                        console.error("Error enviando reporte:", error);
                        Swal.fire(
                            "Error",
                            "No se pudo enviar el reporte. Intenta nuevamente.",
                            "error",
                        );
                    }
                }
            });

        // üì± MOSTRAR QR
        document
            .getElementById("btn-show-qr")
            ?.addEventListener("click", () => {
                const profileUrl = window.location.href;

                Swal.fire({
                    title: "üì± C√≥digo QR",
                    html: `
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-4">Escanea este c√≥digo para ver el perfil</p>
                    <div id="qr-container" class="flex justify-center"></div>
                    <p class="text-xs text-gray-500 mt-4">${profileUrl}</p>
                </div>
            `,
                    width: 400,
                    showConfirmButton: false,
                    showCloseButton: true,
                    didOpen: () => {
                        // Generar QR usando API p√∫blica
                        const qrContainer =
                            document.getElementById("qr-container");
                        const qrImg = document.createElement("img");
                        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(profileUrl)}`;
                        qrImg.className = "mx-auto rounded-lg shadow-md";
                        qrContainer.appendChild(qrImg);
                    },
                });
            });

        // üí≥ DESCARGAR TARJETA DIGITAL
        document
            .getElementById("btn-download-card")
            ?.addEventListener("click", async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: "landscape",
                        unit: "mm",
                        format: [85.6, 53.98], // Tama√±o tarjeta de cr√©dito
                    });

                    // Fondo degradado
                    doc.setFillColor(147, 51, 234); // Purple
                    doc.rect(0, 0, 85.6, 53.98, "F");

                    // Nombre
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont(undefined, "bold");
                    doc.text(profesional.nombre, 8, 15);

                    // Rubro
                    doc.setFontSize(10);
                    doc.setFont(undefined, "normal");
                    doc.text(profesional.rubro_principal, 8, 22);

                    // Tel√©fono
                    if (profesional.telefono) {
                        doc.setFontSize(12);
                        doc.text(`üì± ${profesional.telefono}`, 8, 35);
                    }

                    // URL del perfil
                    doc.setFontSize(8);
                    doc.text(window.location.href, 8, 48);

                    // Logo/Badge
                    doc.setFontSize(20);
                    doc.text("‚ö°", 70, 15);

                    // Descargar
                    doc.save(
                        `tarjeta-${profesional.nombre.replace(/\s+/g, "-")}.pdf`,
                    );

                    Swal.fire({
                        icon: "success",
                        title: "¬°Descargado!",
                        text: "Tu tarjeta digital est√° lista",
                        timer: 2000,
                        showConfirmButton: false,
                    });
                } catch (error) {
                    console.error("Error generando tarjeta:", error);
                    Swal.fire(
                        "Error",
                        "No se pudo generar la tarjeta",
                        "error",
                    );
                }
            });
    }); // End of astro:page-load
</script>

<style>
    /* Fix map */
    #mini-map {
        height: 200px;
        width: 100%;
        background: #f0f0f0;
        z-index: 1;
        min-height: 200px; /* Force height */
    }
    .leaflet-container {
        font-family: inherit;
    }

    /* Ensure modal overlay is above everything */
    #budget-modal {
        z-index: 9999;
    }
</style>
