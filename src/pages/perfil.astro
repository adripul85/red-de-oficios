---
import Layout from "../layouts/Layout.astro";
import { db } from "../firebase/client";
import { doc, getDoc, updateDoc, increment } from "firebase/firestore";

const id = Astro.url.searchParams.get("id");
let profesional = null;
let idProfesional = null;

if (id) {
    try {
        const docRef = doc(db, "profesionales", id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            profesional = docSnap.data();
            idProfesional = docSnap.id;
        }
    } catch (e) {
        console.error("Error:", e);
    }
}

if (!profesional) return Astro.redirect("/");

// --- ELIMINADO: Bloqueo de perfiles gratuitos ---
// Los perfiles FREE ahora son públicos
// const planActual = profesional.plan || "gratuito";
// if (planActual === "semilla" || planActual === "gratuito" || planActual === "prueba_gratis") {
//     return Astro.redirect("/?error=perfil_privado");
// }
// -----------------------------------------------------

// --- LÓGICA DE VISUALIZACIÓN ---
const esExperto =
    profesional.plan === "experto" || profesional.plan === "semestral";
const mostrarComoLanding = esExperto && profesional.web_propia;
const promedio = profesional.promedio || 0;
const votos = profesional.total_votos || 0;
const ubicacion = profesional.zona || "Argentina";

const portfolioJson = JSON.stringify(profesional.portfolio || []);
const serviciosJson = JSON.stringify(profesional.servicios_lista || []);
---

<Layout
    title={`${profesional.nombre} | DeOficios`}
    hideHeader={mostrarComoLanding}
    hideFooter={mostrarComoLanding}
>
    <script
        is:inline
        src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    ></script>

    {
        mostrarComoLanding ? (
            /* MODO LANDING */
            <div class="landing-body font-sans min-h-screen bg-gray-50 flex flex-col items-center pb-20">
                <header class="w-full bg-[#111827] text-white pt-12 pb-24 px-4 text-center rounded-b-[50px] shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]" />
                    <div class="relative z-10 flex flex-col items-center">
                        <div class="w-32 h-32 rounded-full p-1 bg-gradient-to-r from-orange-500 to-red-600 shadow-xl mb-4">
                            <img
                                src={profesional.foto}
                                class="w-full h-full rounded-full object-cover border-4 border-[#111827]"
                            />
                        </div>
                        <span class="bg-orange-600 text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider mb-2 shadow-sm">
                            {profesional.rubro_principal}
                        </span>
                        <h1 class="text-3xl md:text-4xl font-black mb-2">
                            {profesional.nombre}
                        </h1>
                        <div class="flex flex-wrap justify-center gap-3 text-sm text-gray-300 mt-2">
                            <span class="flex items-center gap-1">
                                📍 {ubicacion}
                            </span>
                            {profesional.es_24hs && (
                                <span class="bg-red-900/50 text-red-200 px-2 py-0.5 rounded border border-red-800 text-xs font-bold">
                                    🚨 24hs
                                </span>
                            )}
                            <span class="text-yellow-400 font-bold">
                                ★ {promedio.toFixed(1)}
                            </span>
                        </div>
                    </div>
                </header>

                <main class="w-full max-w-md px-4 -mt-16 relative z-20 space-y-4">
                    <div class="grid grid-cols-1 gap-3">
                        {profesional.telefono && (
                            <a
                                href={`https://wa.me/549${profesional.telefono}`}
                                target="_blank"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg text-center flex items-center justify-center gap-2 transition transform hover:scale-105 text-lg"
                                onclick="trackClick()"
                            >
                                <span>💬</span> Contactar por WhatsApp
                            </a>
                        )}
                        {profesional.servicios_lista?.length > 0 && (
                            <button
                                id="btn-landing-pdf"
                                class="bg-white text-gray-800 font-bold py-3 rounded-xl shadow-md border-2 border-orange-500 hover:bg-orange-50 flex items-center justify-center gap-2 transition"
                            >
                                <span>📄</span> Ver Tarifario / Presupuesto
                            </button>
                        )}
                        
                        <!-- Botón de Reporte -->
                        <button
                            id="btn-report-profile"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-medium py-2 rounded-lg flex items-center justify-center gap-2 transition text-sm border border-gray-300"
                        >
                            <span>🚩</span> Reportar Perfil
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-gray-800 font-bold mb-3 border-l-4 border-orange-500 pl-3">
                            Sobre mí
                        </h3>
                        <p class="text-gray-600 text-sm leading-relaxed whitespace-pre-line mb-4">
                            {profesional.descripcion ||
                                "Consultar por servicios."}
                        </p>

                        <div class="flex flex-wrap gap-2 mb-3">
                            {profesional.matricula && (
                                <span class="text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100 font-bold">
                                    🎓 Matrícula: {profesional.matricula}
                                </span>
                            )}
                            {profesional.emite_factura && (
                                <span class="text-[10px] bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200">
                                    🧾 Factura A/C
                                </span>
                            )}
                        </div>
                        {profesional.formas_pago && (
                            <div class="pt-3 border-t border-gray-100">
                                <p class="text-xs text-gray-400 mb-2 font-bold uppercase">
                                    Medios de Pago:
                                </p>
                                <div class="flex flex-wrap gap-2">
                                    {profesional.formas_pago.map((p) => (
                                        <span class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded">
                                            💳 {p}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {profesional.portfolio &&
                        profesional.portfolio.length > 0 && (
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="text-gray-800 font-bold mb-3 border-l-4 border-purple-500 pl-3">
                                    Mis Trabajos
                                </h3>
                                <div class="grid grid-cols-3 gap-2">
                                    {profesional.portfolio
                                        .slice(0, 6)
                                        .map((img, index) => (
                                            <img
                                                src={img}
                                                class="aspect-square object-cover rounded-lg bg-gray-100 cursor-pointer open-lightbox hover:opacity-80 transition"
                                                data-index={index}
                                            />
                                        ))}
                                </div>
                            </div>
                        )}

                    {profesional.ubicacion_exacta?.activo && (
                        <a
                            href={`https://www.google.com/maps/search/?api=1&query=${profesional.ubicacion_exacta.lat},${profesional.ubicacion_exacta.lng}`}
                            target="_blank"
                            class="block bg-blue-50 p-4 rounded-xl text-center text-blue-700 font-bold border border-blue-100 hover:bg-blue-100 transition"
                        >
                            🗺️ Ver Ubicación en Mapa
                        </a>
                    )}
                </main>
            </div>
        ) : (
            /* MODO DIRECTORIO */
            <div
                id="profile-directory"
                data-id={idProfesional}
                class="min-h-screen bg-gray-50 pb-20"
            >
                <div class="bg-white border-b shadow-sm">
                    <div class="container mx-auto px-4 py-8 max-w-6xl">
                        <div class="flex flex-col md:flex-row items-center gap-8">
                            <div class="relative">
                                <img
                                    src={
                                        profesional.foto ||
                                        `https://ui-avatars.com/api/?name=${profesional.nombre}`
                                    }
                                    class="w-36 h-36 rounded-full object-cover border-4 border-white shadow-lg"
                                />
                                {esExperto && (
                                    <span class="absolute bottom-1 right-1 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded shadow-md border border-white">
                                        ⚡ EXPERTO
                                    </span>
                                )}
                            </div>
                            <div class="text-center md:text-left flex-1">
                                <div class="flex items-center justify-center md:justify-start gap-2 mb-2">
                                    <h1 class="text-3xl font-bold text-gray-900">
                                        {profesional.nombre}
                                    </h1>
                                    {profesional.verificado && (
                                        <span
                                            class="text-blue-500 text-xl"
                                            title="Verificado"
                                        >
                                            ✅
                                        </span>
                                    )}
                                    <button
                                        id="btn-fav"
                                        class="text-2xl text-gray-300 hover:text-red-500 transition ml-2 focus:outline-none"
                                    >
                                        ♥
                                    </button>
                                </div>
                                <p class="text-xl text-gray-600 mb-3">
                                    {profesional.rubro_principal} en{" "}
                                    <span class="font-bold text-gray-800">
                                        {ubicacion}
                                    </span>
                                </p>

                                <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-4">
                                    <span class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-bold border border-green-200">
                                        🟢 En línea
                                    </span>
                                    {profesional.es_24hs && (
                                        <span class="bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full font-bold border border-red-200">
                                            🚨 24hs
                                        </span>
                                    )}
                                    {profesional.matricula && (
                                        <span class="bg-blue-50 text-blue-800 text-xs px-3 py-1 rounded-full font-bold border border-blue-200">
                                            🎓 Mat.: {profesional.matricula}
                                        </span>
                                    )}
                                    {promedio >= 4.5 && (
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-full font-bold border border-yellow-200">
                                            🏆 Top
                                        </span>
                                    )}
                                </div>

                                <div class="flex items-center justify-center md:justify-start gap-4">
                                    <div class="bg-gray-100 px-4 py-2 rounded-lg flex items-center gap-2">
                                        <span class="text-yellow-500 font-bold text-xl">
                                            ★ {promedio.toFixed(1)}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            ({votos} op.)
                                        </span>
                                    </div>
                                    <button
                                        onclick="document.getElementById('reviews-section').scrollIntoView({behavior: 'smooth'})"
                                        class="text-orange-600 font-bold text-sm hover:underline"
                                    >
                                        Leer Opiniones
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <main class="container mx-auto px-4 py-8 max-w-6xl grid md:grid-cols-3 gap-8">
                    <div class="md:col-span-2 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">
                                Sobre mí
                            </h3>
                            <p class="text-gray-600 whitespace-pre-line leading-relaxed mb-6">
                                {profesional.descripcion ||
                                    "Sin descripción detallada."}
                            </p>

                            <div class="border-t pt-4">
                                <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">
                                    Información de Contratación
                                </h4>
                                <div class="flex flex-wrap gap-3">
                                    {profesional.emite_factura ? (
                                        <span class="flex items-center gap-1 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100">
                                            🧾 Emite Factura
                                        </span>
                                    ) : (
                                        <span class="text-xs text-gray-400 px-2 py-1">
                                            No factura
                                        </span>
                                    )}
                                    {profesional.formas_pago?.map((p) => (
                                        <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-medium border border-gray-200">
                                            💳 {p}
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                {profesional.etiquetas?.map((t) => (
                                    <span class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-500 font-medium">
                                        #{t}
                                    </span>
                                ))}
                            </div>
                        </div>

                        {profesional.portfolio && (
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="font-bold text-lg mb-4 text-gray-800">
                                    📸 Trabajos Realizados
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {profesional.portfolio.map((img, index) => (
                                        <img
                                            src={img}
                                            class="aspect-square object-cover rounded-lg bg-gray-100 cursor-pointer hover:opacity-90 transition open-lightbox"
                                            data-index={index}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        <div
                            id="reviews-section"
                            class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"
                        >
                            <h3 class="font-bold text-lg mb-6 text-gray-800">
                                Opiniones de Clientes
                            </h3>
                            <div
                                id="review-action-box"
                                class="bg-blue-50 p-6 rounded-xl text-center mb-6 border border-blue-100"
                            >
                                <div id="guest-view">
                                    <p class="text-blue-900 font-bold mb-2">
                                        ¿Lo contrataste?
                                    </p>
                                    <a
                                        href={`/ingresar-cliente?returnUrl=/perfil?id=${idProfesional}`}
                                        class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition inline-block"
                                    >
                                        🔒 Iniciar Sesión para Opinar
                                    </a>
                                </div>
                                <div id="user-view" class="hidden text-left">
                                    <div class="flex items-center gap-2 mb-3">
                                        <img
                                            id="user-avatar"
                                            class="w-8 h-8 rounded-full bg-white border"
                                        />
                                        <div>
                                            <>
                                                <p
                                                    id="user-name"
                                                    class="font-bold text-sm text-gray-900"
                                                >
                                                    Usuario
                                                </p>
                                                <p class="text-xs text-green-600 font-bold">
                                                    Verificado ✅
                                                </p>
                                            </>
                                        </div>
                                    </div>
                                    <div
                                        class="flex gap-2 text-2xl mb-3 cursor-pointer"
                                        id="stars-selector"
                                    >
                                        <>
                                            <span
                                                data-v="1"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ★
                                            </span>
                                            <span
                                                data-v="2"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ★
                                            </span>
                                            <span
                                                data-v="3"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ★
                                            </span>
                                            <span
                                                data-v="4"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ★
                                            </span>
                                            <span
                                                data-v="5"
                                                class="text-gray-300 hover:text-yellow-400"
                                            >
                                                ★
                                            </span>
                                        </>
                                    </div>
                                    <input
                                        type="hidden"
                                        id="rating-val"
                                        value="0"
                                    />
                                    <textarea
                                        id="review-text"
                                        class="w-full p-3 rounded border border-gray-300 mb-3 bg-white"
                                        placeholder="Cuéntanos tu experiencia..."
                                    />
                                    <button
                                        id="btn-send-review"
                                        class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition w-full md:w-auto"
                                    >
                                        Publicar Reseña
                                    </button>
                                </div>
                            </div>
                            <div id="reviews-list" class="space-y-4" />
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 sticky top-24">
                            <div class="text-center mb-6">
                                <p class="text-gray-500 text-sm">Contactar a</p>
                                <h2 class="text-xl font-bold text-gray-900">
                                    {profesional.nombre}
                                </h2>
                                <p class="text-sm font-medium text-green-600 mt-1">
                                    ⚡ Respuesta Rápida
                                </p>
                            </div>

                            {profesional.telefono ? (
                                <a
                                    href={`https://wa.me/549${profesional.telefono}`}
                                    target="_blank"
                                    class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl text-center shadow-md transition transform hover:scale-105 flex items-center justify-center gap-2 mb-3"
                                    onclick="trackClick()"
                                >
                                    <span class="text-xl">💬</span> WhatsApp
                                </a>
                            ) : (
                                <button
                                    disabled
                                    class="w-full bg-gray-200 py-3 rounded-xl font-bold text-gray-400 mb-3"
                                >
                                    Sin WhatsApp
                                </button>
                            )}

                            {profesional.servicios_lista?.length > 0 && (
                                <button
                                    id="btn-generate-pdf-sidebar"
                                    class="block w-full bg-white border-2 border-orange-500 text-orange-600 font-bold py-3 rounded-xl text-center hover:bg-orange-50 transition shadow-sm flex items-center justify-center gap-2"
                                >
                                    <span>📄</span> Ver Tarifario / Presupuesto
                                </button>
                            )}

                            {profesional.ubicacion_exacta?.activo &&
                                profesional.ubicacion_exacta?.lat && (
                                    <div class="mt-4 pt-4 border-t border-gray-100">
                                        <p class="font-bold text-sm mb-2 text-gray-700">
                                            📍 Zona de Trabajo
                                        </p>
                                        <div
                                            id="mini-map"
                                            class="w-full h-40 bg-gray-200 rounded-lg overflow-hidden border border-gray-200"
                                            data-lat={
                                                profesional.ubicacion_exacta.lat
                                            }
                                            data-lng={
                                                profesional.ubicacion_exacta.lng
                                            }
                                        />
                                        <p class="text-xs text-gray-500 mt-2 text-center">
                                            {ubicacion}
                                        </p>
                                    </div>
                                )}
                        </div>

                        <!-- QR y Tarjeta Digital - Solo para Expertos -->
                        {esExperto && (
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl shadow-lg border border-purple-200 mt-6">
                                <h3 class="text-lg font-bold text-purple-900 mb-4 text-center">
                                    ✨ Herramientas Premium
                                </h3>
                                
                                <div class="space-y-3">
                                    <button
                                        id="btn-show-qr"
                                        class="w-full bg-white hover:bg-purple-50 text-purple-700 font-bold py-3 px-4 rounded-lg border-2 border-purple-300 transition flex items-center justify-center gap-2"
                                    >
                                        <span class="text-2xl">📱</span>
                                        <span>Ver Código QR</span>
                                    </button>

                                    <button
                                        id="btn-download-card"
                                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2 shadow-md"
                                    >
                                        <span class="text-2xl">💳</span>
                                        <span>Descargar Tarjeta Digital</span>
                                    </button>
                                </div>

                                <p class="text-xs text-center text-purple-600 mt-4">
                                    Comparte tu perfil fácilmente
                                </p>
                            </div>
                        )}
                    </div>
                </main>
            </div>
        )
    }

    <div
        id="lightbox"
        class="fixed inset-0 bg-black bg-opacity-95 z-[9999] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm"
    >
        <button
            id="close-lightbox"
            class="absolute top-5 right-5 text-white text-4xl font-bold hover:text-gray-300 focus:outline-none z-50"
            >×</button
        >
        <div
            class="relative w-full max-w-4xl h-[70vh] flex items-center justify-center"
        >
            <button
                id="prev-img"
                class="absolute left-2 text-white text-5xl hover:text-orange-500 transition opacity-70 hover:opacity-100 drop-shadow-lg"
                >‹</button
            >
            <img
                id="lightbox-img"
                src=""
                class="max-w-full max-h-full rounded shadow-2xl object-contain"
            />
            <button
                id="next-img"
                class="absolute right-2 text-white text-5xl hover:text-orange-500 transition opacity-70 hover:opacity-100 drop-shadow-lg"
                >›</button
            >
        </div>
        <div
            class="mt-4 w-full max-w-4xl overflow-x-auto flex gap-2 p-2 scrollbar-hide bg-white/10 rounded-lg backdrop-blur-md border border-white/20"
        >
            {
                profesional.portfolio?.map((img, idx) => (
                    <img
                        src={img}
                        data-idx={idx}
                        class="thumb-img h-16 w-16 object-cover rounded-md cursor-pointer opacity-60 hover:opacity-100 border-2 border-transparent transition"
                    />
                ))
            }
        </div>
    </div>
</Layout>

<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

<script
    is:inline
    define:vars={{
        portfolioJson,
        serviciosJson,
        nombre: profesional.nombre,
        rubro: profesional.rubro_principal,
        tel: profesional.telefono,
        matricula: profesional.matricula,
    }}
>
    const images = JSON.parse(portfolioJson);
    const services = JSON.parse(serviciosJson);
    const proName = nombre;
    const proRubro = rubro;
    const proTel = tel;
    const proMat = matricula;
    let currentIndex = 0;

    document.addEventListener("DOMContentLoaded", () => {
        // LIGHTBOX
        const lightbox = document.getElementById("lightbox");
        const mainImg = document.getElementById("lightbox-img");
        const thumbs = document.querySelectorAll(".thumb-img");

        function updateLightbox(index) {
            if (index < 0) index = images.length - 1;
            if (index >= images.length) index = 0;
            currentIndex = index;
            mainImg.src = images[currentIndex];
            thumbs.forEach((t) => {
                t.style.opacity = "0.6";
                t.style.borderColor = "transparent";
            });
            const activeThumb = document.querySelector(
                `.thumb-img[data-idx="${currentIndex}"]`,
            );
            if (activeThumb) {
                activeThumb.style.opacity = "1";
                activeThumb.style.borderColor = "#f97316";
                activeThumb.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "center",
                });
            }
        }

        document.querySelectorAll(".open-lightbox").forEach((img) => {
            img.addEventListener("click", (e) => {
                const idx = parseInt(e.target.dataset.index);
                lightbox.classList.remove("hidden");
                updateLightbox(idx);
            });
        });

        document
            .getElementById("close-lightbox")
            ?.addEventListener("click", () => lightbox.classList.add("hidden"));
        document
            .getElementById("prev-img")
            ?.addEventListener("click", () => updateLightbox(currentIndex - 1));
        document
            .getElementById("next-img")
            ?.addEventListener("click", () => updateLightbox(currentIndex + 1));
        thumbs.forEach((t) =>
            t.addEventListener("click", (e) =>
                updateLightbox(parseInt(e.target.dataset.idx)),
            ),
        );
        document.addEventListener("keydown", (e) => {
            if (lightbox.classList.contains("hidden")) return;
            if (e.key === "Escape") lightbox.classList.add("hidden");
            if (e.key === "ArrowLeft") updateLightbox(currentIndex - 1);
            if (e.key === "ArrowRight") updateLightbox(currentIndex + 1);
        });

        // PDF GENERATOR
        const generatePdf = () => {
            if (services.length === 0)
                return alert("El profesional no tiene un tarifario cargado.");
            if (!window.jspdf)
                return alert("Cargando PDF... intenta de nuevo.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const orange = [234, 88, 12];

            doc.setFillColor(...orange);
            doc.rect(0, 0, 210, 30, "F");
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text("PRESUPUESTO / TARIFARIO", 20, 20);
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.text(proName, 20, 45);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(proRubro, 20, 51);
            if (proMat) doc.text(`Matrícula: ${proMat}`, 20, 57);
            if (proTel) doc.text(`Contacto: ${proTel}`, 20, 63);

            let y = 80;
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y, 170, 8, "F");
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text("SERVICIO", 25, y + 5);
            doc.text("PRECIO ESTIMADO", 150, y + 5);

            y += 15;
            services.forEach((s) => {
                doc.setFont("helvetica", "bold");
                doc.text(s.nombre, 25, y);
                doc.setFont("helvetica", "normal");
                doc.text(`$${s.min} - $${s.max}`, 150, y);
                y += 6;
                if (s.descripcion) {
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(s.descripcion, 25, y);
                    y += 8;
                } else {
                    y += 4;
                }
                doc.setDrawColor(230);
                doc.line(20, y - 3, 190, y - 3);
                doc.setTextColor(0);
                doc.setFontSize(9);
            });

            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text("Generado en DeOficios.com.ar", 105, 280, {
                align: "center",
            });
            doc.save(`tarifario_${proName.replace(/\s+/g, "_")}.pdf`);
        };

        document
            .getElementById("btn-generate-pdf-sidebar")
            ?.addEventListener("click", generatePdf);
        document
            .getElementById("btn-landing-pdf")
            ?.addEventListener("click", generatePdf);

        // MAPA
        const mapDiv = document.getElementById("mini-map");
        if (mapDiv) {
            const lat = mapDiv.dataset.lat;
            const lng = mapDiv.dataset.lng;
            const map = L.map("mini-map", {
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
            }).setView([lat, lng], 13);
            L.tileLayer(
                "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
            ).addTo(map);
            L.circle([lat, lng], {
                radius: 800,
                color: "#3b82f6",
                fillColor: "#3b82f6",
                fillOpacity: 0.2,
            }).addTo(map);
        }
    });
</script>

<script>
    import { auth, db } from "../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        doc,
        getDoc,
        addDoc,
        collection,
        query,
        orderBy,
        getDocs,
        runTransaction,
        serverTimestamp,
        updateDoc,
        increment,
    } from "firebase/firestore";

    window.trackClick = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const pid = urlParams.get("id");
        if (pid)
            await updateDoc(doc(db, "profesionales", pid), {
                contacto_clicks: increment(1),
            });
    };

    const container = document.getElementById("profile-directory");
    const idPro = container?.dataset.id;

    if (idPro) {
        const list = document.getElementById("reviews-list");
        if (list) {
            const q = query(
                collection(db, "profesionales", idPro, "resenas"),
                orderBy("fecha", "desc"),
            );
            getDocs(q).then((snap) => {
                list.innerHTML = "";
                if (snap.empty) {
                    list.innerHTML = `<div class="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300"><p class="text-3xl mb-2">💬</p><p class="text-gray-500 italic mb-2">Aún no hay opiniones.</p><p class="text-orange-600 font-bold text-sm">¡Sé el primero en compartir tu experiencia!</p></div>`;
                    return;
                }
                snap.forEach((doc) => {
                    const d = doc.data();
                    const date = d.fecha
                        ? new Date(d.fecha.seconds * 1000).toLocaleDateString()
                        : "";
                    const avatarSrc =
                        d.clienteFoto ||
                        `https://ui-avatars.com/api/?name=${d.clienteNombre}&background=random&color=fff&size=64`;
                    list.innerHTML += `<div class="border-b border-gray-100 pb-4 last:border-0 mb-4"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-3"><img src="${avatarSrc}" class="w-8 h-8 rounded-full shadow-sm"><span class="font-bold text-sm text-gray-800">${d.clienteNombre}</span></div><span class="text-xs text-gray-400">${date}</span></div><div class="text-yellow-400 text-xs mb-2">${"★".repeat(d.estrellas)}</div><p class="text-sm text-gray-600 leading-relaxed">"${d.comentario}"</p></div>`;
                });
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "clientes", user.uid));
                if (snap.exists()) {
                    document
                        .getElementById("guest-view")
                        ?.classList.add("hidden");
                    document
                        .getElementById("user-view")
                        ?.classList.remove("hidden");
                    // @ts-ignore
                    document.getElementById("user-name").innerText =
                        snap.data().nombre;
                    // @ts-ignore
                    document.getElementById("user-avatar").src =
                        snap.data().foto ||
                        user.photoURL ||
                        `https://ui-avatars.com/api/?name=${snap.data().nombre}&background=0D8ABC&color=fff`;
                    checkFav(user.uid);
                }
            }
        });

        const stars = document.querySelectorAll("#stars-selector span");
        const ratingInput = document.getElementById("rating-val");
        stars.forEach((s, idx) => {
            s.addEventListener("click", () => {
                // @ts-ignore
                ratingInput.value = idx + 1;
                stars.forEach((st, i) =>
                    st.classList.toggle("text-yellow-400", i <= idx),
                );
            });
        });

        document
            .getElementById("btn-send-review")
            ?.addEventListener("click", async () => {
                // @ts-ignore
                const val = parseInt(ratingInput.value);
                // @ts-ignore
                const txt = document.getElementById("review-text").value;
                if (!val || !txt)
                    return alert("Por favor califica y escribe un comentario.");
                try {
                    // @ts-ignore
                    await runTransaction(db, async (t) => {
                        const ref = doc(
                            collection(db, "profesionales", idPro, "resenas"),
                        );
                        const proRef = doc(db, "profesionales", idPro);
                        const proDoc = await t.get(proRef);
                        const d = proDoc.data();
                        const newTotal = (d.total_votos || 0) + 1;
                        const newAvg =
                            ((d.promedio || 0) * (d.total_votos || 0) + val) /
                            newTotal;
                        // @ts-ignore
                        const userName =
                            document.getElementById("user-name").innerText;
                        // @ts-ignore
                        const userPic =
                            document.getElementById("user-avatar").src;

                        t.set(ref, {
                            estrellas: val,
                            comentario: txt,
                            fecha: serverTimestamp(),
                            clienteNombre: userName,
                            clienteId: auth.currentUser.uid,
                            clienteFoto: userPic,
                        });
                        t.update(proRef, {
                            total_votos: newTotal,
                            promedio: newAvg,
                        });
                    });
                    alert("¡Opinión publicada!");
                    window.location.reload();
                } catch (e) {
                    console.error(e);
                    alert("Error al publicar.");
                }
            });
    }

    async function checkFav(uid) {
        const btn = document.getElementById("btn-fav");
        if (!btn) return;
        const snap = await getDoc(doc(db, "clientes", uid));
        if (snap.exists() && snap.data().favoritos?.includes(idPro))
            btn.style.color = "#ef4444";
        btn.addEventListener("click", async () => {
            const ref = doc(db, "clientes", uid);
            const isRed = btn.style.color === "rgb(239, 68, 68)";
            btn.style.color = isRed ? "#d1d5db" : "#ef4444";
            // @ts-ignore
            await runTransaction(db, async (t) => {
                const d = await t.get(ref);
                let favs = d.data().favoritos || [];
                if (isRed) favs = favs.filter((id) => id !== idPro);
                else if (!favs.includes(idPro)) favs.push(idPro);
                t.update(ref, { favoritos: favs });
            });
        });
    }

    // 🚩 REPORTAR PERFIL
    document.getElementById("btn-report-profile")?.addEventListener("click", async () => {
        const { value: formValues } = await Swal.fire({
            title: '🚩 Reportar Perfil',
            html: `
                <div class="text-left">
                    <p class="text-sm text-gray-600 mb-4">Ayúdanos a mantener la comunidad segura reportando perfiles inapropiados.</p>
                    <label class="block text-xs font-bold text-gray-700 mb-2">Motivo del reporte:</label>
                    <select id="report-reason" class="w-full border p-2 rounded mb-4">
                        <option value="">Selecciona un motivo...</option>
                        <option value="contenido_inapropiado">Contenido inapropiado</option>
                        <option value="informacion_falsa">Información falsa</option>
                        <option value="spam">Spam o publicidad</option>
                        <option value="suplantacion">Suplantación de identidad</option>
                        <option value="otro">Otro</option>
                    </select>
                    <label class="block text-xs font-bold text-gray-700 mb-2">Descripción (opcional):</label>
                    <textarea id="report-description" class="w-full border p-2 rounded" rows="3" placeholder="Describe el problema..."></textarea>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Enviar Reporte',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#ef4444',
            preConfirm: () => {
                const reason = document.getElementById('report-reason').value;
                const description = document.getElementById('report-description').value;
                
                if (!reason) {
                    Swal.showValidationMessage('Por favor selecciona un motivo');
                    return false;
                }
                
                return { reason, description };
            }
        });

        if (formValues) {
            try {
                const user = auth.currentUser;
                if (!user) {
                    Swal.fire('Error', 'Debes iniciar sesión para reportar', 'error');
                    return;
                }

                // Guardar reporte en Firestore
                await addDoc(collection(db, "reportes_perfiles"), {
                    perfilReportado: idProfesional,
                    nombreReportado: profesional.nombre,
                    reportadoPor: user.uid,
                    motivo: formValues.reason,
                    descripcion: formValues.description || "",
                    fecha: new Date(),
                    estado: "pendiente"
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Reporte Enviado',
                    text: 'Gracias por ayudarnos a mantener la comunidad segura. Revisaremos tu reporte pronto.',
                    confirmButtonColor: '#10b981'
                });
            } catch (error) {
                console.error("Error enviando reporte:", error);
                Swal.fire('Error', 'No se pudo enviar el reporte. Intenta nuevamente.', 'error');
            }
        }
    });

    // 📱 MOSTRAR QR
    document.getElementById("btn-show-qr")?.addEventListener("click", () => {
        const profileUrl = window.location.href;
        
        Swal.fire({
            title: '📱 Código QR',
            html: `
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-4">Escanea este código para ver el perfil</p>
                    <div id="qr-container" class="flex justify-center"></div>
                    <p class="text-xs text-gray-500 mt-4">${profileUrl}</p>
                </div>
            `,
            width: 400,
            showConfirmButton: false,
            showCloseButton: true,
            didOpen: () => {
                // Generar QR usando API pública
                const qrContainer = document.getElementById('qr-container');
                const qrImg = document.createElement('img');
                qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(profileUrl)}`;
                qrImg.className = 'mx-auto rounded-lg shadow-md';
                qrContainer.appendChild(qrImg);
            }
        });
    });

    // 💳 DESCARGAR TARJETA DIGITAL
    document.getElementById("btn-download-card")?.addEventListener("click", async () => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [85.6, 53.98] // Tamaño tarjeta de crédito
            });

            // Fondo degradado
            doc.setFillColor(147, 51, 234); // Purple
            doc.rect(0, 0, 85.6, 53.98, 'F');
            
            // Nombre
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(profesional.nombre, 8, 15);
            
            // Rubro
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(profesional.rubro_principal, 8, 22);
            
            // Teléfono
            if (profesional.telefono) {
                doc.setFontSize(12);
                doc.text(`📱 ${profesional.telefono}`, 8, 35);
            }
            
            // URL del perfil
            doc.setFontSize(8);
            doc.text(window.location.href, 8, 48);
            
            // Logo/Badge
            doc.setFontSize(20);
            doc.text('⚡', 70, 15);
            
            // Descargar
            doc.save(`tarjeta-${profesional.nombre.replace(/\s+/g, '-')}.pdf`);
            
            Swal.fire({
                icon: 'success',
                title: '¡Descargado!',
                text: 'Tu tarjeta digital está lista',
                timer: 2000,
                showConfirmButton: false
            });
        } catch (error) {
            console.error('Error generando tarjeta:', error);
            Swal.fire('Error', 'No se pudo generar la tarjeta', 'error');
        }
    });
</script>
