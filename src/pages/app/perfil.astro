---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Mi Perfil - DeOficios" hideHeader={true} hideFooter={true}>
    <div class="auth-gateway-container">
        <!-- Loading State -->
        <div
            id="loading-state"
            class="flex flex-col items-center justify-center h-full"
        >
            <div class="spinner-large"></div>
            <p class="mt-4 text-gray-500 font-medium animate-pulse">
                Cargando tu perfil...
            </p>
        </div>

        <!-- Login Selection State (Hidden by default) -->
        <div
            id="login-options"
            class="hidden flex flex-col items-center justify-center h-full p-6 animate-fade-in"
        >
            <div class="mb-8 text-center">
                <img
                    src="/icon-192.png"
                    alt="Logo"
                    class="w-32 h-38 mx-auto mb-4 rounded-2xl shadow-lg"
                />
                <h1 class="text-2xl font-bold text-gray-900">Bienvenido</h1>
                <p class="text-gray-500 mt-2">
                    Inicia sesiÃ³n para gestionar tus servicios o contrataciones
                </p>
            </div>

            <div class="w-full space-y-4 max-w-sm">
                <a href="/ingresar" class="block w-full">
                    <div
                        class="card-app p-4 flex items-center gap-4 hover:bg-orange-50 transition border-l-4 border-orange-500"
                    >
                        <div class="bg-orange-100 p-3 rounded-full text-2xl">
                            ðŸ‘·
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-gray-900">
                                Soy Profesional
                            </h3>
                            <p class="text-xs text-gray-500">
                                Ofrece tus servicios y trabaja
                            </p>
                        </div>
                        <span class="ml-auto text-gray-400">â†’</span>
                    </div>
                </a>

                <a href="/ingresar-cliente" class="block w-full">
                    <div
                        class="card-app p-4 flex items-center gap-4 hover:bg-blue-50 transition border-l-4 border-blue-500"
                    >
                        <div class="bg-blue-100 p-3 rounded-full text-2xl">
                            ðŸ‘¤
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-gray-900">Soy Cliente</h3>
                            <p class="text-xs text-gray-500">
                                Busca expertos y contrata
                            </p>
                        </div>
                        <span class="ml-auto text-gray-400">â†’</span>
                    </div>
                </a>
            </div>

            <div class="mt-12 text-center text-sm text-gray-400">
                <p>Â¿AÃºn no tienes cuenta?</p>
                <div class="flex gap-4 justify-center mt-2">
                    <a
                        href="/registro-profesional"
                        class="text-orange-600 font-bold"
                        >Registrarme como Pro</a
                    >
                    <span class="text-gray-300">|</span>
                    <a href="/registro-cliente" class="text-blue-600 font-bold"
                        >Registrarme como Cliente</a
                    >
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { auth, db } from "../../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    const loadingState = document.getElementById("loading-state");
    const loginOptions = document.getElementById("login-options");

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Usuario logueado: Determinar tipo y redirigir
            try {
                // 1. Check Profesional
                const proRef = doc(db, "profesionales", user.uid);
                const proSnap = await getDoc(proRef);

                if (proSnap.exists()) {
                    console.log("ðŸ‘¤ Redirigiendo a Perfil Profesional...");
                    window.location.href = "/mi-perfil";
                    return;
                }

                // 2. Check Cliente (Si no es pro, asumimos cliente o checkeamos colecciÃ³n)
                console.log("ðŸ‘¤ Redirigiendo a Panel Cliente...");
                window.location.href = "/mi-cuenta";
            } catch (error) {
                console.error("Error al determinar rol:", error);
                // En caso de error, mostramos opciones por seguridad
                showLoginOptions();
            }
        } else {
            // Usuario NO logueado: Mostrar opciones
            showLoginOptions();
        }
    });

    function showLoginOptions() {
        if (loadingState) loadingState.style.display = "none";
        if (loginOptions) loginOptions.classList.remove("hidden");
    }
</script>

<style>
    .auth-gateway-container {
        height: 100vh;
        height: 100dvh;
        background-color: #f9fafb;
        padding: 20px;
        padding-bottom: 90px; /* Space for BottomNav */
        overflow-y: auto; /* Ensure scroll if tall */
    }

    .spinner-large {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid #ea580c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
