---
import Layout from "../../layouts/Layout.astro";
import LoginCliente from "../../components/LoginCliente.astro";
import { db } from "../../firebase/client";
import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
} from "firebase/firestore";

// 1. OBTENER EL SLUG DE LA URL
const { slug } = Astro.params;
let profesional = null;
let idProfesional = null;

// 2. BUSCAR EL PROFESIONAL EN BASE DE DATOS (Server Side)
if (slug) {
    // Intentamos buscar por campo 'slug'
    const q = query(collection(db, "profesionales"), where("slug", "==", slug));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        profesional = querySnapshot.docs[0].data();
        idProfesional = querySnapshot.docs[0].id;
    } else {
        // Si no existe por slug, intentamos por ID directo (backup)
        try {
            const docRef = doc(db, "profesionales", slug);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                profesional = docSnap.data();
                idProfesional = docSnap.id;
            }
        } catch (e) {}
    }
}

// Si no encontramos nada, redirigir o mostrar error
if (!profesional) return Astro.redirect("/404");
---

<Layout title={`Perfil de ${profesional.nombre} - DeOficios`}>
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="grid md:grid-cols-3 gap-8 items-start">
            <!-- LEFT COLUMN: STICKY PROFILE CARD -->
            <aside class="md:col-span-1 sticky top-24 space-y-6">
                <!-- Main Profile Card -->
                <div
                    class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm text-center relative overflow-hidden"
                >
                    <!-- Experto Badge Background Effect -->
                    {
                        profesional.plan === "experto" && (
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 to-orange-500" />
                        )
                    }

                    <div class="relative inline-block mb-4">
                        <img
                            src={profesional.foto ||
                                "https://ui-avatars.com/api/?name=" +
                                    profesional.nombre}
                            class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg mx-auto"
                        />
                        {
                            profesional.plan === "experto" && (
                                <span class="absolute bottom-0 right-0 bg-yellow-400 text-xs font-bold px-2 py-1 rounded-full border border-white shadow-sm">
                                    ‚≠ê EXPERTO
                                </span>
                            )
                        }
                    </div>

                    <h1
                        class="text-2xl font-bold text-gray-900 leading-tight mb-1"
                    >
                        {profesional.nombre}
                    </h1>
                    <p class="text-blue-600 font-bold mb-3">
                        {profesional.rubro_principal}
                    </p>

                    <!-- Stars -->
                    <div
                        class="flex items-center justify-center gap-2 mb-6 bg-gray-50 py-2 rounded-lg"
                    >
                        <div class="text-yellow-400 text-lg">
                            {
                                "‚òÖ".repeat(
                                    Math.round(profesional.puntuacion || 0),
                                )
                            }
                            <span class="text-gray-300"
                                >{
                                    "‚òÖ".repeat(
                                        5 -
                                            Math.round(
                                                profesional.puntuacion || 0,
                                            ),
                                    )
                                }</span
                            >
                        </div>
                        <span class="text-gray-500 text-xs font-bold">
                            ({profesional.total_valoraciones || 0})
                        </span>
                    </div>

                    <!-- Contact Buttons -->
                    {
                        profesional.telefono && (
                            <div class="space-y-3">
                                <button
                                    id="btn-whatsapp-contact"
                                    data-whatsapp={profesional.telefono}
                                    data-pro-id={idProfesional}
                                    data-pro-name={profesional.nombre}
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-transform transform active:scale-95 flex items-center justify-center gap-2"
                                >
                                    <span class="text-xl">üí¨</span> Contactar
                                </button>

                                <button
                                    id="btn-vcard-download"
                                    data-name={profesional.nombre}
                                    data-phone={profesional.telefono}
                                    data-rubro={profesional.rubro_principal}
                                    class="w-full bg-white border-2 border-slate-200 text-slate-700 hover:bg-slate-50 font-bold py-3 px-4 rounded-xl shadow-sm transition-transform transform active:scale-95 flex items-center justify-center gap-2"
                                >
                                    <span class="text-xl">üì≤</span> Guardar
                                </button>
                            </div>
                        )
                    }
                </div>

                <!-- Info Box (Map & Security) -->
                <div
                    class="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm space-y-4"
                >
                    {
                        profesional.zona && (
                            <div>
                                <h4 class="font-bold text-xs text-gray-400 uppercase tracking-wider mb-2">
                                    Zona
                                </h4>
                                <div class="flex items-center gap-2 text-gray-700 font-medium">
                                    <span>üìç</span> {profesional.zona}
                                </div>
                            </div>
                        )
                    }

                    <div class="border-t border-gray-100 pt-4">
                        <h4
                            class="font-bold text-xs text-gray-400 uppercase tracking-wider mb-2"
                        >
                            Seguridad
                        </h4>
                        <ul class="text-sm space-y-2">
                            <li
                                class={`flex items-center gap-2 font-bold ${profesional.verificado ? "text-green-600" : "text-orange-500"}`}
                            >
                                <span
                                    >{
                                        profesional.verificado ? "üõ°Ô∏è" : "‚è≥"
                                    }</span
                                >
                                {
                                    profesional.verificado
                                        ? "Identidad Verificada"
                                        : "Validaci√≥n Pendiente"
                                }
                            </li>
                            <li class="flex items-center gap-2 text-gray-500">
                                <span>üìÖ</span> Miembro desde 2024
                            </li>
                        </ul>
                    </div>
                </div>
            </aside>

            <!-- RIGHT COLUMN: CONTENT SCROLL -->
            <main class="md:col-span-2 space-y-8">
                <!-- About Section -->
                <section
                    class="bg-white p-8 rounded-2xl border border-gray-200 shadow-sm"
                >
                    <h3
                        class="font-bold text-xl text-gray-900 mb-4 flex items-center gap-2"
                    >
                        üëã Sobre m√≠
                    </h3>
                    <p
                        class="text-gray-600 leading-relaxed whitespace-pre-line text-lg"
                    >
                        {
                            profesional.descripcion ||
                                "Este profesional a√∫n no ha agregado una descripci√≥n."
                        }
                    </p>

                    {/* Etiquetas */}
                    {
                        profesional.etiquetas && (
                            <div class="mt-6 flex flex-wrap gap-2 pt-4 border-t border-gray-100">
                                {profesional.etiquetas.map((tag) => (
                                    <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-bold border border-blue-100">
                                        #{tag}
                                    </span>
                                ))}
                            </div>
                        )
                    }
                </section>

                <!-- Reviews Section -->
                <section id="reviews-section">
                    <div class="flex items-center justify-between mb-6">
                        <h3
                            class="font-bold text-2xl text-gray-900 flex items-center gap-2"
                        >
                            üåü Opiniones
                        </h3>
                        <span
                            class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full"
                        >
                            {profesional.total_valoraciones || 0} reviews
                        </span>
                    </div>

                    <div id="review-action-area" class="mb-8">
                        <div id="guest-view">
                            <LoginCliente />
                        </div>

                        <div
                            id="user-view"
                            class="hidden bg-white p-6 rounded-2xl border border-blue-100 shadow-md relative overflow-hidden"
                        >
                            <div
                                class="absolute top-0 right-0 w-20 h-20 bg-blue-50 rounded-full -mr-10 -mt-10 blur-xl"
                            >
                            </div>

                            <div
                                class="flex items-center gap-3 mb-4 relative z-10"
                            >
                                <img
                                    id="user-avatar"
                                    src=""
                                    class="w-10 h-10 rounded-full bg-gray-200 border-2 border-white shadow-sm"
                                />
                                <div>
                                    <p
                                        class="font-bold text-sm text-gray-900"
                                        id="user-name-display"
                                    >
                                        Cargando...
                                    </p>
                                    <p
                                        class="text-xs text-green-600 font-bold flex items-center gap-1"
                                    >
                                        ‚úÖ Cliente Verificado
                                    </p>
                                </div>
                            </div>

                            <label class="block font-bold mb-2 text-gray-700"
                                >Califica tu experiencia:</label
                            >

                            <div
                                class="flex gap-2 text-4xl mb-4 cursor-pointer"
                                id="stars-selector"
                            >
                                <button
                                    type="button"
                                    class="star text-gray-200 hover:text-yellow-400 transition-all hover:scale-110"
                                    data-value="1">‚òÖ</button
                                >
                                <button
                                    type="button"
                                    class="star text-gray-200 hover:text-yellow-400 transition-all hover:scale-110"
                                    data-value="2">‚òÖ</button
                                >
                                <button
                                    type="button"
                                    class="star text-gray-200 hover:text-yellow-400 transition-all hover:scale-110"
                                    data-value="3">‚òÖ</button
                                >
                                <button
                                    type="button"
                                    class="star text-gray-200 hover:text-yellow-400 transition-all hover:scale-110"
                                    data-value="4">‚òÖ</button
                                >
                                <button
                                    type="button"
                                    class="star text-gray-200 hover:text-yellow-400 transition-all hover:scale-110"
                                    data-value="5">‚òÖ</button
                                >
                            </div>
                            <p
                                id="rating-text"
                                class="text-sm text-gray-400 mb-3 font-medium min-h-[20px]"
                            >
                                - Selecciona estrellas -
                            </p>
                            <input type="hidden" id="rating-value" value="0" />

                            <textarea
                                id="review-comment"
                                class="w-full border border-gray-200 bg-gray-50 p-4 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all"
                                rows="3"
                                placeholder="¬øCumpli√≥ con lo pactado? ¬øFue puntual? Cu√©ntanos..."
                            ></textarea>

                            <button
                                id="btn-submit-review"
                                class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-blue-200"
                            >
                                Publicar Rese√±a
                            </button>
                        </div>
                    </div>

                    <div id="reviews-list" class="space-y-6">
                        <!-- Skeleton -->
                        <div
                            class="animate-pulse flex gap-4 bg-white p-4 rounded-xl border border-gray-100"
                        >
                            <div class="h-12 w-12 bg-gray-200 rounded-full">
                            </div>
                            <div class="flex-1 space-y-3 py-1">
                                <div class="h-4 bg-gray-200 rounded w-1/3">
                                </div>
                                <div class="h-4 bg-gray-200 rounded w-2/3">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
</Layout>

<script
    type="application/ld+json"
    set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        name: profesional.nombre,
        image:
            profesional.foto ||
            `https://ui-avatars.com/api/?name=${profesional.nombre}`,
        "@id": Astro.url.href,
        url: Astro.url.href,
        telephone: profesional.telefono ? `+549${profesional.telefono}` : "",
        address: {
            "@type": "PostalAddress",
            addressLocality: profesional.zona || "Argentina",
            addressCountry: "AR",
        },
        description:
            profesional.descripcion ||
            `Servicios de ${profesional.rubro_principal} en ${profesional.zona}`,
        aggregateRating:
            profesional.total_valoraciones > 0
                ? {
                      "@type": "AggregateRating",
                      ratingValue: profesional.puntuacion,
                      reviewCount: profesional.total_valoraciones,
                  }
                : undefined,
    })}
/>

<script define:vars={{ idProfesional }}>
    import { onAuthStateChanged } from "firebase/auth";
    import { auth, db } from "../../firebase/client";
    import Swal from "sweetalert2";
    import {
        doc,
        getDoc,
        addDoc,
        collection,
        updateDoc,
        increment,
        serverTimestamp,
        query,
        orderBy,
        getDocs,
        runTransaction,
    } from "firebase/firestore";

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [PERFIL] P√°gina cargada/navegada");

        const guestView = document.getElementById("guest-view");
        const userView = document.getElementById("user-view");
        let currentUser = null;

        // 1. DETECTAR USUARIO (CLIENTE)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario Logueado -> Buscamos sus datos de Cliente
                const docSnap = await getDoc(doc(db, "clientes", user.uid));

                if (docSnap.exists()) {
                    const cliente = docSnap.data();
                    currentUser = { uid: user.uid, ...cliente };

                    guestView.classList.add("hidden");
                    userView.classList.remove("hidden");

                    document.getElementById("user-name-display").innerText =
                        cliente.nombre;
                    const foto =
                        cliente.foto ||
                        `https://ui-avatars.com/api/?name=${cliente.nombre}&background=random`;
                    document.getElementById("user-avatar").src = foto;
                } else {
                    // Es logueado pero NO es cliente (quiz√°s es el mismo profesional)
                    if (user.uid === idProfesional) {
                        guestView.innerHTML = `<div class="p-4 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">üëÄ Est√°s viendo tu propio perfil.</div>`;
                    }
                }
            } else {
                // Usuario No Logueado
                guestView.classList.remove("hidden");
                userView.classList.add("hidden");
            }
        });

        // 2. L√ìGICA DE ESTRELLAS
        const stars = document.querySelectorAll("#stars-selector .star");
        const ratingInput = document.getElementById("rating-value");
        const ratingText = document.getElementById("rating-text");
        const labels = [
            "Malo üò°",
            "Regular üòê",
            "Bueno üôÇ",
            "Muy Bueno üòÑ",
            "Excelente üî•",
        ];

        stars.forEach((star, index) => {
            star.addEventListener("click", () => {
                const value = index + 1;
                ratingInput.value = value;
                ratingText.innerText = labels[index];

                // Pintar estrellas
                stars.forEach((s, i) => {
                    if (i < value) s.classList.add("text-yellow-400");
                    else s.classList.remove("text-yellow-400");
                });
            });
        });

        // 3. PUBLICAR RESE√ëA
        const btnSubmit = document.getElementById("btn-submit-review");
        btnSubmit.addEventListener("click", async () => {
            const rating = parseInt(ratingInput.value);
            const comment = document.getElementById("review-comment").value;

            if (rating === 0)
                return alert("Por favor selecciona las estrellas.");
            if (comment.length < 5)
                return alert("Escribe un comentario un poco m√°s largo.");

            btnSubmit.disabled = true;
            btnSubmit.innerText = "Publicando...";

            try {
                // TRANSACCI√ìN: Guardar rese√±a + Actualizar promedio del profesional
                await runTransaction(db, async (transaction) => {
                    const proRef = doc(db, "profesionales", idProfesional);
                    const proDoc = await transaction.get(proRef);

                    if (!proDoc.exists()) throw "Profesional no existe";

                    const data = proDoc.data();
                    const nuevoTotal = (data.total_valoraciones || 0) + 1;
                    const nuevaSuma = (data.suma_puntuacion || 0) + rating; // Necesitamos guardar la suma bruta
                    const nuevoPromedio = nuevaSuma / nuevoTotal;

                    // 1. Crear la rese√±a en subcolecci√≥n
                    const rese√±aRef = doc(
                        collection(
                            db,
                            `profesionales/${idProfesional}/rese√±as`,
                        ),
                    );
                    transaction.set(rese√±aRef, {
                        clienteId: currentUser.uid,
                        clienteNombre: currentUser.nombre,
                        clienteFoto: currentUser.foto || null,
                        estrellas: rating,
                        comentario: comment,
                        fecha: serverTimestamp(),
                    });

                    // 2. Actualizar promedio en el profesional
                    transaction.update(proRef, {
                        total_valoraciones: nuevoTotal,
                        suma_puntuacion: nuevaSuma, // Guardamos esto para c√°lculos precisos
                        puntuacion: nuevoPromedio,
                    });
                });

                alert("¬°Gracias! Tu opini√≥n ayuda a la comunidad.");
                window.location.reload(); // Recargar para ver la rese√±a nueva
            } catch (error) {
                console.error(error);
                alert("Error al publicar. Intenta de nuevo.");
                btnSubmit.disabled = false;
                btnSubmit.innerText = "Publicar Rese√±a";
            }
        });

        // 4. CARGAR RESE√ëAS EXISTENTES
        async function loadReviews() {
            const container = document.getElementById("reviews-list");
            const q = query(
                collection(db, `profesionales/${idProfesional}/rese√±as`),
                orderBy("fecha", "desc"),
            );

            const snapshot = await getDocs(q);

            container.innerHTML = ""; // Limpiar skeleton

            if (snapshot.empty) {
                container.innerHTML = `<p class="text-gray-500 italic text-center py-4">A√∫n no hay opiniones. ¬°S√© el primero!</p>`;
                return;
            }

            snapshot.forEach((doc) => {
                const r = doc.data();
                const fecha = r.fecha
                    ? r.fecha.toDate().toLocaleDateString()
                    : "Reciente";

                const html = `
                <div class="border-b border-gray-100 pb-4 mb-4 last:border-0">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <img src="${r.clienteFoto || `https://ui-avatars.com/api/?name=${r.clienteNombre}`}" class="w-8 h-8 rounded-full">
                            <div>
                                <p class="font-bold text-sm text-gray-800">${r.clienteNombre}</p>
                                <div class="text-yellow-400 text-xs">
                                    ${"‚òÖ".repeat(r.estrellas)}${"‚òÜ".repeat(5 - r.estrellas)}
                                </div>
                            </div>
                        </div>
                        <span class="text-xs text-gray-400">${fecha}</span>
                    </div>
                    <p class="mt-2 text-gray-600 text-sm">${r.comentario}</p>
                    ${
                        r.fotoTrabajo
                            ? `
                    <div class="mt-3 rounded-xl overflow-hidden border border-gray-100 max-w-xs shadow-sm">
                        <img src="${r.fotoTrabajo}" class="w-full h-auto object-cover cursor-pointer hover:opacity-90 transition" onclick="window.open('${r.fotoTrabajo}', '_blank')">
                    </div>
                    `
                            : ""
                    }
                </div>
            `;
                container.innerHTML += html;
            });
        }

        // 5. SAFETY TOKEN & WHATSAPP CONTACT
        const btnContact = document.getElementById("btn-whatsapp-contact");
        btnContact?.addEventListener("click", async () => {
            const whatsapp = btnContact.dataset.whatsapp;
            const proId = btnContact.dataset.proId;
            const proName = btnContact.dataset.proName;

            // Generate 4 digit token
            const safetyToken = Math.floor(
                1000 + Math.random() * 9000,
            ).toString();

            // @ts-ignore
            Swal.fire({
                title: "üõ°Ô∏è C√≥digo de Seguridad",
                html: `
                    <p class="mb-4">Tu c√≥digo de verificaci√≥n para <strong>${proName}</strong> es:</p>
                    <div class="text-4xl font-bold tracking-widest text-orange-600 bg-orange-50 py-4 rounded-xl border-2 border-orange-200 mb-4">
                        ${safetyToken}
                    </div>
                    <p class="text-xs text-gray-500 uppercase font-bold tracking-tight">Mostrale este c√≥digo al profesional al llegar</p>
                `,
                confirmButtonText: "Ir a WhatsApp üí¨",
                confirmButtonColor: "#16a34a",
                showCancelButton: true,
                cancelButtonText: "Cancelar",
                reverseButtons: true,
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // Log the contact event
                    try {
                        await addDoc(collection(db, "contactos"), {
                            proId: proId,
                            proNombre: proName,
                            clienteId: currentUser?.uid || "anonimo",
                            clienteNombre: currentUser?.nombre || "Anonimo",
                            token: safetyToken,
                            fecha: serverTimestamp(),
                            visto: false,
                        });

                        // Redirect to WA
                        window.open(
                            `https://wa.me/549${whatsapp}?text=${encodeURIComponent(`Hola ${proName}, te contacto desde DeOficios. Mi c√≥digo de seguridad es ${safetyToken}`)}`,
                            "_blank",
                        );

                        // SHOW FEEDBACK PROMPT after a delay
                        setTimeout(() => {
                            // @ts-ignore
                            Swal.fire({
                                title: "¬øPudiste contactarlo? ü§î",
                                text: "Tu feedback nos ayuda a mantener profesionales activos.",
                                icon: "question",
                                showDenyButton: true,
                                showCancelButton: true,
                                confirmButtonText: "‚úÖ S√≠, todo bien",
                                denyButtonText: "‚ùå No contest√≥",
                                cancelButtonText: "üö© Reportar Perfil",
                                confirmButtonColor: "#16a34a",
                                denyButtonColor: "#ef4444",
                                cancelButtonColor: "#374151",
                            }).then(async (res) => {
                                let feedbackType = "";
                                if (res.isConfirmed) feedbackType = "positivo";
                                else if (res.isDenied)
                                    feedbackType = "sin_respuesta";
                                else if (
                                    res.isDismissed &&
                                    res.dismiss === "cancel"
                                )
                                    feedbackType = "reporte";

                                if (feedbackType) {
                                    // Save feedback
                                    await addDoc(
                                        collection(db, "feedback_contactos"),
                                        {
                                            proId: proId,
                                            tipo: feedbackType,
                                            fecha: serverTimestamp(),
                                            uid: currentUser?.uid || "anonimo",
                                        },
                                    );
                                }
                            });
                        }, 5000);
                    } catch (e) {
                        console.error("Error logging contact:", e);
                    }
                }
            });
        });

        // 6. vCARD DOWNLOAD
        const btnVCard = document.getElementById("btn-vcard-download");
        btnVCard?.addEventListener("click", () => {
            const name = btnVCard.dataset.name;
            const phone = btnVCard.dataset.phone;
            const rubro = btnVCard.dataset.rubro;

            const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${name} (DeOficios)
ORG:DeOficios - ${rubro}
TEL;TYPE=CELL,VOICE:+549${phone}
END:VCARD`;

            const blob = new Blob([vcard], { type: "text/vcard" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${name.replace(/\s+/g, "_")}_DeOficios.vcf`;
            a.click();
            window.URL.revokeObjectURL(url);
        });

        loadReviews();
    }); // End of astro:page-load
</script>
