---
import Layout from "../../layouts/Layout.astro";
import LoginCliente from "../../components/LoginCliente.astro";
import { db } from "../../firebase/client";
import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
} from "firebase/firestore";

// 1. OBTENER EL SLUG DE LA URL
const { slug } = Astro.params;
let profesional = null;
let idProfesional = null;

// 2. BUSCAR EL PROFESIONAL EN BASE DE DATOS (Server Side)
if (slug) {
    // Intentamos buscar por campo 'slug'
    const q = query(collection(db, "profesionales"), where("slug", "==", slug));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        profesional = querySnapshot.docs[0].data();
        idProfesional = querySnapshot.docs[0].id;
    } else {
        // Si no existe por slug, intentamos por ID directo (backup)
        try {
            const docRef = doc(db, "profesionales", slug);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                profesional = docSnap.data();
                idProfesional = docSnap.id;
            }
        } catch (e) {}
    }
}

// Si no encontramos nada, redirigir o mostrar error
if (!profesional) return Astro.redirect("/404");
---

<Layout title={`Perfil de ${profesional.nombre} - DeOficios`}>
    <!-- Map Script (Head) -->
    <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- NEW PREMIUM HEADER (REFERENCE BASED) -->
    <div class="relative w-full max-w-6xl mx-auto px-0 sm:px-4 mt-4">
        <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-xl border border-slate-100">
            <!-- TOP GRADIENT SECTION -->
            <div class="relative h-64 bg-gradient-to-br from-orange-500 via-orange-400 to-amber-300 flex items-center justify-center">
                <!-- Profile Image -->
                <div class="relative group">
                    <img
                        src={profesional.foto || "https://ui-avatars.com/api/?name=" + profesional.nombre}
                        class="w-40 h-40 rounded-full object-cover border-4 border-white shadow-2xl transition-transform duration-500 group-hover:scale-105"
                        alt={profesional.nombre}
                    />
                    {profesional.plan === "experto" && (
                        <div class="absolute -bottom-2 right-4 bg-yellow-400 text-slate-900 p-1.5 rounded-full border-2 border-white shadow-lg animate-bounce">
                            <span class="material-symbols-outlined text-sm font-bold">star</span>
                        </div>
                    )}
                </div>
            </div>

            <!-- INFO CARD SECTION -->
            <div class="relative bg-white -mt-12 rounded-t-[3rem] px-8 pt-10 pb-12 shadow-inner">
                <div class="flex flex-col md:flex-row justify-between items-start gap-6">
                    <!-- Left: Identity & Badges -->
                    <div class="flex-1 space-y-4">
                        <div class="flex flex-wrap items-center gap-4">
                            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">
                                {profesional.nombre}
                            </h1>
                            
                            <!-- Badges -->
                            <div class="flex items-center gap-2">
                                <span class="bg-slate-900 text-white text-[10px] font-black px-4 py-2 rounded-full tracking-[0.2em] uppercase flex items-center gap-2">
                                    {profesional.plan === "experto" ? "EXPERTO" : "PROFESIONAL"}
                                    <span class="material-symbols-outlined text-[12px]">handyman</span>
                                </span>
                                
                                <div class="flex items-center -space-x-1">
                                    <div class="w-8 h-8 rounded-full bg-amber-50 flex items-center justify-center border-2 border-white shadow-sm" title="Gold Member">üèÖ</div>
                                    <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center border-2 border-white shadow-sm" title="Verified Security">üõ°Ô∏è</div>
                                </div>
                            </div>
                        </div>

                        <p class="text-slate-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm text-orange-500">location_on</span>
                            {profesional.zona || "Argentina"}
                            <span class="w-1 h-1 bg-slate-200 rounded-full"></span>
                            <span class="text-slate-500">{profesional.verificado ? "Identidad Verificada" : "Validaci√≥n Identidad"}</span>
                        </p>

                        <!-- Rating & Category -->
                        <div class="flex flex-wrap items-center gap-6 pt-2">
                            <div class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100">
                                <span class="text-orange-500 font-black text-lg">‚òÖ</span>
                                <span class="text-slate-900 font-extrabold text-lg">{ (profesional.puntuacion || 0).toFixed(1) }</span>
                                <span class="text-slate-400 text-xs font-bold uppercase tracking-wide">({profesional.total_valoraciones || 0} rese√±as)</span>
                            </div>

                            <div class="flex items-center gap-2 text-slate-500 font-bold text-sm bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100">
                                <span class="material-symbols-outlined text-lg text-slate-400">work</span>
                                {profesional.rubro_principal}
                            </div>
                        </div>
                    </div>

                    <!-- Right: CTAs -->
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        
                        <!-- Floating Heart Interaction -->
                        <button id="btn-toggle-fav" class="w-14 h-14 rounded-full bg-red-50 text-red-500 flex items-center justify-center shadow-lg border-2 border-white hover:scale-110 active:scale-90 transition-all shrink-0">
                            <span class="material-symbols-outlined font-bold">favorite</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 md:px-8 max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-10 lg:gap-16 items-start">
        <div class="lg:col-span-8 space-y-8 lg:space-y-12">
            <!-- PORTFOLIO SECTION -->
            {profesional.portfolio && profesional.portfolio.length > 0 && (
                <section id="portfolio" class="mb-24 mt-12">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-2xl font-black text-slate-900 tracking-tight uppercase">Portafolio Destacado</h2>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {profesional.portfolio.map((img: any, index: number) => {
                            const isLegacy = typeof img === "string";
                            const url = isLegacy ? img : (img.url || img.URL || "");
                            const title = isLegacy ? "" : (img.titulo || "");
                            const desc = isLegacy ? "" : (img.descripcion || "");
                            const date = isLegacy ? "" : (img.fecha || "");
                            
                            if (!url) return null;
                            return (
                                <div class="group bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-500 border border-slate-100 cursor-pointer open-lightbox" data-index={index}>
                                    <div class="relative h-64 overflow-hidden bg-slate-50">
                                        <img 
                                            src={url} 
                                            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                            alt={title || "Foto de trabajo"}
                                            loading="lazy"
                                        />
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-6">
                                            <span class="bg-white/20 backdrop-blur-md text-white text-[10px] font-black px-4 py-2 rounded-full tracking-widest uppercase border border-white/30">Ver pantalla completa</span>
                                        </div>
                                    </div>
                                    {(title || desc || date) && (
                                        <div class="p-6 space-y-2">
                                            {title && <h4 class="font-black text-slate-900 text-lg leading-tight">{title}</h4>}
                                            {desc && <p class="text-sm text-slate-500 line-clamp-2 leading-relaxed">{desc}</p>}
                                            {date && (
                                                <div class="flex items-center gap-2 text-[10px] font-black text-orange-600 uppercase tracking-widest pt-2">
                                                    <span class="material-symbols-outlined text-sm">calendar_today</span>
                                                    {date}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </section>
            )}

            <div class="h-32"></div> <!-- Extra spacing -->

            <section id="reviews-section">
                <h3 class="font-bold text-xl mb-6 flex items-center gap-2">
                    üåü Opiniones y Calificaciones
                </h3>

                <div id="review-action-area" class="mb-10">
                    <div id="guest-view">
                        <LoginCliente />
                    </div>

                    <div
                        id="user-view"
                        class="hidden bg-white p-6 rounded-xl border border-blue-100 shadow-md"
                    >
                        <div class="flex items-center gap-3 mb-4">
                            <img
                                id="user-avatar"
                                src=""
                                class="w-10 h-10 rounded-full bg-gray-200"
                            />
                            <div>
                                <p
                                    class="font-bold text-sm"
                                    id="user-name-display"
                                >
                                    Cargando...
                                </p>
                                <p class="text-xs text-green-600 font-semibold">
                                    Cliente Verificado ‚úÖ
                                </p>
                            </div>
                        </div>

                        <label class="block font-bold mb-2 text-gray-700"
                            >Califica tu experiencia:</label
                        >

                        <div
                            class="flex gap-1 text-4xl mb-4 cursor-pointer"
                            id="stars-selector"
                        >
                            <button
                                type="button"
                                class="star text-gray-300 hover:text-yellow-400 transition-colors"
                                data-value="1">‚òÖ</button
                            >
                            <button
                                type="button"
                                class="star text-gray-300 hover:text-yellow-400 transition-colors"
                                data-value="2">‚òÖ</button
                            >
                            <button
                                type="button"
                                class="star text-gray-300 hover:text-yellow-400 transition-colors"
                                data-value="3">‚òÖ</button
                            >
                            <button
                                type="button"
                                class="star text-gray-300 hover:text-yellow-400 transition-colors"
                                data-value="4">‚òÖ</button
                            >
                            <button
                                type="button"
                                class="star text-gray-300 hover:text-yellow-400 transition-colors"
                                data-value="5">‚òÖ</button
                            >
                        </div>
                        <p
                            id="rating-text"
                            class="text-sm text-gray-500 mb-3 font-medium"
                        >
                            - Selecciona estrellas -
                        </p>
                        <input type="hidden" id="rating-value" value="0" />

                        <textarea
                            id="review-comment"
                            class="w-full border border-gray-300 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                            rows="3"
                            placeholder="¬øCumpli√≥ con lo pactado? ¬øFue puntual? Cu√©ntanos..."
                        ></textarea>

                        <button
                            id="btn-submit-review"
                            class="bg-blue-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all w-full md:w-auto"
                        >
                            Publicar Rese√±a
                        </button>
                    </div>
                </div>

                <div id="reviews-list" class="space-y-4">
                    <div class="animate-pulse flex space-x-4">
                        <div class="h-10 w-10 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="lg:col-span-4 space-y-12 lg:sticky lg:top-24">
            {
                profesional.latitud && (
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mt-12">
                        <h4 class="font-bold text-sm mb-3 text-gray-500 uppercase">
                            Zona de Trabajo
                        </h4>
                        <div 
                            id="mini-map" 
                            class="w-full h-48 rounded-xl bg-gray-200" 
                            data-lat={profesional.ubicacion_exacta?.lat || profesional.latitud} 
                            data-lng={profesional.ubicacion_exacta?.lng || profesional.longitud}
                        ></div>
                        <p class="text-sm mt-2 text-center text-slate-500 font-medium">
                            {profesional.zona}
                        </p>
                    </div>
                )
            }

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <h4 class="font-bold text-blue-800 mb-2">Seguridad</h4>
                <ul class="text-sm text-blue-700 space-y-2">
                    <li class="flex items-center gap-2">
                        <span>{profesional.verificado ? "‚úÖ" : "‚è≥"}</span>
                        {
                            profesional.verificado
                                ? "Identidad Verificada"
                                : "Validaci√≥n Pendiente"
                        }
                    </li>
                    <li class="flex items-center gap-2">
                        üìÖ Miembro desde 2024
                    </li>
                </ul>
            </div>
        </div>
    </div>
</Layout>

<script
    type="application/ld+json"
    set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        name: profesional.nombre,
        image:
            profesional.foto ||
            `https://ui-avatars.com/api/?name=${profesional.nombre}`,
        "@id": Astro.url.href,
        url: Astro.url.href,
        telephone: profesional.telefono ? `+549${profesional.telefono}` : "",
        address: {
            "@type": "PostalAddress",
            addressLocality: profesional.zona || "Argentina",
            addressCountry: "AR",
        },
        description:
            profesional.descripcion ||
            `Servicios de ${profesional.rubro_principal} en ${profesional.zona}`,
        aggregateRating:
            profesional.total_valoraciones > 0
                ? {
                      "@type": "AggregateRating",
                      ratingValue: profesional.puntuacion,
                      reviewCount: profesional.total_valoraciones,
                  }
                : undefined,
    })}
/>

<script define:vars={{ idProfesional }}>
    import { onAuthStateChanged } from "firebase/auth";
    import { auth, db } from "../../firebase/client";
    import {
        doc,
        getDoc,
        addDoc,
        collection,
        updateDoc,
        increment,
        serverTimestamp,
        query,
        orderBy,
        getDocs,
        runTransaction,
    } from "firebase/firestore";

    document.addEventListener("astro:page-load", () => {
        console.log("üöÄ [PERFIL] P√°gina cargada/navegada");

        // 0. L√ìGICA DE FAVORITOS
        const btnFav = document.getElementById("btn-toggle-fav");
        if (btnFav) {
            onAuthStateChanged(auth, async (user) => {
                if (!user) return;

                const favRef = doc(db, "favoritos", user.uid);
                let isFav = false;

                try {
                    const favSnap = await getDoc(favRef);
                    if (favSnap.exists()) {
                        const list = favSnap.data().profesionales || [];
                        isFav = list.some((p: any) => p.id === idProfesional);
                    }
                } catch (e) {}

                updateFavIcon(isFav);

                btnFav.addEventListener("click", async () => {
                   /** @ts-ignore */
                   const Swal = window.Swal;
                   
                   isFav = !isFav;
                   updateFavIcon(isFav);

                   try {
                       if (isFav) {
                           const { arrayUnion, setDoc } = await import("firebase/firestore");
                           await setDoc(favRef, {
                               profesionales: arrayUnion({
                                   id: idProfesional,
                                   nombre: profesional.nombre,
                                   rubro: profesional.rubro_principal,
                                   foto: profesional.foto || "",
                                   zona: profesional.zona || ""
                               })
                           }, { merge: true });
                       } else {
                           const currentSnap = await getDoc(favRef);
                           if (currentSnap.exists()) {
                               const list = currentSnap.data().profesionales || [];
                               const newList = list.filter((p: any) => p.id !== idProfesional);
                               await updateDoc(favRef, { profesionales: newList });
                           }
                       }
                   } catch (e) {
                       isFav = !isFav;
                       updateFavIcon(isFav);
                   }
                });
            });
        }

        function updateFavIcon(fav: boolean) {
            const icon = btnFav?.querySelector(".material-symbols-outlined");
            if (!icon) return;
            /** @ts-ignore */
            if (fav) {
                /** @ts-ignore */
                icon.style.fontVariationSettings = "'FILL' 1";
                btnFav?.classList.add("text-red-500", "bg-red-50");
                btnFav?.classList.remove("text-slate-400", "bg-slate-50");
            } else {
                /** @ts-ignore */
                icon.style.fontVariationSettings = "'FILL' 0";
                btnFav?.classList.remove("text-red-500", "bg-red-50");
                btnFav?.classList.add("text-slate-400", "bg-slate-50");
            }
        }

        const guestView = document.getElementById("guest-view");
        const userView = document.getElementById("user-view");
        let currentUser = null;

        // 1. DETECTAR USUARIO (CLIENTE)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario Logueado -> Buscamos sus datos de Cliente
                const docSnap = await getDoc(doc(db, "clientes", user.uid));

                if (docSnap.exists()) {
                    const cliente = docSnap.data();
                    currentUser = { uid: user.uid, ...cliente };

                    guestView.classList.add("hidden");
                    userView.classList.remove("hidden");

                    document.getElementById("user-name-display").innerText =
                        cliente.nombre;
                    const foto =
                        cliente.foto ||
                        `https://ui-avatars.com/api/?name=${cliente.nombre}&background=random`;
                    document.getElementById("user-avatar").src = foto;
                } else {
                    // Es logueado pero NO es cliente (quiz√°s es el mismo profesional)
                    if (user.uid === idProfesional) {
                        guestView.innerHTML = `<div class="p-4 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">üëÄ Est√°s viendo tu propio perfil.</div>`;
                    }
                }
            } else {
                // Usuario No Logueado
                guestView.classList.remove("hidden");
                userView.classList.add("hidden");
            }
        });

        // 2. L√ìGICA DE ESTRELLAS
        const stars = document.querySelectorAll("#stars-selector .star");
        const ratingInput = document.getElementById("rating-value");
        const ratingText = document.getElementById("rating-text");
        const labels = [
            "Malo üò°",
            "Regular üòê",
            "Bueno üôÇ",
            "Muy Bueno üòÑ",
            "Excelente üî•",
        ];

        stars.forEach((star, index) => {
            star.addEventListener("click", () => {
                const value = index + 1;
                ratingInput.value = value;
                ratingText.innerText = labels[index];

                // Pintar estrellas
                stars.forEach((s, i) => {
                    if (i < value) s.classList.add("text-yellow-400");
                    else s.classList.remove("text-yellow-400");
                });
            });
        });

        // 3. PUBLICAR RESE√ëA
        const btnSubmit = document.getElementById("btn-submit-review");
        btnSubmit.addEventListener("click", async () => {
            const rating = parseInt(ratingInput.value);
            const comment = document.getElementById("review-comment").value;

            if (rating === 0)
                return alert("Por favor selecciona las estrellas.");
            if (comment.length < 5)
                return alert("Escribe un comentario un poco m√°s largo.");

            btnSubmit.disabled = true;
            btnSubmit.innerText = "Publicando...";

            try {
                // TRANSACCI√ìN: Guardar rese√±a + Actualizar promedio del profesional
                await runTransaction(db, async (transaction) => {
                    const proRef = doc(db, "profesionales", idProfesional);
                    const proDoc = await transaction.get(proRef);

                    if (!proDoc.exists()) throw "Profesional no existe";

                    const data = proDoc.data();
                    const nuevoTotal = (data.total_valoraciones || 0) + 1;
                    const nuevaSuma = (data.suma_puntuacion || 0) + rating; // Necesitamos guardar la suma bruta
                    const nuevoPromedio = nuevaSuma / nuevoTotal;

                    // 1. Crear la rese√±a en subcolecci√≥n
                    const rese√±aRef = doc(
                        collection(
                            db,
                            `profesionales/${idProfesional}/resenas`,
                        ),
                    );
                    transaction.set(rese√±aRef, {
                        clienteId: currentUser.uid,
                        clienteNombre: currentUser.nombre,
                        clienteFoto: currentUser.foto || null,
                        estrellas: rating,
                        comentario: comment,
                        fecha: serverTimestamp(),
                    });

                    // 2. Actualizar promedio en el profesional
                    transaction.update(proRef, {
                        total_valoraciones: nuevoTotal,
                        suma_puntuacion: nuevaSuma, // Guardamos esto para c√°lculos precisos
                        puntuacion: nuevoPromedio,
                    });
                });


                // Import SweetAlert2
                const Swal = (await import('sweetalert2')).default;
                
                await Swal.fire({
                    icon: 'success',
                    title: '¬°Gracias!',
                    text: 'Tu opini√≥n ayuda a la comunidad.',
                    confirmButtonText: 'Aceptar',
                    confirmButtonColor: '#2563eb',
                    timer: 3000,
                    timerProgressBar: true
                });
                
                window.location.reload(); // Recargar para ver la rese√±a nueva
            } catch (error) {
                console.error(error);
                alert("Error al publicar. Intenta de nuevo.");
                btnSubmit.disabled = false;
                btnSubmit.innerText = "Publicar Rese√±a";
            }
        });

        // 4. CARGAR RESE√ëAS EXISTENTES
        async function loadReviews() {
            const container = document.getElementById("reviews-list");
            const q = query(
                collection(db, `profesionales/${idProfesional}/resenas`),
                orderBy("fecha", "desc"),
            );

            const snapshot = await getDocs(q);

            container.innerHTML = ""; // Limpiar skeleton

            if (snapshot.empty) {
                container.innerHTML = `<p class="text-gray-500 italic text-center py-4">A√∫n no hay opiniones. ¬°S√© el primero!</p>`;
                return;
            }

            snapshot.forEach((doc) => {
                const r = doc.data();
                const fecha = r.fecha
                    ? r.fecha.toDate().toLocaleDateString()
                    : "Reciente";

                const html = `
                <div class="border-b border-gray-100 pb-4 mb-4 last:border-0">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <img src="${r.clienteFoto || `https://ui-avatars.com/api/?name=${r.clienteNombre}`}" class="w-8 h-8 rounded-full">
                            <div>
                                <p class="font-bold text-sm text-gray-800">${r.clienteNombre}</p>
                                <div class="text-yellow-400 text-xs">
                                    ${"‚òÖ".repeat(r.estrellas)}${"‚òÜ".repeat(5 - r.estrellas)}
                                </div>
                            </div>
                        </div>
                        <span class="text-xs text-gray-400">${fecha}</span>
                    </div>
                    <p class="mt-2 text-gray-600 text-sm">${r.comentario}</p>
                </div>
            `;
                container.innerHTML += html;
            });
            
            // Actualizar el contador de estrellas y opiniones en el header
            updateRatingDisplay();
        }

        // Funci√≥n para actualizar la visualizaci√≥n de calificaci√≥n
        async function updateRatingDisplay() {
            console.log("üîÑ updateRatingDisplay() ejecut√°ndose...");
            try {
                // Obtener datos actualizados del profesional
                const proRef = doc(db, "profesionales", idProfesional);
                const proSnap = await getDoc(proRef);
                
                if (!proSnap.exists()) {
                    console.error("‚ùå Profesional no existe");
                    return;
                }
                
                const proData = proSnap.data();
                const rating = proData.puntuacion || 0;
                const totalReviews = proData.total_valoraciones || 0;
                
                console.log("üìä Datos del profesional:", { rating, totalReviews, proData });
                
                // Actualizar estrellas
                const starsContainer = document.querySelector('.text-yellow-400.text-xl');
                console.log("‚≠ê Stars container:", starsContainer);
                if (starsContainer) {
                    const fullStars = Math.round(rating);
                    const emptyStars = 5 - fullStars;
                    const newHTML = "‚òÖ".repeat(fullStars) + 
                        '<span class="text-gray-300">' + "‚òÖ".repeat(emptyStars) + '</span>';
                    console.log("‚≠ê Actualizando estrellas:", { fullStars, emptyStars, newHTML });
                    starsContainer.innerHTML = newHTML;
                }
                
                // Actualizar contador de opiniones
                const reviewCountSpan = document.querySelector('.text-gray-500.text-sm');
                console.log("üí¨ Review count span:", reviewCountSpan);
                if (reviewCountSpan && reviewCountSpan.textContent.includes('opiniones')) {
                    const newText = `(${totalReviews} ${totalReviews === 1 ? 'opini√≥n' : 'opiniones'})`;
                    console.log("üí¨ Actualizando contador:", newText);
                    reviewCountSpan.textContent = newText;
                }
                
                console.log("‚úÖ updateRatingDisplay() completado");
            } catch (error) {
                console.error("‚ùå Error actualizando rating display:", error);
            }
        }

        loadReviews();
    }); // End of astro:page-load
</script>
<ProfileLightbox client:load images={profesional.portfolio || []} />

<script is:inline>
    // Map Initialization
    document.addEventListener("astro:page-load", () => {
        try {
            const mapContainer = document.getElementById("mini-map");
            if (mapContainer && window.L) {
                const lat = parseFloat(mapContainer.dataset.lat);
                const lng = parseFloat(mapContainer.dataset.lng);

                if (!isNaN(lat) && !isNaN(lng)) {
                    if (mapContainer._leaflet_id) return; // Prevent re-initialization

                    const map = L.map("mini-map", {
                        center: [lat, lng],
                        zoom: 15,
                        attributionControl: false,
                        zoomControl: false,
                    });

                    L.tileLayer(
                        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
                        {
                            maxZoom: 19,
                        },
                    ).addTo(map);

                    L.circle([lat, lng], {
                        color: '#f97316', // Primary Orange
                        fillColor: '#f97316',
                        fillOpacity: 0.15,
                        radius: 800, // 800 meters approx
                        weight: 1
                    }).addTo(map);

                    // Add text label for context
                    L.popup({
                        closeButton: false,
                        autoClose: false,
                        closeOnClick: false,
                        className: 'zone-popup text-center font-bold text-xs',
                        offset: [0, -10]
                    })
                    .setLatLng([lat, lng])
                    .setContent('<div class="text-orange-600">Zona de Cobertura</div>')
                    .openOn(map);
                }
            }
        } catch(e) { console.error("Error in profile mapping:", e); }
    });
</script>

<style>
    /* Fix map */
    #mini-map {
        height: 200px;
        width: 100%;
        background: #f0f0f0;
        z-index: 1;
        min-height: 200px; /* Force height */
    }
    .leaflet-container {
        font-family: inherit;
    }
</style>
