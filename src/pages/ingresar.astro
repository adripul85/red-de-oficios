---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Ingresar - DeOficios">
  <div
    class="min-h-screen flex font-sans bg-slate-50 dark:bg-slate-900 transition-colors duration-300"
  >
    <!-- BANNER IZQUIERDO (Oculto en m√≥vil) -->
    <div
      class="hidden lg:flex flex-1 relative bg-cover bg-center"
      style="background-image: url('https://images.unsplash.com/photo-1621905251189-08b45d6a269e?q=80&w=1000&auto=format&fit=crop');"
    >
      <div class="absolute inset-0 bg-black/60 z-10"></div>
      <div class="relative z-20 max-w-md text-center text-white p-12">
        <h1 class="text-5xl font-bold mb-6 drop-shadow-lg">
          ¬°Bienvenido Colega! üõ†Ô∏è
        </h1>
        <p class="text-xl opacity-90 leading-relaxed">
          Sumate a la red de oficios m√°s grande del barrio. Consegu√≠ clientes y
          mostr√° tu trabajo al mundo.
        </p>
      </div>
    </div>

    <!-- FORMULARIO DERECHO -->
    <div
      class="flex-1 flex flex-col justify-center p-6 sm:p-12 lg:p-24 bg-white dark:bg-slate-900 transition-colors duration-300"
    >
      <div class="w-full max-w-md mx-auto">
        <!-- HEADER -->
        <div class="flex justify-between items-center mb-10">
          <a
            href="/"
            class="text-slate-500 hover:text-orange-600 dark:text-slate-400 dark:hover:text-orange-400 text-sm font-medium transition-colors"
          >
            ‚Üê Volver al inicio
          </a>
          <img src="/favicon.svg" alt="Logo" class="w-10 h-10" />
        </div>

        <!-- TABS -->
        <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl mb-8">
          <button
            class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all duration-200 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 tab-btn active"
            id="tab-login"
          >
            Ingresar
          </button>
          <a
            href="/registro-profesional"
            class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all duration-200 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-center block tab-btn"
            style="text-decoration: none;"
          >
            Crear Cuenta
          </a>
        </div>

        <!-- FORM LOGIN -->
        <form id="form-login" class="auth-form active space-y-6">
          <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">
              Hola de nuevo üëã
            </h2>
            <p class="text-slate-500 dark:text-slate-400">
              Ingres√° tus datos para gestionar tu perfil.
            </p>
          </div>

          <div class="space-y-2">
            <label
              class="block text-sm font-bold text-slate-700 dark:text-slate-200"
              >Email</label
            >
            <input
              type="email"
              id="login-email"
              placeholder="ejemplo@correo.com"
              required
              class="w-full px-4 py-3 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
            />
          </div>

          <div class="space-y-2">
            <label
              class="block text-sm font-bold text-slate-700 dark:text-slate-200"
              >Contrase√±a</label
            >
            <input
              type="password"
              id="login-password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
              class="w-full px-4 py-3 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition-all placeholder-slate-400"
            />
          </div>

          <button
            type="submit"
            class="w-full py-3.5 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg shadow-lg shadow-orange-500/30 transition-all transform active:scale-95"
          >
            Ingresar
          </button>

          <div class="text-right">
            <a
              href="/recuperacion"
              class="text-sm text-slate-500 hover:text-orange-600 dark:text-slate-400 dark:hover:text-orange-400"
            >
              ¬øOlvidaste tu contrase√±a?
            </a>
          </div>

          <div class="relative py-4">
            <div class="absolute inset-0 flex items-center">
              <div
                class="w-full border-t border-slate-200 dark:border-slate-700"
              >
              </div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span
                class="px-4 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400"
                >O ingres√° con</span
              >
            </div>
          </div>

          <button
            type="button"
            id="btn-google-login"
            class="w-full py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-bold rounded-lg flex items-center justify-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 48 48"
            >
              <path
                fill="#FFC107"
                d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
              ></path>
              <path
                fill="#FF3D00"
                d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
              ></path>
              <path
                fill="#4CAF50"
                d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
              ></path>
              <path
                fill="#1976D2"
                d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
              ></path>
            </svg>
            Google
          </button>
        </form>

        <!-- FORM REGISTER (OCULTO INICIALMENTE) -->
        <div
          id="form-register"
          class="auth-form hidden space-y-6 text-center py-12"
        >
          <div
            class="w-20 h-20 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center text-4xl mx-auto mb-6"
          >
            üöÄ
          </div>
          <h2 class="text-2xl font-bold text-slate-800 dark:text-white">
            Crea tu Perfil Profesional
          </h2>
          <p class="text-slate-500 dark:text-slate-400 max-w-xs mx-auto mb-8">
            Para unirte a la red, necesitamos conocer tu oficio, zona y
            experiencia.
          </p>

          <a
            href="/registro-profesional"
            class="block w-full py-4 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl shadow-lg shadow-orange-500/30 transition-all transform active:scale-[0.98]"
          >
            Comenzar Registro
          </a>

          <div class="relative py-4">
            <div class="absolute inset-0 flex items-center">
              <div
                class="w-full border-t border-slate-200 dark:border-slate-700"
              >
              </div>
            </div>
            <div class="relative flex justify-center text-sm">
              <span
                class="px-4 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400"
                >O registrate con</span
              >
            </div>
          </div>

          <button
            type="button"
            id="btn-google-register"
            class="w-full py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-bold rounded-lg flex items-center justify-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 48 48"
            >
              <path
                fill="#FFC107"
                d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
              ></path>
              <path
                fill="#FF3D00"
                d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
              ></path>
              <path
                fill="#4CAF50"
                d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
              ></path>
              <path
                fill="#1976D2"
                d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
              ></path>
            </svg>
            Google
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { auth, db } from "../firebase/client";
  import {
    signInWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
  } from "firebase/auth";
  import { doc, getDoc } from "firebase/firestore";

  const formLogin = document.getElementById("form-login");
  const formRegister = document.getElementById("form-register");
  const btnGoogleLogin = document.getElementById("btn-google-login");
  const btnGoogleRegister = document.getElementById("btn-google-register");

  // Tab switching logic
  const tabLoginBtn = document.getElementById("tab-login");
  const tabRegisterBtn = document.querySelector(
    'a[href="/registro-profesional"]',
  );

  const showRegister = (e) => {
    e?.preventDefault();
    formLogin?.classList.add("hidden");
    formLogin?.classList.remove("active");
    formRegister?.classList.remove("hidden");
    formRegister?.classList.add("active");

    tabLoginBtn?.classList.remove("active");
    tabRegisterBtn?.classList.add("active");
  };

  const showLogin = (e) => {
    e?.preventDefault();
    formRegister?.classList.add("hidden");
    formRegister?.classList.remove("active");
    formLogin?.classList.remove("hidden");
    formLogin?.classList.add("active");

    tabRegisterBtn?.classList.remove("active");
    tabLoginBtn?.classList.add("active");
  };

  tabRegisterBtn?.addEventListener("click", showRegister);
  tabLoginBtn?.addEventListener("click", showLogin);

  // LOGIN LOGIC
  formLogin?.addEventListener("submit", async (e) => {
    e.preventDefault();
    // @ts-ignore
    const email = document.getElementById("login-email").value;
    // @ts-ignore
    const password = document.getElementById("login-password").value;

    try {
      const userCredential = await signInWithEmailAndPassword(
        auth,
        email,
        password,
      );
      window.location.href = "/panel";
    } catch (error) {
      console.error(error);
      alert("Error al ingresar: " + error.message);
    }
  });

  // REGISTER LOGIC
  // GOOGLE LOGIC
  const handleGoogle = async () => {
    try {
      const { setDoc, doc, getDoc } = await import("firebase/firestore");
      const result = await signInWithPopup(auth, new GoogleAuthProvider());

      const docRef = doc(db, "profesionales", result.user.uid);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        // New User: Create Basic Shell & Redirect to Wizard
        await setDoc(docRef, {
          nombre: result.user.displayName,
          email: result.user.email,
          foto: result.user.photoURL,
          rol: "profesional",
          createdAt: new Date(),
          perfilCompletado: false, // Flag for Wizard
        });
        window.location.href = "/registro-profesional";
      } else {
        // Existing User: Check Completion
        const data = docSnap.data();
        if (data.perfilCompletado === false) {
          window.location.href = "/registro-profesional";
        } else {
          // Check if they are actually a pro (might be client trying to login as pro)
          if (data.rol === "cliente") {
            window.location.href = "/mi-cuenta";
          } else {
            window.location.href = "/panel";
          }
        }
      }
    } catch (error) {
      console.error(error);
      alert("Error con Google: " + error.message);
    }
  };

  btnGoogleLogin?.addEventListener("click", handleGoogle);
  btnGoogleRegister?.addEventListener("click", handleGoogle);
</script>

<style>
  /* Animaciones de entrada */
  .auth-form {
    display: none;
    animation: fadeIn 0.3s ease-out;
  }
  .auth-form.active {
    display: block;
  }

  /* Tabs activas */
  .tab-btn.active {
    background-color: white;
    color: #ea580c; /* orange-600 */
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  /* Dark mode overrides for active tab */
  :global(.dark) .tab-btn.active {
    background-color: #1e293b; /* slate-800 */
    color: #f97316; /* orange-500 */
    box-shadow: none;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
