---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Ingresar - DeOficios">
<div class="auth-container">
    <div class="auth-banner">
      <div class="banner-content">
        <h1>¬°Bienvenido Colega! üõ†Ô∏è</h1>
        <p>
          Sumate a la red de oficios m√°s grande del barrio. Consegu√≠ clientes y
          mostr√° tu trabajo.
        </p>
      </div>
      <div class="overlay"></div>
    </div>

    <div class="auth-form-wrapper">
      <div class="form-header">
        <a href="/" class="back-link">‚Üê Volver al inicio</a>
        <img src="/favicon.svg" alt="Logo" class="logo-img" />
      </div>

      <div class="auth-tabs">
        <button class="tab-btn active" id="tab-login">Ingresar</button>
        <a
          href="/registro-profesional"
          class="tab-btn"
          style="text-decoration: none; text-align: center; display: block;"
          >Crear Cuenta</a
        >
      </div>

      <form id="form-login" class="auth-form active">
        <h2>Hola de nuevo üëã</h2>
        <p class="subtitle">Ingres√° tus datos para gestionar tu perfil.</p>

        <div class="input-group">
          <label>Email</label>
          <input type="email" placeholder="ejemplo@correo.com" required />
        </div>

        <div class="input-group">
          <label>Contrase√±a</label>
          <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>

        <button type="submit" class="btn-primary">Ingresar</button>
        <div style="text-align: right; margin-bottom: 15px;">
          <a
            href="/recuperacion"
            style="color: #6b7280; font-size: 0.9rem; text-decoration: none;"
          >
            ¬øOlvidaste tu contrase√±a?
          </a>
        </div>
        <div class="divider"><span>O ingres√° con</span></div>

        <button type="button" class="btn-google">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 48 48"
          >
            <path
              fill="#FFC107"
              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
            <path
              fill="#FF3D00"
              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
            ></path>
            <path
              fill="#4CAF50"
              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
            ></path>
            <path
              fill="#1976D2"
              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
          </svg>
          Google
        </button>
      </form>

      <form id="form-register" class="auth-form">
        <h2>Crear Cuenta üöÄ</h2>
        <p class="subtitle">Registrate gratis y empez√° a trabajar.</p>

        <div class="input-group">
          <label>Nombre Completo</label>
          <input type="text" placeholder="Juan Perez" required />
        </div>

        <div class="input-group">
          <label>Email</label>
          <input type="email" placeholder="ejemplo@correo.com" required />
        </div>

        <div class="input-group">
          <label>Contrase√±a</label>
          <input
            type="password"
            placeholder="Crea una contrase√±a segura"
            required
          />
        </div>

        <button type="submit" class="btn-primary">Registrarme</button>

        <div class="divider"><span>O registrate con</span></div>

        <button type="button" class="btn-google">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 48 48"
          >
            <path
              fill="#FFC107"
              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
            <path
              fill="#FF3D00"
              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
            ></path>
            <path
              fill="#4CAF50"
              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
            ></path>
            <path
              fill="#1976D2"
              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
          </svg>
          Google
        </button>
      </form>
    </div>
  </div>
</Layout>

<script>
import { auth, db } from "../firebase/client"; // üëà Importamos db tambi√©n
  import {
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendEmailVerification, // <--- IMPORTANTE
    GoogleAuthProvider,
    signInWithPopup,
  } from "firebase/auth";
  import { doc, setDoc, getDoc } from "firebase/firestore"; // üëà Herramientas para guardar datos

  // --- L√ìGICA VISUAL (PESTA√ëAS) ---
  const tabLogin = document.getElementById("tab-login");
  const tabRegister = document.getElementById("tab-register");
  const formLogin = document.getElementById("form-login");
  const formRegister = document.getElementById("form-register");

  tabLogin?.addEventListener("click", () => {
    tabLogin.classList.add("active");
    tabRegister.classList.remove("active");
    formLogin.classList.add("active");
    formRegister.classList.remove("active");
  });

  tabRegister?.addEventListener("click", () => {
    tabRegister.classList.add("active");
    tabLogin.classList.remove("active");
    formRegister.classList.add("active");
    formLogin.classList.remove("active");
  });

  // --- REGISTRO (CREAR USUARIO + PERFIL) ---
  formRegister?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nombreInput = formRegister.querySelector(
      'input[placeholder="Juan Perez"]',
    ); // Capturamos el nombre
    const emailInput = formRegister.querySelector('input[type="email"]');
    const passwordInput = formRegister.querySelector('input[type="password"]');
    const btn = formRegister.querySelector('button[type="submit"]');

    const nombre = (nombreInput as HTMLInputElement).value;
    const email = (emailInput as HTMLInputElement).value;
    const password = (passwordInput as HTMLInputElement).value;

    try {
      btn.textContent = "Creando perfil...";
      (btn as HTMLButtonElement).disabled = true;

      // 1. Crear usuario en Auth (La Llave)
      const userCredential = await createUserWithEmailAndPassword(
        auth,
        email,
        password,
      );
const user = userCredential.user;
      await sendEmailVerification(user);

      // 1. CALCULAMOS LAS FECHAS üìÖ
      const fechaRegistro = new Date();
      const fechaVencimiento = new Date();
      // Le sumamos 10 d√≠as a la fecha de hoy
      fechaVencimiento.setDate(fechaRegistro.getDate() + 10);

      // 2. Crear ficha en Base de Datos (La Casa)
      // Usamos el MISMO ID (uid) para que sean pareja
      await setDoc(doc(db, "profesionales", user.uid), {
        nombre: nombre,
        email: email,
        categoria: "Sin categor√≠a", // Datos por defecto
        zona: "Sin zona",
        descripcion: "¬°Hola! Soy nuevo en DeOficios.",
        verificado: false,
        es_24hs: false,

        // üëá DATOS NUEVOS DE SUSCRIPCI√ìN üëá
        plan: "prueba_gratis", // 'prueba_gratis', 'mensual', 'semestral'
        vencimiento: fechaVencimiento,
        estado: "activo", // 'activo', 'vencido'

        contactos_gratis_usados: 0,
        votos: 0,
        fecha_registro: fechaRegistro,
        rol: "profesional",
      });

      console.log("Perfil creado en DB para:", user.uid);
      
      // üöÄ ENVIAR EMAIL DE BIENVENIDA (Fuego y olvido)
      try {
        fetch("/api/send-welcome", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: email,
            name: nombre,
            role: "profesional",
          }),
        }).catch(err => console.warn("Error enviando welcome email:", err));
      } catch (e) { console.warn("Error trigger email:", e); }

      alert("¬°Cuenta creada! Revisa tu email para verificarla.");

      // 3. Redirigir a la p√°gina de edici√≥n (La crearemos luego)
      window.location.href = "/mi-perfil";
    } catch (error) {
      console.error(error);
      let mensaje = "Error al registrarse." + error.message;
      if (error.code === "auth/email-already-in-use")
        mensaje = "Ese email ya existe.";
      if (error.code === "auth/weak-password")
        mensaje = "La contrase√±a es muy corta.";
      alert(mensaje);
      btn.textContent = "Registrarme";
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  // --- LOGIN (INGRESAR) ---
  formLogin?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = (
      formLogin.querySelector('input[type="email"]') as HTMLInputElement
    ).value;
    const password = (
      formLogin.querySelector('input[type="password"]') as HTMLInputElement
    ).value;
    const btn = formLogin.querySelector('button[type="submit"]');

    try {
      btn.textContent = "Ingresando...";
      (btn as HTMLButtonElement).disabled = true;

      await signInWithEmailAndPassword(auth, email, password);

      // Al entrar, lo mandamos a su panel
      window.location.href = "/mi-perfil";
    } catch (error) {
      console.error(error);
      alert("Datos incorrectos. Intenta de nuevo.");
      btn.textContent = "Ingresar";
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  // --- GOOGLE LOGIN (Botones) ---
  const googleBtns = document.querySelectorAll(".btn-google");
  googleBtns.forEach((btn) => {
    btn.addEventListener("click", async () => {
      try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Check if user exists in DB, if not create basic profile
        const docRef = doc(db, "profesionales", user.uid);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          // Create profile for Google User
          const fechaRegistro = new Date();
          const fechaVencimiento = new Date();
          fechaVencimiento.setDate(fechaRegistro.getDate() + 10);

          await setDoc(docRef, {
            nombre: user.displayName || "Usuario Google",
            email: user.email,
            categoria: "Sin categor√≠a",
            zona: "Sin zona",
            descripcion: "¬°Hola! Soy nuevo en DeOficios.",
            verificado: false,
            es_24hs: false,
            plan: "prueba_gratis",
            vencimiento: fechaVencimiento,
            estado: "activo",
            contactos_gratis_usados: 0,
            votos: 0,
            fecha_registro: fechaRegistro,
            rol: "profesional",
            foto: user.photoURL, // Use Google photo
          });
        }

        window.location.href = "/mi-perfil";
      } catch (error) {
        console.error("Google Auth Error:", error);
        // Avoid alerting if popup closed by user
        if (error.code !== "auth/popup-closed-by-user") {
          alert("Error ingresando con Google: " + error.message);
        }
      }
    });
  });
</script>

<style>
  /* --- LAYOUT GENERAL --- */
  .auth-container {
    display: flex;
    min-height: 100vh;
    font-family: "Segoe UI", system-ui, sans-serif;
  }

  /* --- BANNER IZQUIERDO --- */
  .auth-banner {
    flex: 1;
    background-image: url("https://images.unsplash.com/photo-1621905251189-08b45d6a269e?q=80&w=1000&auto=format&fit=crop");
    background-size: cover;
    background-position: center;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    padding: 40px;
  }

  .overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1;
  }

  .banner-content {
    position: relative;
    z-index: 2;
    max-width: 400px;
  }
  .banner-content h1 {
    font-size: 3rem;
    margin-bottom: 20px;
    text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
  }
  .banner-content p {
    font-size: 1.2rem;
    opacity: 0.9;
  }

  /* --- FORMULARIO DERECHO --- */
  .auth-form-wrapper {
    flex: 1;
    max-width: 600px; /* Ancho m√°ximo del panel derecho */
    background: white;
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }
  .back-link {
    color: #7f8c8d;
    text-decoration: none;
    font-size: 0.9rem;
  }
  .logo-img {
    width: 40px;
  }

  /* TABS */
  .auth-tabs {
    display: flex;
    background: #f3f4f6;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 30px;
  }
  .tab-btn {
    flex: 1;
    border: none;
    background: transparent;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    color: #7f8c8d;
    transition: 0.3s;
  }
  .tab-btn.active {
    background: white;
    color: #e67e22;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  /* FORMULARIOS */
  .auth-form {
    display: none;
    animation: fadeIn 0.3s ease-out;
  }
  .auth-form.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
display: none;
    }
    to {
      opacity: 1;
      transform: translateY(0);
display: block;
    }
  }

  h2 {
    font-size: 2rem;
    color: #2c3e50;
    margin-bottom: 5px;
  }
  .subtitle {
    color: #95a5a6;
    margin-bottom: 30px;
  }

  .input-group {
    margin-bottom: 20px;
  }
  .input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #34495e;
    font-size: 0.9rem;
  }
  .input-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    box-sizing: border-box;
  }
  .input-group input:focus {
    outline: none;
    border-color: #e67e22;
    box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
  }

  .btn-primary {
    width: 100%;
    background: #e67e22;
    color: white;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: 0.2s;
    margin-bottom: 20px;
  }
  .btn-primary:hover {
    background: #d35400;
  }

  .divider {
    text-align: center;
    margin-bottom: 20px;
    position: relative;
  }
  .divider::before {
    content: "";
    position: absolute;
    left: 0;
    top: 50%;
    width: 100%;
    height: 1px;
    background: #eee;
    padding: 0; /* Fix potential margin issues */
  }
  .divider span {
    background: white;
    padding: 0 10px;
    color: #999;
    font-size: 0.8rem;
    position: relative;
    z-index: 1;
  }

  .btn-google {
    width: 100%;
    background: white;
    border: 1px solid #ddd;
    color: #333;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: 0.2s;
  }
  .btn-google:hover {
    background: #f9fafb;
    border-color: #ccc;
  }
  .btn-google img {
    width: 20px;
  }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    .auth-banner {
      display: none;
    } /* En m√≥vil ocultamos la imagen */
    .auth-form-wrapper {
      max-width: 100%;
    }
  }
</style>
