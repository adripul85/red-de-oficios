---
import Layout from "../layouts/Layout.astro";
import { db } from "../firebase/client";
import { collection, getDocs } from "firebase/firestore";
import { BARRIOS_COORDENADAS } from "../consts/coordenadas";

// 1. TRAER DATOS
const snapshot = await getDocs(collection(db, "profesionales"));

const profesionales = snapshot.docs
  .map((doc) => {
    const data = doc.data();
    const zona = data.zona || "";

    // --- üî• FILTRO DE SEGURIDAD: OCULTAR FREE ---
    const plan = data.plan || "gratuito";
    // Si el plan es alguno de estos, NO lo mostramos en el mapa
    if (plan === "semilla" || plan === "gratuito" || plan === "prueba_gratis") {
      return null;
    }

    // 1. Ubicaci√≥n exacta
    let lat = null,
      lng = null;

    if (data.ubicacion_exacta && data.ubicacion_exacta.lat) {
      lat = data.ubicacion_exacta.lat;
      lng = data.ubicacion_exacta.lng;
    }
    // 2. Barrio Gen√©rico (Fallback)
    else if (BARRIOS_COORDENADAS && BARRIOS_COORDENADAS[zona]) {
      const coords = BARRIOS_COORDENADAS[zona];
      const noise = () => (Math.random() - 0.5) * 0.008;
      lat = coords[0] + noise();
      lng = coords[1] + noise();
    }

    // Clasificaci√≥n para el color del pin
    const esExperto = data.plan === "experto" || data.plan === "semestral";
    const esPro = data.plan === "mensual" || data.plan === "profesional";

    let nivel = "basico";
    if (esExperto) nivel = "experto";
    else if (esPro) nivel = "pro";

    return {
      id: doc.id,
      nombre: data.nombre,
      categoria: data.rubro_principal || "Profesional",
      foto: data.foto,
      nivel,
      coords: { lat, lng },
    };
  })
  .filter((p) => p !== null && p.coords.lat !== null); // Filtramos nulos y sin coords

const prosJson = JSON.stringify(profesionales);
---

<Layout title="Mapa de Profesionales - DeOficios" hideFooter={true}>
  <div class="map-page">
    <div class="map-sidebar">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-3xl">üó∫Ô∏è</span>
        <h1 class="text-xl font-bold text-gray-900">Mapa en Vivo</h1>
      </div>

      <button
        id="btn-locate"
        class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition flex items-center justify-center gap-2 text-sm"
      >
        <span>üìç</span> Ver mi ubicaci√≥n
      </button>

      <div
        class="bg-gray-100 p-3 rounded-lg flex justify-between items-center text-sm mt-3"
      >
        <span class="font-bold text-gray-700">{profesionales.length}</span>
        <span class="text-gray-500">Profesionales activos</span>
      </div>

      <div class="space-y-2 text-sm mt-3">
        <p class="font-bold text-gray-700 text-xs uppercase tracking-wide">
          Referencias:
        </p>
        <div class="flex items-center gap-2">
          <img
            src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png"
            width="12"
          />
          <span class="text-gray-600">Experto (Recomendado)</span>
        </div>
        <div class="flex items-center gap-2">
          <img
            src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png"
            width="12"
          />
          <span class="text-gray-600">Profesional</span>
        </div>
        <div class="flex items-center gap-2">
          <img
            src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png"
            width="12"
          />
          <span class="text-gray-600">Est√°ndar</span>
        </div>
      </div>

      <div
        class="mt-auto bg-gray-900 p-4 rounded-xl text-center text-white mt-4"
      >
        <p class="text-xs text-gray-400 mb-2">¬øQuieres destacar aqu√≠?</p>
        <a
          href="/planes"
          class="block bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold py-2 rounded-lg transition"
        >
          üöÄ Obtener Pin Rojo
        </a>
      </div>

      <a
        href="/"
        class="block text-center text-gray-500 text-xs hover:text-orange-600 font-bold mt-2"
        >‚¨Ö Volver al listado</a
      >
    </div>

    <div id="map" class="map-container"></div>
  </div>
</Layout>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>

<script is:inline define:vars={{ prosJson }}>
  // Variable global para limpiar el mapa anterior
  let mapInstance = null;

  document.addEventListener("astro:page-load", () => {
    console.log("üó∫Ô∏è [MAPA] Inicializando mapa...");

    const mapContainer = document.getElementById("map");
    if (!mapContainer) {
      console.error("‚ùå [MAPA] Contenedor #map no encontrado");
      return;
    }

    // Limpiar mapa anterior si existe
    if (mapInstance) {
      console.log("üßπ [MAPA] Limpiando mapa anterior...");
      try {
        mapInstance.off();
        mapInstance.remove();
      } catch (e) {
        console.warn("‚ö†Ô∏è [MAPA] Error limpiando mapa:", e);
      }
      mapInstance = null;
    }

    // Limpiar completamente el contenedor HTML
    mapContainer.innerHTML = "";
    // Remover el ID interno de Leaflet para permitir reinicializaci√≥n
    delete mapContainer._leaflet_id;

    // Esperar a que Leaflet est√© disponible
    if (typeof L === "undefined") {
      console.error("‚ùå [MAPA] Leaflet no est√° cargado");
      setTimeout(() => {
        if (typeof L !== "undefined") {
          initMap();
        }
      }, 500);
      return;
    }

    initMap();

    function initMap() {
      console.log("‚úÖ [MAPA] Creando instancia de mapa...");

      // Iniciar Mapa (Centro Buenos Aires por defecto)
      mapInstance = L.map("map", { zoomControl: false }).setView(
        [-34.6037, -58.3816],
        6,
      ); // Zoom 6 para ver el pa√≠s
      L.control.zoom({ position: "bottomright" }).addTo(mapInstance);

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
        {
          attribution: "¬© OpenStreetMap",
          maxZoom: 19,
        },
      ).addTo(mapInstance);

      // Definir Iconos
      const IconFactory = (color) =>
        L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
          shadowUrl:
            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        });

      const redIcon = IconFactory("red"); // EXPERTO
      const goldIcon = IconFactory("gold"); // PRO
      const blueIcon = IconFactory("blue"); // BASIC

      const pros = JSON.parse(prosJson);
      console.log(`üìç [MAPA] Agregando ${pros.length} marcadores...`);
      const markers = [];

      // Agregar Marcadores
      pros.forEach((p) => {
        let iconToUse = blueIcon;
        let zIndex = 100;

        if (p.nivel === "experto") {
          iconToUse = redIcon;
          zIndex = 1000;
        } else if (p.nivel === "pro") {
          iconToUse = goldIcon;
          zIndex = 500;
        }

        const fotoHtml = p.foto
          ? `<img src="${p.foto}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.2);display:block;margin:0 auto;">`
          : `<div style="width:40px;height:40px;border-radius:50%;background:#ccc;display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;margin:0 auto;">${p.nombre[0]}</div>`;

        const popupContent = `
          <div style="text-align:center; font-family:sans-serif; min-width:160px; padding:5px;">
            <div style="margin-bottom:8px;">${fotoHtml}</div>
            <strong style="font-size:1rem; color:#111827; display:block; line-height:1.2;">${p.nombre}</strong>
            <span style="color:#ea580c; font-size:0.75rem; font-weight:bold; text-transform:uppercase; letter-spacing:0.5px;">${p.categoria}</span>
            <a href="/perfil?id=${p.id}" target="_blank" style="display:block; margin-top:10px; background:#111827; color:white; text-decoration:none; padding:6px 0; border-radius:6px; font-size:0.8rem; font-weight:bold;">Ver Perfil</a>
          </div>
        `;

        const marker = L.marker([p.coords.lat, p.coords.lng], {
          icon: iconToUse,
          zIndexOffset: zIndex,
        }).bindPopup(popupContent);
        markers.push(marker);
      });

      if (markers.length > 0) {
        const group = L.featureGroup(markers).addTo(mapInstance);
        mapInstance.fitBounds(group.getBounds(), {
          padding: [50, 50],
          maxZoom: 15,
        });
        console.log("‚úÖ [MAPA] Mapa inicializado correctamente");
      } else {
        console.warn("‚ö†Ô∏è [MAPA] No hay marcadores para mostrar");
      }
    }

    // Geolocalizaci√≥n
    const btnLocate = document.getElementById("btn-locate");
    if (btnLocate) {
      btnLocate.addEventListener("click", () => {
        btnLocate.innerHTML = "<span>üîÑ</span> Buscando...";
        mapInstance.locate({ setView: true, maxZoom: 15 });
      });
    }
    mapInstance.on("locationfound", (e) => {
      // User request: "Eliminar el punto azul el est√°ndar"
      // L.circle(e.latlng, { radius: e.accuracy / 2, color: "blue" }).addTo(mapInstance);

      // Instead, maybe just a custom marker or nothing, but for now we silence the blue circle.
      // We can add a custom 'You are here' marker if needed later.
      const userIcon = L.divIcon({
        className: "user-location-marker",
        html: '<div style="background-color:#3b82f6;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 4px rgba(59,130,246,0.3);"></div>',
        iconSize: [20, 20],
      });
      L.marker(e.latlng, { icon: userIcon }).addTo(mapInstance);

      if (btnLocate) btnLocate.innerHTML = "<span>‚úÖ</span> Est√°s aqu√≠";
    });
  });
</script>

<style>
  .map-page {
    position: relative;
    height: 100vh;
    width: 100%;
    overflow: hidden;
  }
  .map-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .map-sidebar {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 300px;
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    z-index: 10;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(5px);
  }

  @media (max-width: 768px) {
    .map-sidebar {
      top: auto;
      bottom: 0;
      left: 0;
      width: 100%;
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-bottom: 30px;
      gap: 10px;
    }
  }
</style>
