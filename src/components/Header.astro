---
import { Briefcase, BookOpen, CircleHelp, Menu, MessageSquare } from "lucide-astro";
---

<div id="global-announcement" class="global-announcement hidden">
  <div class="container announcement-content">
    <span id="announcement-text"></span>
  </div>
</div>

<header class="site-header">
  <div class="container header-content">
    <a href="/" class="logo">DeOficios<span class="dot">.com.ar</span></a>

    <div class="header-right">
      <nav class="main-nav hidden-mobile">
        <a
          href="/planes"
          id="btn-planes-desktop"
        <a
          href="/planes"
          id="btn-planes-desktop"
          class="nav-link destacados hidden flex items-center gap-1">
          <Briefcase class="w-4 h-4" /> Planes
        </a>
        <a href="/blog" class="nav-link flex items-center gap-1">
          <BookOpen class="w-4 h-4" /> Blog
        </a>
        <a href="/foro" class="nav-link flex items-center gap-1">
          <MessageSquare class="w-4 h-4" /> Comunidad / Foro
        </a>
        <a href="/faq" class="nav-link flex items-center gap-1">
          <CircleHelp class="w-4 h-4" /> Ayuda
        </a>

      </nav>

      <div class="separator hidden-mobile"></div>

      <div class="right-actions">
        <div id="user-area" class="auth-buttons">
          <div class="spinner-small"></div>
        </div>
        <button id="menu-toggle" class="menu-toggle" aria-label="Abrir men√∫">
          <Menu class="w-8 h-8 text-gray-700" />

        </button>
      </div>
    </div>
  </div>
</header>

<div id="mobile-menu" class="mobile-menu hidden">
  <a href="/" class="mobile-link">üîç Buscar</a>
  <a href="/planes" id="btn-planes-mobile" class="mobile-link hidden">üöÄ Planes</a>
  <a href="/blog" class="mobile-link">üì∞ Blog</a>
  <a href="/foro" class="mobile-link">üí¨ Comunidad / Foro</a>
  <div id="mobile-auth-area" class="p-4 flex flex-col gap-2"></div>
</div>


<script>
  import { auth, db } from "../firebase/client";
  import { onAuthStateChanged, signOut } from "firebase/auth";
  import { doc, getDoc, onSnapshot } from "firebase/firestore";

  let currentUser: any = null; // Variable global para el usuario actual

  // Listener Aviso Global (Real-time)
  onSnapshot(doc(db, "configuracion", "aviso_global"), (snapshot) => {
    const announcement = document.getElementById("global-announcement");
    const announcementText = document.getElementById("announcement-text");
    if (snapshot.exists()) {
      const data = snapshot.data();
      if (data.activo && data.mensaje) {
        if (announcementText) announcementText.innerText = data.mensaje;
        announcement?.classList.remove("hidden");
      } else {
        announcement?.classList.add("hidden");
      }
    }
  }, (error) => {
      console.warn("[Header] Error en listener aviso global:", error);
  });

  // Funci√≥n principal de renderizado con CACH√â

  async function updateHeaderUI() {
    const userArea = document.getElementById("user-area");
    const mobileAuth = document.getElementById("mobile-auth-area");
    if (!userArea) return;

    if (currentUser) {
      // --- USUARIO LOGUEADO ---
      let nombre = "Usuario";
      let avatarHTML =
        '<div class="avatar-placeholder" style="width:32px;height:32px;border-radius:50%;background:#ea580c;color:white;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;">U</div>';
      let profileLink = "/mi-perfil";
      let userType = null;

      try {
        // üöÄ OPTIMIZACI√ìN 1: Verificar cach√© primero
        const cachedType = localStorage.getItem(`userType_${currentUser.uid}`);

        if (cachedType === "profesional" || cachedType === "cliente") {
          console.log("‚ö° [HEADER] Usando cach√©:", cachedType);

          // Usar cach√© para query directa

          const collection =
            cachedType === "profesional" ? "profesionales" : "clientes";
          const docRef = doc(db, collection, currentUser.uid);
          const snap = await getDoc(docRef);

          if (snap.exists()) {
            const data = snap.data();
            nombre = data.nombre || "Usuario";
            profileLink =
              cachedType === "profesional" ? "/mi-perfil" : "/mi-cuenta";
            userType = cachedType;

            if (data.foto) {
              avatarHTML = `<img src="${data.foto}" alt="${nombre}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; display: block;" />`;
            } else if (data.nombre) {
              const bgColor =
                cachedType === "profesional" ? "#ea580c" : "#4f46e5";
              avatarHTML = `<div class="avatar-placeholder" style="width:32px;height:32px;border-radius:50%;background:${bgColor};color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;">${data.nombre[0].toUpperCase()}</div>`;
            }
          } else {
            // Cach√© inv√°lido, limpiar

            localStorage.removeItem(`userType_${currentUser.uid}`);
          }
        }

        // üöÄ OPTIMIZACI√ìN 2: Si no hay cach√©, queries EN PARALELO
        if (!userType) {
          console.log("‚ö° [HEADER] Sin cach√©, buscando en paralelo...");


          const [profSnap, clientSnap] = await Promise.all([
            getDoc(doc(db, "profesionales", currentUser.uid)),
            getDoc(doc(db, "clientes", currentUser.uid)),
          ]);

          if (profSnap.exists()) {
            // Es profesional
            const data = profSnap.data();
            nombre = data.nombre || "Usuario";
            profileLink = "/mi-perfil";
            userType = "profesional";

            if (data.foto) {
              avatarHTML = `<img src="${data.foto}" alt="${nombre}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; display: block;" />`;
            } else if (data.nombre) {
              avatarHTML = `<div class="avatar-placeholder" style="width:32px;height:32px;border-radius:50%;background:#ea580c;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;">${data.nombre[0].toUpperCase()}</div>`;
            }

            // Mostrar bot√≥n Planes para profesionales (query sin cach√©)

            document
              .getElementById("btn-planes-desktop")
              ?.classList.remove("hidden");
            document
              .getElementById("btn-planes-mobile")
              ?.classList.remove("hidden");

            // Guardar en cach√©
            localStorage.setItem(`userType_${currentUser.uid}`, "profesional");

            // Mostrar bot√≥n Planes para profesionales

            document
              .getElementById("btn-planes-desktop")
              ?.classList.remove("hidden");
            document
              .getElementById("btn-planes-mobile")
              ?.classList.remove("hidden");
          } else if (clientSnap.exists()) {
            // Es cliente
            const data = clientSnap.data();
            nombre = data.nombre || "Usuario";
            profileLink = "/mi-cuenta";
            userType = "cliente";

            if (data.foto) {
              avatarHTML = `<img src="${data.foto}" alt="${nombre}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; display: block;" />`;
            } else if (data.nombre) {
              avatarHTML = `<div class="avatar-placeholder" style="width:32px;height:32px;border-radius:50%;background:#4f46e5;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;">${data.nombre[0].toUpperCase()}</div>`;
            }

            // Guardar en cach√©

            localStorage.setItem(`userType_${currentUser.uid}`, "cliente");
          }
        }
      } catch (e) {
        console.error("Error perfil", e);
      }

      const iconUser = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
      const iconHeart = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>`;
      const iconLogOut = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`;
      const htmlUser = `
        <div class="user-dropdown-container relative group">
            <button class="flex items-center gap-2 text-gray-700 hover:text-orange-600 font-medium transition py-4 focus:outline-none">
                ${avatarHTML}
                <span>${nombre}</span>
                <span class="text-xs">‚ñº</span>

            </button>
            
            <div class="absolute right-0 top-full pt-2 w-48 hidden group-hover:block z-50">
                <div class="bg-white border border-gray-100 rounded-xl shadow-xl p-2">
                    <a href="${profileLink}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 rounded-lg transition flex items-center">${iconUser} Mi Perfil</a>
                    ${userType === "cliente" ? `<a href="/mi-cuenta" class="block px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 rounded-lg transition flex items-center">${iconHeart} Favoritos</a>` : ""}
                    <hr class="my-1 border-gray-100">
                    <button id="btn-logout-header" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition flex items-center">${iconLogOut} Cerrar Sesi√≥n</button>

                </div>
            </div>
        </div>
      `;
      userArea.innerHTML = htmlUser;

      // MOVIL
      if (mobileAuth)
        mobileAuth.innerHTML = `
          <div class="flex items-center gap-3 mb-3 px-2">
             ${avatarHTML}
             <div>
                <p class="font-bold text-gray-800">${nombre}</p>
                <p class="text-xs text-green-600">Sesi√≥n activa</p>
             </div>
          </div>
          <a href="${profileLink}" class="block text-center w-full bg-gray-100 py-2 rounded-lg font-bold text-gray-700 flex items-center justify-center gap-2">${iconUser} Ir a mi Perfil</a>
          <a href="/ingresar-derivador" class="block text-center w-full bg-white border border-gray-200 py-2 mt-2 rounded-lg font-bold text-gray-600 flex items-center justify-center gap-2">üîÑ Cambiar Perfil</a>
          <button id="btn-logout-mobile" class="block w-full text-center text-red-500 py-2 mt-2 flex items-center justify-center gap-2">${iconLogOut} Cerrar Sesi√≥n</button>
      `;

      // Event listeners para cerrar sesi√≥n
      const btnLogoutHeader = document.getElementById("btn-logout-header");
      const btnLogoutMobile = document.getElementById("btn-logout-mobile");

      [btnLogoutHeader, btnLogoutMobile].forEach((btn) => {
        btn?.addEventListener("click", async () => {
          // Limpiar cach√© al cerrar sesi√≥n

          if (currentUser) {
            localStorage.removeItem(`userType_${currentUser.uid}`);
          }
          await signOut(auth);
          window.location.href = "/"; // Redirigir a la p√°gina principal

        });
      });
    } else {
      // --- USUARIO NO LOGUEADO ---
      const htmlAnonimo = `
        <div class="flex items-center gap-3">
            <a href="/ingresar-cliente" class="text-sm font-semibold text-gray-500 hover:text-blue-600 transition hidden md:block">Soy Cliente</a>
            <a href="/ingresar" class="bg-orange-600 hover:bg-orange-700 text-white text-sm px-5 py-2.5 rounded-full font-bold shadow-sm transition">Soy Profesional</a>
        </div>
      `;
      userArea.innerHTML = htmlAnonimo;

      if (mobileAuth)
        mobileAuth.innerHTML = `
          <a href="/ingresar-cliente" class="block text-center w-full border border-gray-300 py-2 rounded-lg font-bold text-gray-600 mb-2">Soy Cliente</a>
          <a href="/ingresar" class="block text-center w-full bg-orange-600 text-white py-2 rounded-lg font-bold">Soy Profesional</a>
      `;
    }
  }

  // Listener de autenticaci√≥n (SOLO UNA VEZ)

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    await updateHeaderUI();
  });

  // Listener de navegaci√≥n en Astro (re-render UI en cada navegaci√≥n)
  document.addEventListener("astro:page-load", async () => {
    // 1. Activar men√∫ m√≥vil INMEDIATAMENTE (no esperar a auth)
    const menuBtn = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");

    // Remover listeners anteriores para evitar duplicados si astro:page-load dispara m√∫ltiple
    const newMenuBtn = menuBtn?.cloneNode(true);
    if (menuBtn && newMenuBtn && menuBtn.parentNode) {
      menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
      (newMenuBtn as HTMLElement).addEventListener("click", () => {
        console.log("üçî Toggle men√∫");
        mobileMenu?.classList.toggle("hidden");
        (newMenuBtn as HTMLElement).classList.toggle("active");

        mobileMenu?.classList.toggle("active");
      });
    }

    // 2. Actualizar UI de usuario (Async)
    await updateHeaderUI();
  });
</script>

<style>
  .global-announcement {
    @apply bg-orange-600 text-white py-2.5 text-center text-sm font-bold z-[100] relative;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .announcement-content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }

  .site-header {
    @apply bg-white/80 border-b border-gray-100 transition-colors duration-300;
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);

    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 70px;
  }
  .logo {
    font-family: "Montserrat", sans-serif;
    font-weight: 800;
    font-size: 1.5rem;
    @apply text-gray-800;

    text-decoration: none;
  }
  .dot {
    color: #ea580c;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .main-nav {
    display: flex;
    gap: 20px;
  }
  .nav-link {
    text-decoration: none;
    @apply text-gray-600;

    font-weight: 600;
    font-size: 0.95rem;
    transition: 0.2s;
  }
  .nav-link:hover {
    color: #ea580c;
  }
  .separator {
    width: 1px;
    height: 24px;
    background-color: #e5e7eb;
  }

  /* ESTO ARREGLA EL MEN√ö */

  .group:hover .group-hover\:block {
    display: block;
  }

  .spinner-small {
    width: 20px;
    height: 20px;
    border: 2px solid #eee;
    border-top: 2px solid #ea580c;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    100% {
      transform: rotate(360deg);
    }
  }

  .menu-toggle {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
  }
  .mobile-menu {
    @apply bg-white border-t border-gray-100;
    padding: 15px;
    position: fixed;
    z-index: 9999; /* Higher than everything */
    width: 100%;
    top: 70px; /* Below header */
    left: 0;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
    max-height: calc(100vh - 70px);
    overflow-y: auto;

  }
  .mobile-link {
    display: block;
    padding: 10px 0;
    text-decoration: none;
    @apply text-gray-700 border-b border-gray-50;
    font-weight: 600;

  }
  .hidden {
    display: none !important;
  }
  @media (max-width: 768px) {
    .hidden-mobile {
      display: none !important;
    }
    .visible-mobile {
      display: block !important;
    }

    /* Responsive Header Fixes */
    .header-content {
      height: 60px;
      padding: 0 15px;
    }

    .logo {
      font-size: 1.2rem;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);

      z-index: 60;
    }

    /* CRITICAL: HIDE USER AREA IN HEADER ON MOBILE */
    #user-area {
      display: none !important;
    }

    .header-right {
      gap: 0;
    }

    /* Hamburger Config - SVG Style */
    .menu-toggle {
      display: none !important; /* User requested to hide it */

      font-size: 1.8rem;
      color: #374151;
      padding: 5px;
      line-height: 1;
      background: transparent;
      border: none;
      cursor: pointer;
      z-index: 60;
    }

    /* SVG Transition */
    .menu-toggle svg {
      transition: transform 0.3s ease;
    }

    .menu-toggle.active svg {
      transform: rotate(90deg);
      color: #ea580c;
    }

    /* Fix mobile menu positioning */
    .mobile-menu {
      top: 60px;
      border-top: 1px solid #f3f4f6;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      max-height: calc(100vh - 60px);
      overflow-y: auto;

      /* Transitions */
      display: block !important;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .mobile-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* Ensure hidden class works for initial state logic */
    .mobile-menu.hidden {
      display: block !important;
      visibility: hidden;
      opacity: 0;
    }
  }
</style>

