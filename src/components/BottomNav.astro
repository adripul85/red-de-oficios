---
const { currentPath = "" } = Astro.props;

interface MenuItem {
    label: string;
    icon: string;
    path: string;
    primary?: boolean;
    adminOnly?: boolean;
    authRequired?: boolean;
}

const menuItems: MenuItem[] = [
    { label: "Inicio", icon: "üè†", path: "/" },
    { label: "Buscar", icon: "üîç", path: "/resultados" },
    { label: "Publicar", icon: "‚ûï", path: "/solicitar", primary: true },
    { label: "Mapa", icon: "üó∫Ô∏è", path: "/mapa" },
    { label: "Perfil", icon: "üë§", path: "/app/perfil" },
];
---

<nav class="bottom-nav-mobile md:hidden">
    <div class="bottom-nav-container">
        {
            menuItems.map((item) => (
                <a
                    href={item.path}
                    class:list={[
                        "nav-item",
                        {
                            active:
                                currentPath === item.path ||
                                (item.path !== "/" &&
                                    currentPath.startsWith(item.path)),
                        },
                        { "primary-action": item.primary },
                        { "auth-item": item.authRequired || item.adminOnly },
                    ]}
                    data-admin={item.adminOnly}
                >
                    <span
                        class="icon"
                        id={item.label === "Perfil" ? "profile-icon" : ""}
                    >
                        {item.icon}
                    </span>
                    <span
                        class="label"
                        id={item.label === "Perfil" ? "profile-label" : ""}
                    >
                        {item.label}
                    </span>
                </a>
            ))
        }
    </div>
</nav>

<style>
    .bottom-nav-mobile {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px; /* Standard height */
        /* Glassmorphism: More transparent, more blur, saturation boost */
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);

        /* Subtle glass border top */
        border-top: 1px solid rgba(255, 255, 255, 0.6);

        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom);

        /* Softer, deeper shadow */
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.08);
    }

    .bottom-nav-container {
        display: flex;
        justify-content: space-around;
        align-items: center;
        height: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 0 10px;
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: #64748b;
        flex: 1;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .nav-item .icon {
        font-size: 1.5rem;
        margin-bottom: 2px;
        transition: transform 0.2s;
    }

    .nav-item .label {
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .nav-item.active {
        color: #ea580c;
    }

    .nav-item.active .icon {
        transform: translateY(-2px);
    }

    /* Primary Center Button (App Style) */
    .nav-item.primary-action {
        background: #ea580c;
        color: white;
        height: 50px;
        width: 50px;
        min-width: 50px;
        border-radius: 18px;
        margin-bottom: 15px;
        box-shadow: 0 8px 15px rgba(234, 88, 12, 0.3);
        flex: none;
    }

    .nav-item.primary-action .icon {
        margin-bottom: 0;
        font-size: 1.4rem;
    }

    .nav-item.primary-action .label {
        display: none;
    }

    .nav-item.primary-action:active {
        transform: scale(0.9);
    }

    /* Auth handling (handled via client script in future or simple CSS) */
    .auth-item {
        /* Initially visible, could be hidden/shown via JS toggle */
    }

    /* Haptic effect simulator */
    .nav-item:active {
        opacity: 0.7;
    }
</style>

<script>
    import { auth, db } from "../firebase/client";
    import { onAuthStateChanged } from "firebase/auth";
    import { doc, getDoc } from "firebase/firestore";

    // --- Core Logic ---
    function updateAvatar(src: string) {
        const profileIcon = document.getElementById("profile-icon");
        if (profileIcon) {
            profileIcon.innerHTML = `<img src="${src}" alt="Perfil" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`;
        }
    }

    function applyLinks(role: string) {
        // We use querySelectorAll and iterate to ensure we catch elements even if they have slightly different classes or attributes in different contexts
        const centerButtons = document.querySelectorAll(
            ".nav-item.primary-action",
        );
        const profileButtons = document.querySelectorAll(
            '.nav-item[href="/app/perfil"], .nav-item[href="/mi-perfil"], .nav-item[href="/mi-cuenta"]',
        );

        console.log("üìç [NAV] Applying Role:", role);

        centerButtons.forEach((btn) => {
            if (role === "client")
                (btn as HTMLAnchorElement).href = "/solicitar";
            else if (role === "pro-free")
                (btn as HTMLAnchorElement).href = "/mi-perfil";
            else if (role === "pro-paid")
                (btn as HTMLAnchorElement).href = "/panel";
        });

        profileButtons.forEach((btn) => {
            if (role === "client")
                (btn as HTMLAnchorElement).href = "/mi-cuenta";
            // Both pro types go to /mi-perfil
            else if (role.startsWith("pro"))
                (btn as HTMLAnchorElement).href = "/mi-perfil";
        });
    }

    // --- Init Function (Runs on every navigation) ---
    function initBottomNav() {
        console.log("üöÄ [NAV] initBottomNav executing...");

        // 1. Immediate Cache Apply
        const lastKnownRole = localStorage.getItem("lastKnownRole");
        const lastKnownAvatar = localStorage.getItem("lastKnownAvatar");

        if (lastKnownRole) applyLinks(lastKnownRole);
        if (lastKnownAvatar) updateAvatar(lastKnownAvatar);

        // 2. Auth Listener (Updates Cache & UI if changed)
        // We unsubscribe previous listener if any (simplification: firebase handles duplicates generally well,
        // but for Astro we usually just let it run. To avoid memory leaks in single-page feel, strictly we should track unsubs,
        // but for this critical UI, re-attaching is safer to ensure it catches state).

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Determine Role & Update Cache
                try {
                    // Check Cache match first to avoid unnecessary DB calls if possible?
                    // No, always verify on auth change to ensure Plan validity.

                    // Parallel Check
                    const proRef = doc(db, "profesionales", user.uid);
                    const proSnap = await getDoc(proRef);

                    let role = "unknown";
                    let avatar = null;

                    if (proSnap.exists()) {
                        const data = proSnap.data();
                        const plan = (data.plan || "gratuito").toLowerCase();

                        // üî• LOGIC FIX: Explicit Plan Check
                        // USER RULE: Only "experto" or "profesional" get Panel access.
                        // "impulso" (mensual) -> Free-tier behavior (Mi Perfil)
                        const isPaid =
                            plan.includes("experto") ||
                            plan.includes("profesional");

                        const debugPlan = plan; // For console logging if needed

                        role = isPaid ? "pro-paid" : "pro-free";
                        avatar = data.foto;

                        console.log(
                            `üîç [NAV-CHECK] Plan: "${debugPlan}" -> IsPaid? ${isPaid} -> Role: ${role}`,
                        );
                    } else {
                        const clientRef = doc(db, "clientes", user.uid);
                        const clientSnap = await getDoc(clientRef);
                        if (clientSnap.exists()) {
                            role = "client";
                            avatar = clientSnap.data().foto;
                        }
                    }

                    if (role !== "unknown") {
                        const currentRole =
                            localStorage.getItem("lastKnownRole");
                        if (currentRole !== role) {
                            console.log(
                                "üîÑ [NAV] Role changed/updates, applying...",
                            );
                            localStorage.setItem("lastKnownRole", role);
                            applyLinks(role);
                        } else {
                            // Even if role is same, re-apply in case DOM was reset
                            applyLinks(role);
                        }
                    }

                    if (avatar) {
                        localStorage.setItem("lastKnownAvatar", avatar);
                        updateAvatar(avatar);
                    }
                } catch (e) {
                    console.error("Error fetching role:", e);
                }
            } else {
                // Logged Out
                localStorage.removeItem("lastKnownRole");
                const profileIcon = document.getElementById("profile-icon");
                if (profileIcon) profileIcon.innerText = "üë§";
                // Reset links to defaults
                const centerButtons = document.querySelectorAll(
                    ".nav-item.primary-action",
                );
                const profileButtons = document.querySelectorAll(
                    '.nav-item[href="/app/perfil"], .nav-item[href="/mi-perfil"], .nav-item[href="/mi-cuenta"]',
                );

                centerButtons.forEach(
                    (btn) => ((btn as HTMLAnchorElement).href = "/solicitar"),
                ); // or /ingresar
                profileButtons.forEach(
                    (btn) => ((btn as HTMLAnchorElement).href = "/app/perfil"),
                );
            }
        });
    }

    // --- Lifecycle Hooks for Astro Views Actions ---
    // Run immediately (script tag execution)
    initBottomNav();

    // Run on view transition navigation
    document.addEventListener("astro:page-load", () => {
        // Prevent double execution if script re-runs?
        // Actually, initBottomNav is safe to call multiple times as it re-applies UI.
        // But we might want to avoid attaching multiple onAuthStateChanged listeners if not careful.
        // For 'astro:page-load', it runs *after* the new body is swapped.

        // Simpler check: we just re-apply cached state immediately on page-load to ensure new DOM elements get updated.
        // The Auth listener from the previous "run" might still be active if it's a SPA navigation.
        // However, usually scripts in components re-run.

        const lastKnownRole = localStorage.getItem("lastKnownRole");
        if (lastKnownRole) applyLinks(lastKnownRole);

        const lastKnownAvatar = localStorage.getItem("lastKnownAvatar");
        if (lastKnownAvatar) updateAvatar(lastKnownAvatar);
    });
</script>
