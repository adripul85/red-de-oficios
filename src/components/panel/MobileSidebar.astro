const { currentPath } = Astro.props;
import { 
    LayoutDashboard, 
    Target, 
    FileText, 
    Wallet, 
    HardHat, 
    Users, 
    Shield,
    LogOut,
    User,
    Download,
    X,
    Zap
} from 'lucide-astro';

const menuItems = [
    { path: "/panel", icon: LayoutDashboard, label: "Dashboard" },
    {
        path: "/panel/oportunidades",
        icon: Target,
        label: "Oportunidades",
        badgeId: "badge-oportunidades-mobile",
    },
    { path: "/panel/presupuestos", icon: FileText, label: "Presupuestos" },
    { path: "/panel/finanzas", icon: Wallet, label: "Finanzas" },
    { path: "/panel/mi-equipo", icon: HardHat, label: "Mi Equipo" },
    { path: "/panel/clientes", icon: Users, label: "Clientes" },
    { path: "/panel/contactos", icon: Shield, label: "Mis Contactos" },
];

const isActive = (path) => {
    if (path === "/panel" && currentPath === "/panel") return true;
    if (path !== "/panel" && currentPath.startsWith(path)) return true;
    return false;
};
---

<style>
    .toggle-checkbox:checked {
        right: 0;
        border-color: #22c55e;
    }
    .toggle-checkbox {
        right: 50%;
        transition: all 0.3s;
        top: 0;
        bottom: 0;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #22c55e;
    }
    .toggle-checkbox {
        position: absolute;
        top: 0;
        left: 0;
        transition: all 0.3s;
    }
    .toggle-checkbox:checked {
        left: 100%;
        transform: translateX(-100%);
    }
</style>

<aside
    id="mobile-sidebar"
    class="md:hidden fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 border-r border-slate-700 flex flex-col transform -translate-x-full transition-transform duration-300"
>
    <div
        class="h-16 flex items-center justify-between px-6 border-b border-slate-700"
    >
        <a href="/" class="text-xl font-bold text-white flex items-center gap-2">
            <Zap class="w-6 h-6 text-orange-500" />
            DeOficios<span class="text-orange-500">Pro</span>
        </a>
        <button
            id="close-sidebar"
            class="text-gray-400 hover:text-white"
        >
            <X class="w-8 h-8" />
        </button>
    </div>

    <div class="flex-1 overflow-y-auto py-4">
        <nav class="px-3 space-y-1">
            {
                menuItems.map((item) => (
                    <a
                        href={item.path}
                        class:list={[
                            "flex items-center gap-3 px-3 py-2.5 rounded-lg group transition-colors relative",
                            isActive(item.path)
                                ? "bg-orange-900/20 text-orange-500"
                                : "text-gray-400 hover:bg-slate-800 hover:text-white",
                        ]}
                    >
                        <item.icon class="w-5 h-5" />
                        <span
                            class={
                                isActive(item.path)
                                    ? "font-semibold text-sm"
                                    : "font-medium text-sm"
                            }
                        >
                            {item.label}
                        </span>
                        {item.badgeId && (
                            <span
                                id={item.badgeId}
                                class="ml-auto bg-orange-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"
                            />
                        )}
                    </a>
                ))
            }
        </nav>
    </div>

    <div class="p-4 border-t border-slate-700">
        <!-- SWITCH ONLINE MOBILE -->
        <div class="px-3 mb-3">
            <label
                class="flex items-center justify-between p-2 bg-slate-800 rounded-lg cursor-pointer group hover:bg-slate-700 transition"
            >
                <div class="flex items-center gap-2">
                    <span id="status-icon-mobile" class="text-gray-500 text-xs text-center w-5"
                        >‚ö´</span
                    >
                    <span
                        id="status-text-mobile"
                        class="text-white text-xs font-bold">Offline</span
                    >
                </div>
                <div
                    class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in"
                >
                    <input
                        type="checkbox"
                        name="toggle"
                        id="online-toggle-mobile"
                        class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600"
                    />
                    <label
                        for="online-toggle-mobile"
                        class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-600 cursor-pointer"
                    ></label>
                </div>
            </label>
        </div>

        <a
            href="/mi-perfil"
            class="flex items-center gap-3 px-3 py-2 w-full text-gray-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors mb-1"
        >
            <User class="w-5 h-5" />
            <span class="font-medium text-sm">Mi Perfil</span>
        </a>
        <button
            id="btn-logout-mobile"
            class="flex items-center gap-3 px-3 py-2 w-full text-gray-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors text-left"
        >
            <LogOut class="w-5 h-5" />
            <span class="font-medium text-sm">Cerrar Sesi√≥n</span>
        </button>
    </div>
    <button
        id="btn-install-pwa-mobile"
        class="hidden flex items-center gap-3 px-3 py-2 w-full text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors mt-2"
    >
        <Download class="w-5 h-5" />
        <span class="font-medium text-sm">Instalar App</span>
    </button>

<!-- Mobile Sidebar Overlay -->
<div
    id="sidebar-overlay"
    class="sidebar-overlay fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300 md:hidden"
>
</div>

<script>
    import { auth } from "../../firebase/client";
    import { signOut } from "firebase/auth";

    function setupMobileSidebar() {
        const mobileSidebar = document.getElementById("mobile-sidebar");
        const sidebarOverlay = document.getElementById("sidebar-overlay");
        const openSidebarBtns = document.querySelectorAll("#open-sidebar");
        const closeSidebarBtn = document.getElementById("close-sidebar");
        const logoutBtnMobile = document.getElementById("btn-logout-mobile");

        if (!mobileSidebar) return;

        function openMobileSidebar(e) {
            e?.preventDefault();
            e?.stopPropagation();
            mobileSidebar.classList.remove("-translate-x-full");
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove("hidden");
                // Allow browser to render hidden removal before changing opacity for transition
                requestAnimationFrame(() => {
                    sidebarOverlay.classList.remove("opacity-0");
                    sidebarOverlay.classList.add("opacity-100");
                });
            }
        }

        function closeMobileSidebar(e) {
            e?.preventDefault();
            mobileSidebar.classList.add("-translate-x-full");
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove("opacity-100");
                sidebarOverlay.classList.add("opacity-0");
                setTimeout(() => {
                    sidebarOverlay.classList.add("hidden");
                }, 300);
            }
        }

        openSidebarBtns.forEach((btn) => (btn.onclick = openMobileSidebar));

        if (closeSidebarBtn) closeSidebarBtn.onclick = closeMobileSidebar;
        if (sidebarOverlay) sidebarOverlay.onclick = closeMobileSidebar;

        // Logout logic
        if (logoutBtnMobile) {
            logoutBtnMobile.onclick = async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    window.location.href = "/ingresar";
                } catch (error) {
                    console.error("Error al cerrar sesi√≥n:", error);
                }
            };
        }

        // ONLINE SWITCH LOGIC (MOBILE)
        const onlineToggleMobile = document.getElementById(
            "online-toggle-mobile",
        );
        const statusTextMobile = document.getElementById("status-text-mobile");
        const statusIconMobile = document.getElementById("status-icon-mobile");

        // Helper to update UI
        function updateStatusUIMobile(isOnline) {
            if (!statusTextMobile || !statusIconMobile) return;
            if (isOnline) {
                statusTextMobile.textContent = "EN L√çNEA";
                statusTextMobile.classList.remove("text-gray-400");
                statusTextMobile.classList.add("text-green-400");
                statusIconMobile.textContent = "üü¢";
            } else {
                statusTextMobile.textContent = "OFFLINE";
                statusTextMobile.classList.remove("text-green-400");
                statusTextMobile.classList.add("text-gray-400");
                statusIconMobile.textContent = "‚ö´";
            }
        }

        // Import needed functions if not present in this scope (assuming auth imported above)
        // Accessing db from global scope or import if needed. Since this script is `type=module` implicit in Astro <script>,
        // we need imports. Adding imports at top of script block if missing.
        // Wait, I can't easily add imports at the top with this replace.
        // I will assume db is NOT imported here and fix imports in a separate step or try to use existing imports.
        // MobileSidebar script already imports auth. I need to add db, doc, updateDoc, getDoc.

        // Logic inside setupMobileSidebar
        if (onlineToggleMobile) {
            // Re-using onAuthStateChanged from top scope
            import("firebase/firestore").then(({ doc, updateDoc, getDoc }) => {
                import("../../firebase/client").then(({ db }) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            try {
                                const userRef = doc(
                                    db,
                                    "profesionales",
                                    user.uid,
                                );
                                const docSnap = await getDoc(userRef);
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    const isOnline = data.online === true;

                                    onlineToggleMobile.checked = isOnline;
                                    updateStatusUIMobile(isOnline);

                                    onlineToggleMobile.addEventListener(
                                        "change",
                                        async (e) => {
                                            const newValue = e.target.checked;
                                            updateStatusUIMobile(newValue);
                                            try {
                                                await updateDoc(userRef, {
                                                    online: newValue,
                                                });
                                            } catch (err) {
                                                console.error(
                                                    "Error mobile switch:",
                                                    err,
                                                );
                                                onlineToggleMobile.checked =
                                                    !newValue;
                                                updateStatusUIMobile(!newValue);
                                            }
                                        },
                                    );
                                }
                            } catch (e) {
                                console.error(
                                    "Error fetching mobile status:",
                                    e,
                                );
                            }
                        }
                    });
                });
            });
        }
    }

    // Initialize on load and after swaps
    setupMobileSidebar();
    document.addEventListener("astro:page-load", setupMobileSidebar);
    document.addEventListener("astro:after-swap", setupMobileSidebar);
</script>
