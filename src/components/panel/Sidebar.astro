---
const { currentPath } = Astro.props;

const menuItems = [
    { path: "/panel", icon: "ðŸ“Š", label: "Dashboard" },
    {
        path: "/panel/oportunidades",
        icon: "ðŸŽ¯",
        label: "Oportunidades",
        badgeId: "badge-oportunidades",
    },
    { path: "/panel/presupuestos", icon: "ðŸ“", label: "Presupuestos" },
    { path: "/panel/finanzas", icon: "ðŸ’°", label: "Finanzas" },
    { path: "/panel/mi-equipo", icon: "ðŸ‘·", label: "Mi Equipo" },
    { path: "/panel/codigos", icon: "ðŸ›¡ï¸", label: "Mis CÃ³digos" },
    { path: "/panel/clientes", icon: "ðŸ‘¥", label: "Clientes" },
];

const isActive = (path) => {
    if (path === "/panel" && currentPath === "/panel") return true;
    if (path !== "/panel" && currentPath.startsWith(path)) return true;
    return false;
};
---

<aside
    class="hidden md:flex flex-col w-64 bg-black border-r border-slate-700 h-full"
>
    <div class="h-16 flex items-center px-6 border-b border-slate-700">
        <a href="/" class="text-xl font-bold text-white">
            DeOficios<span class="text-orange-500">Pro</span>
        </a>
    </div>

    <div class="flex-1 overflow-y-auto py-4">
        <nav class="px-3 space-y-1">
            {
                menuItems.map((item) => (
                    <a
                        href={item.path}
                        class:list={[
                            "flex items-center gap-3 px-3 py-2.5 rounded-lg group transition-colors relative",
                            isActive(item.path)
                                ? "bg-orange-900/20 text-orange-500"
                                : "text-gray-400 hover:bg-slate-800 hover:text-white",
]}
                    >
                        <span class="text-xl">{item.icon}</span>
                        <span
                            class={
                                isActive(item.path)
                                    ? "font-semibold text-sm"
                                    : "font-medium text-sm"
}
                        >
                            {item.label}
                        </span>
                        {item.badgeId && (
                            <span
                                id={item.badgeId}
                                class="ml-auto bg-orange-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"
                            />
                        )}
                    </a>
                ))
            }
        </nav>

        <div class="px-6 mt-8 mb-2">
            <h4
class="text-xs font-bold text-gray-500 uppercase tracking-wider"
            >
                Tu Nivel
            </h4>
        </div>
        <div class="px-6">
            <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
                <div class="flex justify-between items-center mb-2">
                    <span
                        id="level-name"
class="font-bold text-sm text-indigo-400"
                        >Cargando...</span
                    >
                    <span id="level-number" class="text-xs text-gray-500"
                        >Lvl ?</span
                    >
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2 mb-2">
                    <div
                        id="level-progress"
                        class="bg-indigo-500 h-2 rounded-full transition-all duration-1000"
style="width: 0%"
                    >
                    </div>
                </div>
                <p id="level-next" class="text-xs text-gray-500">
                    Calculando puntos...
                </p>
            </div>
        </div>
    </div>

    <div class="mt-auto pt-4 border-t border-slate-700 space-y-2">
<a
            href="/mi-perfil"
            class="flex items-center gap-3 px-3 py-2 w-full text-gray-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
        >
            <span>ðŸ‘¤</span>
            <span class="font-medium text-sm">Mi Perfil</span>
        </a>

        <button
            id="btn-logout"
class="flex items-center gap-3 px-3 py-2 w-full text-gray-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors text-left"
        >
            <span>ðŸšª</span>
            <span class="font-medium text-sm">Cerrar SesiÃ³n</span>
        </button>
    </div>

    <button
        id="btn-install-pwa"
class="hidden flex items-center gap-3 px-3 py-2 w-full text-indigo-600 bg-indigo-50 hover:bg-indigo-100 dark:text-white dark:bg-indigo-600 dark:hover:bg-indigo-700 rounded-lg transition-colors mt-2"
    >
        <span>ðŸ“²</span>
        <span class="font-medium text-sm">Instalar App</span>
    </button>
</aside>

<script>
    import { auth, app, db } from "../../firebase/client";
    import { signOut } from "firebase/auth";
    import { getFirestore, doc, onSnapshot } from "firebase/firestore";
    import { calculateLevel, getLevelProgress } from "../../utils/gamification";
    
    // const db = getFirestore(app); // Standardized to use singleton from client.js
    console.log("ðŸ”¥ [SIDEBAR DEBUG] Global db from client.js:", db?.constructor?.name);

    function setupSidebar() {
        const logoutBtn = document.getElementById("btn-logout");
        const installBtn = document.getElementById("btn-install-pwa");
        
        // Level elements
        const levelNameEl = document.getElementById("level-name");
        const levelNumberEl = document.getElementById("level-number");
        const levelProgressEl = document.getElementById("level-progress");
        const levelNextEl = document.getElementById("level-next");

        let deferredPrompt;

        const syncLevel = (user) => {
            if (!user) {
                console.log("âš ï¸ [SIDEBAR] syncLevel: No user found");
                return;
            }
            if (!db) {
                console.error("âŒ [SIDEBAR] Firestore 'db' is not initialized");
                return;
            }
            onSnapshot(doc(db, `profesionales/${user.uid}`), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const xp = data.puntos || 0;
                    console.log("âœ¨ [SIDEBAR] Level data received. Points:", xp);
                    
                    const { current, next } = calculateLevel(xp);
                    const progress = getLevelProgress(xp);

                    if (levelNameEl) levelNameEl.innerText = current.name;
                    if (levelNumberEl) levelNumberEl.innerText = `Lvl ${current.threshold === 0 ? 1 : Math.floor(xp / 1000) + 1}`;
                    if (levelProgressEl) levelProgressEl.style.width = `${progress}%`;
                    
                    if (levelNextEl) {
                        if (next) {
                            const remaining = next.threshold - xp;
                            levelNextEl.innerText = `Faltan ${remaining} pts para el prÃ³ximo nivel`;
                        } else {
                            levelNextEl.innerText = "Â¡Nivel MÃ¡ximo alcanzado! ðŸ‘‘";
                        }
                    }
                } else {
                    console.warn("â“ [SIDEBAR] syncLevel: Document does not exist for", user.uid);
                }
            }, (err) => {
                console.error("ðŸ’¥ [SIDEBAR] syncLevel error:", err);
            });
        };

        // Immediate check + listener
        const currentUser = auth.currentUser;
        if (currentUser) {
            console.log("âœ… [SIDEBAR] User found immediately:", currentUser.uid);
            syncLevel(currentUser);
        } else {
            console.log("â³ [SIDEBAR] No immediate user, waiting for state change...");
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("ðŸ”„ [SIDEBAR] Auth state ready:", user.uid);
                syncLevel(user);
            }
        });

        // Logout
        if (logoutBtn) {
            logoutBtn.onclick = async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    window.location.href = "/ingresar";
                } catch (error) {
console.error("Error al cerrar sesiÃ³n:", error);
                }
            };
        }

        // PWA Install
        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBtn) installBtn.classList.remove("hidden");
        });

        if (installBtn) {
            installBtn.onclick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBtn.classList.add("hidden");
            };
        }

        window.addEventListener("appinstalled", () => {
            if (installBtn) installBtn.classList.add("hidden");
        });
    }

    // Initialize
    setupSidebar();
    document.addEventListener("astro:page-load", setupSidebar);
    document.addEventListener("astro:after-swap", setupSidebar);
</script>
