---

---

<div id="ai-assistant-wrapper">
    <!-- FAB (Floating Action Button) -->
    <div
        id="ai-fab-container"
        class="fixed bottom-24 right-5 md:bottom-8 md:right-8 z-50 group font-sans transition-all duration-300"
    >
        <!-- Tooltip (Desktop Hover) -->
        <div
            id="ai-tooltip"
            class="absolute bottom-full right-0 mb-4 w-52 bg-white border border-slate-200 p-3 rounded-2xl shadow-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none hidden md:block"
        >
            <p class="text-[11px] font-bold text-slate-800 leading-tight">
                ‚ú® <strong>¬øNo sab√©s qu√© profesional necesit√°s?</strong> Describime
                tu problema y yo te gu√≠o.
            </p>
            <div
                class="absolute top-full right-6 w-3 h-3 bg-white border-r border-b border-slate-200 rotate-45 -mt-1.5"
            >
            </div>
        </div>

        <!-- Main Button -->
        <button
            id="btn-ai-toggle"
            class="w-14 h-14 md:w-16 md:h-16 bg-slate-900 text-white rounded-full shadow-[0_10px_30px_rgba(0,0,0,0.3)] flex items-center justify-center hover:scale-105 active:scale-95 transition-all border-2 border-white/10 relative overflow-hidden"
            aria-label="Asistente IA"
        >
            <span
                id="ai-icon-sparkle"
                class="text-2xl relative z-10 transition-transform duration-300"
                >‚ú®</span
            >
            <span
                id="ai-icon-close"
                class="text-xl relative z-10 transition-transform duration-300 hidden"
                >‚úï</span
            >

            <!-- Shine Effect -->
            <div
                class="absolute inset-0 bg-gradient-to-tr from-white/0 via-white/10 to-white/0 rotate-45 translate-x-[-100%] animate-shine"
            >
            </div>
        </button>
    </div>

    <!-- CHAT WINDOW (Hidden by default) -->
    <div
        id="ai-chat-window"
        class="fixed bottom-40 right-4 md:bottom-28 md:right-8 w-[90%] md:w-[380px] h-[500px] bg-white rounded-3xl shadow-2xl border border-slate-100 z-40 hidden flex flex-col overflow-hidden transition-all duration-300 origin-bottom-right opacity-0 scale-90"
    >
        <!-- Header -->
        <div
            class="bg-slate-900 px-5 py-4 flex items-center justify-between shrink-0"
        >
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-lg"
                >
                    ‚ú®
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm">
                        Asistente DeOficios
                    </h3>
                    <p
                        class="text-slate-400 text-[10px] flex items-center gap-1"
                    >
                        <span
                            class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"
                        ></span>
                        En l√≠nea
                    </p>
                </div>
            </div>
            <!-- Close Btn inside header -->
            <button
                id="btn-close-chat"
                class="text-slate-400 hover:text-white transition"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-5 h-5"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div
            id="ai-messages"
            class="flex-1 bg-slate-50 p-4 overflow-y-auto space-y-4"
        >
            <!-- Welcome Message -->
            <div class="flex gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-sm shrink-0"
                >
                    ü§ñ
                </div>
                <div
                    class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-sm shadow-sm text-sm text-slate-700 max-w-[85%]"
                >
                    <p>¬°Hola! Soy tu asistente de diagn√≥stico.</p>
                    <p class="mt-2 text-slate-500 text-xs">
                        Contame qu√© problema ten√©s en tu casa o empresa (ej:
                        "tengo humedad", "se cort√≥ la luz") y te ayudo a
                        encontrar al profesional ideal.
                    </p>
                </div>
            </div>

            <!-- Example User Message (Hidden initially, for structure) 
            <div class="flex gap-3 justify-end hidden">
                <div class="bg-slate-900 p-3 rounded-2xl rounded-tr-sm shadow-sm text-sm text-white max-w-[85%]">
                    Me sale agua debajo de la bacha.
                </div>
            </div>
            -->
        </div>

        <!-- Input Area -->
        <div class="p-3 bg-white border-t border-slate-100 shrink-0">
            <form id="ai-form" class="relative flex items-center gap-2">
                <input
                    type="text"
                    id="ai-input"
                    placeholder="Describ√≠ tu problema..."
                    class="w-full bg-slate-50 border border-slate-200 rounded-full px-4 py-3 text-sm focus:outline-none focus:border-slate-400 focus:ring-1 focus:ring-slate-400 transition-all placeholder:text-slate-400"
                    autocomplete="off"
                />
                <button
                    type="submit"
                    class="absolute right-2 p-2 bg-slate-900 text-white rounded-full hover:bg-slate-800 transition shadow-sm flex items-center justify-center"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        class="w-4 h-4"
                    >
                        <path
                            d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.086l-1.414 4.926a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.289z"
                        ></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    @keyframes shine {
        0% {
            transform: translateX(-150%) rotate(45deg);
        }
        20%,
        100% {
            transform: translateX(150%) rotate(45deg);
        }
    }
    .animate-shine {
        animation: shine 3s infinite ease-in-out;
    }

    /* Scrollbar minimalista */
    #ai-messages::-webkit-scrollbar {
        width: 6px;
    }
    #ai-messages::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 10px;
    }
    #ai-messages::-webkit-scrollbar-track {
        background-color: transparent;
    }

    /* Animation Classes */
    .chat-open {
        display: flex !important;
        opacity: 1 !important;
        transform: scale(1) !important;
    }
</style>

<script>
    import { ALL_TRADES, CATEGORIES } from "../data/categories";

    const btnToggle = document.getElementById("btn-ai-toggle");
    const btnClose = document.getElementById("btn-close-chat");
    const chatWindow = document.getElementById("ai-chat-window");
    const iconSparkle = document.getElementById("ai-icon-sparkle");
    const iconClose = document.getElementById("ai-icon-close");
    const form = document.getElementById("ai-form");
    // @ts-ignore
    const input = document.getElementById("ai-input") as HTMLInputElement;
    const messagesContainer = document.getElementById("ai-messages");

    let isOpen = false;

    function toggleChat() {
        isOpen = !isOpen;
        if (isOpen) {
            // Open
            chatWindow?.classList.remove("hidden");
            // Small delay to allow display:flex to apply before transition
            setTimeout(() => {
                chatWindow?.classList.add("chat-open");
                input?.focus();
            }, 10);

            // Icon transformation
            iconSparkle?.classList.add("hidden");
            iconClose?.classList.remove("hidden");

            // Hide tooltip permanently after first open
            document.getElementById("ai-tooltip")?.classList.add("!hidden");
        } else {
            // Close
            chatWindow?.classList.remove("chat-open");
            setTimeout(() => {
                chatWindow?.classList.add("hidden");
            }, 300); // Wait for transition

            // Icon transformation
            iconSparkle?.classList.remove("hidden");
            iconClose?.classList.add("hidden");
        }
    }

    btnToggle?.addEventListener("click", toggleChat);
    btnClose?.addEventListener("click", toggleChat);

    // State Management
    let chatState = "idle"; // idle, waiting_problem, waiting_zone, done
    let context = { problem: "", zone: "", rubro: "" };

    // Simple keyword mapping
    function detectRubro(text) {
        const t = text.toLowerCase();
        // Priority checks
        if (
            t.includes("luz") ||
            t.includes("enchufe") ||
            t.includes("cable") ||
            t.includes("el√©ctrico")
        )
            return "Electricista";
        if (
            t.includes("agua") ||
            t.includes("ca√±o") ||
            t.includes("gotera") ||
            t.includes("inodoro")
        )
            return "Plomero";
        if (t.includes("gas") || t.includes("estufa") || t.includes("p√©rdida"))
            return "Gasista";
        if (
            t.includes("aire") ||
            t.includes("acondicionado") ||
            t.includes("climatizador")
        )
            return "Aire Acondicionado";
        if (t.includes("llave") || t.includes("puerta") || t.includes("traba"))
            return "Cerrajero";
        if (
            t.includes("pintar") ||
            t.includes("pared") ||
            t.includes("humedad")
        )
            return "Pintor";
        if (t.includes("jard√≠n") || t.includes("pasto") || t.includes("poda"))
            return "Jardinero";
        if (
            t.includes("construir") ||
            t.includes("ladrillo") ||
            t.includes("cemento")
        )
            return "Alba√±il";

        // Fallback: Check against all trade names
        for (const trade of ALL_TRADES) {
            if (t.includes(trade.toLowerCase())) return trade;
        }
        return "";
    }

    // Mock Response Logic
    form?.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        // 1. Add User Message
        addUserMessage(text);
        input.value = "";

        // Disable input to prevent race conditions
        input.disabled = true;
        input.placeholder = "Procesando...";

        // 2. Mock AI Thinking & Response
        showTypingIndicator();

        setTimeout(() => {
            removeTypingIndicator();
            handleAiResponse(text);
        }, 1200);
    });

    function handleAiResponse(text) {
        if (chatState === "idle" || chatState === "waiting_problem") {
            const detectedValue = detectRubro(text);

            if (detectedValue) {
                context.rubro = detectedValue;
                addAiMessage(`Entiendo, necesit√°s un **${detectedValue}**. üõ†Ô∏è`);
            } else {
                addAiMessage(
                    "Bien. Buscar√© al profesional m√°s adecuado para eso.",
                );
            }

            context.problem = text;

            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    addAiMessage(
                        "Para mostrarte los m√°s cercanos: **¬øEn qu√© barrio o ciudad est√°s?** üìç",
                    );
                    chatState = "waiting_zone";
                    input.disabled = false;
                    input.placeholder = "Ej: Palermo, Centro...";
                    input.focus();
                }, 800);
            }, 600);
        } else if (chatState === "waiting_zone") {
            context.zone = text;
            addAiMessage(`Perfecto, buscando en **${text}**... üîç`);

            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();

                    const rubroQuery = context.rubro
                        ? encodeURIComponent(context.rubro)
                        : "";
                    const zonaQuery = encodeURIComponent(context.zone);

                    addAiMessage("¬°Listo! Tengo estas opciones para vos:");

                    // Action Buttons
                    const actionsDiv = document.createElement("div");
                    actionsDiv.className =
                        "flex flex-col gap-2 mt-2 animate-fade-in pl-11";

                    let searchUrl = `/resultados?ubicacion=${zonaQuery}`;
                    if (rubroQuery) searchUrl += `&rubro=${rubroQuery}`;

                    let budgetUrl = `/solicitar?ubicacion=${zonaQuery}`;
                    if (rubroQuery) budgetUrl += `&rubro=${rubroQuery}`;

                    actionsDiv.innerHTML = `
                        <a href="${searchUrl}" class="bg-slate-900 hover:bg-slate-800 text-white text-sm px-4 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-md">
                            <span>üîç</span> Ver Profesionales
                        </a>
                        <a href="${budgetUrl}" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 text-sm px-4 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-sm">
                            <span>üìù</span> Pedir Presupuesto
                        </a>
                    `;
                    messagesContainer?.appendChild(actionsDiv);
                    scrollToBottom();

                    chatState = "done";
                    input.placeholder = "B√∫squeda finalizada";
                }, 1000);
            }, 800);
        } else if (chatState === "done") {
            addAiMessage(
                "Si necesit√°s mas ayuda, pod√©s usar los botones de arriba o iniciar una nueva b√∫squeda recargando la p√°gina. üòâ",
            );
            // Optional: reset button logic could go here
        }
    }

    function addUserMessage(text) {
        const div = document.createElement("div");
        div.className = "flex gap-3 justify-end animate-fade-in";
        div.innerHTML = `
            <div class="bg-slate-900 p-3 rounded-2xl rounded-tr-sm shadow-sm text-sm text-white max-w-[85%]">
                ${text}
            </div>
        `;
        messagesContainer?.appendChild(div);
        scrollToBottom();
    }

    function addAiMessage(text) {
        const div = document.createElement("div");
        div.className = "flex gap-3 animate-fade-in";
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs shrink-0">‚ú®</div>
            <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-sm shadow-sm text-sm text-slate-700 max-w-[85%]">
                ${text}
            </div>
        `;
        messagesContainer?.appendChild(div);
        scrollToBottom();
    }

    function showTypingIndicator() {
        const div = document.createElement("div");
        div.id = "typing-indicator";
        div.className = "flex gap-3 animate-fade-in";
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs shrink-0">‚ú®</div>
            <div class="bg-white border border-slate-100 p-3 rounded-2xl rounded-tl-sm shadow-sm flex items-center gap-1 h-10 w-16">
                <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span>
                <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
            </div>
        `;
        messagesContainer?.appendChild(div);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const el = document.getElementById("typing-indicator");
        el?.remove();
    }

    function scrollToBottom() {
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
</script>
