---
import { db } from '../../firebase/client';
import { collection, query, limit, getDocs } from 'firebase/firestore';

// Variables para guardar los datos
let recientes = [];
let error = null;

try {
  // 1. Buscamos en la colecci√≥n "profesionales"
  const q = query(collection(db, "profesionales"), limit(6));
  const querySnapshot = await getDocs(q);
  
  // 2. Convertimos los datos
  recientes = querySnapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

} catch (e) {
  console.error("Error trayendo profesionales:", e);
  error = e.message; // Guardamos el error para mostrarlo
}
---

<section class="recientes-section">
  <h2>üÜï Reci√©n llegados a DeOficios</h2>
  
  <div class="grid-container">
    
    {/* CASO 1: HUBO UN ERROR */}
    {error && (
      <div class="error-box">
        <h3>‚ö†Ô∏è Hubo un problema</h3>
        <p>{error}</p>
        <small>Revisa que la colecci√≥n en Firebase se llame "profesionales" (min√∫scula).</small>
      </div>
    )}

    {/* CASO 2: NO HAY NADIE (Lista vac√≠a) */}
    {!error && recientes.length === 0 && (
      <div class="empty-box">
        <p>üì≠ A√∫n no hay profesionales registrados.</p>
        <p>¬°S√© el primero! Ve a <a href="/ingresar">Ingresar</a> y crea tu cuenta.</p>
      </div>
    )}

    {/* CASO 3: LISTADO CORRECTO */}
    {recientes.map((pro) => (
      <a href={`/perfil/?id=${pro.id}`} class="card-link">
        <div class="pro-card">
          <div class="card-header">
            <div class="avatar">
              {pro.foto ? (
                <img src={pro.foto} alt={pro.nombre} class="img-card" />
              ) : (
                pro.nombre ? pro.nombre.substring(0, 2).toUpperCase() : '?'
              )}
            </div>
            
            <div class="info">
              <h3>{pro.nombre || "Usuario Nuevo"}</h3>
              <span class="badge">{pro.categoria || "Sin categor√≠a"}</span>
            </div>
          </div>
          
          <div class="card-body">
            <p>üìç {pro.zona || "Sin zona definida"}</p>
            <p class="desc">
              {pro.descripcion 
                ? pro.descripcion.substring(0, 60) + "..." 
                : "¬°Hola! Estoy listo para trabajar."}
            </p>
          </div>
        </div>
      </a>
    ))}

  </div>
</section>

<style>
  /* ESTILOS SIMPLES */
  .recientes-section { padding: 40px 20px; max-width: 1100px; margin: 0 auto; }
  h2 { text-align: center; margin-bottom: 30px; color: #2c3e50; }

  .grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
  }

  /* TARJETAS */
  .card-link { text-decoration: none; color: inherit; }
  .pro-card {
    background: white; border: 1px solid #eee; border-radius: 12px;
    padding: 20px; transition: transform 0.2s, box-shadow 0.2s;
    height: 100%; display: flex; flex-direction: column;
  }
  .pro-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #e67e22; }

  .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
  .avatar {
    width: 50px; height: 50px; background: #e67e22; color: white;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 1.2rem; flex-shrink: 0;
  }
  .info h3 { margin: 0; font-size: 1.1rem; color: #333; }
  .badge { background: #fff7ed; color: #d35400; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; }

  .card-body p { margin: 5px 0; color: #666; font-size: 0.9rem; }
  .desc { font-style: italic; color: #888; margin-top: 10px; line-height: 1.4; }

  /* CAJAS DE ERROR / VAC√çO */
  .error-box { background: #fee2e2; color: #991b1b; padding: 20px; border-radius: 8px; grid-column: 1 / -1; text-align: center; }
  .empty-box { background: #f3f4f6; color: #6b7280; padding: 40px; border-radius: 8px; grid-column: 1 / -1; text-align: center; }
/* Agrega esto */
  .avatar { overflow: hidden; }
  .img-card { width: 100%; height: 100%; object-fit: cover; }

</style>