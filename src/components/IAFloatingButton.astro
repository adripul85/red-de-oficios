---
// IAFloatingButton.astro
---

<div class="fixed bottom-6 right-6 z-[9999]">
    <!-- Main Button -->
    <button
        id="ia-faq-btn"
        class="w-16 h-16 bg-gradient-to-tr from-orange-500 to-red-600 rounded-full shadow-2xl flex items-center justify-center text-3xl hover:scale-110 transition-transform active:scale-95 group relative"
    >
        <div
            class="absolute inset-0 bg-white/20 rounded-full animate-ping group-hover:hidden"
        >
        </div>
        ü§ñ
    </button>

    <!-- Chat Window -->
    <div
        id="ia-chat-window"
        class="absolute bottom-20 right-0 w-[350px] max-w-[90vw] bg-white rounded-3xl shadow-2xl border border-slate-100 flex flex-col overflow-hidden transition-all duration-300 translate-y-10 opacity-0 pointer-events-none"
    >
        <!-- Header -->
        <div
            class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 text-white flex items-center justify-between"
        >
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-sm"
                >
                    AI
                </div>
                <div>
                    <h4 class="font-bold text-sm">Asistente DeOficios</h4>
                    <p class="text-[10px] text-slate-400">En l√≠nea ahora</p>
                </div>
            </div>
            <button
                id="close-chat"
                class="text-slate-400 hover:text-white transition-colors"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div
            id="chat-messages"
            class="flex-1 p-4 space-y-4 overflow-y-auto max-h-[400px] min-h-[300px] bg-slate-50"
        >
            <div class="flex gap-2">
                <div
                    class="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-xs self-end"
                >
                    ü§ñ
                </div>
                <div
                    class="bg-white p-3 rounded-2xl rounded-bl-sm shadow-sm border border-slate-100 max-w-[80%]"
                >
                    <p class="text-xs text-slate-700">
                        ¬°Hola! Soy tu asistente inteligente. ¬øEn qu√© puedo
                        ayudarte hoy?
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
            <input
                type="text"
                id="ia-chat-input"
                placeholder="Escribe tu pregunta..."
                class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-orange-500 outline-none"
            />
            <button
                id="send-ia-msg"
                class="p-2 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-colors"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("astro:page-load", () => {
        const btn = document.getElementById("ia-faq-btn");
        const windowChat = document.getElementById("ia-chat-window");
        const closeBtn = document.getElementById("close-chat");
        const sendBtn = document.getElementById("send-ia-msg");
        const input = document.getElementById(
            "ia-chat-input",
        ) as HTMLInputElement;
        const messages = document.getElementById("chat-messages");

        // Re-attach listeners explicitly
        if (!btn || !windowChat) return;

        const KNOWLEDGE_BASE = [
            // Identidad y Prop√≥sito
            {
                keywords: ["hola", "buen", "dia", "tarde", "noche"],
                answer: "¬°Hola! üëã Soy el asistente virtual de DeOficios. ¬øEn qu√© puedo ayudarte hoy?",
            },
            {
                keywords: [
                    "quien",
                    "eres",
                    "sos",
                    "bot",
                    "asistente",
                    "haces",
                    "hacer",
                    "ayuda",
                    "funcion",
                ],
                answer: "Soy una IA entrenada para responder tus dudas sobre DeOficios. Puedo explicarte c√≥mo funciona la web, los planes, c√≥mo contratar o trabajar. ¬°Preguntame lo que quieras! ü§ñ",
            },
            {
                keywords: [
                    "web",
                    "sirve",
                    "plataforma",
                    "pagina",
                    "sitio",
                    "deoficios",
                    "objetivo",
                    "es",
                ],
                answer: "DeOficios es una plataforma que conecta vecinos que necesitan soluciones con profesionales de confianza üõ†Ô∏è. Si busc√°s un profesional, pod√©s pedir presupuesto gratis. Si sos profesional, pod√©s conseguir nuevos clientes.",
            },
            // Planes y Precios
            {
                keywords: [
                    "precio",
                    "costo",
                    "pagar",
                    "pago",
                    "plan",
                    "gratis",
                    "cobran",
                    "tarifa",
                    "valor",
                ],
                answer: "Tenemos 3 opciones: \n1Ô∏è‚É£ **Plan Semilla (Gratis):** Ideal para empezar.\n2Ô∏è‚É£ **Plan Impulso ($30k/mes):** M√°s visibilidad y beneficios.\n3Ô∏è‚É£ **Plan Experto ($150k/semestre):** Incluye Panel Pro, Gesti√≥n de Equipos y Sello Oro. üèÜ",
            },
            {
                keywords: [
                    "medios",
                    "tarjeta",
                    "efectivo",
                    "transferencia",
                    "como pago",
                ],
                answer: "Pod√©s abonar los planes a trav√©s de Mercado Pago con todas las tarjetas, d√©bito o dinero en cuenta. Es 100% seguro. üí≥",
            },
            // Verificaci√≥n y Seguridad
            {
                keywords: [
                    "verificado",
                    "sello",
                    "seguro",
                    "identidad",
                    "confianza",
                    "seguridad",
                ],
                answer: "La seguridad es prioridad. ‚úÖ La verificaci√≥n requiere subir DNI y validar identidad. El sello 'Verificado Oro' es exclusivo del Plan Experto e indica m√°xima confianza.",
            },
            // Contacto
            {
                keywords: [
                    "telefono",
                    "celular",
                    "whatsapp",
                    "contacto",
                    "llamar",
                    "mail",
                    "correo",
                ],
                answer: "üìû **Para Clientes:** Los profesionales te contactar√°n directamente por WhatsApp cuando pidas un presupuesto.\nüë∑ **Para Profesionales:** Ver√°s los datos del cliente al desbloquear el contacto en tu panel.",
            },
            // Funcionalidades Pro
            {
                keywords: [
                    "equipo",
                    "colaboradores",
                    "miembros",
                    "socios",
                    "agregar",
                ],
                answer: "La funci√≥n 'Gesti√≥n de Equipo' üë• te permite agregar socios o empleados a tu cuenta para gestionar pedidos juntos. Es exclusiva del **Plan Experto**.",
            },
            {
                keywords: [
                    "presupuesto",
                    "pedido",
                    "solicitud",
                    "contratar",
                    "necesito",
                ],
                answer: "¬°Es muy f√°cil! En tu panel de cliente, toc√° el bot√≥n 'Necesitas un profesional' y complet√° los datos. Es GRATIS y r√°pido. üöÄ",
            },
        ];

        function toggleChat() {
            windowChat?.classList.toggle("opacity-0");
            windowChat?.classList.toggle("pointer-events-none");
            windowChat?.classList.toggle("translate-y-10");
            windowChat?.classList.toggle("active");
        }

        // Cleanup old listeners
        btn.onclick = toggleChat;
        if (closeBtn) closeBtn.onclick = toggleChat;

        function addMessage(text: string, isUser = false) {
            if (!messages) return;
            const msgDiv = document.createElement("div");
            msgDiv.className = `flex gap-2 ${isUser ? "flex-row-reverse" : ""}`;

            // Format markdown-like bold text for display
            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\n/g, "<br>");

            msgDiv.innerHTML = `
                <div class="w-6 h-6 ${isUser ? "bg-orange-500" : "bg-slate-200"} rounded-full flex items-center justify-center text-[10px] text-white self-end">
                    ${isUser ? "üë§" : "ü§ñ"}
                </div>
                <div class="${isUser ? "bg-orange-500 text-white" : "bg-white text-slate-700"} p-3 rounded-2xl ${isUser ? "rounded-br-sm" : "rounded-bl-sm"} shadow-sm border border-slate-100 max-w-[80%]">
                    <p class="text-xs leading-relaxed">${formattedText}</p>
                </div>
            `;
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function normalize(str: string) {
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        function generateAIResponse(query: string) {
            const cleanQuery = normalize(query);

            for (const item of KNOWLEDGE_BASE) {
                // Check if ANY keyword is included in the query
                if (
                    item.keywords.some((k) => cleanQuery.includes(normalize(k)))
                ) {
                    return item.answer;
                }
            }
            return "Lo siento, no tengo respuesta exacta para eso. üòï\n\nPero puedes ver m√°s info en la secci√≥n **FAQ** del pie de p√°gina o escribirnos directamente a **Contacto** (tambi√©n en el footer). üëá";
        }

        async function handleSend() {
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            input.value = "";
            addMessage(text, true);

            // Simulate thinking flow
            const thinkingDelay = Math.random() * 500 + 500; // 500-1000ms
            setTimeout(() => {
                const reply = generateAIResponse(text);
                addMessage(reply);
            }, thinkingDelay);
        }

        if (sendBtn) sendBtn.onclick = handleSend;
        if (input)
            input.onkeypress = (e) => {
                if (e.key === "Enter") handleSend();
            };
    });
</script>

<style>
    #ia-chat-window.active {
        box-shadow: 0 25px 50px -12px rgba(234, 88, 12, 0.25);
    }
</style>
